# 问题追踪

本文档记录项目中发现的问题及其处理状态。

## 状态说明

| 状态 | 含义 |
|------|------|
| 🔴 待处理 | 已发现，尚未开始处理 |
| 🟡 处理中 | 正在解决 |
| 🟢 已解决 | 已修复，记录解决版本 |
| ⚪ 暂不处理 | 评估后决定暂缓或不修复 |

## 严重程度说明

| 等级 | 含义 |
|------|------|
| P0 | 阻塞使用，必须立即修复 |
| P1 | 影响体验，应尽快修复 |
| P2 | 小问题，有空再修 |

---

## 当前问题列表

| ID | 问题描述 | 严重程度 | 状态 | 发现版本 | 解决版本 | 备注 |
|----|---------|---------|------|---------|---------|------|
| #001 | V9路书需要手动粘贴到高级设置 | P1 | 🔴 待处理 | V28 | - | 可考虑自动读取项目文件夹里的路书文件 |
| #002 | 气泡图格式依赖AI理解V9路书 | P1 | 🔴 待处理 | V28 | - | 如果AI生成的SVG格式不对，需要在路书中补充更详细的SVG示例 |
| #005 | 并发请求可能触发API限流 | P2 | ⚪ 暂不处理 | V38 | - | 多标签页同时生成可能触发DMXapi限流，建议错开10-20秒 |
| #007 | COLLAB.md部署状态需手动更新 | P2 | 🔴 待处理 | V131 | - | 部署流程中没有自动更新状态字段的步骤 |
| #008 | 作业管理暂无批量导出功能 | P2 | 🔴 待处理 | V148 | - | 已入库记录只能在系统内查看 |
| #009 | Noto Sans CJK字体文件待复制 | P2 | 🔴 待处理 | V134 | - | fonts/目录可能仍只有wqy-zenhei，需确认Noto字体是否已部署 |

---

## 已解决问题归档

### V172-V177 归档（多租户隔离修复）

| ID | 问题描述 | 严重程度 | 发现版本 | 解决版本 | 解决方案 |
|----|---------|---------|---------|---------|---------|
| #H090 | 学生历史记录跨账户泄露（localStorage） | P0 | V172 | V172 | localStorage key 必须包含 userId，删除 "default" 回退逻辑 |
| #H091 | getConfigValue 跨租户 fallback 到 systemConfig | P0 | V173 | V173 | 有 userId 时仅查 user_config，不 fallback，返回 DEFAULT_CONFIG |
| #H092 | 前端学生下拉列表跨账户数据残留 | P0 | V174 | V174 | 切换账户时先清空再加载；saveStudentLesson 走 getUserOnlyConfigValue |
| #H093 | migrateSystemConfigToAdmin 复制数据给所有 admin | P0 | V175 | V175 | 仅对 openId === ENV.ownerOpenId 执行迁移 |
| #H094 | exportBackup 混入 systemConfig 数据 | P1 | V175 | V175 | 备份仅包含 user_config + DEFAULT_CONFIG，不读 systemConfig |
| #H095 | 路径输入框默认值显示为黑色实心（应为灰色 placeholder） | P2 | V176 | V176 | config.getAll 不返回 DEFAULT_CONFIG 作为实际值 |
| #H096 | 非管理员无法保存设置（config.update 是 adminProcedure） | P1 | V177 | V177 | 改为 protectedProcedure，所有用户可修改自己的配置 |

### V1-V28 归档

| ID | 问题描述 | 严重程度 | 发现版本 | 解决版本 | 解决方案 |
|----|---------|---------|---------|---------|---------|
| #H001 | 长文档生成时超时 | P0 | V21 | V22 | 改用SSE流式输出 |
| #H002 | AI输出内容被截断 | P1 | V20 | V21 | max_tokens从8000改为16000 |
| #H003 | 只有学情反馈使用自定义路书 | P1 | V17 | V18 | 让所有文档都使用自定义路书 |
| #H004 | AI转述路书效果差 | P1 | V22 | V23 | 直接使用路书原文作为提示词 |
| #H005 | 录音压缩步骤增加出错概率 | P2 | V25 | V26 | 取消压缩，直接使用原文 |

### V29-V45 归档

| ID | 问题描述 | 严重程度 | 发现版本 | 解决版本 | 解决方案 |
|----|---------|---------|---------|---------|---------|
| #H006 | Cloudflare 524超时（100秒限制） | P0 | V44 | V45b-e | 端到端SSE流式输出，保持连接活跃 |
| #H007 | 并发请求学生名污染 | P0 | V39 | V40 | 每个请求独立log对象，不使用全局变量 |
| #H008 | 气泡图中文乱码 | P1 | V42 | V42 | 前端Canvas渲染，绕过服务器字体问题 |
| #H009 | SSE改造后日志导出失败 | P1 | V45b | V45i-j | 4个SSE端点补充日志记录逻辑 |
| #H010 | 超长内容（24000+字符）解析失败 | P1 | V45l | V45l | 分块发送（10000字符/块），前端拼接 |
| #H011 | 星期显示错误 | P2 | V45f | V45f | 日期附带星期传给AI，不让AI自己计算 |
| #H012 | 小班课文件链接不可点击 | P1 | V44 | V44 | 补充返回uploadResult.url |
| #H013 | 日期偏移一天 | P1 | V44 | V44 | 修复日期解析逻辑，明确提取"本次课"日期 |
| #H014 | max_tokens不够导致截断 | P1 | V45c | V45c | 从16000改为32000，全部18处 |
| #H015 | OAuth回调路由404 | P1 | V35 | V35 | 代码需Publish发布到正式环境才能生效 |
| #H016 | Google Drive rclone正式环境不可用 | P0 | V36 | V37 | 改用Google Drive REST API + OAuth Token |
| #H017 | SSE事件类型误判 | P1 | V45b | V45b | 用event:行判断类型，不用字段判断 |
| #H018 | SSE变量作用域导致状态丢失 | P1 | V45b | V45b | currentEventType在while外部声明 |
| #H019 | 复习文档进度不显示字符数 | P2 | V45g | V45g-h | complete事件保存chars字段并显示 |
| #H020 | AI等待用户确认不生成内容 | P1 | V44 | V44 | 路书和程序都加"不要互动"指令 |
| #H021 | 未经大量真实数据测试验证 | P0 | V28 | V45 | V45系列进行了大量真实数据测试 |

### V46-V47 归档

| ID | 问题描述 | 严重程度 | 发现版本 | 解决版本 | 解决方案 |
|----|---------|---------|---------|---------|---------|
| #H022 | 批量处理文件名显示"学情反馈" | P1 | V46 | V46 | 批量处理使用独立的命名函数，不复用课堂反馈命名逻辑 |
| #H023 | 批量处理没有Google Drive链接 | P1 | V46 | V46 | 补充uploadResult返回，前端显示链接 |
| #H024 | 并发数限制不生效 | P1 | V46 | V46 | 修复并发池队列管理逻辑 |
| #H025 | 词汇卡片JSON解析失败 | P1 | V47 | V47 | 路书明确要求"不要输出Markdown代码块标记" |
| #H026 | 词汇卡片模板语法错误 | P1 | V47 | V47 | require改import，module.exports改export |
| #H027 | 代码重复，没有模块化 | P2 | V45 | V46 | V46抽取sseHelper公共模块，4个SSE端点共用 |

### V48 归档

| ID | 问题描述 | 严重程度 | 发现版本 | 解决版本 | 解决方案 |
|----|---------|---------|---------|---------|---------|
| #H028 | Markdown粗体/斜体不保留 | P1 | V48 | V48 | 新增parseInlineFormatting函数解析并生成对应TextRun |
| #H029 | Markdown表格不支持 | P1 | V48 | V48 | 新增parseMarkdownTable函数，转换为docx Table |
| #H030 | llm.ts不支持文件参数 | P1 | V48 | V48 | 新增FileInfo类型和fileInfo参数 |
| #H031 | mime_type类型限制过严 | P1 | V48 | V48 | 从枚举改为string类型 |
| #H032 | 文件上传顺序不对 | P2 | V48 | V48 | 按文件名排序后再分配任务编号 |

### V49-V51 归档

| ID | 问题描述 | 严重程度 | 发现版本 | 解决版本 | 解决方案 |
|----|---------|---------|---------|---------|---------|
| #H033 | 不同AI模型max_tokens上限不同 | P1 | V49 | V49 | 新增max_tokens配置项，默认64000 |
| #H034 | 输出被截断时用户无感知 | P1 | V49 | V49 | 解析stop_reason，截断时弹出警告 |
| #H035 | 无法确认当前运行版本 | P2 | V49 | V49 | 页面右上角添加版本号显示 |
| #H036 | 用户不了解模板输出格式要求 | P2 | V50 | V50 | 添加模板格式说明显示区域 |
| #H037 | 复制模板说明到路书不方便 | P2 | V50 | V50 | 添加一键复制按钮 |
| #H038 | 部分AI模型不支持file_url | P1 | V51 | V51 | 实现文档转文字，提取纯文本发送 |
| #H039 | AI无法区分不同来源的内容 | P2 | V51 | V51 | 使用XML标签标记内容来源 |
| #H040 | 前端extractedText未传递到后端 | P0 | V51 | V51 | 修复BatchProcess.tsx文件映射逻辑 |

### V52-V65 归档

| ID | 问题描述 | 严重程度 | 发现版本 | 解决版本 | 解决方案 |
|----|---------|---------|---------|---------|---------|
| #H041 | vm2 沙箱中 require 不可用 | P0 | V52 | V60 | 改用 NodeVM 或全局变量注入 |
| #H042 | ESM/CommonJS 混用导致模块加载失败 | P1 | V52 | V60 | 统一使用 CommonJS 或预注入模块 |
| #H043 | AI 代码模式文件命名混乱 | P1 | V52 | V60.1 | AI代码模式禁用前端命名，路书指定规则 |
| #H044 | 步骤失败时状态未更新 | P1 | V61 | V61 | 使用 useRef 避免 React 闭包陷阱 |
| #H045 | 硬编码 API Key 安全风险 | P0 | V63 | V63.3 | 移除硬编码，使用环境变量 |
| #H046 | 业务 API 无登录保护 | P1 | V63 | V63.4 | 所有业务 API 改为 protectedProcedure |
| #H047 | 一对一模式后 4 文档串行太慢 | P2 | V63 | V63.7 | 改为并行生成 |
| #H048 | 小班课后 4 文档串行太慢 | P2 | V63 | V63.9 | 改为并行生成 |
| #H049 | SSE 连接被代理断开 | P1 | V64 | V64 | 添加 15 秒心跳保活 |
| #H050 | SSE 断开后误报错误 | P1 | V64 | V64 | 先查询状态再决定是否报错 |
| #H051 | 批量失败后需重跑全部 | P1 | V65 | V65 | 新增「指定任务」模式 |
| #H052 | 指定任务模式 502 错误 | P0 | V65 | V65 | 修复 start/end 变量作用域问题 |

### V66-V152 归档

#### V68-V71 SSE传输修复

| ID | 问题描述 | 严重程度 | 发现版本 | 解决版本 | 解决方案 |
|----|---------|---------|---------|---------|---------|
| #H053 | SSE分块传输内容丢失 | P0 | V68 | V71 | 大内容改为内存暂存+HTTP拉取，SSE只传通知 |
| #H054 | res.flush()在无compression时报错 | P1 | V68.2 | V68.3 | 改用填充数据方案，后续V71彻底重构 |
| #H055 | SSE进度更新被缓冲区拦截 | P1 | V68 | V68.2 | 添加flush调用（临时方案） |

#### V72-V100 质量与健壮性修复

| ID | 问题描述 | 严重程度 | 发现版本 | 解决版本 | 解决方案 |
|----|---------|---------|---------|---------|---------|
| #H056 | AI输出包含元评论 | P1 | V72 | V72-V100 | stripAIMetaCommentary统一后处理剔除 |
| #H057 | OAuth token并发刷新冲突 | P1 | V72 | V72-V100 | 并发锁：复用进行中的刷新Promise |
| #H058 | 大文本输入框卡顿 | P1 | V72 | V72-V100 | DebouncedTextarea防抖组件 |
| #H059 | SSE reader cancel后流泄漏 | P1 | V72 | V72-V100 | 正确处理reader cancel事件 |
| #H060 | contentStore无上限导致内存溢出风险 | P2 | V72 | V72-V100 | 设置500条上限 |
| #H061 | 空文件上传到Google Drive | P1 | V72 | V72-V100 | 添加空文件校验，为空则拦截 |
| #H062 | sseUploadResult未声明（V87） | P1 | V87 | V87 | 合并冲突修复 |
| #H063 | lessonDate重复定义TypeScript错误 | P1 | V96 | V96 | 修复重复声明 |
| #H064 | lessonNumber字段缺失TypeScript错误 | P1 | V102 | V102 | 添加字段声明 |

#### V103-V111 Google Drive集成修复

| ID | 问题描述 | 严重程度 | 发现版本 | 解决版本 | 解决方案 |
|----|---------|---------|---------|---------|---------|
| #H065 | 小班课文件存错文件夹 | P1 | V72-V100 | V72-V100 | 修复文件夹路径逻辑 |
| #H066 | 北京时间计算公式错误 | P1 | V104 | V104 | 修复UTC+8计算 |
| #H067 | 文件名有空格/无空格不兼容 | P1 | V107 | V107 | 兼容两种格式 |
| #H068 | 精确路径搜索找不到文件 | P1 | V109 | V109 | 三级搜索兜底（精确→目录→全局） |

#### V112-V118 后台任务系统

| ID | 问题描述 | 严重程度 | 发现版本 | 解决版本 | 解决方案 |
|----|---------|---------|---------|---------|---------|
| #H069 | TEXT字段65KB截断长文本 | P0 | V113 | V113 | 升级为MEDIUMTEXT（16MB） |
| #H070 | 并发数默认5太保守 | P2 | V118 | V118 | 默认改为50，持久化保存 |

#### V119-V128 体验与稳定性修复

| ID | 问题描述 | 严重程度 | 发现版本 | 解决版本 | 解决方案 |
|----|---------|---------|---------|---------|---------|
| #H071 | 生成按钮可重复点击 | P1 | V119 | V119 | 按钮加锁防重复 |
| #H072 | 后台任务SSE流式不稳定 | P1 | V122 | V122 | 改为非流式调用 |
| #H073 | AI输出截断无法恢复 | P1 | V122 | V122 | 截断自动续写功能 |
| #H074 | SVG字体注入破坏XML结构 | P0 | V124 | V124 | 转义CSS中的XML特殊字符 |
| #H075 | 复习文档/气泡图中文乱码 | P0 | V126 | V126 | docx设微软雅黑默认字体+SVG字体注入增强（未彻底） |
| #H076 | require('sharp')在ESM崩溃 | P0 | V128 | V128 | 移除require调用 |
| #H077 | 取消云盘读取后残留幽灵数据 | P1 | V128 | V128 | 取消时清除ref和state |

#### V129-V134 气泡图引擎重构

| ID | 问题描述 | 严重程度 | 发现版本 | 解决版本 | 解决方案 |
|----|---------|---------|---------|---------|---------|
| #H078 | 气泡图中文显示□□□（彻底解决） | P0 | V114 | V129 | 渲染引擎从sharp/librsvg换为resvg |
| #H079 | resvg找不到系统字体（沙箱限制） | P0 | V130 | V131 | 字体文件复制到项目本地fonts/目录 |

#### V137-V147 体验优化

| ID | 问题描述 | 严重程度 | 发现版本 | 解决版本 | 解决方案 |
|----|---------|---------|---------|---------|---------|
| #H080 | 学生名持久化失败 | P1 | V137 | V137 | Zod schema添加students字段声明 |

#### V148-V152 作业管理系统

| ID | 问题描述 | 严重程度 | 发现版本 | 解决版本 | 解决方案 |
|----|---------|---------|---------|---------|---------|
| #H081 | updateStudent字段映射错误（snake_case） | P1 | V150 | V150 | 改用Drizzle camelCase字段名 |
| #H082 | 添加已删除同名学生报UNIQUE错误 | P1 | V150 | V150 | 先查询再决定INSERT还是UPDATE激活 |
| #H083 | importFromExtraction不激活inactive学生 | P1 | V150 | V150 | 导入时检查并激活 |

---

## 踩坑经验总结

### V46-V47 踩坑经验总结

#### 通用教训

| 教训 | 说明 |
|------|------|
| 新功能独立命名 | 新功能要使用独立的命名和逻辑，不要复用其他功能的命名导致混乱 |
| JSON输出要明确禁止Markdown标记 | 让AI输出JSON时，路书必须明确要求"不要输出Markdown代码块标记" |
| 模块语法要统一 | TypeScript项目用import/export，不要混用require/module.exports |
| 检查返回值完整性 | 新功能要检查是否遗漏了返回值（如uploadResult.url） |

#### 预防措施

| 问题类型 | 预防方法 |
|---------|---------|
| 命名混乱 | 任务书中明确指定命名规则，新功能用独立的命名函数 |
| JSON解析失败 | 路书模板中加入"只输出纯JSON，不要输出任何Markdown标记" |
| 功能遗漏 | 任务书中列出"与XX功能保持一致的点"，逐项检查 |
| 模块语法错误 | 新文件参考项目中已有文件的import/export写法 |

### V48 踩坑经验总结

| 教训 | 说明 |
|------|------|
| 类型定义要灵活 | mime_type用string比枚举更灵活，便于扩展 |
| 字段命名要统一 | 前后端字段名不一致会导致取值失败 |
| 文件排序要考虑中文 | 使用localeCompare进行中文友好排序 |
| 复杂解析分步做 | Markdown解析器按元素类型分Step实现 |

### V49-V51 踩坑经验总结

#### Git Rebase覆盖改动

| 教训 | 说明 |
|------|------|
| Checkpoint不等于安全 | Git rebase可能覆盖最近的改动 |
| 发布后必须验证 | 用无痕模式访问正式环境确认功能 |
| 版本号显示很重要 | 一眼确认当前运行版本 |

#### 前后端数据传递

| 教训 | 说明 |
|------|------|
| 新增字段要检查全链路 | 前端state → API请求 → 后端处理 |
| 字段名要保持一致 | extractedText前后端统一 |
| 添加调试日志排查 | console.log打印收到的数据结构 |

### V52-V65 踩坑经验总结

#### 沙箱执行

| 教训 | 说明 |
|------|------|
| vm2 require 限制 | vm2 默认禁止 require，需要配置 NodeVM 或预注入模块 |
| 模块格式统一 | ESM 和 CommonJS 混用会出问题，要统一 |

#### React 状态管理

| 教训 | 说明 |
|------|------|
| 闭包陷阱 | 回调函数会捕获旧状态，用 useRef 或函数式更新解决 |
| 并行状态更新 | 多个并发任务更新同一状态时要用函数式更新 |

#### SSE 稳定性

| 教训 | 说明 |
|------|------|
| 心跳保活 | 长连接需要定期心跳，15 秒是个好选择 |
| 断线处理 | 必须有降级方案，不能一断就报错 |

#### 变量作用域

| 教训 | 说明 |
|------|------|
| 全局搜索 | 修改变量作用域前，必须搜索所有引用位置 |
| 先排查后修改 | 遇到 502/503 错误，先排查服务器日志，不要盲目改代码 |

### V66-V152 踩坑经验总结

#### SSE与数据传输

| 教训 | 说明 |
|------|------|
| SSE传通知不传数据 | SSE适合事件通知，大数据走HTTP拉取 |
| 非流式优于流式 | 除非需要实时展示，否则非流式更稳定、token上限更大 |
| flush依赖中间件 | res.flush()是compression中间件注入的，不一定存在 |

#### 数据库

| 教训 | 说明 |
|------|------|
| TEXT不够用 | 中文场景下TEXT(64KB)经常不够，直接用MEDIUMTEXT |
| Drizzle用camelCase | 代码中一律用camelCase，SQL中是snake_case |
| 软删除+UNIQUE | 需要先查后决定INSERT/UPDATE |

#### AI输出

| 教训 | 说明 |
|------|------|
| 后处理兜底 | 不能只靠prompt约束AI，必须有stripAIMetaCommentary |
| 截断检测 | 检查stop_reason而非内容长度 |

#### 渲染与字体

| 教训 | 说明 |
|------|------|
| 换引擎比打补丁好 | 气泡图中文问题修了10+个版本，换resvg一次解决 |
| 沙箱注意文件系统 | 沙箱环境无法访问系统字体目录，用本地fonts/ |

#### 版本管理

| 教训 | 说明 |
|------|------|
| reflog是救命稻草 | git log被rebase覆盖，reflog仍完整 |
| Zod同步更新 | 新增字段必须更新所有相关Zod schema |
| ESM/CJS别混用 | require()在ESM中会直接崩溃 |

---

## 问题统计

| 类别 | 数量 |
|------|------|
| 当前待处理 | 4（#001, #002, #007, #008, #009） |
| 暂不处理 | 1（#005） |
| 已解决归档 | 83（#H001-#H083） |

---

## 问题记录模板

新增问题时复制以下模板：

```
| #XXX | 问题描述 | PX | 🔴 待处理 | VXX | - | 备注 |
```

解决问题时移动到归档并填写解决方案：

```
| #HXXX | 问题描述 | PX | VXX | VXX | 解决方案 |
```

---

*文档创建时间：2026年1月7日*
*最后更新：2026年2月10日*
*当前版本：V152*
