# V65 批量处理 502 错误排查报告

## 排查日期
2026年1月27日

## 问题描述
测试「指定任务」功能时，点击"开始批量生成"按钮后返回 HTTP 502 错误。

---

## 排查结果汇总

| 排查项 | 结果 | 说明 |
|--------|------|------|
| 服务器启动 | ✅ 正常 | 端口 3000 正常监听 |
| pnpm build | ✅ 通过 | 无编译错误 |
| 路由注册 | ✅ 正确 | `/api/batch` 已注册 |
| curl 测试 | ✅ 正常 | 返回 401（需要登录），说明路由工作正常 |
| batchRoutes.ts 语法 | ⚠️ 有问题 | 第 245 行使用了未定义的变量 `start` 和 `end` |

---

## 详细排查过程

### 1. 服务器启动检查

服务器正常启动，端口 3000 正在监听：

```
tcp6  0  0  :::3000  :::*  LISTEN  92257/node
```

### 2. TypeScript 编译检查

`pnpm build` 编译通过，无错误：

```
✓ 1773 modules transformed.
✓ built in 4.46s
  dist/index.js  304.4kb
⚡ Done in 12ms
```

### 3. 路由注册检查

在 `server/_core/index.ts` 第 50 行，批量处理路由已正确注册：

```typescript
app.use("/api/batch", requireAuth, batchRoutes);
```

路由路径为 `/api/batch`，需要登录认证。

### 4. curl 测试结果

测试 `/api/batch/generate-stream` 端点：

```bash
curl -X POST http://localhost:3000/api/batch/generate-stream \
  -H "Content-Type: application/json" \
  -d '{"startNumber": 1, "endNumber": 2, "roadmap": "测试"}'
```

返回结果：
```json
HTTP/1.1 401 Unauthorized
{"error":"Unauthorized","message":"请先登录后再使用此功能","code":"UNAUTHORIZED"}
```

**结论**：API 路由工作正常，返回 401 是因为 curl 没有携带登录凭证。这说明服务器端路由注册没有问题。

### 5. batchRoutes.ts 代码检查

**发现问题**：在 `server/batch/batchRoutes.ts` 第 245 行：

```typescript
console.log(`[BatchRoutes] 任务范围: ${start} - ${end} (共 ${totalTasks} 个)`);
```

这里使用了 `start` 和 `end` 变量，但这两个变量**只在连续范围模式下定义**（第 226-227 行）。

当使用「指定任务」模式时，代码走的是第 208-214 行的分支，不会定义 `start` 和 `end` 变量，导致运行时抛出 `ReferenceError: start is not defined`。

**相关代码片段**：

```typescript
// 第 206-238 行
if (inputTaskNumbers && Array.isArray(inputTaskNumbers) && inputTaskNumbers.length > 0) {
  // 指定任务模式：直接使用前端传来的数组
  taskNumbers = inputTaskNumbers.filter((n: unknown) => typeof n === 'number' && n > 0);
  // 注意：这里没有定义 start 和 end
} else {
  // 连续范围模式
  const start = Number(startNumber);  // 只在这个分支定义
  const end = Number(endNumber);      // 只在这个分支定义
  // ...
}

// 第 245 行（在 if 块外部）
console.log(`[BatchRoutes] 任务范围: ${start} - ${end} (共 ${totalTasks} 个)`);
// ❌ 如果走指定任务模式，start 和 end 未定义！
```

---

## 问题原因

**Step 2 的改动引入了变量作用域问题**：

1. 原代码只支持连续范围模式，`start` 和 `end` 在函数作用域内定义
2. Step 2 新增了指定任务模式，将 `start` 和 `end` 的定义移到了 `else` 分支内
3. 但第 245 行的日志输出仍然引用了 `start` 和 `end`
4. 当使用指定任务模式时，这两个变量未定义，导致运行时错误

---

## 为什么 TypeScript 没有报错？

TypeScript 编译通过是因为：
1. `start` 和 `end` 在 `else` 分支中用 `const` 声明
2. 第 245 行的代码在 `if-else` 块之后
3. TypeScript 的控制流分析可能没有检测到这个问题（因为两个分支都可能执行到第 245 行）

但运行时，如果走了 `if` 分支（指定任务模式），`start` 和 `end` 就是未定义的。

---

## 修复建议

将 `start` 和 `end` 的定义提升到 `if-else` 块之前，或者修改日志输出逻辑：

**方案 A**：修改日志输出，使用 `taskNumbers` 数组的首尾元素

```typescript
const firstTask = taskNumbers[0];
const lastTask = taskNumbers[taskNumbers.length - 1];
console.log(`[BatchRoutes] 任务范围: ${firstTask} - ${lastTask} (共 ${totalTasks} 个)`);
```

**方案 B**：在两个分支中都定义 `start` 和 `end`

```typescript
let start: number;
let end: number;

if (inputTaskNumbers && ...) {
  taskNumbers = ...;
  start = taskNumbers[0];
  end = taskNumbers[taskNumbers.length - 1];
} else {
  start = Number(startNumber);
  end = Number(endNumber);
  // ...
}
```

---

## 其他发现

在控制台日志中还发现了一个错误：

```
[2026-01-27T11:49:54.665Z] ReferenceError: start is not defined
```

这与我们的分析一致，确认了问题原因。

---

## 总结

| 问题 | 原因 | 修复难度 |
|------|------|----------|
| 502 错误 | `start` 和 `end` 变量在指定任务模式下未定义 | 简单 |

**建议**：采用方案 A，修改第 245 行的日志输出，使用 `taskNumbers` 数组的首尾元素代替 `start` 和 `end`。
