# 迭代记录 V52-V65

**整理日期**: 2026-01-27  
**整理人**: Manus

---

## V52 - AI代码生成Word系统（2026-01-17 ~ 01-18）

**核心功能**：让 AI 生成 docx-js 代码，在沙箱中执行生成 Word 文档，实现真正的自由排版。

**主要变更**：
- Step 1.1: 创建代码沙箱执行模块（`server/core/codeSandbox.ts`），使用 vm2 实现安全执行环境
- Step 1.2: 限制沙箱权限，实现模块白名单机制（只允许 docx, fs, path）
- Step 2.1: 捕获语法和运行时错误，解析错误位置和代码片段
- Step 2.2: 格式化错误信息为 AI 可读格式，提供修复建议
- Step 3.1: 实现重试控制器框架（`executeWithRetry`）
- Step 3.2: 对接 AI 实现代码修正（`aiCodeFixer.ts`）
- Step 4.1-4.2: 验证 docx 文件存在性、大小和结构完整性
- Step 5.1-5.3: 后端整合完整流程，前端新增「自由排版（AI代码）」模板选项

**关键文件**：
- `server/core/codeSandbox.ts` - 代码沙箱执行
- `server/core/codeRetry.ts` - 重试控制器
- `server/core/aiCodeFixer.ts` - AI 代码修正
- `server/core/docxValidator.ts` - docx 验证
- `server/core/errorFormatter.ts` - 错误格式化

**测试覆盖**：121 个测试全部通过

---

## V53 - 版本号显示功能（2026-01-18）

**变更**：
- 在页面右上角添加版本号显示
- 调整版本号位置和样式

---

## V56 - 文档文字提取功能（2026-01-19）

**核心功能**：支持从上传的文档中提取纯文本，发送给 AI 处理。

**主要变更**：
- 支持 PDF 和 DOCX 文件的文本提取
- 提取的文本作为上下文发送给 AI

---

## V58 - 发布错误修复（2026-01-19）

**变更**：修复发布过程中的错误

---

## V60 - AI代码生成系统修复（2026-01-20 ~ 01-21）

**核心功能**：修复 V52 AI代码生成系统在实际运行中的各种问题。

**主要变更**：
- 沙箱改用 NodeVM 解决 require 不可用问题
- AI 提示词改为全局变量注入
- 将 `require('docx')` 改为 ESM import 方式
- V60.1: AI代码模式文件命名优化
  - 前端禁用文件命名区域
  - 路书添加文件命名要求
  - 后端使用 AI 实际生成的文件名

**踩坑经验**：
- vm2 沙箱中 require 不可用，需要改用 NodeVM
- ESM 模块和 CommonJS 混用会导致问题

---

## V61 - 步骤状态修复（2026-01-21）

**变更**：
- 修复步骤失败时状态未更新的问题（闭包陷阱）
- V61b: 让成功的步骤也显示"重做"按钮

**踩坑经验**：
- React 中使用 useRef 或 useCallback 避免闭包陷阱

---

## V62 - 步骤跳过功能（2026-01-21）

**变更**：
- 为步骤 2-5 添加"跳过"功能
- 用户可以跳过不需要的步骤继续执行

---

## V63 - 多项优化与修复（2026-01-22 ~ 01-24）

**核心功能**：多项功能优化和安全修复。

**主要变更**：
- V63: 修复 .md/.txt 文件文本提取功能
- V63b: 版本号自动化（显示 commit hash）
- V63.1: 修复 .md 文件 mimetype 识别问题
- V63.2: 清理调试日志
- V63.3: 移除硬编码 API Key（安全修复）
- V63.4: 添加 API 登录保护（所有业务 API 改为 protectedProcedure）
- V63.5: ai_code 模式恢复三种文件命名方式
- V63.6: 修改文件上传数量限制为 100 个
- V63.7: 一对一模式后 4 个文档并行生成
- V63.8: 并行生成进度显示优化
- V63.9: 小班课后 4 文档并行执行
- V63.10: 小班课气泡图多学生并行生成
- V63.11: 小班课并行进度显示优化
- V63.12: 修复小班课单步重试 bug
- V63.13: 添加小班课失败跳过功能

**关键改动**：
- 安全：移除硬编码 API Key，添加登录保护
- 性能：后 4 个文档从串行改为并行生成
- 体验：并行进度显示优化

---

## V64 - 单任务重做 + SSE稳定性优化（2026-01-25 ~ 01-26）

**核心功能**：批量处理完成后支持重做单个失败任务，优化 SSE 连接稳定性。

**主要变更**：
- V64.1: 后端新增 `POST /api/batch/retry-task` 端点
- V64.2: 前端添加重做按钮和参数快照保存
- V64.3: 实现重做功能的完整 SSE 调用逻辑
- V64（心跳）: 添加 SSE 心跳机制防止连接断开（每 15 秒）
- V64.2（状态查询）: 添加批次状态查询接口 `GET /api/batch/status/:batchId`
- V64.3（降级）: 前端添加超时检测和状态恢复降级机制

**关键改动**：
- `server/batch/batchRoutes.ts` - 新增 retry-task 和 status 端点
- `client/src/components/BatchProcess.tsx` - 重做按钮、心跳处理、降级查询

**踩坑经验**：
- SSE 连接在长时间无事件时会被代理/网关断开，需要心跳保活
- 连接断开后应先查询状态，避免误报错误

---

## V65 - 批量处理指定任务功能（2026-01-27）

**核心功能**：批量处理支持「指定任务」模式，允许用户只重跑特定编号的任务。

**主要变更**：
- Step 1: 前端新增模式切换（连续范围 / 指定任务）和输入框
- Step 2: 后端支持 `taskNumbers` 数组参数，兼容两种模式
- Step 3: 测试验收，修复变量作用域问题

**关键改动**：
- `client/src/components/BatchProcess.tsx` - 新增 taskMode/specificTasks 状态
- `server/batch/batchRoutes.ts` - 支持 taskNumbers 参数

**踩坑经验**：
- 将变量定义移到条件分支内时，要检查外部是否还有引用
- 修复了 `start` 和 `end` 变量作用域问题（第 245 行和第 289-290 行）

---

## 版本号速查表

| 版本 | 功能 | 日期 |
|------|------|------|
| V52 | AI代码生成Word系统 | 01-17~18 |
| V53 | 版本号显示 | 01-18 |
| V56 | 文档文字提取 | 01-19 |
| V58 | 发布错误修复 | 01-19 |
| V60 | AI代码系统修复 | 01-20~21 |
| V61 | 步骤状态修复 | 01-21 |
| V62 | 步骤跳过功能 | 01-21 |
| V63 | 多项优化（安全/并行/小班课） | 01-22~24 |
| V64 | 单任务重做 + SSE稳定性 | 01-25~26 |
| V65 | 批量处理指定任务 | 01-27 |

---

## 说明

- V54、V55、V57、V59 在 Git 历史中未找到明确记录，可能是中间状态或被合并
- 部分版本有多个子版本（如 V63.1-V63.13），表示该版本有多次迭代
- 日期为大致时间，根据 Git 提交顺序推断
