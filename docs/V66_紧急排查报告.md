# V66 紧急排查报告

## 问题现象
2 个任务，DMXapi 日志显示 4 次 AI 调用（每任务 2 次），说明还在用旧的「两次调用」逻辑。

## 排查结果

### 1. ai_code 分支位置
```bash
$ grep -n "ai_code" server/batch/batchRoutes.ts
718:    } else if (templateType === 'ai_code') {   # ← 主流程（已改为单次调用）
1299:    } else if (templateType === 'ai_code') {  # ← 重做流程（还在用旧逻辑！）
```

### 2. buildCodePrompt 函数
```bash
$ grep -n "buildCodePrompt" server/batch/batchRoutes.ts
376:  const buildCodePrompt = (                    # ← 函数定义存在
734:      const codePrompt = buildCodePrompt(...   # ← 主流程在使用
```
✅ **buildCodePrompt 函数存在，主流程在使用**

### 3. processAICodeGeneration 调用
```bash
$ grep -n "processAICodeGeneration" server/batch/batchRoutes.ts
17:import { processAICodeGeneration } from "../core/aiCodeProcessor";
1311:      const aiCodeResult = await processAICodeGeneration(  # ← 重做流程还在用！
```
❌ **processAICodeGeneration 还在被调用（在重做流程中）**

## 问题定位

**有两个 ai_code 分支**：

| 位置 | 用途 | 状态 |
|------|------|------|
| 第 718 行 | 主流程（批量处理） | ✅ 已改为单次调用 |
| 第 1299 行 | 重做流程（单任务重做） | ❌ 还在用旧的两次调用 |

**根本原因**：Step 2 只修改了主流程的 ai_code 分支，没有修改重做流程的 ai_code 分支。

## 代码对比

### 主流程（第 718-839 行）- ✅ 已修改
```typescript
} else if (templateType === 'ai_code') {
  // V66 Step2: AI代码生成模式（简化版：单次AI调用，不重试）
  const codePrompt = buildCodePrompt(...);
  const codeResult = await invokeAIStream(...);  // 单次调用
  const executeResult = await executeInSandbox(cleanedCode, { outputDir });
  // ...
}
```

### 重做流程（第 1299-1360 行）- ❌ 未修改
```typescript
} else if (templateType === 'ai_code') {
  // AI代码模式（旧逻辑）
  const aiCodeResult = await processAICodeGeneration(  // 两次调用！
    aiCodePrompt,
    { ... },
    (message) => { ... }
  );
  // ...
}
```

## 修复建议

将第 1299 行的重做流程也改为单次调用逻辑，与主流程保持一致。

---
排查时间：2026-01-27
