# 学情反馈系统 技术说明书

> 版本：V179 | 更新日期：2026-02-16

---

## 一、项目简介

### 1.1 项目定位

**学情反馈系统（feedback-mvp）** 是一款面向教育培训场景的教学辅助自动化工具。系统的核心目标是：帮助教师在课后快速生成专业的学情反馈文档，取代传统的手工整理工作。

教师只需输入课堂笔记和录音转文字，系统即可通过 AI 自动生成学情反馈、复习文档、测试本、课后信息提取和气泡图共 5 种文档，并一键上传到 Google Drive。

### 1.2 目标用户

| 角色 | 使用场景 |
|------|---------|
| 教师 | 课后输入课堂信息，获得学情反馈、复习文档、测试本 |
| 助教 | 获得课后信息提取文档，用于作业管理和家长沟通 |
| 内容制作者 | 批量生成教学材料（词汇表、练习册等） |

### 1.3 核心功能概览

系统包含 **5 个主要功能模块**，在前端以 Tab 页形式呈现：

| Tab | 功能 | 简述 |
|-----|------|------|
| 课堂反馈 | 学情反馈生成 | 一对一/小班课 → AI 生成 5 种文档 → 上传 Google Drive |
| 作业管理 | 学生作业跟踪 | 语音输入 → AI 结构化 → 学生状态迭代更新 |
| 作业批改 | AI 辅助批改 | 上传文本/图片 → AI 批改 → 自动推送状态更新 |
| 一键打分 | 周打分汇总 | 配置日期范围 → AI 生成打分结论 → 同步到各学生状态 |
| 任务记录 | 历史任务浏览 | 查看、下载、导入历史生成记录 |

此外还有**批量处理**（批量生成教学材料）和**催作业**（一键生成催学文本）等辅助功能。

---

## 二、技术栈

### 2.1 总体架构

```
┌─────────────────────────────────────────────────┐
│                   前端 (SPA)                      │
│         React 19 + TypeScript + Vite              │
│         TailwindCSS + shadcn/ui                   │
│         Wouter (路由) + React Query (缓存)         │
└───────────────┬─────────────────────┬─────────────┘
                │  tRPC (JSON-RPC)    │  SSE (流式)
                ▼                     ▼
┌─────────────────────────────────────────────────┐
│                   后端 (Node.js)                   │
│         Express + tRPC v11                        │
│         esbuild (ESM 构建)                        │
├────────┬────────┬────────┬────────┬───────────────┤
│ 反馈   │ 作业   │ 批改   │ 打分  │ 批量处理      │
│ 生成   │ 管理   │ 系统   │ 系统  │ 系统          │
├────────┴────────┴────────┴────────┴───────────────┤
│              通用基础设施                           │
│  AI 客户端 | Google Drive | 后台任务 | 认证        │
└───────────────┬─────────────────────┬─────────────┘
                │                     │
                ▼                     ▼
┌──────────────────────┐  ┌──────────────────────┐
│   MySQL + Drizzle    │  │   Google Drive API    │
│   (数据持久化)        │  │   (文件存储)           │
└──────────────────────┘  └──────────────────────┘
```

### 2.2 技术选型

| 层 | 技术 | 说明 |
|----|------|------|
| 前端框架 | React 19 + TypeScript | 函数式组件 + Hooks |
| 构建工具 | Vite | 开发热更新 + 生产构建 |
| UI 组件库 | shadcn/ui + Radix UI | 可定制的无头 UI 组件 |
| 样式方案 | TailwindCSS | 原子化 CSS |
| 路由 | Wouter | 轻量级客户端路由（无 SSR） |
| 数据请求 | tRPC + React Query | 端到端类型安全 + 自动缓存 |
| 后端框架 | Express + tRPC v11 | tRPC 提供类型安全的 API 层 |
| 数据库 | MySQL + Drizzle ORM | 类型安全的 SQL 查询构建器 |
| 文件存储 | Google Drive OAuth API | 自定义封装，非 rclone |
| AI 调用 | 自定义封装（whatai.ts） | 支持多供应商切换 |
| SVG 渲染 | @resvg/resvg-js | SVG → PNG，用于气泡图 |
| 后端构建 | esbuild (ESM) | 所有依赖标记 external |
| 序列化 | superjson | tRPC 数据传输序列化 |

### 2.3 为什么选这些技术

- **tRPC**：前后端共享 TypeScript 类型，消除 API 类型不一致的问题
- **Drizzle ORM**：比 Prisma 更轻量，SQL-like 的查询 API 便于复杂查询
- **esbuild (ESM)**：服务端必须用 ESM 格式（`@resvg/resvg-js` 不支持 CJS），esbuild 构建速度快且 bundle 体积小
- **resvg**：替代 sharp/librsvg，在 ESM 环境下兼容性更好，且支持中文字体注入
- **Google Drive OAuth API**：部署环境（Manus 沙箱）无法安装 rclone，只能用 API 直连

---

## 三、目录结构

```
feedback-mvp/
│
├── client/                        # 前端代码
│   └── src/
│       ├── App.tsx                # 应用入口，路由定义
│       ├── main.tsx               # React 挂载点
│       ├── version.generated.ts   # 构建时自动生成的版本信息
│       ├── pages/
│       │   └── Home.tsx           # 主页面（5 个 Tab）
│       ├── components/
│       │   ├── HomeworkManagement.tsx  # 作业管理前端
│       │   ├── HomeworkCorrection.tsx  # 作业批改前端
│       │   ├── GlobalSettings.tsx     # 全局设置（API/模型/路书/供应商）
│       │   ├── BatchProcess.tsx       # 批量任务前端
│       │   ├── TaskHistory.tsx        # 任务记录
│       │   └── ui/                    # shadcn/ui 组件库
│       └── _core/
│           └── hooks/useAuth.ts   # 认证 Hook
│
├── server/                        # 后端代码
│   ├── routers.ts                 # tRPC 路由定义（核心 API）
│   ├── feedbackGenerator.ts       # 反馈生成引擎（5 步流程）
│   ├── homeworkManager.ts         # 作业管理后端
│   ├── correctionRunner.ts        # 作业批改引擎
│   ├── gradingRunner.ts           # 一键打分引擎
│   ├── reminderRunner.ts          # 催作业引擎
│   ├── backgroundTaskRunner.ts    # 后台任务调度器
│   ├── classStreamRoutes.ts       # SSE 流式端点
│   ├── gdrive.ts                  # Google Drive API 封装
│   ├── whatai.ts                  # AI 客户端（多供应商）
│   ├── contentStore.ts            # SSE 中间结果存储
│   ├── db.ts                      # 数据库连接与用户管理
│   ├── logger.ts                  # 生成日志系统
│   ├── errorHandler.ts            # 错误处理与中文翻译
│   ├── utils.ts                   # 工具函数
│   ├── batch/
│   │   ├── batchTaskRunner.ts     # 批量任务执行器
│   │   └── batchRoutes.ts         # 批量处理 SSE 端点
│   ├── core/
│   │   ├── aiClient.ts            # 配置读取（getConfigValue）
│   │   ├── trpc.ts                # tRPC 初始化与中间件
│   │   ├── context.ts             # tRPC 上下文创建
│   │   ├── index.ts               # 服务启动入口
│   │   ├── authMiddleware.ts      # 非 tRPC 端点的认证中间件
│   │   ├── oauth.ts               # OAuth 流程
│   │   ├── sdk.ts                 # 认证 SDK（token 生成/验证）
│   │   └── voiceTranscription.ts  # 语音转文字 API
│   └── templates/                 # Prompt 模板
│
├── drizzle/
│   ├── schema.ts                  # 数据库表结构定义
│   ├── 0000-0013_*.sql            # 数据库迁移文件（只增不删）
│   └── meta/                      # Drizzle 元数据
│
├── shared/                        # 前后端共享代码
│   ├── const.ts                   # 常量定义
│   ├── types.ts                   # 共享类型
│   └── templateTypes.ts           # 模板类型定义
│
├── docs/                          # 项目文档
├── fonts/                         # 中文字体（wqy-zenhei.ttc 等）
├── scripts/
│   └── generate-version.cjs       # 版本号生成脚本
├── CLAUDE.md                      # Claude 开发指南
├── COLLAB.md                      # Claude ↔ Manus 协作看板
├── package.json
├── vite.config.ts
└── tsconfig.json
```

---

## 四、数据库设计

### 4.1 ER 概览

系统使用 MySQL 数据库，通过 Drizzle ORM 进行类型安全的查询。共 **13 张表**：

```
users (用户)
  ├── user_config (用户级配置，1:N)
  ├── google_tokens (Google Drive 凭证，1:1)
  ├── background_tasks (后台反馈任务，1:N)
  ├── batch_tasks (批量任务，1:N)
  │   └── batch_task_items (批量子项，1:N)
  ├── hw_students (学生名册，1:N)
  ├── hw_entries (作业条目队列，1:N)
  ├── correction_tasks (批改任务，1:N)
  ├── grading_tasks (打分任务，1:N)
  │   └── grading_sync_items (打分同步子项，1:N)
  └── reminder_tasks (催作业任务，1:N)

system_config (系统级配置，全局共享)
```

### 4.2 核心表说明

**users** — 用户表
- `openId`：OAuth 唯一标识
- `email`：业务唯一标识，用于用户合并
- `role`：user / admin
- `accountStatus`：active / suspended

**user_config** — 用户级配置
- 每用户独立的配置项（API Key、模型选择、路书等）
- `userId + key` 复合唯一索引
- 查询时**不 fallback 到 systemConfig**，保证租户隔离

**hw_students** — 学生名册
- `currentStatus`：学生当前正式状态文档（迭代更新，核心字段）
- `planType`：daily / weekly
- `userId + name` 复合唯一，同一用户下学生名不重复

**hw_entries** — 作业条目队列
- 状态流转：`pending → processing → pre_staged → confirmed`（或 `failed`）
- `parsedContent`：AI 处理后的结构化内容
- 入库（confirmed）后触发 `currentStatus` 更新

**background_tasks** — 后台反馈生成任务
- `inputParams`：JSON，存储所有生成参数
- `stepResults`：JSON，每步（反馈/复习/测试/提取/气泡图）的生成结果
- 支持断点续跑和故障恢复

### 4.3 多租户隔离策略

所有数据表均有 `userId` 列。查询时必须附带 `WHERE user_id = ?` 条件。

```
规则：
1. getConfigValue(key, userId) 有 userId 时仅查 user_config，不 fallback 到 systemConfig
2. systemConfig 仅存储系统级配置（如 allowedEmails 邮箱白名单）
3. Google Drive OAuth 凭证按用户独立存储
4. 前端 localStorage 的 key 包含 userId，避免切换账户时读到旧数据
5. ContentStore（SSE 中间结果）带 userId 归属校验
```

---

## 五、核心模块详解

### 5.1 学情反馈生成（feedbackGenerator.ts）

这是系统的核心功能。一次生成流程包含 5 个步骤，每步调用 AI 并生成不同类型的文档：

```
步骤 1：学情反馈（.md）
  └── AI 分析课堂笔记 + 录音转文字 → 生成纯文本反馈
       （不含 Markdown 标记，可直接粘贴到微信群）

步骤 2：复习文档（.docx）
  └── AI 提取核心知识点 → 生成 Word 文档
       使用 docx 库构建文档结构

步骤 3：测试本（.docx）
  └── AI 生成练习题 + 答案 → 生成 Word 文档
       答案与题目之间用分页符分隔

步骤 4：课后信息提取（.md）
  └── AI 提取作业任务、难点、下节课预告
       可一键导入到作业管理系统

步骤 5：气泡图（.png）
  └── AI 生成知识点分布 SVG → resvg 渲染为 PNG
       注入中文字体（Noto Sans CJK / WenQuanYi Zen Hei）
```

**支持两种课程类型：**

| 类型 | 区别 |
|------|------|
| 一对一（one-to-one） | 单个学生，5 份文档 |
| 小班课（class） | 多个学生，学情反馈包含所有学生，气泡图每人一张 |

**数据流：**

```
用户输入（笔记 + 录音）
  → 创建 background_task（status=pending）
  → 后台依次执行 5 步
  → 每步结果存入 stepResults（JSON）
  → 每份文档上传到 Google Drive
  → 返回文件链接
```

### 5.2 作业管理系统（homeworkManager.ts）

管理学生作业状态的迭代更新系统。核心概念是**学生状态文档**（`currentStatus`）：

```
语音/文本输入
  → 创建 hw_entry（status=pending）
  → AI 处理：读取学生当前 currentStatus + 新输入 → 生成更新后的状态
  → 进入预入库队列（pre_staged）
  → 教师确认入库（confirmed）
  → 更新 hw_students.currentStatus
  → 删除已入库条目（只保留最新状态）
```

**关键设计：**
- 迭代更新：AI 在学生现有状态上增量更新，而非每次从零开始
- 提示词系统：教师可配置自定义提示词，替代默认的 AI 指令
- 跨模块打通：课堂反馈的步骤 4（课后信息提取）可一键导入作业管理

### 5.3 作业批改系统（correctionRunner.ts）

```
教师上传作业（文本 + 图片）
  → 创建 correction_task
  → AI 批改：
     ① 读取学生 currentStatus（上下文）
     ② 生成批改结果（给学生）+ 状态更新建议（给作业管理）
  → 自动推送到作业管理（创建 hw_entry → AI 处理 → pre_staged）
  → 3 天自动清理过期记录
```

**图片处理：** 图片以 base64 编码提交，存储时转为外部存储引用（storagePut），避免数据库字段过大。

### 5.4 一键打分系统（gradingRunner.ts）

```
教师配置日期范围 + 打分提示词
  → 阶段一：AI 生成整周打分结论（入库到 grading_tasks.result）
  → 教师可编辑打分结论
  → 阶段二：同步到各学生
     ├── 为每个学生创建 grading_sync_item
     ├── 并发执行（可配置 20-100 并发）
     ├── AI 将打分结论融入各学生的 currentStatus
     └── 更新 hw_students.currentStatus
  → 180 天自动清理
```

### 5.5 后台任务系统（backgroundTaskRunner.ts）

所有耗时操作都通过后台任务异步执行，保证前端不阻塞：

```
特性：
├── 离线安全：任务入库后即使服务重启也不丢失
├── 故障恢复：服务启动时自动检测并恢复中断的任务
├── 自动清理：超过 7 天的过期任务自动删除
└── 进度可查：前端通过轮询查看实时进度
```

### 5.6 SSE 流式生成（classStreamRoutes.ts）

对于需要实时反馈的场景（如实时显示 AI 生成进度），系统使用 Server-Sent Events：

```
前端 POST /api/class-feedback-stream
  → 后端设置 SSE 响应头（Content-Type: text/event-stream）
  → 调用 invokeWithContinuation()（流式 AI 调用）
  → 每收到一个 chunk，发送 data: 事件
  → 前端累积显示"已生成 N 字符"
  → 客户端断开 → AbortController.abort() → 中止 AI 流
```

### 5.7 Google Drive 集成（gdrive.ts）

```
OAuth 流程：
  用户授权 → 获取 access_token + refresh_token → 存入 google_tokens 表

核心操作：
  ├── navigateToFolder(path)  — 递归创建/查找文件夹
  ├── uploadToGoogleDrive()   — 上传文本/Word 文件
  ├── uploadBinaryToGoogleDrive() — 上传 PNG 等二进制文件
  ├── downloadFileById()      — 下载文件
  └── searchFileInGoogleDrive() — 按名称搜索文件

防护措施：
  ├── 并发去重：pendingFolderOps Map 防止同时创建多个同名文件夹
  ├── 超时保护：普通操作 60s，上传操作 120s
  └── 自动刷新：token 过期时自动 refresh
```

### 5.8 AI 客户端（whatai.ts）

系统通过自定义封装的 AI 客户端与大模型交互：

```
支持的调用方式：
  ├── invokeWhatAI()         — 非流式调用，等待完整响应
  ├── invokeWhatAIStream()   — 流式调用，逐 chunk 返回
  └── invokeWithContinuation() — 流式 + 回调（用于 SSE 端点）

配置项（per-user）：
  ├── apiModel   — 模型名称
  ├── apiKey     — API 密钥
  ├── apiUrl     — API 地址
  └── 供应商预设  — 一键切换密钥和地址
```

---

## 六、认证与权限

### 6.1 认证流程

```
用户访问 → OAuth 登录
  → callback 回调 → sdk.createSessionToken(openId)
  → 写入 HTTP-only Cookie
  → 后续请求自动携带 Cookie
  → tRPC Context 从 Cookie 提取用户信息
```

### 6.2 权限等级

| 中间件 | 说明 | 使用场景 |
|--------|------|---------|
| publicProcedure | 无需认证 | 健康检查等公开接口 |
| protectedProcedure | 需认证 + 账户未暂停 | 绝大多数业务接口 |
| adminProcedure | 需 admin 角色 | 用户管理、邮箱白名单等 |

### 6.3 管理员伪装模式

管理员可以"伪装"为任意用户，查看该用户的数据视图：

```
admin.impersonateUser(targetUserId)
  → 原 session 保存到 ADMIN_COOKIE
  → 切换到目标用户的 session
  → 操作均以目标用户身份执行

admin.stopImpersonating()
  → 恢复原 session
```

### 6.4 邮箱白名单

- 系统级配置 `allowedEmails` 存储在 `systemConfig` 表
- 未配置时为开放模式（任何人可注册）
- 配置后，不在白名单中的邮箱无法登录（admin 角色始终放行）

### 6.5 用户合并

当 OAuth 登录的用户邮箱与已有的预创建用户（`manual_` 前缀的 openId）匹配时，系统自动合并：

```
新 OAuth 用户（email=a@b.com）
  → 检查 users 表是否有同邮箱的 manual_ 记录
  → 若有：更新 openId，保留原有 admin 角色
  → 防止同一个人出现两条记录
```

---

## 七、前端架构

### 7.1 页面结构

单页应用（SPA），主页面 `Home.tsx` 包含 5 个 Tab 切换：

```
Home.tsx
  ├── Tab 1: 课堂反馈     — 一对一/小班课模式切换 + 参数输入 + 生成进度
  ├── Tab 2: 作业管理     — HomeworkManagement.tsx（学生名册 + 条目队列 + 状态）
  ├── Tab 3: 作业批改     — HomeworkCorrection.tsx（选学生 + 上传 + 批改结果）
  ├── Tab 4: 一键打分     — 日期范围 + 打分提示词 + 同步进度
  └── Tab 5: 任务记录     — TaskHistory.tsx（历史任务列表 + 展开详情）

  右上角: 设置          — GlobalSettings.tsx（API/模型/路书/供应商管理）
```

### 7.2 数据请求

前端通过 tRPC + React Query 与后端通信：

```typescript
// 类型安全的 API 调用示例
const { data } = trpc.homework.listStudents.useQuery();
const mutation = trpc.homework.submitEntry.useMutation();
```

- 自动类型推断：无需手写 API 类型定义
- 自动缓存：React Query 管理请求缓存和失效
- 乐观更新：部分操作支持乐观 UI 更新

### 7.3 SSE 流式接收

对于反馈生成等耗时操作，前端使用 EventSource 接收实时进度：

```typescript
const es = new EventSource('/api/class-feedback-stream?...');
es.onmessage = (event) => {
  // 更新进度："已生成 1234 字符"
  setChars(parseInt(event.data));
};
```

---

## 八、构建与部署

### 8.1 构建流程

```bash
npm run build
# 等价于：
# 1. node scripts/generate-version.cjs   → 生成 version.generated.ts
# 2. vite build                           → 构建前端 SPA → dist/public/
# 3. esbuild server/_core/index.ts        → 构建后端 → dist/index.js
#    --platform=node --packages=external --bundle --format=esm
```

**构建产物：**
- `dist/public/` — 前端静态文件（HTML + JS + CSS）
- `dist/index.js` — 后端 Node.js 入口（ESM 格式）

### 8.2 运行

```bash
# 开发模式（热更新）
npm run dev

# 生产模式
npm run build && npm start
# 等价于 NODE_ENV=production node dist/index.js
```

### 8.3 环境变量

| 变量 | 说明 |
|------|------|
| DATABASE_URL | MySQL 连接字符串 |
| OWNER_OPEN_ID | 系统 owner 的 OAuth ID |
| GOOGLE_CLIENT_ID | Google OAuth 客户端 ID |
| GOOGLE_CLIENT_SECRET | Google OAuth 客户端密钥 |
| SESSION_SECRET | JWT 签名密钥 |

详细配置参见 `docs/环境变量配置模板.md`。

### 8.4 部署架构

系统部署在 Manus 平台（Ubuntu 22.04 沙箱环境）：

```
Manus 沙箱
  ├── Node.js 服务 (dist/index.js)
  │   ├── Express 监听端口
  │   ├── 提供前端静态文件 (dist/public/)
  │   └── 提供 tRPC + SSE API
  ├── MySQL 数据库
  └── fonts/ 目录（中文字体）

外部依赖：
  ├── Google Drive API（文件存储）
  ├── AI 供应商 API（大模型调用）
  └── GitHub 仓库（代码管理）
```

**沙箱限制：**
- 无法访问系统字体路径（`/usr/share/fonts`），需将字体文件放在项目 `fonts/` 目录
- 无法安装 rclone，所有 Google Drive 操作通过 OAuth API 实现

---

## 九、数据流示例

### 9.1 一对一课堂反馈生成（完整流程）

```
1. 教师填写参数：学生姓名、课次、日期、笔记、录音转文字
2. 前端提交 → tRPC mutation → 创建 background_task（status=pending）
3. 后台任务调度器检测到 pending 任务 → 开始执行
4. 步骤 1：调用 AI 生成学情反馈
   → AI 输入：系统提示词 + 路书 + 笔记 + 录音 + 上次反馈
   → AI 输出：纯文本反馈
   → 上传到 Google Drive（{姓名}{课次}学情反馈.md）
5. 步骤 2：调用 AI 生成复习文档
   → 基于步骤 1 的反馈内容生成知识点整理
   → 用 docx 库生成 Word 文件 → 上传
6. 步骤 3：调用 AI 生成测试本
   → 基于反馈内容生成练习题 + 答案
   → Word 文件 → 上传
7. 步骤 4：调用 AI 生成课后信息提取
   → 提取作业任务、难点、预告
   → 上传
8. 步骤 5：生成气泡图
   → AI 输出知识点分布 SVG
   → resvg 注入中文字体 → 渲染为 PNG
   → 上传
9. background_task 标记为 completed，存储所有文件链接
10. 前端轮询到 completed → 显示结果和下载链接
```

### 9.2 作业管理迭代更新流程

```
1. 教师语音输入 "小明今天做了阅读理解，错了3题，主要是推断题"
2. 前端提交 → 创建 hw_entry（student=小明, status=pending）
3. 后台 AI 处理：
   → 读取小明的 currentStatus（已有状态文档）
   → 系统提示词：在现有状态基础上更新，不要从零开始
   → AI 输出：融合新旧信息的更新后状态
4. hw_entry 状态变为 pre_staged（预入库）
5. 教师在预入库队列中审查 → 确认入库
6. 更新 hw_students.currentStatus = AI 输出
7. 删除已入库的 hw_entry
```

---

## 十、版本管理

### 10.1 版本号机制

- 版本号在 `scripts/generate-version.cjs` 中手动维护（如 `const VERSION = 'V179'`）
- 每次推送前版本号 +1
- 构建时自动生成 `client/src/version.generated.ts`，包含版本号和 Git commit hash
- 前端页面右下角显示当前版本号

### 10.2 数据库迁移

- 迁移文件放在 `drizzle/` 目录，文件名格式 `0000_xxx.sql`
- **只允许新增，不允许删除已有迁移文件**
- 表结构变更使用 `CREATE TABLE IF NOT EXISTS` 和 `ALTER TABLE ... ADD COLUMN`，保证幂等性
- 部分 DDL 在服务启动时自动执行（`server/core/index.ts` 中的 autoCreateTables）

---

## 十一、错误处理

### 11.1 后端错误处理（errorHandler.ts）

```
AI 调用错误 → parseError() 解析
  → 识别错误类型（401/403/429/超时/余额不足等）
  → formatErrorMessage() 翻译为中文
  → 返回给前端显示
```

常见错误翻译：
| HTTP 状态 | 中文提示 |
|-----------|---------|
| 401 | API密钥无效或已过期 |
| 403 | API访问被拒绝 |
| 429 | 请求过于频繁，请稍后重试 |
| 超时 | AI响应超时，请稍后重试 |
| 余额不足 | API余额不足 |

### 11.2 前端错误边界

使用 React ErrorBoundary 捕获未处理的前端错误，显示中文错误提示和重新加载按钮。

---

## 十二、关键设计决策

### 12.1 为什么用后台任务而不是直接 SSE？

早期版本使用 SSE 流式生成全部 5 步，但存在问题：
- 客户端断开（如手机锁屏）会导致生成中断
- 5 步总耗时可能超过 2 分钟，连接不稳定

改为后台任务模式后：
- 任务入库即安全，不依赖客户端连接
- 服务重启后可自动恢复中断的任务
- 前端通过轮询查看进度，断开重连不影响生成

### 12.2 为什么作业管理用"迭代更新"而不是"追加记录"？

如果每次输入都创建新记录，教师需要自行汇总所有记录才能了解学生全貌。
迭代更新模式下，`currentStatus` 始终是最新的完整状态文档，AI 负责将新信息融入旧文档，教师打开即是完整视图。

### 12.3 为什么字体要放在项目目录？

部署环境（Manus 沙箱）中 Node.js 进程无法访问 `/usr/share/fonts`。将字体文件放在项目 `fonts/` 目录，resvg 直接从项目目录加载，绕过沙箱限制。

### 12.4 为什么用 esbuild 而不是 tsc？

服务端依赖 `@resvg/resvg-js` 等 native addon，它们只支持 ESM import。esbuild 可以将所有服务端代码打包为单个 ESM 文件（`dist/index.js`），同时将 node_modules 中的依赖标记为 external，避免打包 native addon。

---

## 十三、参考文档

| 文档 | 路径 | 内容 |
|------|------|------|
| 项目概述 | `docs/项目概述.md` | 功能详述与设计决策 |
| 迭代记录 | `docs/迭代记录.md` | V1 至 V179 完整变更记录 |
| 技术备忘 | `docs/技术备忘.md` | 39 章技术经验与踩坑实录 |
| 问题追踪 | `docs/问题追踪.md` | 90+ 个已解决/待解决问题 |
| 环境变量配置 | `docs/环境变量配置模板.md` | 部署所需的环境变量说明 |
| 租户隔离方案 | `docs/租户隔离改造清单.md` | 多租户隔离的设计与实现 |
| 协作看板 | `COLLAB.md` | Claude ↔ Manus 协作状态 |
| 开发指南 | `CLAUDE.md` | Claude 开发协议与规范 |
