# 环境变量配置模板

## 使用说明

1. 在项目根目录创建 `.env` 文件
2. 复制下方配置内容到 `.env` 文件
3. 填入实际的配置值
4. 确保 `.env` 不被提交到版本控制
5. 在 Manus 平台部署时，敏感信息应配置在 Manus Secrets 中而非 `.env` 文件

---

## 完整配置模板

### Manus Secrets 配置

在 Manus 平台的 Secrets 中添加以下密钥：

| 名称 | 用途 | 必须 |
|------|------|------|
| `GITHUB_TOKEN` | GitHub 版本控制 | 推荐 |
| `GOOGLE_CLIENT_ID` | Google OAuth 客户端ID | 必须 |
| `GOOGLE_CLIENT_SECRET` | Google OAuth 客户端密钥 | 必须 |

### .env 文件配置

```env
# ============================================
# feedback-mvp 环境变量配置
# ============================================

# ============================================
# 数据库配置（必须）
# ============================================
# MySQL/TiDB 连接字符串
# 格式：mysql://用户名:密码@主机:端口/数据库名
DATABASE_URL=mysql://root:password@localhost:3306/feedback_mvp

# ============================================
# 认证配置（必须）
# ============================================
# JWT 密钥，用于 Session cookie 签名
# 建议使用随机生成的长字符串，至少32位
JWT_SECRET=your-jwt-secret-key-at-least-32-characters

# ============================================
# Google OAuth 配置（V34新增，必须）
# 注意：在 Manus 平台部署时，这两个值应配置在 Secrets 中
# ============================================
GOOGLE_CLIENT_ID=your-google-client-id.apps.googleusercontent.com
GOOGLE_CLIENT_SECRET=GOCSPX-your-client-secret

# ============================================
# Manus OAuth 配置（Manus平台专用，非Manus部署可忽略）
# ============================================
VITE_APP_ID=your-manus-app-id
OAUTH_SERVER_URL=https://oauth.manus.im
VITE_OAUTH_PORTAL_URL=https://login.manus.im
OWNER_OPEN_ID=your-owner-open-id
OWNER_NAME=your-owner-name

# ============================================
# Manus 内置 API（Manus平台专用，非Manus部署可忽略）
# ============================================
BUILT_IN_FORGE_API_URL=https://forge.manus.im
BUILT_IN_FORGE_API_KEY=your-forge-api-key
VITE_FRONTEND_FORGE_API_KEY=your-frontend-forge-api-key
VITE_FRONTEND_FORGE_API_URL=https://forge.manus.im

# ============================================
# 应用配置（可选）
# ============================================
VITE_APP_TITLE=学情反馈系统
VITE_APP_LOGO=
VITE_ANALYTICS_ENDPOINT=
VITE_ANALYTICS_WEBSITE_ID=

# ============================================
# 运行环境
# ============================================
NODE_ENV=development
```

---

## 环境变量详细说明

### 必须配置

| 变量名 | 用途 | 示例值 |
|--------|------|--------|
| `DATABASE_URL` | MySQL/TiDB数据库连接字符串 | `mysql://root:password@localhost:3306/feedback_mvp` |
| `JWT_SECRET` | Session cookie签名密钥，至少32位 | `a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6` |
| `GOOGLE_CLIENT_ID` | Google OAuth 客户端ID | `xxxxx.apps.googleusercontent.com` |
| `GOOGLE_CLIENT_SECRET` | Google OAuth 客户端密钥 | `GOCSPX-xxxxx` |

### Manus平台专用（非Manus部署需替换）

| 变量名 | 用途 | 非Manus部署建议 |
|--------|------|-----------------|
| `VITE_APP_ID` | Manus OAuth应用ID | 自行实现认证或留空 |
| `OAUTH_SERVER_URL` | Manus OAuth后端地址 | 自行实现认证或留空 |
| `VITE_OAUTH_PORTAL_URL` | Manus登录门户地址 | 自行实现认证或留空 |
| `OWNER_OPEN_ID` | 项目所有者OpenID | 可留空 |
| `OWNER_NAME` | 项目所有者名称 | 可留空 |
| `BUILT_IN_FORGE_API_*` | Manus内置API | 不使用则留空 |

### 可选配置

| 变量名 | 用途 | 默认值 |
|--------|------|--------|
| `VITE_APP_TITLE` | 应用标题 | 学情反馈系统 |
| `VITE_APP_LOGO` | 应用Logo URL | 空 |
| `VITE_ANALYTICS_*` | 分析统计 | 空 |
| `NODE_ENV` | 运行环境 | development |

---

## GitHub 版本控制配置（V33新增）

V33版本将项目代码迁移到GitHub进行版本管理，需要配置Personal Access Token用于推送和拉取代码。

在 Manus 平台的 Secrets 中添加（不是 .env 文件）：

| 名称 | 用途 | 获取方式 |
|------|------|----------|
| `GITHUB_TOKEN` | GitHub Personal Access Token | GitHub Settings → Developer settings → Personal access tokens → Generate new token (classic) |

**获取步骤：**

1. 打开 https://github.com/settings/tokens
2. 点击 "Generate new token" → "Generate new token (classic)"
3. 填写：
   - Note: feedback-mvp
   - Expiration: 90 days（或根据需要设置）
   - 勾选 repo（完整仓库权限）
4. 点击 "Generate token"
5. 立即复制保存（只显示一次）
6. 在 Manus 平台的 Secrets 中添加 `GITHUB_TOKEN`

**安全提醒：**

- 不要在对话中明文发送 Token
- 不要将 Token 写入代码或 .env 文件
- 使用 Manus Secrets 功能安全存储

---

## Google OAuth 配置（V34新增）

V34版本新增了用户自助 Google Drive 授权功能，不再依赖服务器上的 rclone 配置。

在 Manus 平台的 Secrets 中添加：

| 名称 | 用途 | 获取方式 |
|------|------|----------|
| `GOOGLE_CLIENT_ID` | Google OAuth 客户端ID | Google Cloud Console 创建 OAuth 凭据 |
| `GOOGLE_CLIENT_SECRET` | Google OAuth 客户端密钥 | 同上，创建时显示，关闭后不可再查看 |

**获取步骤：**

1. 打开 https://console.cloud.google.com/
2. 创建项目或选择已有项目
3. 启用 Google Drive API
   - APIs & Services → Library → 搜索 "Google Drive API" → Enable
4. 配置 OAuth 同意屏幕（OAuth consent screen）
   - 类型：External
   - App name：托福阅读学情反馈系统
   - Scopes：添加 `https://www.googleapis.com/auth/drive.file`
   - Test users：添加你的 Google 邮箱
5. 创建 OAuth 凭据（Credentials → Create Credentials → OAuth client ID）
   - 应用类型：Web application
   - 名称：feedback-mvp-web
   - Authorized JavaScript origins：
     - `http://localhost:3000`
     - `https://你的域名.manus.space`
   - Authorized redirect URIs：
     - `http://localhost:3000/api/google/callback`
     - `https://你的域名.manus.space/api/google/callback`
6. 点击 Create，保存 Client ID 和 Client Secret
7. 在 Manus 平台的 Secrets 中添加这两个值

---

## Google Drive 上传方式说明

当前项目使用 Google OAuth API 读写 Google Drive（V34起改造，V108统一）。

- 用户在系统界面中自助完成 OAuth 授权
- 授权信息存储在数据库 `google_tokens` 表中
- 不再依赖 rclone

**历史变更：**

- V28及之前：使用 rclone 命令行工具上传（系统 → rclone 命令 → 配置文件 → Google Drive）
- V37及之后：使用 Google Drive REST API + OAuth Token 上传（系统 → Google Drive API → OAuth Token（数据库存储）→ Google Drive）

**变更原因：**

- rclone 需要服务器安装和配置，部署复杂
- OAuth 方式用户可在网站"高级设置"内自助授权
- Token 过期后用户自行在网站上重新授权，无需重新部署
- 不再依赖服务器上的配置文件

---

## 数据库配置项

以下配置项通过网站"高级设置"界面配置，不需要写入 `.env` 文件或 Manus Secrets。

> **V172+ 变更**：这些配置项已从 `system_config` 迁移到 `user_config` 表，按 userId 隔离。每个用户可独立设置自己的配置值。`system_config` 仅保留 `allowedEmails`（邮箱白名单）。

| key | 说明 | 新增版本 | 默认值 |
|-----|------|----------|--------|
| `google_access_token` | Google OAuth 访问令牌 | V34 | - |
| `google_refresh_token` | Google OAuth 刷新令牌 | V34 | - |
| `google_token_expiry` | Token 过期时间 | V34 | - |
| `driveBasePath` | Google Drive 存储根路径 | V38 | `Mac/Documents/XDF/学生档案` |
| `roadmapClass` | 小班课路书内容 | V43 | - |
| `firstLessonTemplate` | 一对一首次课范例 | V43 | - |
| `classFirstLessonTemplate` | 小班课首次课范例 | V43 | - |
| `batchStoragePath` | 批量处理文件存储路径 | V46 | `Mac(online)/Documents/XDF/批量任务` |
| `batchFilePrefix` | 批量处理文件名前缀 | V46 | `任务` |
| `max_tokens` | AI输出最大token数 | V49 | `64000` |
| `batchHeartbeatInterval` | SSE 心跳间隔（毫秒） | V64 | `15000` |
| `batchStatusRetention` | 批次状态保留时间（毫秒） | V64 | `3600000` |

**批量处理配置说明（V46）：**

- `batchStoragePath`：用户在「批量处理」页面修改存储路径后自动保存
- `batchFilePrefix`：用户修改文件名前缀后自动保存，生成的文件名格式为 `{前缀}{编号}.docx`，如 `生词表01.docx`

**max_tokens 手动设置示例（V49）：**

```sql
INSERT INTO system_config (`key`, value, description)
VALUES ('max_tokens', '64000', '最大输出token数')
ON DUPLICATE KEY UPDATE value = '64000';
```

---

## 存储路径可定制（V38新增）

用户可在网站"高级设置"中修改 `driveBasePath`（Google Drive 存储路径）。

**配置方式：**

1. 打开网站 → 高级设置
2. 找到"Google Drive 存储路径"输入框
3. 输入自定义路径（如 `XDF/学生档案`）
4. 点击保存

**存储结构：**

```
{driveBasePath}/
├── {学生姓名}/                    # 一对一模式
│   ├── 学情反馈/
│   ├── 复习文档/
│   ├── 气泡图/
│   └── 课后信息/
└── 小班课/{班号}班/               # 小班课模式
    ├── 学情反馈/
    ├── 复习文档/
    ├── 气泡图/
    └── 课后信息/
```

**注意事项：**

- 路径不能以 `/` 开头或结尾
- 路径会在 Google Drive 的 My Drive 下创建
- 如果要同步到本地电脑，需要在 Google Drive 桌面应用中设置该文件夹为"可离线使用"

---

## 非Manus平台部署注意事项

如果要在非Manus平台部署，需要注意以下几点：

### 1. 认证系统

当前项目使用 Manus OAuth 认证。如需在其他平台部署，有两种选择：

- **方案A**：移除认证功能，改为无需登录直接使用
- **方案B**：替换为其他认证方案（如自建用户系统、第三方OAuth等）

需要修改的文件：

- `server/_core/oauth.ts` - OAuth回调处理
- `server/_core/context.ts` - 用户上下文
- `client/src/_core/hooks/useAuth.ts` - 前端认证Hook

### 2. Google Drive 读写

当前项目使用 Google OAuth API 读写 Google Drive（V34起改造，V108统一）。

- 用户在系统界面中自助完成 OAuth 授权
- 授权信息存储在数据库 `google_tokens` 表中
- 不再依赖 rclone

如需在其他服务器部署：

- 需要有效的 Google Cloud 项目，配置 OAuth 同意屏幕
- 在 `.env` 中正确配置 `GOOGLE_CLIENT_ID` 和 `GOOGLE_CLIENT_SECRET`
- 确保回调URL指向部署后的实际地址

**方案A：使用 OAuth 授权（推荐）**

1. 在 Google Cloud Console 创建 OAuth 凭据
2. 配置 `GOOGLE_CLIENT_ID` 和 `GOOGLE_CLIENT_SECRET` 环境变量
3. 部署后在网站"高级设置"中点击"连接 Google Drive"完成授权
4. 授权后 Token 自动保存到数据库，过期后可在网站上重新授权

### 3. AI API

当前使用 DMXapi（兼容OpenAI格式）。可以在网站"高级设置"中配置：

- API地址
- API密钥
- 模型名称（默认 claude-sonnet-4-5-20250929）
- max_tokens（已改为 32000）

也可以切换到其他兼容OpenAI格式的服务（如官方OpenAI、Azure OpenAI等）。

### 4. 版本控制（V33新增）

项目代码托管在 GitHub：https://github.com/wanghaoen2000/feedback-mvp

如需在新服务器部署：

```bash
# 克隆代码
git clone https://github.com/wanghaoen2000/feedback-mvp.git
cd feedback-mvp

# 安装依赖
pnpm install

# 配置数据库
pnpm db:push

# 启动开发服务器
pnpm dev
```

### 5. 字体文件（部署依赖）

气泡图功能依赖项目 `fonts/` 目录中的中文字体文件（NotoSansCJKsc 或 wqy-zenhei）。这不是环境变量，但属于部署必需依赖项，请确保 `fonts/` 目录存在且包含所需字体。

---

## 依赖库说明

从早期版本升级时，需要确认以下依赖已安装：

```bash
# 文档解析库（V51 文档转文字功能）
pnpm add mammoth pdf-parse
pnpm add -D @types/pdf-parse
```

---

## 安全提醒（V63.3）

V63.3 移除了代码中硬编码的 API Key。请确保：

1. 绝对不要在代码中硬编码 API Key
2. 所有敏感信息都通过环境变量或 Manus Secrets 配置
3. `.env` 文件已加入 `.gitignore`

---

## V66-V179 补充说明

V66-V152 期间新增的功能（后台任务系统V112、作业管理V148等）没有新增环境变量。这些功能的配置全部通过数据库 `system_config` 表管理。

V153-V171 期间新增了用户管理系统（OAuth认证、多用户、God Mode），新增了 `OWNER_OPEN_ID` 环境变量（标识系统owner）。

V172-V179 多租户隔离改造：**所有用户级配置从 `system_config` 迁移到 `user_config` 表**（按 userId 隔离）。`system_config` 仅保留 `allowedEmails`（邮箱白名单）。以下配置现在每个用户独立存储在 `user_config` 中：

- AI模型名称和API密钥
- 并发数设置（默认50）
- Google Drive存储路径
- max_tokens 设置
- 路书内容

---

## 配置检查清单

部署前确认以下配置已完成：

| 检查项 | 配置位置 | 状态 |
|--------|----------|------|
| `DATABASE_URL` | `.env` 或平台环境变量 | □ |
| `JWT_SECRET` | `.env` 或平台环境变量 | □ |
| `GOOGLE_CLIENT_ID` | Manus Secrets 或 `.env` | □ |
| `GOOGLE_CLIENT_SECRET` | Manus Secrets 或 `.env` | □ |
| `GITHUB_TOKEN` | Manus Secrets（可选） | □ |
| Google Drive 授权 | 网站高级设置 | □ |
| AI API 配置 | 网站高级设置 | □ |
| 路书内容 | 网站高级设置 | □ |
| 存储路径 | 网站高级设置 | □ |
| max_tokens 配置 | 网站高级设置 或 数据库 | □ |
| mammoth 库安装 | package.json | □ |
| pdf-parse 库安装 | package.json | □ |
| 无硬编码 API Key | 代码检查 | □ |

---

*文档创建时间：2026年1月7日*
*最后更新：2026年2月16日*
*当前版本：V179*
