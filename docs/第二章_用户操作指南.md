# 第二章 用户操作指南

> **学情反馈系统 (feedback-mvp) 技术手册**
> 版本 V179 | 2026-02-16

---

## 2.1 页面布局概览

系统为单页面应用（SPA），所有功能集中在一个主页面 (`/`) 上。页面结构从上到下为：

```
┌─────────────────────────────────────────────────┐
│  顶部栏：路书管理 | 用户菜单 | 全局设置 | 版本号    │
├─────────────────────────────────────────────────┤
│  标题区："学情反馈系统" + 说明文字                    │
├────────────────┬────────────────────────────────┤
│  课堂反馈       │  学生管理                        │
├────────────────┼────────────────────────────────┤
│  作业批改       │  批量处理                        │
├────────────────┴────────────────────────────────┤
│                                                 │
│          当前 Tab 的内容区域                       │
│                                                 │
└─────────────────────────────────────────────────┘
```

**顶部栏元素（从左到右）：**

- **「路书及范例管理」按钮** — 打开路书编辑弹窗
- **用户下拉菜单** — 显示当前用户名/邮箱，可退出登录
- **全局设置按钮（齿轮图标）** — 打开全局设置弹窗
- **版本号** — 显示当前版本（如 V179）

**四大 Tab（2×2 网格排列）：**

| 位置 | Tab 名称 | 图标 | 对应组件 |
|------|---------|------|----------|
| 左上 | 课堂反馈 | 📄 FileText | Home.tsx 内嵌 |
| 右上 | 学生管理 | 📖 BookOpen | HomeworkManagement.tsx |
| 左下 | 作业批改 | ✏️ PenLine | HomeworkCorrection.tsx |
| 右下 | 批量处理 | 👥 Users | BatchProcess.tsx |

---

## 2.2 课堂反馈（Tab 1）— 完整操作流程

这是系统的核心功能，用于一键生成课后反馈报告及配套文档。

### 2.2.1 第一步：选择课程类型

页面顶部有一个单选切换：

- **一对一** — 一个老师对一个学生（默认选中）
- **小班课** — 一个老师对多个学生（3~10 人）

选择不同类型后，下面的表单字段会相应变化。

### 2.2.2 第二步：填写基本信息

#### 一对一模式

| 字段 | 是否必填 | 说明 |
|------|----------|------|
| 学生姓名 | 必填 | 输入框带下拉自动补全，显示历史学生列表（按最近使用排序），选中后自动填充课次 |
| 课次 | 自动填充 | 基于历史记录自动填入「上次 + 1」，也可手动修改 |
| 年份 | 自动填充 | 默认当前北京时间年份 |
| 本次课日期 | 选填 | 格式如「1月15日」或「1.15」，会自动显示星期几；留空则由 AI 从录音中自动提取 |
| 新生首次课 | 开关 | 打开后自动在「上次课反馈」栏填入首次课范例模板 |

#### 小班课模式

| 字段 | 是否必填 | 说明 |
|------|----------|------|
| 班号 | 必填 | 输入框带下拉自动补全，选中后自动填充课次和出勤学生名单 |
| 课次 | 自动填充 | 同一对一 |
| 年份 | 自动填充 | 同一对一 |
| 本次课日期 | 选填 | 同一对一 |
| 首次课 | 开关 | 同一对一，使用小班课专用首次课范例 |
| 出勤学生 | 至少 1 人 | 10 个输入框（2 列 × 5 行），填入出勤学生姓名，空白框自动忽略 |

**历史记录机制：**

- 系统自动记忆最近 30 个学生/班级的使用记录
- 记录内容包括：姓名、上次课次编号、最后使用时间、（小班课）出勤学生名单
- 记录同时保存在浏览器 localStorage（离线可用）和服务器（跨设备同步）
- 每个用户的历史记录互相隔离

### 2.2.3 第三步：填写/加载课程材料

页面中间有三个大文本输入区域：

#### ① 上次课反馈

- **内容**：上一次课的反馈报告全文
- **自动加载**：勾选「自动加载」复选框后，系统会从 Google Drive 搜索该学生最新的反馈文件并自动填入
  - 搜索规则：在 `{driveBasePath}/{学生姓名}/` 目录下找最新的 `{学生姓名}{课次}学情反馈.md`
- **手动输入**：直接粘贴文本，或点击上传按钮选择文件
- **首次课**：如果打开了「新生首次课」开关，此栏会自动填入首次课范例模板，无需加载

#### ② 课堂笔记（必填）

- **内容**：本次课的教学笔记
- **自动加载**：勾选后从本地下载目录读取文件
  - 一对一：搜索 `{下载目录}/{学生姓名}{课次}.docx`
  - 小班课：搜索 `{下载目录}/{班号}班{课次}.docx`
- **手动输入**：直接粘贴或上传文件
- 右下角显示字符数

#### ③ 录音转文字（必填）

- **内容**：课程录音的文字转写稿
- **自动加载**：勾选后从本地下载目录读取文件
  - 搜索规则：`{下载目录}/{学生姓名}{MMDD}.docx`（MMDD 从日期字段提取）
- **多段录音**：勾选「多段录音」后，可指定段数（默认 3），系统会搜索多个文件并合并
  - 文件命名：`{学生姓名}{MMDD}.docx`、`{学生姓名}{MMDD}-2.docx`、`{学生姓名}{MMDD}-3.docx`
- **手动输入**：直接粘贴或上传文件
- 右下角显示字符数

### 2.2.4 第四步：提交生成

点击底部的 **「生成」** 按钮提交。

**表单验证规则：**

- 一对一：学生姓名 + 课堂笔记 + 录音转文字（或对应的自动加载已勾选）
- 小班课：班号 + 至少 1 个出勤学生 + 课堂笔记 + 录音转文字

**两种执行路径：**

| 情况 | 执行方式 | 特点 |
|------|----------|------|
| 没有勾选任何自动加载 | SSE 实时流式生成 | 页面实时显示进度，需保持页面打开 |
| 勾选了自动加载 | 后台任务模式 | 先在后台加载文件，然后提交后台任务，可以关闭页面 |

### 2.2.5 第五步：查看生成进度

提交后，页面下方出现 5 步进度面板：

```
步骤 1：学情反馈    ✅ 已完成  已生成 3,256 字符  [查看链接]
步骤 2：复习文档    ✅ 已完成  已生成 1,842 字符  [查看链接]
步骤 3：测试本      🔄 生成中  已生成 892 字符...
步骤 4：课后信息提取  ⏳ 等待中
步骤 5：气泡图      ⏳ 等待中
```

**各步骤状态图标：**

| 状态 | 图标 | 含义 |
|------|------|------|
| pending | ⚪ 灰色空心圆 | 等待中，尚未开始 |
| running | 🔵 蓝色旋转圆 | 正在生成 |
| success | ✅ 绿色对勾 | 已完成 |
| error | ❌ 红色叉 | 生成失败（可点击重试按钮） |
| skipped | ⏭️ 灰色跳过 | 已跳过 |

**执行逻辑：**

1. 步骤 1（学情反馈）先执行，这是后续所有步骤的输入依据
2. 步骤 1 完成后，步骤 2~5 **并行执行**
3. 如果步骤 1 失败，后续步骤全部跳过
4. 步骤 2~5 各自独立，某个失败不影响其他

### 2.2.6 第六步：查看结果和下载

生成完成后可以：

- **查看反馈内容** — 点击「查看提示词」预览完整的 AI 提示词
- **复制反馈** — 一键复制学情反馈文本到剪贴板
- **导出日志** — 导出完整的生成过程日志（用于排查问题）
- **查看链接** — 每个步骤右侧有 Google Drive 链接，点击直接打开
- **下载文件** — 「下载复习+测试」和「下载气泡图」按钮，从 Drive 下载到本地（60 秒超时）
- **导入作业管理** — 步骤 4（课后信息提取）完成后，可一键导入到学生管理系统

### 2.2.7 任务记录

在「课堂反馈」Tab 的底部，有一个 **「任务记录」** 区域，显示所有历史生成任务：

- 每条记录显示：课程类型标签、学生/班级名、课次、日期、耗时、状态
- 点击展开可查看 5 个步骤的详细状态
- 已完成的任务可以下载文件
- 一对一任务可以「导入作业管理」
- 使用的 AI 模型名称会简化显示（如 `opus-4.5` 而非完整的模型 ID）

---

## 2.3 学生管理（Tab 2）— 完整操作流程

### 2.3.1 学生名册管理

进入「学生管理」Tab 后，左侧是学生列表区域：

**添加学生：**
1. 在输入框中输入学生姓名
2. 选择计划类型：「周计划」（默认）或「日计划」
3. 点击「添加」按钮
4. 如果该学生之前被删除过，系统会自动重新激活（不会报重复名错误）

**学生列表：**
- 学生以按钮卡片形式排列，按拼音排序
- 日计划学生会有橙色标记
- 点击学生卡片可选中（高亮为蓝色），再次点击取消选中
- 每个学生卡片右上角有删除按钮（×）

**删除学生：**
- 点击卡片右上角的 × 按钮
- 弹出确认对话框
- 确认后软删除（标记为 inactive，数据保留在数据库中）

### 2.3.2 语音输入与 AI 处理

选中学生后，可以在右侧输入区域提交语音转文字内容：

1. **输入文本** — 在文本框中粘贴语音转文字的原文
2. **选择模型**（可选） — 下拉菜单选择 AI 模型，系统会记住上次选择
3. **提交** — 点击提交按钮

**处理流程：**
```
提交 → pending（等待中）
     → processing（AI 处理中，实时显示已处理时长）
     → pre_staged（待入库，可查看 AI 处理结果）
     → confirmed（已入库，学生状态已更新）
```

**预入库队列：**
- 处理完成后，条目进入「预入库」状态
- 展开条目可以看到：
  - **上方（蓝色标题）**：AI 处理结果（结构化后的内容）
  - **下方**：原始输入文本
- 可以点击「重试」按钮用不同模型重新处理
- 确认无误后，点击「入库」确认

**入库操作：**
- 单条入库：点击条目的「入库」按钮
- 批量入库：点击顶部的「全部入库」按钮
- 入库时系统会：
  1. 将 AI 处理结果保存为学生的「当前状态」
  2. 删除预入库队列中的条目
  3. 自动备份到 Google Drive

### 2.3.3 查看学生当前状态

选中学生后，下方显示该学生的「当前状态」文档：

- 这是该学生所有历史入库记录的迭代累积结果
- 每次新入库的内容不是替换而是在现有状态基础上由 AI 迭代更新
- 右上角有「复制」按钮，可一键复制完整状态文本

### 2.3.4 提示词管理

点击顶部的「提示词」按钮，展开提示词编辑区：

- 文本框固定高度（约半屏），超长内容可滚动
- 右侧有「到顶」「到底」快捷按钮
- 编辑后点击「保存」
- 配置了自定义提示词后，AI 处理时会使用该提示词替代默认提示词
- 未配置时使用系统默认的结构化处理模板

### 2.3.5 一键打分

点击「一键打分」按钮进入打分功能：

**设置打分参数：**

1. **日期范围** — 选择开始和结束日期（默认：最近 7 天到昨天）
2. **打分要求** — 输入打分标准和要求
3. **备注**（可选） — 补充说明
4. **模型选择** — 选择 AI 模型

**打分流程：**

1. 点击「开始打分」
2. AI 对日期范围内所有活跃学生批量生成评分
3. 结果展示为每个学生一张可展开的卡片
4. 可以在线编辑每个学生的打分结果
5. 编辑后点击「保存」可保存修改

**同步到学生状态：**

打分完成后，可以将结果同步回各学生的状态文档：

1. 点击「同步到学生状态」
2. 系统逐个学生处理（显示进度条）
3. 每个学生的同步状态：pending → running → 成功/失败
4. 失败的可以单独重试

### 2.3.6 作业提醒

点击「作业提醒」按钮：

1. 输入提醒要求/模板
2. 选择模型
3. 点击生成
4. AI 根据每个学生的当前状态生成个性化提醒文案
5. 每个学生的提醒内容可一键复制
6. 复制按钮点击后永久显示「已复制」（设计意图：防止重复发送）

### 2.3.7 数据备份与恢复

**导出备份：**
1. 点击「导出备份」
2. 预览显示学生数量和样例
3. 确认后下载 Markdown 格式的备份文件

**导入备份：**
1. 点击「导入备份」
2. 上传之前导出的备份文件
3. 预览显示：总学生数、样例记录、冲突处理策略
4. 确认后导入，显示结果（创建 N 个、更新 N 个）

---

## 2.4 作业批改（Tab 3）— 完整操作流程

### 2.4.1 选择学生

页面顶部显示学生列表（与学生管理共享同一份学生库）：

- 点击学生按钮选中（蓝色高亮）
- 再次点击取消选中
- 列表按拼音排序
- 可以直接在此添加新学生（点击「添加学生」）

### 2.4.2 选择批改类型

在下拉菜单中选择批改类型：

| 类型 | 说明 |
|------|------|
| 豆包翻译 | 检查翻译的准确性、流畅性、用词 |
| 学术文章 | 检查论点逻辑、论据、用语规范性 |
| 日常文章 | 检查语法、用词、表达地道性 |
| 词汇填空 | 检查答案正确性、解释错误选项 |

批改类型可在设置面板中自定义添加/编辑/删除。

### 2.4.3 输入作业内容

三种输入方式可以同时使用：

**① 文字输入：**
- 直接在文本框中粘贴作业文字
- 右下角显示字符数

**② 图片输入：**
- 点击上传区域选择图片
- 拖拽图片到上传区域
- 直接粘贴（Ctrl+V）剪贴板中的图片
- 支持多张图片
- 图片自动压缩：
  - 最大尺寸：2048×2048 像素
  - 格式：JPEG
  - 质量：0.85（超过 1.5MB 时降至 0.6）
  - 压缩前后大小对比会显示在缩略图旁
- 每张图片旁有删除按钮

**③ 文件输入：**
- 点击上传区域选择文件
- 拖拽文件到上传区域
- 支持格式：`.docx`（Word）、`.pdf`（PDF）、`.txt`（文本）
- 服务端自动提取文件中的文字内容
- 每个文件旁有删除按钮

### 2.4.4 提交与查看结果

1. 确认学生 + 批改类型 + 内容都已填写
2. 点击「提交」按钮
3. 任务提交到后台处理（可以关闭页面）
4. 下方「批改记录」区域显示最近 20 条批改任务

**批改记录卡片：**
- 学生姓名、批改类型、提交时间
- 状态（pending → processing → completed / failed）
- 处理时长（processing 中实时更新，每 3 秒刷新）
- 展开后可查看：
  - 输入内容（文字/图片/文件）
  - AI 批改结果（一键复制）
  - 可在线编辑批改结果并保存

**自动状态推送：**
- 批改完成后，AI 输出分两部分：
  - **批改内容**（给学生看）— 显示在结果区
  - **状态更新**（给系统用）— 自动推送到学生管理的状态文档

### 2.4.5 设置面板

页面内有一个可展开的设置面板，用于：

- **管理批改类型** — 添加/编辑/删除批改类型，每个类型有独立的提示词
- **通用批改提示词** — 所有批改类型共用的基础提示词模板
- **模型选择** — 选择用于批改的 AI 模型

---

## 2.5 批量处理（Tab 4）— 完整操作流程

### 2.5.1 基本设置

**模板类型选择：**

| 模板 | 输出格式 | 说明 |
|------|----------|------|
| 教学材料（带样式） | DOCX（带格式） | 默认选项，适合正式教学文档 |
| 通用文档（无样式） | DOCX（纯文本） | 简单文档，无额外排版 |
| 生成 MD 文件（不转换） | Markdown | 直接输出 Markdown，不转 Word |
| 词汇卡片（精确排版） | DOCX（特殊排版） | 适合制作词汇卡、记忆卡片 |
| 写作素材模板 | DOCX | 适合写作相关的素材整理 |

**任务编号范围：**
- 起始编号（如 1）和结束编号（如 100）
- 系统会生成 `编号1` 到 `编号100` 共 100 个子任务

**并发数设置：**
- 同时执行的子任务数量
- 默认 50，最大 200
- 修改后自动保存到配置

**文件命名方式：**

- **前缀+编号**：输入前缀（如「生词表」），生成 `生词表01.docx`、`生词表02.docx`……
- **从文本解析**：在文本框中每行一个文件名，空行默认为「任务XX」

### 2.5.2 路书内容

在大文本框中输入路书（课程大纲/指导内容），这是 AI 生成文档的核心输入。

- 右下角显示字符数
- 有「复制」按钮
- 有「预览」按钮可查看完整的 AI 提示词

### 2.5.3 文件上传

**独立文件（每个任务一个）：**
- 上传多个文件，系统按文件名字母排序
- 第 1 个文件分配给第 1 个任务，第 2 个给第 2 个，依此类推
- 适合每个任务需要不同参考材料的场景

**共享文件（所有任务共用）：**
- 上传的文件会发送给每一个子任务
- 适合所有任务需要同一份参考材料的场景

### 2.5.4 提交与监控

1. 确认编号范围和路书内容
2. 点击「提交」
3. 系统创建批量任务，按并发数分批执行

**进度监控：**
- 每 3~5 秒自动刷新
- 显示：总进度（X/N 已完成）、每个子任务的状态
- 子任务状态：pending → running → completed / failed
- 已完成的子任务显示 Google Drive 文件链接
- 失败的子任务可以单独重试

---

## 2.6 全局设置（弹窗）

点击页面右上角的齿轮图标打开。包含三个标签页。

### 2.6.1 API 配置

| 设置项 | 说明 |
|--------|------|
| API 模型 | 当前使用的 AI 模型名称/ID |
| API Key | API 密钥（输入后不会回显完整密钥，仅显示末尾 4 位） |
| API 地址 | AI 服务的 Base URL |
| 最大 Token 数 | 单次 API 调用的最大输出 Token（默认 64000，范围 1000~200000） |

**模型预设：**
- 下拉列表中预配置多个模型名称
- 可编辑预设列表（一行一个模型名）

**API 供应商预设：**
- 预配置多个 AI 供应商（名称 + 密钥 + 地址）
- 下拉选择后一键切换供应商
- 密钥安全显示：仅展示 `****xxxx` 格式

### 2.6.2 Google Drive

**连接状态：**
- 显示当前是否已授权
- 已授权时显示关联的 Google 账号邮箱

**连接/断开操作：**
- 点击「连接 Google Drive」→ 跳转 Google 授权页面 → 授权后自动回调
- 点击「断开」→ 确认对话框 → 移除 OAuth Token

**存储路径配置：**

| 路径 | 说明 | 示例 |
|------|------|------|
| Google Drive 基础路径 | 所有文件的根目录 | `Mac/Documents/XDF/学生档案` |
| 小班课存储路径 | 小班课文件的专用目录 | `Mac/Documents/XDF/小班课` |
| 批量处理存储路径 | 批量生成文件的目录 | `Mac/Documents/XDF/批量` |
| 打分存储路径 | 打分结果文件的目录 | `Mac/Documents/XDF/打分` |
| 本地 Drive 基础路径 | Google Drive 在本地的挂载路径 | `/Users/xxx/Google Drive/我的云端硬盘` |
| 下载目录路径 | 自动加载文件的搜索目录 | `/Users/xxx/Downloads` |

### 2.6.3 管理员面板（仅 admin 可见）

**用户管理功能：**

| 操作 | 说明 |
|------|------|
| 创建用户 | 输入姓名、邮箱、角色（user/admin），手动创建账号 |
| 编辑用户 | 修改姓名、邮箱、角色 |
| 暂停用户 | 将用户状态设为 suspended，立即禁止使用（数据保留） |
| 恢复用户 | 将 suspended 用户恢复为 active |
| 删除用户 | 永久删除用户及其所有关联数据（级联删除） |
| 伪装登录 | 切换为目标用户身份，用于查看/调试其他用户的数据 |

**伪装登录（God Mode）：**
- 点击某用户的「伪装」按钮
- 系统保存当前管理员 Session，创建目标用户的 Session
- 页面顶部会出现提示条，表示当前处于伪装模式
- 点击「退出伪装」恢复管理员身份

### 2.6.4 系统诊断

点击「系统检查」按钮，自动检测各项服务状态：

- API 连通性
- Google Drive 授权状态
- 文件系统访问
- 数据库连接
- 等

每项检查显示：状态（通过/失败/跳过）、详细信息、失败时的修复建议。

### 2.6.5 配置备份与恢复

- **导出备份**：一键导出所有配置为 JSON 文件（API Key 被遮蔽，不会导出明文密钥）
- **导入备份**：上传之前导出的 JSON 文件，确认后恢复配置

---

## 2.7 路书及范例管理（弹窗）

点击标题下方的「路书及范例管理」按钮打开。

### 2.7.1 路书 Tab

**一对一路书：**
- 大文本框编辑路书内容
- 路书是 AI 生成反馈时的核心指导文档，决定了反馈的风格、格式、侧重点
- 编辑后点击「保存」
- 有「清空」按钮（带确认对话框）
- 显示字符数

**小班课路书：**
- 独立的文本框，与一对一路书分开管理
- 操作方式相同

### 2.7.2 首次课范例 Tab

**一对一首次课范例：**
- 新生第一次上课时，「上次课反馈」栏没有历史数据
- 此处配置一份范例模板，开启「新生首次课」开关时自动填入
- 编辑/保存/清空操作同路书

**小班课首次课范例：**
- 小班课专用的首次课范例
- 操作方式相同

---

## 2.8 常见操作速查表

| 我想要…… | 怎么操作 |
|---------|---------|
| 给一对一学生生成课后反馈 | 课堂反馈 Tab → 选「一对一」→ 填学生名/笔记/录音 → 点「生成」 |
| 给小班课生成课后反馈 | 课堂反馈 Tab → 选「小班课」→ 填班号/出勤学生/笔记/录音 → 点「生成」 |
| 让系统自动读取上次反馈和笔记 | 勾选各输入框旁的「自动加载」复选框 |
| 查看历史生成任务 | 课堂反馈 Tab → 滚动到底部「任务记录」 |
| 下载生成的复习文档和测试本 | 任务记录 → 展开任务 → 点「下载复习+测试」 |
| 添加新学生 | 学生管理 Tab → 输入姓名 → 选计划类型 → 点「添加」 |
| 记录学生课后情况 | 学生管理 Tab → 选中学生 → 粘贴语音转文字 → 提交 → 确认入库 |
| 查看学生当前状态 | 学生管理 Tab → 点击学生卡片 → 下方显示「当前状态」 |
| 批改学生作业 | 作业批改 Tab → 选学生 → 选批改类型 → 粘贴文字/上传图片 → 提交 |
| 给全部学生打分 | 学生管理 Tab → 点「一键打分」→ 设日期范围和要求 → 开始 |
| 批量生成教学材料 | 批量处理 Tab → 设编号范围 → 填路书 → 上传参考文件 → 提交 |
| 切换 AI 模型或供应商 | 全局设置 → API 配置 → 选模型/供应商 |
| 连接 Google Drive | 全局设置 → Google Drive → 点「连接」→ 完成授权 |
| 配置反馈的风格模板 | 点「路书及范例管理」→ 编辑路书内容 → 保存 |
| 备份学生数据 | 学生管理 Tab → 点「导出备份」→ 下载文件 |
| 管理其他用户（管理员） | 全局设置 → 管理员面板 → 操作用户列表 |
