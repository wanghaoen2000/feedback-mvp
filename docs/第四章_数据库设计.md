# 第四章 数据库设计

> **学情反馈系统 (feedback-mvp) 技术手册**
> 版本 V179 | 2026-02-16

---

## 4.1 概述

系统使用 **MySQL 8.x** 作为关系数据库，通过 **Drizzle ORM 0.44** 进行数据访问。

**关键设计原则：**

- **多租户隔离**：所有用户数据表包含 `user_id` 列，查询时必须附加用户 ID 过滤
- **大文本存储**：AI 输入/输出、系统提示词等大段文本使用 `MEDIUMTEXT`（最大 16MB）
- **审计追踪**：任务表保留完整的 `systemPrompt` 和 `inputParams` 快照，方便事后排查
- **状态机驱动**：所有异步任务都通过 status 字段管理生命周期
- **只增不删**：数据库迁移文件（`drizzle/` 目录下的 SQL）只允许新增，禁止删除已有文件

**表总览（13 张表）：**

| 类别 | 表名 | 用途 |
|------|------|------|
| 用户管理 | `users` | 用户账号 |
| 配置 | `system_config` | 系统级配置（全局） |
| 配置 | `user_config` | 用户级配置（覆盖） |
| 凭证 | `google_tokens` | Google Drive OAuth Token |
| 任务 | `background_tasks` | 后台反馈生成任务 |
| 任务 | `batch_tasks` | 批量任务主表 |
| 任务 | `batch_task_items` | 批量任务子项 |
| 学生管理 | `hw_students` | 学生名册 |
| 学生管理 | `hw_entries` | 语音输入预入库队列 |
| 批改 | `correction_tasks` | 作业批改任务 |
| 打分 | `grading_tasks` | 一键打分任务 |
| 打分 | `grading_sync_items` | 打分同步子任务 |
| 提醒 | `reminder_tasks` | 作业提醒任务 |

---

## 4.2 数据库连接

**文件：** `server/db.ts`

```typescript
// 连接方式：惰性初始化，仅在 DATABASE_URL 环境变量存在时建立连接
const db = drizzle(mysql2Connection, { schema });
```

**特性：**

- **惰性初始化**：首次调用 `getDb()` 时才建立连接，`DATABASE_URL` 不存在时返回 null
- **连接失败不崩溃**：捕获连接错误并记录日志，不影响服务启动
- **Email 合并逻辑**：OAuth 登录时，如果发现已有用户使用相同邮箱，自动合并账号（保留 admin 角色）

---

## 4.3 表结构详解

### 4.3.1 users — 用户表

存储所有系统用户，支持 OAuth 登录和手动创建。

| 列名 | 类型 | 约束 | 说明 |
|------|------|------|------|
| `id` | INT | PK, AUTO_INCREMENT | 自增主键，用于关联其他表 |
| `openId` | VARCHAR(64) | NOT NULL, UNIQUE | Manus OAuth 标识符 |
| `name` | TEXT | 可空 | 用户显示名称 |
| `email` | VARCHAR(320) | UNIQUE, 可空 | 业务唯一标识，用于账号合并 |
| `loginMethod` | VARCHAR(64) | 可空 | OAuth 提供商名称（如 "manus"） |
| `role` | ENUM('user','admin') | NOT NULL, 默认 'user' | 用户角色 |
| `account_status` | VARCHAR(20) | NOT NULL, 默认 'active' | 账号状态：active / suspended |
| `createdAt` | TIMESTAMP | NOT NULL, 默认 NOW() | 创建时间 |
| `updatedAt` | TIMESTAMP | NOT NULL, 自动更新 | 最后修改时间 |
| `lastSignedIn` | TIMESTAMP | NOT NULL, 默认 NOW() | 最后登录时间 |

**索引：**
- `openId` UNIQUE — OAuth 查找
- `email` UNIQUE — 邮箱合并查找

**Email 合并机制：** 当 OAuth 用户首次登录时，如果其邮箱匹配到一个已手动创建的用户记录，系统会将 OAuth 信息写入该记录（而非创建新记录），实现无缝合并。

---

### 4.3.2 system_config — 系统级配置表

存储全局配置键值对，所有用户共享。

| 列名 | 类型 | 约束 | 说明 |
|------|------|------|------|
| `id` | INT | PK, AUTO_INCREMENT | 自增主键 |
| `key` | VARCHAR(64) | NOT NULL, UNIQUE | 配置键名 |
| `value` | MEDIUMTEXT | NOT NULL | 配置值（常为 JSON 字符串） |
| `description` | TEXT | 可空 | 配置说明 |
| `updatedAt` | TIMESTAMP | NOT NULL, 自动更新 | 最后修改时间 |

**常用配置键：**

| key | 说明 | 值示例 |
|-----|------|--------|
| `apiModel` | 默认 AI 模型 | `"claude-sonnet-4-5-20250929"` |
| `apiKey` | API 密钥 | `"sk-xxx..."` |
| `apiUrl` | API 服务地址 | `"https://api.xxx.com/v1"` |
| `roadmap` | 一对一路书 | 长文本 |
| `roadmapClass` | 小班课路书 | 长文本 |
| `driveBasePath` | Drive 基础路径 | `"Mac/Documents/XDF/学生档案"` |
| `modelPresets` | 模型预设列表 | JSON 数组 |
| `apiProviderPresets` | API 供应商预设 | JSON 数组 |
| `hwPromptTemplate` | 作业管理提示词 | 长文本 |
| `correctionTypes` | 批改类型列表 | JSON 数组 |
| `correctionPrompt` | 通用批改提示词 | 长文本 |

---

### 4.3.3 user_config — 用户级配置表

存储用户个人配置，覆盖 system_config 中的同名键。

| 列名 | 类型 | 约束 | 说明 |
|------|------|------|------|
| `id` | INT | PK, AUTO_INCREMENT | 自增主键 |
| `userId` | INT | NOT NULL | 所属用户 ID |
| `key` | VARCHAR(64) | NOT NULL | 配置键名 |
| `value` | MEDIUMTEXT | NOT NULL | 用户级配置值 |
| `updatedAt` | TIMESTAMP | NOT NULL, 自动更新 | 最后修改时间 |

**索引：**
- `idx_user_key` UNIQUE (userId, key) — 防止重复
- `idx_userId` — 按用户查询

**配置优先级：** `user_config[userId, key]` > `system_config[key]` > 代码内置默认值

---

### 4.3.4 google_tokens — Google Drive OAuth Token 表

每个用户独立存储 Google Drive 授权凭证。

| 列名 | 类型 | 约束 | 说明 |
|------|------|------|------|
| `id` | INT | PK, AUTO_INCREMENT | 自增主键 |
| `user_id` | INT | NOT NULL | 所属用户 ID |
| `access_token` | TEXT | NOT NULL | 当前访问令牌 |
| `refresh_token` | TEXT | NOT NULL | 刷新令牌（用于续期） |
| `expires_at` | TIMESTAMP | NOT NULL | 令牌过期时间 |
| `created_at` | TIMESTAMP | 默认 NOW() | 创建时间 |
| `updated_at` | TIMESTAMP | 自动更新 | 最后更新时间 |

**索引：**
- `idx_google_tokens_user` UNIQUE (user_id) — 每用户一条记录

---

### 4.3.5 background_tasks — 后台任务表

跟踪学情反馈的后台生成任务。

| 列名 | 类型 | 约束 | 说明 |
|------|------|------|------|
| `id` | VARCHAR(36) | PK | UUID（非自增） |
| `user_id` | INT | NOT NULL | 所属用户 |
| `course_type` | VARCHAR(20) | NOT NULL | `'one-to-one'` 或 `'class'` |
| `display_name` | VARCHAR(200) | NOT NULL | 显示名称（如"张三 第12次"） |
| `status` | VARCHAR(20) | NOT NULL, 默认 'pending' | 任务状态 |
| `current_step` | INT | NOT NULL, 默认 0 | 当前步骤（0~5） |
| `total_steps` | INT | NOT NULL, 默认 5 | 总步骤数 |
| `input_params` | MEDIUMTEXT | NOT NULL | JSON：完整生成参数 |
| `step_results` | MEDIUMTEXT | 可空 | JSON：各步骤结果 |
| `error_message` | TEXT | 可空 | 错误信息 |
| `created_at` | TIMESTAMP | NOT NULL | 创建时间 |
| `updated_at` | TIMESTAMP | NOT NULL, 自动更新 | 最后更新时间 |
| `completed_at` | TIMESTAMP | 可空 | 完成时间 |

**索引：** `idx_background_tasks_user_id` (user_id)

**status 状态机：**

```
pending → running → completed
                  → partial（部分步骤失败）
                  → failed
         → cancelled（用户取消）
```

**自动清理：** 3 天以上的旧任务自动删除；运行超过 30 分钟的任务自动标记为 failed。

**step_results JSON 结构：**

```json
{
  "feedback": { "status": "completed", "fileName": "...", "url": "...", "chars": 3256, "duration": 45 },
  "review":   { "status": "completed", "fileName": "...", "url": "...", "chars": 1842 },
  "test":     { "status": "failed", "error": "API 超时" },
  "extraction": { "status": "completed", "chars": 987 },
  "bubbleChart": { "status": "completed", "url": "..." }
}
```

---

### 4.3.6 batch_tasks — 批量任务主表

| 列名 | 类型 | 约束 | 说明 |
|------|------|------|------|
| `id` | VARCHAR(36) | PK | UUID |
| `user_id` | INT | NOT NULL | 所属用户 |
| `display_name` | VARCHAR(200) | NOT NULL | 显示名称 |
| `status` | VARCHAR(20) | NOT NULL, 默认 'pending' | 任务状态 |
| `total_items` | INT | NOT NULL, 默认 0 | 子任务总数 |
| `completed_items` | INT | NOT NULL, 默认 0 | 已完成数 |
| `failed_items` | INT | NOT NULL, 默认 0 | 失败数 |
| `input_params` | MEDIUMTEXT | NOT NULL | JSON：路书、模板类型等 |
| `error_message` | TEXT | 可空 | 错误信息 |
| `created_at` | TIMESTAMP | NOT NULL | 创建时间 |
| `updated_at` | TIMESTAMP | NOT NULL, 自动更新 | 最后更新时间 |
| `completed_at` | TIMESTAMP | 可空 | 完成时间 |

**索引：** `idx_batch_userId` (user_id)

**status 状态机：**

```
pending → running → completed / failed / stopped / cancelled
```

### 4.3.7 batch_task_items — 批量任务子项表

| 列名 | 类型 | 约束 | 说明 |
|------|------|------|------|
| `id` | INT | PK, AUTO_INCREMENT | 自增主键 |
| `batch_id` | VARCHAR(36) | NOT NULL | 父任务 ID |
| `task_number` | INT | NOT NULL | 子任务序号 |
| `status` | VARCHAR(20) | NOT NULL, 默认 'pending' | 子任务状态 |
| `chars` | INT | 默认 0 | 生成字符数 |
| `filename` | VARCHAR(500) | 可空 | 生成的文件名 |
| `url` | TEXT | 可空 | Google Drive 文件链接 |
| `error` | TEXT | 可空 | 错误信息 |
| `truncated` | INT | 默认 0 | 是否被截断（0/1） |
| `created_at` | TIMESTAMP | NOT NULL | 创建时间 |
| `updated_at` | TIMESTAMP | NOT NULL, 自动更新 | 最后更新时间 |
| `completed_at` | TIMESTAMP | 可空 | 完成时间 |

**索引：** `idx_batch_id` (batch_id) — 按父任务查询

**与 batch_tasks 的关系：** 一对多。一个 batch_tasks 记录对应 N 个 batch_task_items（N = total_items）。

---

### 4.3.8 hw_students — 学生名册表

| 列名 | 类型 | 约束 | 说明 |
|------|------|------|------|
| `id` | INT | PK, AUTO_INCREMENT | 自增主键 |
| `user_id` | INT | NOT NULL | 所属教师 |
| `name` | VARCHAR(64) | NOT NULL | 学生姓名 |
| `plan_type` | VARCHAR(10) | NOT NULL, 默认 'weekly' | 计划类型：`daily` / `weekly` |
| `current_status` | MEDIUMTEXT | 可空 | 学生当前正式状态文档（迭代更新） |
| `status` | VARCHAR(10) | NOT NULL, 默认 'active' | 记录状态：`active` / `inactive` |
| `created_at` | TIMESTAMP | NOT NULL | 创建时间 |
| `updated_at` | TIMESTAMP | NOT NULL, 自动更新 | 最后更新时间 |

**索引：**
- `idx_hw_user_name` UNIQUE (user_id, name) — 同一教师下学生名不能重复
- `idx_hw_userId` — 按教师查询

**current_status 迭代机制：**

每次入库操作时：
1. 取最新预入库条目的 `parsedContent`（AI 处理结果）
2. 保存到该学生的 `current_status`
3. 删除预入库条目

AI 处理时，如果学生已有 `current_status`，会将其作为上下文传递给 AI，让 AI 在现有基础上迭代更新，而不是从零开始。

---

### 4.3.9 hw_entries — 语音输入预入库队列表

| 列名 | 类型 | 约束 | 说明 |
|------|------|------|------|
| `id` | INT | PK, AUTO_INCREMENT | 自增主键 |
| `user_id` | INT | NOT NULL | 所属教师 |
| `student_name` | VARCHAR(64) | NOT NULL | 学生姓名 |
| `raw_input` | TEXT | NOT NULL | 原始输入（语音转文字） |
| `parsed_content` | MEDIUMTEXT | 可空 | AI 结构化处理结果 |
| `ai_model` | VARCHAR(128) | 可空 | 使用的 AI 模型 |
| `entry_status` | VARCHAR(20) | NOT NULL, 默认 'pending' | 条目状态 |
| `error_message` | TEXT | 可空 | 错误信息 |
| `streaming_chars` | INT | 默认 0 | 流式接收字符数（实时） |
| `started_at` | TIMESTAMP | 可空 | AI 处理开始时间 |
| `completed_at` | TIMESTAMP | 可空 | AI 处理完成时间 |
| `created_at` | TIMESTAMP | NOT NULL | 创建时间 |
| `updated_at` | TIMESTAMP | NOT NULL, 自动更新 | 最后更新时间 |

**索引：** `idx_entry_userId` (user_id)

**entry_status 状态机：**

```
pending → processing → pre_staged → confirmed（入库完成，随后删除记录）
                     → failed（可重试）
```

---

### 4.3.10 correction_tasks — 作业批改任务表

| 列名 | 类型 | 约束 | 说明 |
|------|------|------|------|
| `id` | INT | PK, AUTO_INCREMENT | 自增主键 |
| `user_id` | INT | NOT NULL | 所属教师 |
| `student_name` | VARCHAR(64) | NOT NULL | 学生姓名 |
| `correction_type` | VARCHAR(64) | NOT NULL | 批改类型 ID |
| `raw_text` | MEDIUMTEXT | 可空 | 用户输入的文本 |
| `images` | MEDIUMTEXT | 可空 | JSON：图片引用（存储 key 或 base64） |
| `files` | MEDIUMTEXT | 可空 | JSON：`[{name, extractedText}]` |
| `student_status` | MEDIUMTEXT | 可空 | 提交时的学生状态快照 |
| `system_prompt` | MEDIUMTEXT | 可空 | 完整系统提示词快照 |
| `result_correction` | MEDIUMTEXT | 可空 | AI 批改结果（给学生的） |
| `result_status_update` | MEDIUMTEXT | 可空 | AI 状态更新（给学生管理系统的） |
| `ai_model` | VARCHAR(128) | 可空 | 使用的 AI 模型 |
| `task_status` | VARCHAR(20) | NOT NULL, 默认 'pending' | 任务状态 |
| `error_message` | TEXT | 可空 | 错误信息 |
| `streaming_chars` | INT | 默认 0 | 流式接收字符数 |
| `auto_imported` | INT | 默认 0 | 是否已自动推送（0/1） |
| `import_entry_id` | INT | 可空 | 推送后的条目 ID |
| `created_at` | TIMESTAMP | NOT NULL | 创建时间 |
| `updated_at` | TIMESTAMP | NOT NULL, 自动更新 | 最后更新时间 |
| `completed_at` | TIMESTAMP | 可空 | 完成时间 |

**索引：** `idx_corr_userId` (user_id)

**自动清理：** 3 天以上的旧任务自动删除。

**AI 输出拆分：** AI 返回的内容通过 `=== 批改内容 ===` 和 `=== 状态更新 ===` 分隔符拆分为两部分，分别存入 `result_correction` 和 `result_status_update`。

---

### 4.3.11 grading_tasks — 一键打分任务表

| 列名 | 类型 | 约束 | 说明 |
|------|------|------|------|
| `id` | INT | PK, AUTO_INCREMENT | 自增主键 |
| `user_id` | INT | NOT NULL | 所属教师 |
| `start_date` | VARCHAR(10) | NOT NULL | 日期范围起始（YYYY-MM-DD） |
| `end_date` | VARCHAR(10) | NOT NULL | 日期范围结束 |
| `grading_prompt` | MEDIUMTEXT | NOT NULL | 打分要求 |
| `user_notes` | TEXT | 可空 | 备注 |
| `student_count` | INT | 默认 0 | 涉及学生数 |
| `system_prompt` | MEDIUMTEXT | 可空 | 完整系统提示词快照 |
| `result` | MEDIUMTEXT | 可空 | AI 打分结果 |
| `edited_result` | MEDIUMTEXT | 可空 | 教师编辑后的版本 |
| `ai_model` | VARCHAR(128) | 可空 | 使用的 AI 模型 |
| `task_status` | VARCHAR(20) | NOT NULL, 默认 'pending' | 任务状态 |
| `error_message` | TEXT | 可空 | 错误信息 |
| `streaming_chars` | INT | 默认 0 | 流式字符数 |
| `sync_status` | VARCHAR(20) | 可空 | 同步状态：null / syncing / completed / failed |
| `sync_total` | INT | 默认 0 | 需同步的学生总数 |
| `sync_completed` | INT | 默认 0 | 已同步成功数 |
| `sync_failed` | INT | 默认 0 | 同步失败数 |
| `sync_error` | TEXT | 可空 | 同步错误信息 |
| `sync_system_prompt` | MEDIUMTEXT | 可空 | 同步使用的系统提示词 |
| `sync_concurrency` | INT | 默认 20 | 同步并发数 |
| `sync_imported` | VARCHAR(20) | 可空 | null / 'imported' |
| `created_at` | TIMESTAMP | NOT NULL | 创建时间 |
| `updated_at` | TIMESTAMP | NOT NULL, 自动更新 | 最后更新时间 |
| `completed_at` | TIMESTAMP | 可空 | 完成时间 |

**索引：** `idx_grading_userId` (user_id)

**数据保留：** 180 天。

### 4.3.12 grading_sync_items — 打分同步子任务表

| 列名 | 类型 | 约束 | 说明 |
|------|------|------|------|
| `id` | INT | PK, AUTO_INCREMENT | 自增主键 |
| `grading_task_id` | INT | NOT NULL | 父任务 ID |
| `student_id` | INT | NOT NULL | 学生 ID（hw_students.id） |
| `student_name` | VARCHAR(64) | NOT NULL | 学生姓名（冗余，方便查询） |
| `status` | VARCHAR(20) | NOT NULL, 默认 'pending' | 同步状态 |
| `chars` | INT | 默认 0 | 流式字符数 |
| `result` | MEDIUMTEXT | 可空 | AI 生成的更新后状态文档 |
| `error` | TEXT | 可空 | 错误信息 |
| `started_at` | TIMESTAMP | 可空 | 开始时间 |
| `completed_at` | TIMESTAMP | 可空 | 完成时间 |
| `created_at` | TIMESTAMP | NOT NULL | 创建时间 |
| `updated_at` | TIMESTAMP | NOT NULL, 自动更新 | 最后更新时间 |

**索引：** `idx_sync_grading_id` (grading_task_id) — 按父任务查询

**与 grading_tasks 的关系：** 一对多。一个打分任务对应 N 个同步子项（N = 学生数）。

---

### 4.3.13 reminder_tasks — 作业提醒任务表

| 列名 | 类型 | 约束 | 说明 |
|------|------|------|------|
| `id` | INT | PK, AUTO_INCREMENT | 自增主键 |
| `user_id` | INT | NOT NULL | 所属教师 |
| `reminder_prompt` | MEDIUMTEXT | NOT NULL | 提醒要求 |
| `student_count` | INT | 默认 0 | 涉及学生数 |
| `student_data` | MEDIUMTEXT | 可空 | 发送给 AI 的学生数据快照 |
| `system_prompt` | MEDIUMTEXT | 可空 | 完整系统提示词快照 |
| `result` | MEDIUMTEXT | 可空 | AI 生成的提醒文案 |
| `ai_model` | VARCHAR(128) | 可空 | 使用的 AI 模型 |
| `task_status` | VARCHAR(20) | NOT NULL, 默认 'pending' | 任务状态 |
| `error_message` | TEXT | 可空 | 错误信息 |
| `streaming_chars` | INT | 默认 0 | 流式字符数 |
| `created_at` | TIMESTAMP | NOT NULL | 创建时间 |
| `updated_at` | TIMESTAMP | NOT NULL, 自动更新 | 最后更新时间 |
| `completed_at` | TIMESTAMP | 可空 | 完成时间 |

**索引：** `idx_reminder_userId` (user_id)

**数据保留：** 30 天。

---

## 4.4 表关系图

```
users (1)
  ├── (1:N) user_config           用户级配置
  ├── (1:1) google_tokens         Drive 授权
  ├── (1:N) background_tasks      后台任务
  ├── (1:N) batch_tasks           批量任务
  │         └── (1:N) batch_task_items  子项
  ├── (1:N) hw_students           学生名册
  ├── (1:N) hw_entries            预入库队列
  ├── (1:N) correction_tasks      批改任务
  ├── (1:N) grading_tasks         打分任务
  │         └── (1:N) grading_sync_items  同步子项
  └── (1:N) reminder_tasks        提醒任务

system_config                      系统级配置（无用户关联）
```

> **注意：** 表之间没有使用数据库级外键约束（FOREIGN KEY）。关联关系通过应用层代码保证。这是刻意的设计决策 — 简化迁移复杂度，避免级联删除的不可控风险。

---

## 4.5 数据库迁移

### 迁移策略

系统不使用 Drizzle Kit 的自动迁移（因为本地没有 `DATABASE_URL`），而是采用以下方式：

1. **`CREATE TABLE IF NOT EXISTS`** — 服务启动时自动建表（幂等操作）
2. **`ALTER TABLE ... ADD COLUMN`** — 新增列时捕获 "Duplicate column" 错误忽略
3. **手写 SQL 迁移文件** — 放在 `drizzle/` 目录下，仅供参考和归档

### 迁移文件一览

| 文件 | 内容 |
|------|------|
| `0000_*.sql` | 创建 users 表 |
| `0001_*.sql` | 创建 system_config、user_config 表 |
| `0002_*.sql` | 创建 google_tokens 表 |
| `0003_*.sql` | 创建 background_tasks 表，system_config.value 改为 MEDIUMTEXT |
| `0004_*.sql` | 创建 hw_students、hw_entries 表 |
| `0005_*.sql` | hw_students 新增 current_status 列 |
| `0006_*.sql` | 创建 batch_tasks、batch_task_items 表 |
| `0007_*.sql` | 创建 correction_tasks 表 |
| `0008_*.sql` | background_tasks 重建为 MEDIUMTEXT；hw_entries/correction_tasks 新增 streaming_chars |
| `0009_*.sql` | 重建作业管理表（IF NOT EXISTS） |
| `0010_*.sql` | 重建批量任务表（IF NOT EXISTS） |
| `0011_*.sql` | 重建 correction_tasks（新增 user_id） |
| `0012_*.sql` | users.email 添加 UNIQUE INDEX |
| `0013_*.sql` | correction_tasks 修复：新增 user_id、streaming_chars；completed_at 改为可空 |

> **关键规则：** drizzle/ 目录下的已有文件**禁止删除和修改**，只允许新增。

---

## 4.6 通用设计模式

### 4.6.1 任务状态管理

所有异步任务表共享统一的状态模式：

```
任务创建 → pending（等待开始）
         → processing/running（执行中）
         → completed（成功）
         → failed（失败，可重试）
         → partial（部分成功，仅 background_tasks）
         → cancelled/stopped（用户取消，仅 batch_tasks）
```

### 4.6.2 时间戳三件套

所有任务表都包含三个标准时间戳：

| 字段 | 行为 | 用途 |
|------|------|------|
| `created_at` | 创建时写入一次 | 任务创建时间 |
| `updated_at` | 每次 UPDATE 自动刷新 | 最后活动时间（用于检测卡死） |
| `completed_at` | 任务完成时写入 | 计算总耗时 |

### 4.6.3 流式进度追踪

需要实时进度的表（hw_entries、correction_tasks、grading_tasks、reminder_tasks）都包含 `streaming_chars` 字段：

- AI 流式输出时，每 1 秒更新一次该字段
- 前端通过轮询读取该字段，显示"已生成 N 字符"
- 任务完成后该字段保留最终值

### 4.6.4 JSON 序列化存储

大量数据通过 MEDIUMTEXT + JSON 序列化存储：

| 字段模式 | 示例 | 说明 |
|----------|------|------|
| `input_params` | background_tasks, batch_tasks | 保存完整的请求参数快照 |
| `step_results` | background_tasks | 保存各步骤的执行结果 |
| `system_prompt` | correction_tasks, grading_tasks | 保存 AI 提示词（审计用） |
| `images`, `files` | correction_tasks | 保存多模态输入引用 |
| `student_data` | reminder_tasks | 保存发送给 AI 的数据快照 |

> **设计考量：** 使用 JSON 而非关联表的原因是这些数据结构频繁变化、一次性写入后不再修改、且不需要按内容查询。JSON 存储在这种场景下比范式化更实用。

### 4.6.5 数据隔离

除了 `users` 和 `system_config` 表外，所有表都包含 `user_id` 列：

- 每次 SELECT 必须附加 `WHERE user_id = ?`
- 每次 INSERT 必须写入当前用户的 `user_id`
- 管理员通过伪装登录（切换 Session）间接访问其他用户数据，而非直接绕过隔离
