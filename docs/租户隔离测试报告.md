# å¤šç§Ÿæˆ·éš”ç¦»æµ‹è¯•æŠ¥å‘Š

> ç”Ÿæˆæ—¥æœŸï¼š2026-02-14
> æµ‹è¯•æ¡†æ¶ï¼šVitest 2.1.9
> æµ‹è¯•ç»“æœï¼š**230 / 230 å…¨éƒ¨é€šè¿‡**
> ä¿®å¤æ¼æ´ï¼š**1 ä¸ªé«˜å±æ¼æ´å·²ä¿®å¤**

---

## ä¸€ã€æ€»ä½“æ¶æ„æ€ç»´å¯¼å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    FEEDBACK-MVP å¤šç§Ÿæˆ·éš”ç¦»æ¶æ„                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â–¼                       â–¼                       â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ è®¤è¯å±‚  â”‚           â”‚  æˆæƒå±‚    â”‚           â”‚  æ•°æ®å±‚    â”‚
   â”‚ (Auth)  â”‚           â”‚  (RBAC)   â”‚           â”‚ (Isolation)â”‚
   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
        â”‚                      â”‚                       â”‚
   â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”
   â”‚JWT+Cookieâ”‚           â”‚ 3å±‚æƒé™  â”‚           â”‚ userId     â”‚
   â”‚ ä¼šè¯ç®¡ç† â”‚           â”‚ ä¸­é—´ä»¶   â”‚           â”‚ å­—æ®µéš”ç¦»   â”‚
   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
        â”‚                     â”‚                      â”‚
   â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚â€¢ app_session_id â”‚  â”‚â€¢ publicProcedure â”‚  â”‚â€¢ æ‰€æœ‰è¡¨å¸¦ userId â”‚
   â”‚  (Cookie 1å¹´)   â”‚  â”‚  (å…¬å¼€)          â”‚  â”‚â€¢ æ‰€æœ‰æŸ¥è¯¢åŠ       â”‚
   â”‚â€¢ HS256 JWTç­¾å  â”‚  â”‚â€¢ protectedProc   â”‚  â”‚  WHERE userId=X â”‚
   â”‚â€¢ openId+appId   â”‚  â”‚  (éœ€ç™»å½•)        â”‚  â”‚â€¢ çº§è”åˆ é™¤ä¿éšœ    â”‚
   â”‚  èº«ä»½æ ‡è¯†       â”‚  â”‚â€¢ adminProcedure  â”‚  â”‚  æ•°æ®å®Œæ•´æ€§      â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  (éœ€ç®¡ç†å‘˜)      â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## äºŒã€æ•°æ®éš”ç¦»çŸ©é˜µ

### 2.1 æ•°æ®åº“è¡¨ Ã— ç§Ÿæˆ·éš”ç¦»çŠ¶æ€

| # | è¡¨å | userIdåˆ— | æŸ¥è¯¢è¿‡æ»¤ | çº§è”åˆ é™¤ | éš”ç¦»çŠ¶æ€ |
|---|------|----------|----------|----------|----------|
| 1 | `users` | è‡ªèº«ä¸»é”® | N/A | è§¦å‘å…¨é‡æ¸…ç† | âœ… å®‰å…¨ |
| 2 | `user_config` | âœ… userId | âœ… eq(userId) | âœ… éšç”¨æˆ·åˆ é™¤ | âœ… å®‰å…¨ |
| 3 | `system_config` | âŒ å…¨å±€å…±äº« | N/A (ç®¡ç†å‘˜) | N/A | âœ… è®¾è®¡å¦‚æ­¤ |
| 4 | `google_tokens` | âœ… userId (UNIQUE) | âœ… eq(userId) | âœ… éšç”¨æˆ·åˆ é™¤ | âœ… å®‰å…¨ |
| 5 | `hw_students` | âœ… userId | âœ… eq(userId) | âœ… éšç”¨æˆ·åˆ é™¤ | âœ… å®‰å…¨ |
| 6 | `hw_entries` | âœ… userId | âœ… eq(userId) | âœ… éšç”¨æˆ·åˆ é™¤ | âœ… å®‰å…¨ |
| 7 | `background_tasks` | âœ… userId | âœ… and(eq(id), eq(userId)) | âœ… éšç”¨æˆ·åˆ é™¤ | âœ… å®‰å…¨ |
| 8 | `batch_tasks` | âœ… userId | âœ… and(eq(id), eq(userId)) | âœ… éšç”¨æˆ·åˆ é™¤ | âœ… å®‰å…¨ |
| 9 | `batch_task_items` | âŒ é€šè¿‡batchIdéšå¼ | âœ… å…ˆéªŒè¯batchå½’å± | âœ… çº§è”æ¸…ç† | âœ… å®‰å…¨ |
| 10 | `correction_tasks` | âœ… userId | âœ… eq(userId) | âœ… éšç”¨æˆ·åˆ é™¤ | âœ… å®‰å…¨ |
| 11 | `grading_tasks` | âœ… userId | âœ… eq(userId) | âœ… éšç”¨æˆ·åˆ é™¤ | âœ… å®‰å…¨ |
| 12 | `grading_sync_items` | âŒ é€šè¿‡gradingTaskIdéšå¼ | âœ… å…ˆéªŒè¯taskå½’å± | âœ… çº§è”æ¸…ç† | âœ… å®‰å…¨ |

### 2.2 éš”ç¦»æ–¹å¼åˆ†ç±»

```
æ•°æ®éš”ç¦»å±‚çº§ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Level 1: ç›´æ¥éš”ç¦»ï¼ˆè¡¨æœ‰ userId åˆ—ï¼‰                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ user_config, google_tokens, hw_students,     â”‚   â”‚
â”‚  â”‚ hw_entries, background_tasks, batch_tasks,   â”‚   â”‚
â”‚  â”‚ correction_tasks, grading_tasks              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                     â”‚
â”‚  Level 2: é—´æ¥éš”ç¦»ï¼ˆé€šè¿‡çˆ¶è¡¨çš„ userId é—´æ¥å…³è”ï¼‰         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ batch_task_items (via batchId â†’ batch_tasks)  â”‚   â”‚
â”‚  â”‚ grading_sync_items (via gradingTaskId)        â”‚   â”‚
â”‚  â”‚   â†³ APIå±‚å…ˆéªŒè¯çˆ¶è¡¨å½’å±ï¼Œå†æŸ¥å­è¡¨              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                     â”‚
â”‚  Level 3: å…¨å±€å…±äº«ï¼ˆæ‰€æœ‰ç”¨æˆ·å¯è§ï¼‰                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ system_config                                â”‚   â”‚
â”‚  â”‚   â†³ ä»…ç®¡ç†å‘˜å¯å†™ï¼Œæ‰€æœ‰ç”¨æˆ·å¯è¯»ï¼ˆé…ç½®å›é€€ï¼‰      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ä¸‰ã€è½¯é…ç½®ä¸‰çº§å›é€€æœºåˆ¶

### 3.1 é…ç½®å›é€€æµç¨‹å›¾

```
ç”¨æˆ·è¯·æ±‚é…ç½®å€¼: getConfigValue("apiModel", userId=42)
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 1: æŸ¥ user_config â”‚
â”‚ WHERE userId=42    â”‚
â”‚ AND key="apiModel" â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
     æœ‰å€¼ï¼Ÿâ”€â”€â”€â”€ YES â”€â”€â†’ è¿”å›ç”¨æˆ·è‡ªå®šä¹‰å€¼ âœ…
        â”‚
       NO
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 2: æŸ¥ system_config â”‚
â”‚ WHERE key="apiModel"     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
     æœ‰å€¼ï¼Ÿâ”€â”€â”€â”€ YES â”€â”€â†’ è¿”å›ç³»ç»Ÿå…¨å±€å€¼ âœ…
        â”‚
       NO
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 3: DEFAULT_CONFIG â”‚
â”‚ ä»£ç ç¡¬ç¼–ç é»˜è®¤å€¼    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
  è¿”å›é»˜è®¤å€¼ âœ…
```

### 3.2 å¯é…ç½®é¡¹å®Œæ•´åˆ—è¡¨

| é…ç½®é”® | ç”¨é€” | é»˜è®¤å€¼ | ç”¨æˆ·å¯è¦†ç›– | éš”ç¦»éªŒè¯ |
|--------|------|--------|------------|----------|
| `apiModel` | AIæ¨¡å‹é€‰æ‹© | claude-sonnet-4-5-20250929 | âœ… | âœ… å·²æµ‹è¯• |
| `apiKey` | APIå¯†é’¥ | env.WHATAI_API_KEY | âœ… | âœ… å·²æµ‹è¯• |
| `apiUrl` | APIåœ°å€ | DMXapi.com/v1 | âœ… | âœ… å·²æµ‹è¯• |
| `currentYear` | å­¦å¹´ | 2026 | âœ… | âœ… å·²æµ‹è¯• |
| `roadmap` | ä¸€å¯¹ä¸€è·¯ä¹¦ | "" | âœ… | âœ… å·²æµ‹è¯• |
| `roadmapClass` | å°ç­è¯¾è·¯ä¹¦ | "" | âœ… | âœ… å·²æµ‹è¯• |
| `driveBasePath` | Google Driveè·¯å¾„ | Mac/Documents/XDF/... | âœ… | âœ… å·²æµ‹è¯• |
| `classStoragePath` | å°ç­è¯¾å­˜å‚¨è·¯å¾„ | "" | âœ… | âœ… å·²æµ‹è¯• |
| `maxTokens` | LLMæœ€å¤§Token | 64000 | âœ… | âœ… å·²æµ‹è¯• |
| `batchConcurrency` | æ‰¹é‡å¹¶å‘æ•° | 50 | âœ… | âœ… å·²æµ‹è¯• |
| `hwAiModel` | å­¦ç”Ÿç®¡ç†AIæ¨¡å‹ | "" | âœ… | âœ… å·²æµ‹è¯• |
| `hwPromptTemplate` | è‡ªå®šä¹‰æç¤ºè¯ | "" | âœ… | âœ… å·²æµ‹è¯• |
| `gradingPrompt` | æ‰“åˆ†æç¤ºè¯ | "" | âœ… | âœ… å·²æµ‹è¯• |
| `gradingYear` | æ‰“åˆ†å­¦å¹´ | "" | âœ… | âœ… å·²æµ‹è¯• |
| `gradingSyncPrompt` | åŒæ­¥æç¤ºè¯ | "" | âœ… | âœ… å·²æµ‹è¯• |
| `gradingSyncConcurrency` | åŒæ­¥å¹¶å‘æ•° | 20 | âœ… | âœ… å·²æµ‹è¯• |
| `correctionTypes` | æ‰¹æ”¹ç±»å‹åˆ—è¡¨ | JSONé»˜è®¤å€¼ | âœ… | âœ… å·²æµ‹è¯• |
| `correctionPrompt` | é€šç”¨æ‰¹æ”¹æç¤ºè¯ | å†…ç½®é»˜è®¤ | âœ… | âœ… å·²æµ‹è¯• |
| `modelPresets` | æ¨¡å‹é¢„è®¾åˆ—è¡¨ | "" | âœ… | âœ… å·²æµ‹è¯• |
| `allowedEmails` | é‚®ç®±ç™½åå• | JSONæ•°ç»„ | âŒ ä»…ç®¡ç†å‘˜ | âœ… å®‰å…¨ |
| `studentLessonHistory` | è¯¾ç¨‹å†å² | "" | âœ… | âœ… å·²æµ‹è¯• |

---

## å››ã€API è·¯ç”±éš”ç¦»å®¡è®¡

### 4.1 tRPC è·¯ç”±ï¼ˆå…¨éƒ¨ protectedProcedure æˆ– adminProcedureï¼‰

```
APIè·¯ç”±éš”ç¦»çŠ¶æ€æ€»è§ˆï¼š

â”œâ”€â”€ auth (è®¤è¯æ¨¡å—)
â”‚   â”œâ”€â”€ me â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ protectedProcedure â”€â”€â”€â”€ ctx.user â”€â”€â”€â”€ âœ… å®‰å…¨
â”‚   â”œâ”€â”€ login â”€â”€â”€â”€â”€â”€â”€â”€â”€ publicProcedure â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ âœ… å®‰å…¨
â”‚   â””â”€â”€ logout â”€â”€â”€â”€â”€â”€â”€â”€ protectedProcedure â”€â”€â”€â”€ ctx.user â”€â”€â”€â”€ âœ… å®‰å…¨
â”‚
â”œâ”€â”€ config (è½¯é…ç½®æ¨¡å—)
â”‚   â”œâ”€â”€ getAll â”€â”€â”€â”€â”€â”€â”€â”€ adminProcedure â”€â”€â”€â”€â”€â”€â”€ ç®¡ç†å‘˜ä¸“å± â”€â”€â”€ âœ… å®‰å…¨
â”‚   â”œâ”€â”€ update â”€â”€â”€â”€â”€â”€â”€â”€ adminProcedure â”€â”€â”€â”€â”€â”€â”€ ç®¡ç†å‘˜ä¸“å± â”€â”€â”€ âœ… å®‰å…¨
â”‚   â”œâ”€â”€ reset â”€â”€â”€â”€â”€â”€â”€â”€â”€ adminProcedure â”€â”€â”€â”€â”€â”€â”€ ç®¡ç†å‘˜ä¸“å± â”€â”€â”€ âœ… å®‰å…¨
â”‚   â”œâ”€â”€ updateMyConfig â”€ protectedProc â”€â”€â”€â”€â”€â”€â”€ ctx.user.id â”€â”€ âœ… å®‰å…¨
â”‚   â””â”€â”€ resetMyConfig â”€â”€ protectedProc â”€â”€â”€â”€â”€â”€â”€ ctx.user.id â”€â”€ âœ… å®‰å…¨
â”‚
â”œâ”€â”€ bgTask (åå°ä»»åŠ¡æ¨¡å—)
â”‚   â”œâ”€â”€ submit â”€â”€â”€â”€â”€â”€â”€â”€ protectedProc â”€â”€ ctx.user.id â”€â”€â”€â”€â”€â”€â”€â”€ âœ… å®‰å…¨
â”‚   â”œâ”€â”€ list â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ protectedProc â”€â”€ eq(userId) â”€â”€â”€â”€â”€â”€â”€â”€â”€ âœ… å®‰å…¨
â”‚   â”œâ”€â”€ feedbackContent  protectedProc â”€â”€ and(eq(id),eq(uid)) âœ… å®‰å…¨
â”‚   â”œâ”€â”€ extractionContent protectedProc â”€ and(eq(id),eq(uid)) âœ… å®‰å…¨
â”‚   â”œâ”€â”€ inputMaterials â”€ protectedProc â”€â”€ and(eq(id),eq(uid)) âœ… å®‰å…¨
â”‚   â””â”€â”€ cancel â”€â”€â”€â”€â”€â”€â”€â”€ protectedProc â”€â”€ and(eq(id),eq(uid)) âœ… å®‰å…¨
â”‚
â”œâ”€â”€ batchTask (æ‰¹é‡ä»»åŠ¡ tRPCæ¨¡å—)
â”‚   â”œâ”€â”€ submit â”€â”€â”€â”€â”€â”€â”€â”€ protectedProc â”€â”€ ctx.user.id â”€â”€â”€â”€â”€â”€â”€â”€ âœ… å®‰å…¨
â”‚   â”œâ”€â”€ history â”€â”€â”€â”€â”€â”€â”€ protectedProc â”€â”€ eq(userId) â”€â”€â”€â”€â”€â”€â”€â”€â”€ âœ… å®‰å…¨
â”‚   â”œâ”€â”€ items â”€â”€â”€â”€â”€â”€â”€â”€â”€ protectedProc â”€â”€ å…ˆéªŒè¯batchå½’å± â”€â”€â”€â”€ âœ… å®‰å…¨
â”‚   â”œâ”€â”€ retryItem â”€â”€â”€â”€â”€ protectedProc â”€â”€ å…ˆéªŒè¯batchå½’å± â”€â”€â”€â”€ âœ… å®‰å…¨
â”‚   â””â”€â”€ cancel â”€â”€â”€â”€â”€â”€â”€â”€ protectedProc â”€â”€ and(eq(id),eq(uid)) âœ… å®‰å…¨
â”‚
â”œâ”€â”€ homework (å­¦ç”Ÿç®¡ç†æ¨¡å—)
â”‚   â”œâ”€â”€ listStudents â”€â”€ protectedProc â”€â”€ ctx.user.id â”€â”€â”€â”€â”€â”€â”€â”€ âœ… å®‰å…¨
â”‚   â”œâ”€â”€ addStudent â”€â”€â”€â”€ protectedProc â”€â”€ ctx.user.id â”€â”€â”€â”€â”€â”€â”€â”€ âœ… å®‰å…¨
â”‚   â”œâ”€â”€ updateStudent â”€ protectedProc â”€â”€ ctx.user.id â”€â”€â”€â”€â”€â”€â”€â”€ âœ… å®‰å…¨
â”‚   â”œâ”€â”€ removeStudent â”€ protectedProc â”€â”€ ctx.user.id â”€â”€â”€â”€â”€â”€â”€â”€ âœ… å®‰å…¨
â”‚   â”œâ”€â”€ submitEntry â”€â”€â”€ protectedProc â”€â”€ ctx.user.id â”€â”€â”€â”€â”€â”€â”€â”€ âœ… å®‰å…¨
â”‚   â”œâ”€â”€ listPendingEntries protectedProc ctx.user.id â”€â”€â”€â”€â”€â”€â”€â”€ âœ… å®‰å…¨
â”‚   â”œâ”€â”€ listEntries â”€â”€â”€ protectedProc â”€â”€ ctx.user.id â”€â”€â”€â”€â”€â”€â”€â”€ âœ… å®‰å…¨
â”‚   â”œâ”€â”€ confirmEntries â”€ protectedProc â”€â”€ ctx.user.id â”€â”€â”€â”€â”€â”€â”€ âœ… å®‰å…¨
â”‚   â”œâ”€â”€ deleteEntry â”€â”€â”€ protectedProc â”€â”€ ctx.user.id â”€â”€â”€â”€â”€â”€â”€â”€ âœ… å®‰å…¨
â”‚   â”œâ”€â”€ retryEntry â”€â”€â”€â”€ protectedProc â”€â”€ ctx.user.id â”€â”€â”€â”€â”€â”€â”€â”€ âœ… å®‰å…¨
â”‚   â”œâ”€â”€ getConfig â”€â”€â”€â”€â”€ protectedProc â”€â”€ ctx.user.id â”€â”€â”€â”€â”€â”€â”€â”€ âœ… å®‰å…¨
â”‚   â”œâ”€â”€ updateConfig â”€â”€ protectedProc â”€â”€ ctx.user.id â”€â”€â”€â”€â”€â”€â”€â”€ âœ… å®‰å…¨
â”‚   â”œâ”€â”€ submitGrading â”€ protectedProc â”€â”€ ctx.user.id â”€â”€â”€â”€â”€â”€â”€â”€ âœ… å®‰å…¨
â”‚   â”œâ”€â”€ getGradingTask â”€ protectedProc â”€â”€ ctx.user.id â”€â”€â”€â”€â”€â”€â”€ âœ… å®‰å…¨
â”‚   â”œâ”€â”€ listGradingTasks protectedProc â”€â”€ ctx.user.id â”€â”€â”€â”€â”€â”€â”€ âœ… å®‰å…¨
â”‚   â”œâ”€â”€ syncGradingToStudents protectedProc ctx.user.id â”€â”€â”€â”€â”€ âœ… å®‰å…¨
â”‚   â”œâ”€â”€ getSyncItems â”€â”€ protectedProc â”€â”€ ctx.user.id â”€â”€â”€â”€â”€â”€â”€â”€ âœ… å®‰å…¨
â”‚   â”œâ”€â”€ exportBackup â”€â”€ protectedProc â”€â”€ ctx.user.id â”€â”€â”€â”€â”€â”€â”€â”€ âœ… å®‰å…¨
â”‚   â””â”€â”€ importBackup â”€â”€ protectedProc â”€â”€ ctx.user.id â”€â”€â”€â”€â”€â”€â”€â”€ âœ… å®‰å…¨
â”‚
â”œâ”€â”€ correction (æ‰¹æ”¹æ¨¡å—)
â”‚   â”œâ”€â”€ submit â”€â”€â”€â”€â”€â”€â”€â”€ protectedProc â”€â”€ ctx.user.id â”€â”€â”€â”€â”€â”€â”€â”€ âœ… å®‰å…¨
â”‚   â”œâ”€â”€ getTask â”€â”€â”€â”€â”€â”€â”€ protectedProc â”€â”€ ctx.user.id â”€â”€â”€â”€â”€â”€â”€â”€ âœ… å®‰å…¨
â”‚   â”œâ”€â”€ listTasks â”€â”€â”€â”€â”€ protectedProc â”€â”€ ctx.user.id â”€â”€â”€â”€â”€â”€â”€â”€ âœ… å®‰å…¨
â”‚   â”œâ”€â”€ getTypes â”€â”€â”€â”€â”€â”€ protectedProc â”€â”€ ctx.user.id â”€â”€â”€â”€â”€â”€â”€â”€ âœ… å®‰å…¨
â”‚   â”œâ”€â”€ updateTypes â”€â”€â”€ protectedProc â”€â”€ ctx.user.id â”€â”€â”€â”€â”€â”€â”€â”€ âœ… å®‰å…¨
â”‚   â”œâ”€â”€ getPrompt â”€â”€â”€â”€â”€ protectedProc â”€â”€ ctx.user.id â”€â”€â”€â”€â”€â”€â”€â”€ âœ… å®‰å…¨
â”‚   â””â”€â”€ updatePrompt â”€â”€ protectedProc â”€â”€ ctx.user.id â”€â”€â”€â”€â”€â”€â”€â”€ âœ… å®‰å…¨
â”‚
â”œâ”€â”€ feedback (åé¦ˆç”Ÿæˆæ¨¡å—)
â”‚   â”œâ”€â”€ generateFeedback  protectedProc  ctx.user.id â”€â”€â”€â”€â”€â”€â”€â”€ âœ… å®‰å…¨
â”‚   â”œâ”€â”€ generateReview â”€â”€ protectedProc  ctx.user.id â”€â”€â”€â”€â”€â”€â”€â”€ âœ… å®‰å…¨
â”‚   â”œâ”€â”€ generateTest â”€â”€â”€â”€ protectedProc  ctx.user.id â”€â”€â”€â”€â”€â”€â”€â”€ âœ… å®‰å…¨
â”‚   â”œâ”€â”€ generateExtraction protectedProc ctx.user.id â”€â”€â”€â”€â”€â”€â”€â”€ âœ… å®‰å…¨
â”‚   â”œâ”€â”€ generateBubbleChart protectedProc ctx.user.id â”€â”€â”€â”€â”€â”€â”€ âœ… å®‰å…¨
â”‚   â””â”€â”€ uploadBubbleChart  protectedProc ctx.user.id â”€â”€â”€â”€â”€â”€â”€â”€ âœ… å®‰å…¨
â”‚
â”œâ”€â”€ googleAuth (Google Driveæˆæƒ)
â”‚   â”œâ”€â”€ status â”€â”€â”€â”€â”€â”€â”€â”€ protectedProc â”€â”€ ctx.user.id â”€â”€â”€â”€â”€â”€â”€â”€ âœ… å®‰å…¨
â”‚   â”œâ”€â”€ getUrl â”€â”€â”€â”€â”€â”€â”€â”€ protectedProc â”€â”€ ctx.user.id â”€â”€â”€â”€â”€â”€â”€â”€ âœ… å®‰å…¨
â”‚   â”œâ”€â”€ callback â”€â”€â”€â”€â”€â”€ protectedProc â”€â”€ ctx.user.id â”€â”€â”€â”€â”€â”€â”€â”€ âœ… å®‰å…¨
â”‚   â””â”€â”€ disconnect â”€â”€â”€â”€ protectedProc â”€â”€ ctx.user.id â”€â”€â”€â”€â”€â”€â”€â”€ âœ… å®‰å…¨
â”‚
â””â”€â”€ admin (ç®¡ç†å‘˜æ¨¡å—)
    â”œâ”€â”€ listUsers â”€â”€â”€â”€â”€ adminProcedure â”€â”€â”€ ç®¡ç†å‘˜ä¸“å± â”€â”€â”€â”€â”€â”€â”€ âœ… å®‰å…¨
    â”œâ”€â”€ createUser â”€â”€â”€â”€ adminProcedure â”€â”€â”€ ç®¡ç†å‘˜ä¸“å± â”€â”€â”€â”€â”€â”€â”€ âœ… å®‰å…¨
    â”œâ”€â”€ updateUser â”€â”€â”€â”€ adminProcedure â”€â”€â”€ ç®¡ç†å‘˜ä¸“å± â”€â”€â”€â”€â”€â”€â”€ âœ… å®‰å…¨
    â”œâ”€â”€ suspendUser â”€â”€â”€ adminProcedure â”€â”€â”€ ç®¡ç†å‘˜ä¸“å± â”€â”€â”€â”€â”€â”€â”€ âœ… å®‰å…¨
    â”œâ”€â”€ activateUser â”€â”€ adminProcedure â”€â”€â”€ ç®¡ç†å‘˜ä¸“å± â”€â”€â”€â”€â”€â”€â”€ âœ… å®‰å…¨
    â”œâ”€â”€ deleteUser â”€â”€â”€â”€ adminProcedure â”€â”€â”€ çº§è”æ¸…ç† â”€â”€â”€â”€â”€â”€â”€â”€â”€ âœ… å®‰å…¨
    â””â”€â”€ impersonateUser adminProcedure â”€â”€â”€ ç®¡ç†å‘˜ä¸“å± â”€â”€â”€â”€â”€â”€â”€ âœ… å®‰å…¨
```

### 4.2 Express SSE è·¯ç”±å®¡è®¡

| è·¯ç”± | è®¤è¯ä¸­é—´ä»¶ | userIdæ ¡éªŒ | ä¿®å¤å‰çŠ¶æ€ | ä¿®å¤åçŠ¶æ€ |
|------|-----------|-----------|-----------|-----------|
| `POST /api/batch/generate-stream` | requireAuth | âœ… userIdä¼ å…¥æ‰§è¡Œ | âœ… å®‰å…¨ | âœ… å®‰å…¨ |
| `POST /api/batch/stop` | requireAuth | âŒ **æœªæ ¡éªŒå½’å±** | **ğŸ”´ é«˜å±æ¼æ´** | âœ… **å·²ä¿®å¤** |
| `GET /api/batch/status/:batchId` | requireAuth | âŒ **æœªæ ¡éªŒå½’å±** | **ğŸ”´ é«˜å±æ¼æ´** | âœ… **å·²ä¿®å¤** |
| `POST /api/class-feedback-stream` | requireAuth | âœ… userIdä¼ å…¥æ‰§è¡Œ | âœ… å®‰å…¨ | âœ… å®‰å…¨ |
| `GET /api/feedback-content/:id` | requireAuth | âš ï¸ UUIDä¿æŠ¤ | âš ï¸ ä½é£é™© | âš ï¸ ä½é£é™© |

---

## äº”ã€å‘ç°å¹¶ä¿®å¤çš„æ¼æ´

### 5.1 ğŸ”´ é«˜å±æ¼æ´ï¼šæ‰¹é‡ä»»åŠ¡ Express è·¯ç”±ç¼ºå°‘ userId æ ¡éªŒ

**æ–‡ä»¶**ï¼š`server/batch/batchRoutes.ts`

**é—®é¢˜æè¿°**ï¼š
`/api/batch/stop` å’Œ `/api/batch/status/:batchId` ä¸¤ä¸ªç«¯ç‚¹ä½¿ç”¨è¿›ç¨‹å…¨å±€çš„ `activeBatches` Mapï¼ˆä»¥ batchId ä¸º keyï¼‰ï¼Œä½†ä¸éªŒè¯è¯·æ±‚ç”¨æˆ·æ˜¯å¦æ˜¯æ‰¹æ¬¡çš„æ‰€æœ‰è€…ã€‚

**æ”»å‡»åœºæ™¯**ï¼š
```
ç”¨æˆ·A åˆ›å»ºæ‰¹é‡ä»»åŠ¡ â†’ batchId = "abc-123"
ç”¨æˆ·B çŸ¥é“ batchId å â†’ POST /api/batch/stop { batchId: "abc-123" }
â†’ ç”¨æˆ·B æˆåŠŸåœæ­¢äº†ç”¨æˆ·Açš„æ‰¹é‡ä»»åŠ¡ âŒ
â†’ ç”¨æˆ·B å¯ä»¥æŸ¥çœ‹ç”¨æˆ·Açš„ä»»åŠ¡è¿›åº¦å’Œæ–‡ä»¶URL âŒ
```

**ä¿®å¤æ–¹æ¡ˆ**ï¼ˆå·²å®æ–½ï¼‰ï¼š

1. **BatchStatus æ¥å£å¢åŠ  userId å­—æ®µ**ï¼š
```typescript
interface BatchStatus {
  batchId: string;
  userId: number;  // æ–°å¢ï¼šç§Ÿæˆ·éš”ç¦»
  // ...
}
```

2. **æ³¨å†Œæ‰¹æ¬¡æ—¶ç»‘å®š userId**ï¼š
```typescript
activeBatches.set(batchId, {
  batchId,
  userId,  // æ–°å¢ï¼šç»‘å®šåˆ›å»ºè€…
  // ...
});
```

3. **stop ç«¯ç‚¹å¢åŠ å½’å±æ ¡éªŒ**ï¼š
```typescript
if (batch.userId !== userId) {
  res.status(403).json({ error: "æ— æƒæ“ä½œæ­¤æ‰¹æ¬¡" });
  return;
}
```

4. **status ç«¯ç‚¹å¢åŠ å½’å±æ ¡éªŒ**ï¼š
```typescript
if (batchStatus.userId !== userId) {
  res.status(403).json({ success: false, error: "æ— æƒæŸ¥çœ‹æ­¤æ‰¹æ¬¡çŠ¶æ€" });
  return;
}
```

### 5.2 âš ï¸ ä½é£é™©è§‚å¯Ÿé¡¹

#### 5.2.1 æ—¥å¿—æ–‡ä»¶æ— ç”¨æˆ·éš”ç¦»

**æ–‡ä»¶**ï¼š`server/logger.ts`

**ç°çŠ¶**ï¼šæ‰€æœ‰ç”¨æˆ·çš„ç”Ÿæˆæ—¥å¿—å­˜å‚¨åœ¨åŒä¸€ä¸ª `logs/` ç›®å½•ï¼Œæ–‡ä»¶åæ ¼å¼ä¸º `{å­¦ç”Ÿå}_{sessionId}.log`ã€‚`getLatestLogPath()`ã€`listLogFiles()` è¿”å›æ‰€æœ‰ç”¨æˆ·çš„æ—¥å¿—ã€‚

**é£é™©ç­‰çº§**ï¼šâš ï¸ ä½
**åŸå› **ï¼šæ—¥å¿—å†…å®¹ä¸»è¦æ˜¯AIç”Ÿæˆè¿‡ç¨‹çš„æŠ€æœ¯ç»†èŠ‚ï¼ˆæ¨¡å‹å‚æ•°ã€æ­¥éª¤çŠ¶æ€ï¼‰ï¼Œä¸åŒ…å«æ•æ„Ÿä¸ªäººæ•°æ®ã€‚ä½†åœ¨ä¸¥æ ¼å¤šç§Ÿæˆ·åœºæ™¯ä¸‹ï¼Œåº”æŒ‰ç”¨æˆ·éš”ç¦»æ—¥å¿—ã€‚

**å»ºè®®ä¿®å¤æ–¹å‘**ï¼š
```
logs/
  â”œâ”€â”€ user_1/
  â”‚   â””â”€â”€ å¼ ä¸‰_abc123.log
  â””â”€â”€ user_2/
      â””â”€â”€ æå››_def456.log
```

#### 5.2.2 ContentStore æ— ç”¨æˆ·å½’å±

**æ–‡ä»¶**ï¼š`server/contentStore.ts`

**ç°çŠ¶**ï¼šå†…å­˜ä¸­çš„ `storeContent(taskId, content)` ä»¥ UUID taskId ä¸º keyï¼Œä¸è®°å½• userIdã€‚`retrieveContent(taskId)` ä¸éªŒè¯ç”¨æˆ·å½’å±ã€‚

**é£é™©ç­‰çº§**ï¼šâš ï¸ æä½
**åŸå› **ï¼štaskId æ˜¯å‰ç«¯ç”Ÿæˆçš„ UUIDï¼Œ30åˆ†é’Ÿè‡ªåŠ¨è¿‡æœŸï¼Œå®é™…è¢«çŒœä¸­çš„æ¦‚ç‡æä½ï¼ˆUUID v4 æœ‰ 2^122 ç§å¯èƒ½ï¼‰ã€‚

---

## å…­ã€æµ‹è¯•è¦†ç›–åº¦æŠ¥å‘Š

### 6.1 æµ‹è¯•æ–‡ä»¶ç»Ÿè®¡

| æµ‹è¯•æ–‡ä»¶ | æµ‹è¯•ç”¨ä¾‹æ•° | ç±»å‹ | çŠ¶æ€ |
|----------|-----------|------|------|
| `tenantIsolation.test.ts` | **83** | äº¤å‰éš”ç¦» + è½¯é…ç½® | âœ… å…¨éƒ¨é€šè¿‡ |
| `businessFlow.test.ts` | **100** | å…¨æµç¨‹ä¸šåŠ¡å›å½’ | âœ… å…¨éƒ¨é€šè¿‡ |
| `stressConcurrency.test.ts` | **47** | å‹åŠ› + å¹¶å‘ | âœ… å…¨éƒ¨é€šè¿‡ |
| **åˆè®¡** | **230** | | âœ… **å…¨éƒ¨é€šè¿‡** |

### 6.2 æµ‹è¯•åˆ†ç±»è¦†ç›–

```
æµ‹è¯•è¦†ç›–çŸ©é˜µï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”
â”‚ æµ‹è¯•ç»´åº¦                â”‚ å­¦ç”Ÿ â”‚ æ¡ç›® â”‚ æ‰“åˆ† â”‚ é…ç½® â”‚ æ‰¹é‡ â”‚
â”‚                        â”‚ ç®¡ç† â”‚ å¤„ç† â”‚ ç³»ç»Ÿ â”‚ ç³»ç»Ÿ â”‚ ä»»åŠ¡ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. è·¨ç§Ÿæˆ·è¯»å–éš”ç¦»       â”‚  âœ…  â”‚  âœ…  â”‚  âœ…  â”‚  âœ…  â”‚  âœ…  â”‚
â”‚ 2. è·¨ç§Ÿæˆ·å†™å…¥éš”ç¦»       â”‚  âœ…  â”‚  âœ…  â”‚  âœ…  â”‚  âœ…  â”‚  âœ…  â”‚
â”‚ 3. è·¨ç§Ÿæˆ·åˆ é™¤éš”ç¦»       â”‚  âœ…  â”‚  âœ…  â”‚  âœ…  â”‚  âœ…  â”‚  âœ…  â”‚
â”‚ 4. è½¯é…ç½®ä¸‰çº§å›é€€       â”‚  â”€   â”‚  â”€   â”‚  â”€   â”‚  âœ…  â”‚  â”€   â”‚
â”‚ 5. é…ç½®ä¿®æ”¹äº’ä¸å¹²æ‰°     â”‚  â”€   â”‚  â”€   â”‚  â”€   â”‚  âœ…  â”‚  â”€   â”‚
â”‚ 6. å…¨æµç¨‹ä¸šåŠ¡æ­£ç¡®æ€§     â”‚  âœ…  â”‚  âœ…  â”‚  âœ…  â”‚  âœ…  â”‚  âœ…  â”‚
â”‚ 7. å¹¶å‘æ“ä½œä¸ä¸²æ•°æ®     â”‚  âœ…  â”‚  âœ…  â”‚  âœ…  â”‚  âœ…  â”‚  âœ…  â”‚
â”‚ 8. é«˜è´Ÿè½½ä¸‹éš”ç¦»ç¨³å®š     â”‚  âœ…  â”‚  âœ…  â”‚  â”€   â”‚  âœ…  â”‚  âœ…  â”‚
â”‚ 9. ç«æ€æ¡ä»¶å®‰å…¨         â”‚  âœ…  â”‚  âœ…  â”‚  â”€   â”‚  âœ…  â”‚  â”€   â”‚
â”‚ 10. å¤‡ä»½å¯¼å…¥å¯¼å‡ºéš”ç¦»    â”‚  âœ…  â”‚  â”€   â”‚  â”€   â”‚  â”€   â”‚  â”€   â”‚
â”‚ 11. è¾¹ç•Œå€¼/å¼‚å¸¸è¾“å…¥     â”‚  âœ…  â”‚  âœ…  â”‚  âœ…  â”‚  âœ…  â”‚  âœ…  â”‚
â”‚ 12. è·¨æ¨¡å—ç»¼åˆéªŒè¯      â”‚  âœ…  â”‚  âœ…  â”‚  âœ…  â”‚  âœ…  â”‚  â”€   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”˜
```

### 6.3 è¯¦ç»†æµ‹è¯•æ¸…å•

#### äº¤å‰éš”ç¦»æµ‹è¯•ï¼ˆ83ä¸ªï¼‰
```
1.  å­¦ç”Ÿç®¡ç†ï¼š
    1.1  listStudents - ç”¨æˆ·1åªèƒ½çœ‹åˆ°è‡ªå·±çš„å­¦ç”Ÿ
    1.2  addStudent - ä¸åŒç”¨æˆ·å¯å„è‡ªåˆ›å»ºåŒåå­¦ç”Ÿ
    1.3  addStudent - æ’å…¥çš„å­¦ç”Ÿç»‘å®šæ­£ç¡®userId
    1.4  updateStudent - ç”¨æˆ·1ä¸èƒ½ä¿®æ”¹ç”¨æˆ·2çš„å­¦ç”Ÿ
    1.5  updateStudent - æˆåŠŸä¿®æ”¹æœ¬ç”¨æˆ·çš„å­¦ç”Ÿ
    1.6  removeStudent - ç”¨æˆ·1ä¸èƒ½åœç”¨ç”¨æˆ·2çš„å­¦ç”Ÿ
    1.7  removeStudent - æˆåŠŸåœç”¨æœ¬ç”¨æˆ·å­¦ç”Ÿ
    1.8  listEntries - ä»…è¿”å›æœ¬ç”¨æˆ·çš„æ¡ç›®
    1.9  listPendingEntries - ä»…è¿”å›æœ¬ç”¨æˆ·çš„å¾…ç¡®è®¤æ¡ç›®
    1.10 deleteEntry - ç”¨æˆ·1ä¸èƒ½åˆ é™¤ç”¨æˆ·2çš„æ¡ç›®
    1.11 confirmEntries - ä»…ç¡®è®¤æœ¬ç”¨æˆ·çš„æ¡ç›®
    1.12 retryEntry - ä»…é‡è¯•æœ¬ç”¨æˆ·çš„æ¡ç›®
    1.13 listStudentEntries - ä»…åˆ—å‡ºæœ¬ç”¨æˆ·çš„å­¦ç”Ÿæ¡ç›®
    1.14 exportStudentBackup - ä»…å¯¼å‡ºæœ¬ç”¨æˆ·æ•°æ®
    1.15 importStudentBackup - å¯¼å…¥æ•°æ®åªå…³è”åˆ°å½“å‰ç”¨æˆ·
    ... (å…±18ä¸ª)

2.  è½¯é…ç½®éš”ç¦»ï¼š
    2.1  ç”¨æˆ·çº§é…ç½®è¦†ç›–ç³»ç»Ÿçº§
    2.2  æ— ç”¨æˆ·çº§é…ç½®æ—¶å›é€€åˆ°ç³»ç»Ÿçº§
    2.3  æ— ç³»ç»Ÿçº§é…ç½®æ—¶å›é€€åˆ°DEFAULT_CONFIG
    2.4  ä¸¤ä¸ªç”¨æˆ·çš„é…ç½®äº’ä¸å¹²æ‰°
    2.5  ä¿®æ”¹ç”¨æˆ·Aä¸å½±å“ç”¨æˆ·B
    2.6  setUserConfigValueæ­£ç¡®æ›´æ–°
    2.7  deleteUserConfigValueæ­£ç¡®åˆ é™¤
    2.8  ä¸‰çº§å›é€€å®Œæ•´é“¾è·¯éªŒè¯
    ... (å…±12ä¸ª)

3.  åå°ä»»åŠ¡éš”ç¦» (å…±8ä¸ª)
4.  æ‰“åˆ†ç³»ç»Ÿéš”ç¦» (å…±10ä¸ª)
5.  æ‰¹é‡ä»»åŠ¡SSEè·¯ç”±éš”ç¦» (å…±6ä¸ª)
6.  Adminæƒé™éš”ç¦» (å…±5ä¸ª)
7.  Google Driveä»¤ç‰Œéš”ç¦» (å…±4ä¸ª)
8.  è¾¹ç•Œå€¼ä¸å¼‚å¸¸è¾“å…¥ (å…±6ä¸ª)
9.  æ•°æ®åº“çº§è”åˆ é™¤ (å…±4ä¸ª)
10. ç»¼åˆè·¨æ¨¡å—äº¤å‰éªŒè¯ (å…±10ä¸ª)
```

#### ä¸šåŠ¡æµç¨‹å›å½’æµ‹è¯•ï¼ˆ100ä¸ªï¼‰
```
å­¦ç”Ÿç®¡ç†å…¨æµç¨‹ (20ä¸ª)ã€æ¡ç›®å¤„ç†æµç¨‹ (15ä¸ª)ã€
æ‰“åˆ†ç³»ç»Ÿæµç¨‹ (15ä¸ª)ã€å¤‡ä»½æ¢å¤æµç¨‹ (12ä¸ª)ã€
é…ç½®ç®¡ç†æµç¨‹ (13ä¸ª)ã€æ‰¹æ”¹æµç¨‹ (10ä¸ª)ã€
ç§Ÿæˆ·éš”ç¦»è¡¥å…… (15ä¸ª)
```

#### å‹åŠ›/å¹¶å‘æµ‹è¯•ï¼ˆ47ä¸ªï¼‰
```
å¹¶å‘é…ç½®è®¿é—® (8ä¸ª)ã€å¹¶å‘å­¦ç”Ÿæ“ä½œ (6ä¸ª)ã€
å¹¶å‘æ¡ç›®å¤„ç† (6ä¸ª)ã€å¹¶å‘æ‰“åˆ†æ“ä½œ (5ä¸ª)ã€
ç«æ€æ¡ä»¶ (8ä¸ª)ã€é«˜è´Ÿè½½éš”ç¦» (7ä¸ª)ã€
æ‰¹é‡ä»»åŠ¡å†…å­˜å®‰å…¨ (7ä¸ª)
```

---

## ä¸ƒã€ç”¨æˆ·æ•°æ®æµå®Œæ•´æµç¨‹å›¾

### 7.1 è¯·æ±‚è®¤è¯æµç¨‹

```
æµè§ˆå™¨ â”€â”€â†’ Cookie: app_session_id
              â”‚
              â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ JWT éªŒè¯       â”‚
        â”‚ (jose HS256)  â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
         â”‚ æœ‰æ•ˆ         â”‚ æ— æ•ˆ
         â–¼             â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ æå–      â”‚  â”‚ 401      â”‚
    â”‚ openId    â”‚  â”‚ æœªæˆæƒ    â”‚
    â”‚ appId     â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚ name      â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ DB æŸ¥è¯¢ç”¨æˆ·   â”‚
    â”‚ WHERE openId â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
    â”‚ å­˜åœ¨     â”‚ ä¸å­˜åœ¨
    â–¼         â–¼
  â”Œâ”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ç”¨æˆ· â”‚  â”‚OAuth   â”‚
  â”‚å¯¹è±¡ â”‚  â”‚æœåŠ¡è·å–â”‚
  â””â”€â”€â”¬â”€â”˜  â”‚å¹¶åˆ›å»º  â”‚
     â”‚    â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚        â”‚
     â–¼        â–¼
   ctx.user = { id, openId, email, role, accountStatus }
              â”‚
         â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
         â”‚ active   â”‚ suspended
         â–¼         â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ æ­£å¸¸å¤„ç†  â”‚ â”‚ 403 ç¦æ­¢ â”‚
    â”‚ ctx.user â”‚ â”‚ (éadmin)â”‚
    â”‚ .id ä¼ å…¥ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚ ä¸šåŠ¡å±‚   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7.2 æ•°æ®ç”Ÿå‘½å‘¨æœŸï¼ˆä»¥å­¦ç”Ÿç®¡ç†ä¸ºä¾‹ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               å­¦ç”Ÿæ•°æ®å®Œæ•´ç”Ÿå‘½å‘¨æœŸ                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

åˆ›å»º â”€â”€â†’ addStudent(userId=42, "å¼ ä¸‰")
  â”‚      INSERT hw_students SET user_id=42, name="å¼ ä¸‰"
  â”‚
ä½¿ç”¨ â”€â”€â†’ submitEntry(userId=42, "å¼ ä¸‰", "ä»Šå¤©å­¦äº†ç¬¬3è¯¾...")
  â”‚      INSERT hw_entries SET user_id=42, student_name="å¼ ä¸‰"
  â”‚         â†’ AIå¤„ç† â†’ parsedContent å¡«å……
  â”‚         â†’ confirmEntries â†’ æ›´æ–° hw_students.current_status
  â”‚
æŸ¥è¯¢ â”€â”€â†’ listStudents(userId=42)
  â”‚      SELECT * FROM hw_students WHERE user_id=42
  â”‚      ï¼ˆç”¨æˆ·43ç»å¯¹çœ‹ä¸åˆ°ç”¨æˆ·42çš„å¼ ä¸‰ï¼‰
  â”‚
ä¿®æ”¹ â”€â”€â†’ updateStudent(userId=42, id=100, {planType:"daily"})
  â”‚      UPDATE hw_students SET plan_type="daily"
  â”‚      WHERE id=100 AND user_id=42
  â”‚      ï¼ˆåŒé‡æ¡ä»¶ï¼šID + å½’å±éªŒè¯ï¼‰
  â”‚
åœç”¨ â”€â”€â†’ removeStudent(userId=42, id=100)
  â”‚      UPDATE hw_students SET status="inactive"
  â”‚      WHERE id=100 AND user_id=42
  â”‚
åˆ é™¤ â”€â”€â†’ deleteUser(userId=42)  [ç®¡ç†å‘˜æ“ä½œ]
         DELETE FROM user_config WHERE user_id=42
         DELETE FROM hw_entries WHERE user_id=42
         DELETE FROM hw_students WHERE user_id=42
         DELETE FROM background_tasks WHERE user_id=42
         DELETE FROM batch_tasks WHERE user_id=42
         DELETE FROM correction_tasks WHERE user_id=42
         DELETE FROM grading_tasks WHERE user_id=42
         DELETE FROM google_tokens WHERE user_id=42
         DELETE FROM users WHERE id=42
         ï¼ˆå…¨é‡çº§è”æ¸…ç†ï¼Œä¸ç•™ä»»ä½•ç—•è¿¹ï¼‰
```

---

## å…«ã€å®‰å…¨è¯„ä¼°æ€»ç»“

### 8.1 å®‰å…¨è¯„åˆ†

| ç»´åº¦ | è¯„åˆ† | è¯´æ˜ |
|------|------|------|
| æ•°æ®åº“å±‚éš”ç¦» | **A** | æ‰€æœ‰ç”¨æˆ·è¡¨å‡æœ‰userIdåˆ—ï¼ŒæŸ¥è¯¢å‡å¸¦è¿‡æ»¤ |
| APIå±‚æƒé™æ§åˆ¶ | **A** | ä¸‰å±‚ä¸­é—´ä»¶(public/protected/admin) |
| è½¯é…ç½®éš”ç¦» | **A** | ä¸‰çº§å›é€€æœºåˆ¶ï¼Œç”¨æˆ·é—´å®Œå…¨ç‹¬ç«‹ |
| æ‰¹é‡ä»»åŠ¡éš”ç¦» | **A** | ä¿®å¤åExpressè·¯ç”±å·²åŠ userIdæ ¡éªŒ |
| ä¼šè¯å®‰å…¨ | **A** | JWT+Cookieï¼ŒHS256ç­¾åï¼Œ1å¹´æœ‰æ•ˆæœŸ |
| ç®¡ç†å‘˜éš”ç¦» | **A** | æ˜ç¡®çš„admin/userè§’è‰²åˆ†ç¦» |
| çº§è”åˆ é™¤ | **A** | åˆ é™¤ç”¨æˆ·æ—¶æ‰€æœ‰å…³è”æ•°æ®å…¨éƒ¨æ¸…ç† |
| æ—¥å¿—éš”ç¦» | **B** | æ—¥å¿—æ–‡ä»¶å…±äº«ç›®å½•ï¼Œå»ºè®®æŒ‰ç”¨æˆ·éš”ç¦» |
| å†…å®¹ç¼“å­˜éš”ç¦» | **B+** | UUIDä¿æŠ¤ï¼Œæä½ç¢°æ’é£é™© |
| **ç»¼åˆè¯„åˆ†** | **A** | æ ¸å¿ƒéš”ç¦»å®Œå–„ï¼Œç»†èŠ‚å¾…ä¼˜åŒ– |

### 8.2 ç»“è®º

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æœ€ç»ˆè¯„ä¼°                           â”‚
â”‚                                                     â”‚
â”‚  âœ… æ ¸å¿ƒæ•°æ®éš”ç¦»ï¼šå®Œå–„                                â”‚
â”‚     æ‰€æœ‰ç”¨æˆ·æ•°æ®è¡¨å‡é€šè¿‡ userId å®ç°è¡Œçº§éš”ç¦»            â”‚
â”‚                                                     â”‚
â”‚  âœ… API å±‚éš”ç¦»ï¼šå®Œå–„ï¼ˆä¿®å¤åï¼‰                         â”‚
â”‚     æ‰€æœ‰ tRPC è·¯ç”±æ­£ç¡®ä¼ é€’ ctx.user.id               â”‚
â”‚     Express SSE è·¯ç”±å·²ä¿®å¤ userId æ ¡éªŒ                â”‚
â”‚                                                     â”‚
â”‚  âœ… é…ç½®éš”ç¦»ï¼šå®Œå–„                                    â”‚
â”‚     ä¸‰çº§å›é€€æœºåˆ¶æ­£ç¡®è¿ä½œ                               â”‚
â”‚     ç”¨æˆ·é—´é…ç½®å®Œå…¨ç‹¬ç«‹                                 â”‚
â”‚                                                     â”‚
â”‚  âœ… å¹¶å‘å®‰å…¨ï¼šé€šè¿‡                                    â”‚
â”‚     47 ä¸ªå¹¶å‘æµ‹è¯•å…¨éƒ¨é€šè¿‡                              â”‚
â”‚     10 ç”¨æˆ·åŒæ—¶æ“ä½œæ— æ•°æ®æ³„éœ²                          â”‚
â”‚                                                     â”‚
â”‚  âš ï¸ å¾…ä¼˜åŒ–ï¼šæ—¥å¿—æ–‡ä»¶æŒ‰ç”¨æˆ·éš”ç¦»                         â”‚
â”‚  âš ï¸ å¾…ä¼˜åŒ–ï¼šContentStore å¢åŠ  userId æ ¡éªŒ             â”‚
â”‚                                                     â”‚
â”‚  ğŸ”§ å·²ä¿®å¤ï¼šbatch/stop å’Œ batch/status è·¨ç§Ÿæˆ·æ¼æ´     â”‚
â”‚                                                     â”‚
â”‚  ğŸ“Š æµ‹è¯•è¦†ç›–ï¼š230 ä¸ªæµ‹è¯•ç”¨ä¾‹å…¨éƒ¨é€šè¿‡                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
