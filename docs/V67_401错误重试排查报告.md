# V67 排查报告：401 错误重试问题

**排查日期**：2026年1月27日  
**排查人**：Manus AI

---

## 1. 问题现象

故意关闭 API 接口测试，返回 401 错误时，系统仍然进行了多次重试。

- **预期行为**：401（未授权）和 403（禁止访问）这类认证错误不应该重试
- **实际行为**：401 错误触发了 3-4 次重试

---

## 2. 重试逻辑位置

### 2.1 底层重试：`server/core/aiClient.ts`

| 位置 | 行号 | 说明 |
|------|------|------|
| 重试循环 | 204-318 | `for (let attempt = 0; attempt <= maxRetries; attempt++)` |
| 401/403 判断 | 236-238 | 直接 throw，不重试 |
| catch 中的判断 | 314-316 | 检查 error.message 是否包含 401/403 |

**底层代码分析**：

```javascript
// 第 236-238 行：HTTP 响应层面的 401/403 判断
if (response.status === 403 || response.status === 401) {
  throw new Error(`AI API错误: ${response.status} - ${errorText}`);
}

// 第 314-316 行：catch 中的 401/403 判断
if (error.message?.includes("403") || error.message?.includes("401")) {
  throw error;
}
```

✅ **底层已正确处理**：401/403 会直接 throw，不会在底层重试。

---

### 2.2 上层重试：`server/batch/batchRoutes.ts`

| 位置 | 行号 | 说明 |
|------|------|------|
| MAX_RETRIES 定义 | 22 | 最大重试次数 |
| executeTaskWithRetry | 340-370 | 任务级别的重试逻辑 |

**上层代码分析**：

```javascript
// 第 340-370 行：任务级别重试
const executeTaskWithRetry = async (
  taskNumber: number,
  onProgress: (chars: number) => void,
  retryCount: number = 0
): Promise<BatchTaskResult> => {
  try {
    return await executeTask(taskNumber, onProgress);
  } catch (error: any) {
    if (retryCount < MAX_RETRIES) {
      // ❌ 问题所在：这里没有判断错误类型，所有错误都会重试
      console.log(`[BatchRoutes] 任务 ${taskNumber} 失败，正在重试...`);
      await delay(1000);
      return executeTaskWithRetry(taskNumber, onProgress, retryCount + 1);
    }
    throw error;
  }
};
```

❌ **上层未正确处理**：`executeTaskWithRetry` 没有判断错误类型，所有错误（包括 401/403）都会触发重试。

---

## 3. 问题根因

**多层重试导致问题**：

1. **底层 `aiClient.ts`**：正确处理了 401/403，直接 throw 不重试
2. **上层 `batchRoutes.ts`**：`executeTaskWithRetry` 捕获了底层抛出的错误，但没有判断错误类型，导致 401/403 错误仍然被重试

**重试流程**：
```
用户请求
  ↓
executeTaskWithRetry (上层)
  ↓ 捕获错误，重试
executeTask
  ↓
invokeAIStream (底层)
  ↓ 401/403 直接 throw
错误被上层捕获
  ↓ 上层没有判断错误类型
触发上层重试（问题所在）
```

---

## 4. 修复建议

在 `executeTaskWithRetry` 函数中添加错误类型判断：

```javascript
const executeTaskWithRetry = async (
  taskNumber: number,
  onProgress: (chars: number) => void,
  retryCount: number = 0
): Promise<BatchTaskResult> => {
  try {
    return await executeTask(taskNumber, onProgress);
  } catch (error: any) {
    // 新增：认证错误不重试
    const errorMsg = error.message || '';
    if (errorMsg.includes('401') || errorMsg.includes('403') || 
        errorMsg.includes('认证') || errorMsg.includes('Unauthorized')) {
      console.log(`[BatchRoutes] 任务 ${taskNumber} 认证失败，不重试`);
      throw error;
    }
    
    if (retryCount < MAX_RETRIES) {
      console.log(`[BatchRoutes] 任务 ${taskNumber} 失败，正在重试...`);
      await delay(1000);
      return executeTaskWithRetry(taskNumber, onProgress, retryCount + 1);
    }
    throw error;
  }
};
```

---

## 5. 排查结论

| 问题 | 回答 |
|------|------|
| 重试逻辑在哪个文件？ | `server/batch/batchRoutes.ts` 第 340-370 行 |
| 401 是否被排除在重试之外？ | ❌ 上层没有排除，底层已排除 |
| 是否存在多层重试？ | ✅ 是，底层 + 上层两层重试 |
| 修复方案 | 在上层 `executeTaskWithRetry` 中添加 401/403 判断 |

---

## 6. 新发现（基于实际日志）

**实际日志**：
```
[AIClient] API错误: 401 - {"error":{...}}
[AIClient] 请求失败 (尝试 1/3): AI API错误: 401 - {...}
```

**问题分析**：

日志显示 `尝试 1/3`，说明底层 `aiClient.ts` 的 401 判断**在 catch 块中**，而不是在 `if (!response.ok)` 块中。

**执行顺序**：
1. `if (!response.ok)` 块（第 232-242 行）：检测到 401，**throw** 错误
2. 错误被 **catch** 块（第 305-317 行）捕获
3. catch 块先打印日志 `请求失败 (尝试 1/3)`
4. 然后才检查 `error.message?.includes("401")`
5. 如果匹配，才 throw 跳出循环

**问题根因**：
- 第 237 行的 throw 确实会跳出 try 块
- 但 catch 块会先打印日志，然后才检查是否应该 throw
- 日志 `尝试 1/3` 是在 catch 块中打印的，说明 throw 后确实进入了 catch
- catch 块第 314-316 行会检查 401/403 并 throw，所以**实际上不会重试**

**结论**：
- 底层 `aiClient.ts` 的 401 处理是**正确的**，只是日志打印顺序让人误解
- 日志 `尝试 1/3` 只是打印了一次，然后就 throw 跳出了
- 如果真的重试了，应该会看到 `尝试 2/3`、`尝试 3/3`

**需要确认**：
- 是否有 `尝试 2/3` 或 `尝试 3/3` 的日志？
- 如果只有 `尝试 1/3`，说明底层没有重试，问题在上层

---

**报告创建时间**：2026年1月27日
