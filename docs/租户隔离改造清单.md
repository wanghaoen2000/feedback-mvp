# ç§Ÿæˆ·éš”ç¦»æ”¹é€ æ¸…å•ï¼ˆå®Œå…¨éš”ç¦»æ–¹æ¡ˆï¼‰

> ç›®æ ‡ï¼šæ¯ä¸ªç”¨æˆ·æ‹¥æœ‰ç‹¬ç«‹çš„é…ç½®ã€æ•°æ®ã€Google Drive å‡­è¯å’Œå­˜å‚¨ç©ºé—´
> ç¼–åˆ¶æ—¶é—´ï¼š2026-02-13
> æœ€åæ›´æ–°ï¼š2026-02-16
> å½“å‰çŠ¶æ€ï¼šâœ… **å…¨éƒ¨å®Œæˆ** â€” æ‰€æœ‰ Phase 1-5 æ”¹é€ å·²å®Œæˆå¹¶é€šè¿‡ 230+ é¡¹æµ‹è¯•éªŒè¯
>
> V172-V179 è¿½åŠ ä¿®å¤ï¼šgetConfigValue è·¨ç§Ÿæˆ· fallbackã€migrateSystemConfigToAdmin èŒƒå›´æ”¶çª„ã€
> exportBackup æ•°æ®æ³„éœ²ã€config.update æƒé™å¼€æ”¾ã€è·¯å¾„ placeholder æ”¹é€ 

---

## ä¸€ã€æ•´ä½“æ¶æ„ç°çŠ¶

### 1.1 å·²æœ‰åŸºç¡€è®¾æ–½ï¼ˆå¯å¤ç”¨ï¼‰

| ç»„ä»¶ | çŠ¶æ€ | ä½ç½® |
|------|------|------|
| ç”¨æˆ·è®¤è¯ï¼ˆManus OAuthï¼‰ | âœ… å·²å®Œæˆ | `server/_core/sdk.ts`, `server/_core/oauth.ts` |
| users è¡¨ï¼ˆid, openId, email, roleï¼‰ | âœ… å·²å®Œæˆ | `drizzle/schema.ts:8-23` |
| tRPC ä¸Šä¸‹æ–‡ä¼ é€’ user å¯¹è±¡ | âœ… å·²å®Œæˆ | `server/_core/context.ts:5-28` |
| protectedProcedure ä¸­é—´ä»¶ï¼ˆuser ä¿è¯é nullï¼‰ | âœ… å·²å®Œæˆ | `server/_core/trpc.ts:14-37` |
| é‚®ç®±ç™½åå•è®¿é—®æ§åˆ¶ | âœ… å·²å®Œæˆ | `server/_core/trpc.ts:22-26` |
| admin è§’è‰²æƒé™ | âœ… å·²å®Œæˆ | `server/_core/trpc.ts:39-54` |

### 1.2 æ ¸å¿ƒç¼ºå¤±

- **å…¨éƒ¨ 8 å¼ æ•°æ®è¡¨**ç¼ºå°‘ `userId` åˆ—ï¼ˆé™¤ users è¡¨æœ¬èº«ï¼‰
- **systemConfig** å…¨å±€å•ä¾‹ï¼Œæ‰€æœ‰ç”¨æˆ·å…±äº«åŒä¸€å¥—é…ç½®
- **googleTokens** åªå­˜ä¸€æ¡è®°å½•ï¼Œå…¨ç³»ç»Ÿå…±ç”¨ä¸€ä¸ª Google Drive è´¦å·
- **74 ä¸ª tRPC è·¯ç”± + 10 ä¸ª Express SSE ç«¯ç‚¹**æ—  userId è¿‡æ»¤
- **åå°ä»»åŠ¡**ä¸è®°å½•æ˜¯è°æäº¤çš„
- **contentStore** å†…å­˜ç¼“å­˜ï¼ˆSSE ä¸­é—´ç»“æœæš‚å­˜ï¼‰æ— ç”¨æˆ·éš”ç¦»
- **Express è®¤è¯ä¸­é—´ä»¶**å·²åœ¨ `req.user` ä¸Šé™„å¸¦ç”¨æˆ·ä¿¡æ¯ï¼Œå¯ç›´æ¥ä½¿ç”¨

---

## äºŒã€æ•°æ®åº“æ”¹é€ ï¼ˆPhase 1ï¼‰

### 2.1 æ–°å»º user_config è¡¨

**ç›®çš„**ï¼šæ›¿ä»£ systemConfig ä½œä¸ºç”¨æˆ·çº§é…ç½®å­˜å‚¨

```
æ–‡ä»¶ï¼šdrizzle/schema.ts
æ“ä½œï¼šæ–°å¢è¡¨å®šä¹‰

è¡¨ç»“æ„ï¼š
  id          INT AUTO_INCREMENT PRIMARY KEY
  userId      INT NOT NULL           -- FK â†’ users.id
  key         VARCHAR(64) NOT NULL
  value       MEDIUMTEXT NOT NULL
  description TEXT
  updatedAt   TIMESTAMP DEFAULT NOW() ON UPDATE NOW()
  UNIQUE(userId, key)                -- å¤åˆå”¯ä¸€çº¦æŸ
```

**éœ€è¦è¿ç§»åˆ° user_config çš„é…ç½®é¡¹ï¼ˆ20 ä¸ªï¼‰**ï¼š

| é…ç½®é”® | è¯´æ˜ | å½“å‰ä½ç½® |
|--------|------|----------|
| apiModel | AI æ¨¡å‹é€‰æ‹© | systemConfig |
| apiKey | API å¯†é’¥ | systemConfig |
| apiUrl | API ç«¯ç‚¹ | systemConfig |
| currentYear | å½“å‰å¹´ä»½ | systemConfig |
| roadmap | ä¸€å¯¹ä¸€è·¯ä¹¦ | systemConfig |
| roadmapClass | å°ç­è¯¾è·¯ä¹¦ | systemConfig |
| firstLessonTemplate | ä¸€å¯¹ä¸€é¦–æ¬¡è¯¾èŒƒä¾‹ | systemConfig |
| classFirstLessonTemplate | å°ç­è¯¾é¦–æ¬¡è¯¾èŒƒä¾‹ | systemConfig |
| driveBasePath | ä¸€å¯¹ä¸€å­˜å‚¨è·¯å¾„ | systemConfig |
| classStoragePath | å°ç­è¯¾å­˜å‚¨è·¯å¾„ | systemConfig |
| batchFilePrefix | æ‰¹é‡æ–‡ä»¶å‰ç¼€ | systemConfig |
| batchStoragePath | æ‰¹é‡å­˜å‚¨è·¯å¾„ | systemConfig |
| batchConcurrency | æ‰¹é‡å¹¶å‘æ•° | systemConfig |
| maxTokens | æœ€å¤§ token æ•° | systemConfig |
| gdriveLocalBasePath | GDrive æœ¬åœ°è·¯å¾„ | systemConfig |
| gdriveDownloadsPath | GDrive ä¸‹è½½è·¯å¾„ | systemConfig |
| modelPresets | æ¨¡å‹é¢„è®¾ï¼ˆJSONï¼‰ | systemConfig |
| apiProviderPresets | ä¾›åº”å•†é¢„è®¾ï¼ˆå«å¯†é’¥ï¼‰ | systemConfig |
| hwAiModel | å­¦ç”Ÿç®¡ç† AI æ¨¡å‹ | systemConfig |
| hwPromptTemplate | å­¦ç”Ÿç®¡ç†æç¤ºè¯ | systemConfig |
| corrAiModel | æ‰¹æ”¹ AI æ¨¡å‹ | systemConfig |
| correctionPrompt | æ‰¹æ”¹é€šç”¨æç¤ºè¯ | systemConfig |
| correctionTypes | æ‰¹æ”¹ç±»å‹é…ç½® | systemConfig |
| studentLessonHistory | å­¦ç”Ÿè¯¾æ¬¡å†å² | systemConfig |

**ä¿ç•™åœ¨ systemConfig çš„å…¨å±€é…ç½®ï¼ˆ2 ä¸ªï¼‰**ï¼š

| é…ç½®é”® | è¯´æ˜ | ç†ç”± |
|--------|------|------|
| allowedEmails | é‚®ç®±ç™½åå• | å…¨å±€è®¿é—®æ§åˆ¶ï¼Œadmin ç®¡ç† |
| ï¼ˆæ— å…¶ä»–ï¼‰ | â€” | â€” |

### 2.2 æ”¹é€  google_tokens è¡¨

**ç›®çš„**ï¼šæ”¯æŒæ¯äººç»‘å®šè‡ªå·±çš„ Google Drive

```
æ–‡ä»¶ï¼šdrizzle/schema.ts:41-48
æ“ä½œï¼šæ·»åŠ  userId åˆ—

å˜æ›´ï¼š
  + userId INT NOT NULL              -- FK â†’ users.id
  + UNIQUE(userId)                   -- æ¯ç”¨æˆ·åªæœ‰ä¸€æ¡ token
  - åˆ é™¤æ—§çš„æ—  userId çº¦æŸ
```

**å…³è”æ”¹é€ æ–‡ä»¶**ï¼š

| æ–‡ä»¶ | è¡Œå· | æ”¹åŠ¨ |
|------|------|------|
| `server/googleAuth.ts:97` | `db.delete(googleTokens)` | â†’ `db.delete(googleTokens).where(eq(googleTokens.userId, userId))` |
| `server/googleAuth.ts:98-102` | `db.insert(googleTokens).values({...})` | â†’ æ·»åŠ  `userId` å­—æ®µ |
| `server/googleAuth.ts:132` | `db.select().from(googleTokens).limit(1)` | â†’ `.where(eq(googleTokens.userId, userId)).limit(1)` |
| `server/googleAuth.ts:186-191` | `db.update(googleTokens).set(...)` | â†’ æ·»åŠ  `.where(eq(googleTokens.userId, userId))` |
| `server/googleAuth.ts:208` | `db.select().from(googleTokens).limit(1)` | â†’ `.where(eq(googleTokens.userId, userId))` |
| `server/googleAuth.ts:223` | `db.delete(googleTokens)` | â†’ `.where(eq(googleTokens.userId, userId))` |
| `server/googleAuth.ts:245` | `db.select().from(googleTokens).limit(1)` | â†’ `.where(eq(googleTokens.userId, userId))` |
| `server/_core/oauth.ts:34` | `googleAuth.handleCallback(code)` | â†’ `googleAuth.handleCallback(code, userId)` â€” éœ€ä» session ä¸­è·å– userId |

**å‡½æ•°ç­¾åæ”¹é€ **ï¼š

```
getValidToken()      â†’ getValidToken(userId: number)
handleCallback(code) â†’ handleCallback(code: string, userId: number)
isAuthorized()       â†’ isAuthorized(userId: number)
disconnect()         â†’ disconnect(userId: number)
getStatus()          â†’ getStatus(userId: number)
```

**å¹¶å‘åˆ·æ–°é”æ”¹é€ **ï¼š

```
server/googleAuth.ts:113
å½“å‰ï¼šlet refreshPromise: Promise<string | null> | null = null;  // å…¨å±€å•ä¸€é”
æ”¹ä¸ºï¼šconst refreshPromises = new Map<number, Promise<string | null>>();  // æ¯ç”¨æˆ·ä¸€æŠŠé”
```

### 2.3 æ”¹é€  hw_students è¡¨

```
æ–‡ä»¶ï¼šdrizzle/schema.ts:73-81
æ“ä½œï¼šæ·»åŠ  userId åˆ—ï¼Œä¿®æ”¹å”¯ä¸€çº¦æŸ

å˜æ›´ï¼š
  + userId INT NOT NULL              -- FK â†’ users.id
  - UNIQUE(name)                     -- åˆ é™¤å…¨å±€å”¯ä¸€
  + UNIQUE(userId, name)             -- æ”¹ä¸ºæ¯ç”¨æˆ·å†…å”¯ä¸€
```

### 2.4 æ”¹é€  hw_entries è¡¨

```
æ–‡ä»¶ï¼šdrizzle/schema.ts:87-100
æ“ä½œï¼šæ·»åŠ  userId åˆ—

å˜æ›´ï¼š
  + userId INT NOT NULL              -- FK â†’ users.id
```

### 2.5 æ”¹é€  background_tasks è¡¨

```
æ–‡ä»¶ï¼šdrizzle/schema.ts:54-67
æ“ä½œï¼šæ·»åŠ  userId åˆ—

å˜æ›´ï¼š
  + userId INT NOT NULL              -- FK â†’ users.id
```

### 2.6 æ”¹é€  batch_tasks è¡¨

```
æ–‡ä»¶ï¼šdrizzle/schema.ts:106-118
æ“ä½œï¼šæ·»åŠ  userId åˆ—

å˜æ›´ï¼š
  + userId INT NOT NULL              -- FK â†’ users.id
```

### 2.7 æ”¹é€  batch_task_items è¡¨

```
æ–‡ä»¶ï¼šdrizzle/schema.ts:124-137
æ“ä½œï¼šä¸éœ€è¦ç›´æ¥æ·»åŠ  userIdï¼ˆé€šè¿‡ batchId å…³è”åˆ° batch_tasks.userIdï¼‰
ç†ç”±ï¼šå­ä»»åŠ¡å§‹ç»ˆå±äºçˆ¶æ‰¹é‡ä»»åŠ¡ï¼Œé—´æ¥é€šè¿‡ batchId â†’ batchTasks.userId ç¡®å®šå½’å±
```

### 2.8 æ”¹é€  correction_tasks è¡¨

```
æ–‡ä»¶ï¼šdrizzle/schema.ts:143-166
æ“ä½œï¼šæ·»åŠ  userId åˆ—

å˜æ›´ï¼š
  + userId INT NOT NULL              -- FK â†’ users.id
```

### 2.9 æ•°æ®åº“è¿ç§»è„šæœ¬

**å­˜é‡æ•°æ®å¤„ç†ç­–ç•¥**ï¼šæ‰€æœ‰ç°æœ‰æ•°æ®å½’å±ç»™ admin ç”¨æˆ·ï¼ˆid=1ï¼‰

```sql
-- 1. æ–°å¢ user_config è¡¨
CREATE TABLE user_config (...);

-- 2. å„è¡¨æ·»åŠ  userId åˆ—ï¼ˆå…ˆå…è®¸ NULLï¼Œå¡«å……åæ”¹ NOT NULLï¼‰
ALTER TABLE google_tokens ADD COLUMN user_id INT NULL;
ALTER TABLE hw_students ADD COLUMN user_id INT NULL;
ALTER TABLE hw_entries ADD COLUMN user_id INT NULL;
ALTER TABLE background_tasks ADD COLUMN user_id INT NULL;
ALTER TABLE batch_tasks ADD COLUMN user_id INT NULL;
ALTER TABLE correction_tasks ADD COLUMN user_id INT NULL;

-- 3. å¡«å……ç°æœ‰æ•°æ®ï¼ˆå…¨éƒ¨å½’ adminï¼‰
UPDATE google_tokens SET user_id = 1;
UPDATE hw_students SET user_id = 1;
UPDATE hw_entries SET user_id = 1;
UPDATE background_tasks SET user_id = 1;
UPDATE batch_tasks SET user_id = 1;
UPDATE correction_tasks SET user_id = 1;

-- 4. æ”¹ä¸º NOT NULL
ALTER TABLE google_tokens MODIFY COLUMN user_id INT NOT NULL;
ALTER TABLE hw_students MODIFY COLUMN user_id INT NOT NULL;
ALTER TABLE hw_entries MODIFY COLUMN user_id INT NOT NULL;
ALTER TABLE background_tasks MODIFY COLUMN user_id INT NOT NULL;
ALTER TABLE batch_tasks MODIFY COLUMN user_id INT NOT NULL;
ALTER TABLE correction_tasks MODIFY COLUMN user_id INT NOT NULL;

-- 5. ä¿®æ”¹ hw_students å”¯ä¸€çº¦æŸ
ALTER TABLE hw_students DROP INDEX hw_students_name_unique;
ALTER TABLE hw_students ADD UNIQUE INDEX hw_students_user_name (user_id, name);

-- 6. google_tokens æ·»åŠ ç”¨æˆ·å”¯ä¸€çº¦æŸ
ALTER TABLE google_tokens ADD UNIQUE INDEX google_tokens_user_unique (user_id);

-- 7. è¿ç§» systemConfig â†’ user_configï¼ˆä¸º admin ç”¨æˆ·ï¼‰
INSERT INTO user_config (user_id, `key`, value, description)
SELECT 1, `key`, value, description FROM system_config
WHERE `key` NOT IN ('allowedEmails');

-- 8. æ¸…ç† systemConfig ä¸­å·²è¿ç§»çš„è¡Œï¼ˆä¿ç•™ allowedEmailsï¼‰
DELETE FROM system_config WHERE `key` != 'allowedEmails';
```

---

## ä¸‰ã€æ ¸å¿ƒåŸºç¡€è®¾æ–½æ”¹é€ ï¼ˆPhase 2ï¼‰

### 3.1 é…ç½®è¯»å–å±‚æ”¹é€ 

**æ–‡ä»¶ï¼š`server/core/aiClient.ts`**

| è¡Œå· | å½“å‰ | æ”¹ä¸º |
|------|------|------|
| 61 | `getConfigValue(key: string)` | `getConfigValue(key: string, userId?: number)` |
| 65 | `db.select().from(systemConfig).where(eq(systemConfig.key, key))` | userId å­˜åœ¨æ—¶æŸ¥ user_configï¼›å¦åˆ™æŸ¥ systemConfig |
| 79 | `getAPIConfig()` | `getAPIConfig(userId: number)` |

**æ–°å¢å‡½æ•°**ï¼š

```typescript
// è¯»å–ç”¨æˆ·é…ç½®ï¼ˆä¼˜å…ˆç”¨æˆ·çº§ï¼Œå›é€€åˆ°å…¨å±€ systemConfigï¼‰
async function getUserConfigValue(userId: number, key: string): Promise<string> {
  // 1. æŸ¥ user_config
  // 2. æ²¡æœ‰ â†’ æŸ¥ systemConfigï¼ˆå‘ä¸‹å…¼å®¹ï¼‰
  // 3. è¿˜æ²¡æœ‰ â†’ DEFAULT_CONFIG
}
```

**æ–‡ä»¶ï¼š`server/routers.ts:73-87`ï¼ˆsetConfig å‡½æ•°ï¼‰**

```
å½“å‰ï¼šsetConfig(key, value)         â†’ å†™å…¥ systemConfig
æ”¹ä¸ºï¼šsetUserConfig(userId, key, value) â†’ å†™å…¥ user_config
ä¿ç•™ï¼šsetGlobalConfig(key, value)   â†’ å†™å…¥ systemConfigï¼ˆä»… allowedEmailsï¼‰
```

### 3.2 Google Drive è°ƒç”¨é“¾æ”¹é€ 

æ‰€æœ‰è°ƒç”¨ `getValidToken()` çš„åœ°æ–¹éœ€è¦ä¼ å…¥ userIdï¼š

| æ–‡ä»¶ | è¡Œå· | å½“å‰è°ƒç”¨ | æ”¹ä¸º |
|------|------|----------|------|
| `server/gdrive.ts:55` | `getValidToken()` | `getValidToken(userId)` |
| `server/gdrive.ts:254` | `getValidToken()` | `getValidToken(userId)` |
| `server/gdrive.ts:382` | `getValidToken()` | `getValidToken(userId)` |
| `server/gdrive.ts:589` | `getValidToken()` | `getValidToken(userId)` |
| `server/gdrive.ts:675` | `getValidToken()` | `getValidToken(userId)` |
| `server/gdrive.ts:716` | `getValidToken()` | `getValidToken(userId)` |

**gdrive.ts å‡½æ•°ç­¾åæ”¹é€ **ï¼š

```
uploadToGoogleDrive(content, fileName, folderPath, onStatus?, maxRetries?)
â†’ uploadToGoogleDrive(userId, content, fileName, folderPath, onStatus?, maxRetries?)

uploadBinaryToGoogleDrive(content, fileName, folderPath, onStatus?, maxRetries?)
â†’ uploadBinaryToGoogleDrive(userId, content, fileName, folderPath, onStatus?, maxRetries?)

uploadMultipleFiles(files, onProgress?)
â†’ uploadMultipleFiles(userId, files, onProgress?)

readFileFromGoogleDrive(filePath)
â†’ readFileFromGoogleDrive(userId, filePath)

searchFileInGoogleDrive(fileNames, searchDir?)
â†’ searchFileInGoogleDrive(userId, fileNames, searchDir?)

verifyFileExists(filePath)
â†’ verifyFileExists(userId, filePath)

ensureFolderExists(folderPath)
â†’ ensureFolderExists(userId, folderPath)
```

### 3.3 contentStore ç”¨æˆ·éš”ç¦»

**æ–‡ä»¶ï¼š`server/contentStore.ts`ï¼ˆ44 è¡Œï¼‰**

å½“å‰ contentStore ç”¨ taskId åš keyï¼ŒSSE ç«¯ç‚¹åœ¨ç”Ÿæˆå®Œåè°ƒç”¨ `storeContent(taskId, content)` æš‚å­˜ç»“æœä¾›å‰ç«¯è½®è¯¢æ‹‰å–ã€‚

**é£é™©è¯„ä¼°**ï¼štaskId æ˜¯ `crypto.randomUUID()` ç”Ÿæˆçš„ï¼Œå®é™…ä¸Šä¸å¯çŒœæµ‹ï¼Œå®‰å…¨é£é™©æä½ã€‚ä½†ä¸¥æ ¼éš”ç¦»æ–¹æ¡ˆä¸‹ä»å»ºè®®åšä»¥ä¸‹æ”¹é€ ï¼š

```
storeContent(taskId, content, meta?)
â†’ storeContent(taskId, content, meta?)  // key ä¸éœ€è¦æ”¹ï¼ˆUUID å·²éš”ç¦»ï¼‰
  ä½† meta ä¸­è®°å½• userIdï¼ŒretrieveContent æ—¶å¯é€‰éªŒè¯

retrieveContent(taskId)
â†’ retrieveContent(taskId, userId?)  // å¯é€‰ï¼šéªŒè¯ userId æ˜¯å¦åŒ¹é…
```

**ä¼˜å…ˆçº§**ï¼šä½ã€‚taskId æ˜¯ UUIDï¼Œæ³„éœ²é£é™©æä½ï¼Œå¯åæœŸè¡¥å……ã€‚

### 3.4 Express è®¤è¯ä¸­é—´ä»¶ï¼ˆå·²å°±ç»ªï¼‰

**æ–‡ä»¶ï¼š`server/_core/authMiddleware.ts`ï¼ˆ66 è¡Œï¼‰**

`requireAuth` ä¸­é—´ä»¶å·²ç»å°† `(req as any).user = user` æŒ‚è½½åˆ°è¯·æ±‚å¯¹è±¡ä¸Šï¼Œæ‰€æœ‰ SSE ç«¯ç‚¹å¯é€šè¿‡ `req.user.id` è·å– userIdã€‚**ä¸éœ€è¦æ”¹é€ **ï¼Œåªéœ€åœ¨ SSE è·¯ç”±ä¸­ä½¿ç”¨ã€‚

### 3.5 Google Drive OAuth å›è°ƒæ”¹é€ 

**æ–‡ä»¶ï¼š`server/_core/oauth.ts:15-46`**

å½“å‰é—®é¢˜ï¼šGoogle OAuth å›è°ƒ `/api/google/callback` æ˜¯ä¸€ä¸ª Express GET è·¯ç”±ï¼Œä¸ç»è¿‡ tRPC ä¸­é—´ä»¶ï¼Œæ— æ³•è·å– ctx.userã€‚

è§£å†³æ–¹æ¡ˆï¼š
1. å›è°ƒ URL ä¸­é™„å¸¦åŠ å¯†çš„ userId å‚æ•°ï¼ˆstate å‚æ•°ï¼‰
2. æˆ–åœ¨ session ä¸­ç¼“å­˜å½“å‰ç™»å½•ç”¨æˆ·çš„ userIdï¼Œå›è°ƒæ—¶ä» session è¯»å–

```
getAuthUrl() â†’ getAuthUrl(userId: number)
// å°† userId ç¼–ç åˆ° OAuth state å‚æ•°ä¸­

handleCallback(code) â†’ handleCallback(code, userId)
// ä» state å‚æ•°ä¸­è§£ç  userId
```

---

## å››ã€è·¯ç”±å±‚æ”¹é€ ï¼ˆPhase 3ï¼‰

### 4.1 ä¸­é—´ä»¶å¢å¼ºï¼ˆå¯é€‰ä½†æ¨èï¼‰

**æ–‡ä»¶ï¼š`server/_core/trpc.ts`**

åœ¨ `requireUser` ä¸­é—´ä»¶ä¸­å°† `userId` ä½œä¸ºä¾¿æ·å±æ€§ä¼ é€’ï¼š

```typescript
return next({
  ctx: {
    ...ctx,
    user: ctx.user,
    userId: ctx.user.id,  // ä¾¿æ·è®¿é—®
  },
});
```

### 4.2 config è·¯ç”±æ”¹é€ 

**æ–‡ä»¶ï¼š`server/routers.ts`**

| è·¯ç”± | è¡Œå· | æ”¹åŠ¨ |
|------|------|------|
| `config.getAll` | 151 | è¯»å– user_config è€Œé systemConfig |
| `config.update` | 242 | å†™å…¥ user_config è€Œé systemConfig |
| `config.reset` | 436 | ä» user_config åˆ é™¤è€Œé systemConfig |
| `config.getStudentHistory` | 459 | ä» user_config è¯»å– |
| `config.saveStudentHistory` | 472 | å†™å…¥ user_config |

### 4.3 homework è·¯ç”±æ”¹é€ 

**æ–‡ä»¶ï¼š`server/routers.ts:2477-2671`**

æ‰€æœ‰è°ƒç”¨éƒ½éœ€ä¼ å…¥ `ctx.user.id`ï¼š

| è·¯ç”± | è¡Œå· | æ”¹åŠ¨ |
|------|------|------|
| `homework.listStudents` | 2479-2483 | `listStudents(input?.status)` â†’ `listStudents(ctx.user.id, input?.status)` |
| `homework.addStudent` | 2485-2492 | `addStudent(...)` â†’ `addStudent(ctx.user.id, ...)` |
| `homework.updateStudent` | 2494-2504 | `updateStudent(...)` â†’ æ·»åŠ  userId éªŒè¯ |
| `homework.removeStudent` | 2506-2510 | `removeStudent(...)` â†’ æ·»åŠ  userId éªŒè¯ |
| `homework.submitEntry` | 2513-2525 | `submitAndProcessEntry(...)` â†’ ä¼ å…¥ userId |
| `homework.listPendingEntries` | 2527-2530 | `listPendingEntries()` â†’ `listPendingEntries(ctx.user.id)` |
| `homework.listEntries` | 2532-2536 | `listEntries(...)` â†’ `listEntries(ctx.user.id, ...)` |
| `homework.listStudentEntries` | 2539-2547 | â†’ ä¼ å…¥ userId |
| `homework.retryEntry` | 2549-2555 | â†’ éªŒè¯æ¡ç›®å½’å± |
| `homework.deleteEntry` | 2557-2561 | â†’ éªŒè¯æ¡ç›®å½’å± |
| `homework.confirmEntries` | 2563-2569 | â†’ ä¼ å…¥ userId |
| `homework.confirmAll` | 2571-2576 | â†’ ä¼ å…¥ userId |
| `homework.getConfig` | 2579-2589 | â†’ è¯» user_config |
| `homework.updateConfig` | 2591-2604 | â†’ å†™ user_config |
| `homework.getStudentStatus` | 2607-2612 | â†’ ä¼ å…¥ userId |
| `homework.importFromExtraction` | 2615-2624 | â†’ ä¼ å…¥ userId |
| `homework.importFromTask` | 2627-2636 | â†’ ä¼ å…¥ userId + éªŒè¯ä»»åŠ¡å½’å± |
| `homework.importClassFromTask` | 2639-2649 | â†’ ä¼ å…¥ userId + éªŒè¯ä»»åŠ¡å½’å± |
| `homework.exportBackup` | 2652-2658 | â†’ ä¼ å…¥ userId |
| `homework.importBackup` | 2666-2670 | â†’ ä¼ å…¥ userId |

### 4.4 feedback è·¯ç”±æ”¹é€ 

**æ–‡ä»¶ï¼š`server/routers.ts:487-1538`**

æ‰€æœ‰ feedback è·¯ç”±éƒ½ç”¨ `protectedProcedure`ï¼Œéœ€è¦ï¼š
1. ä» `ctx.user.id` è·å– userId
2. ç”¨ userId è¯»å– user_config è€Œé systemConfig
3. ä¼  userId ç»™ Google Drive ä¸Šä¼ å‡½æ•°

| è·¯ç”± | è¡Œå· | å…³é”®æ”¹åŠ¨ |
|------|------|----------|
| `generateFeedback` | 489-597 | getConfig â†’ getUserConfig(userId); uploadToGoogleDrive â†’ uploadToGoogleDrive(userId, ...) |
| `generateReview` | 600-702 | åŒä¸Š |
| `generateTest` | 704-806 | åŒä¸Š |
| `generateExtraction` | 808-909 | åŒä¸Š |
| `generateBubbleChart` | 911-985 | åŒä¸Šï¼ˆä¸æ¶‰åŠä¸Šä¼ ï¼‰ |
| `uploadBubbleChart` | 987-1037 | uploadBinaryToGoogleDrive â†’ (userId, ...) |
| `verifyAll` | 1039-1072 | verifyAllFiles â†’ ä¼  userId |
| `exportLog` | 1089-1136 | uploadToGoogleDrive â†’ (userId, ...) |
| `googleAuthStatus` | 1173 | getStatus() â†’ getStatus(userId) |
| `googleAuthUrl` | 1177 | getAuthUrl() â†’ getAuthUrl(userId) |
| `googleAuthCallback` | 1184 | handleCallback(code) â†’ handleCallback(code, userId) |
| `googleAuthDisconnect` | 1189 | disconnect() â†’ disconnect(userId) |
| `generateClassFeedback` | 1197 | getUserConfig(userId, ...) |
| `generateClassReview` | 1263 | åŒä¸Š |
| `generateClassTest` | 1316 | åŒä¸Š |
| `generateClassExtraction` | 1369 | åŒä¸Š |
| `generateClassBubbleChart` | 1421 | åŒä¸Š |
| `uploadClassFile` | 1462 | uploadToGoogleDrive/uploadBinaryToGoogleDrive â†’ (userId, ...) |

### 4.5 localFile è·¯ç”±æ”¹é€ 

**æ–‡ä»¶ï¼š`server/routers.ts:1541-1904`**

| è·¯ç”± | è¡Œå· | å…³é”®æ”¹åŠ¨ |
|------|------|----------|
| `diagnose` | 1543-1620 | getValidToken â†’ getValidToken(userId); getConfig â†’ getUserConfig(userId, ...) |
| `readFromDownloads` | 1623-1783 | readFileFromGoogleDrive/searchFileInGoogleDrive â†’ (userId, ...); getConfig â†’ getUserConfig |
| `readLastFeedback` | 1787-1903 | readFileFromGoogleDrive â†’ (userId, ...); getConfig â†’ getUserConfig |

### 4.6 bgTask è·¯ç”±æ”¹é€ 

**æ–‡ä»¶ï¼š`server/routers.ts:1907-2190`**

| è·¯ç”± | è¡Œå· | å…³é”®æ”¹åŠ¨ |
|------|------|----------|
| `submit` | 1909-1978 | INSERT æ—¶æ·»åŠ  userIdï¼›taskParams ä¸­æ·»åŠ  userId |
| `status` | 1981-2004 | SELECT æ—¶æ·»åŠ  `.where(eq(userId, ctx.user.id))` |
| `history` | 2007-2078 | SELECT æ·»åŠ  userId è¿‡æ»¤ |
| `feedbackContent` | 2081-2103 | SELECT æ·»åŠ  userId è¿‡æ»¤ |
| `extractionContent` | 2106-2128 | SELECT æ·»åŠ  userId è¿‡æ»¤ |
| `inputMaterials` | 2131-2158 | SELECT æ·»åŠ  userId è¿‡æ»¤ |
| `cancel` | 2161-2189 | SELECT/UPDATE æ·»åŠ  userId è¿‡æ»¤ |

### 4.7 batchTask è·¯ç”±æ”¹é€ 

**æ–‡ä»¶ï¼š`server/routers.ts:2193-2423`**

| è·¯ç”± | è¡Œå· | å…³é”®æ”¹åŠ¨ |
|------|------|----------|
| `submit` | 2195-2294 | INSERT æ—¶æ·»åŠ  userId |
| `history` | 2297-2344 | SELECT æ·»åŠ  userId è¿‡æ»¤ |
| `items` | 2347-2378 | é—´æ¥è¿‡æ»¤ï¼šå…ˆéªŒè¯ batchId å½’å±å½“å‰ç”¨æˆ· |
| `retryItem` | 2381-2393 | éªŒè¯ batchId å½’å± |
| `cancel` | 2396-2422 | éªŒè¯ batchId å½’å± |

### 4.8 correction è·¯ç”±æ”¹é€ 

**æ–‡ä»¶ï¼š`server/routers.ts:2674-2769`**

| è·¯ç”± | è¡Œå· | å…³é”®æ”¹åŠ¨ |
|------|------|----------|
| `submit` | 2676-2692 | submitCorrection ä¼ å…¥ userId |
| `getTask` | 2695-2700 | æ·»åŠ  userId è¿‡æ»¤ |
| `listTasks` | 2703-2711 | æ·»åŠ  userId è¿‡æ»¤ |
| `getTypes` | 2714-2718 | ä» user_config è¯»å– |
| `updateTypes` | 2721-2730 | å†™å…¥ user_config |
| `getPrompt` | 2733-2737 | ä» user_config è¯»å– |
| `updatePrompt` | 2740-2745 | å†™å…¥ user_config |
| `getConfig` | 2748-2756 | ä» user_config è¯»å– |
| `updateConfig` | 2759-2768 | å†™å…¥ user_config |

### 4.9 SSE ç«¯ç‚¹æ”¹é€ ï¼ˆExpress è·¯ç”±ï¼‰

**æ–‡ä»¶ï¼š`server/classStreamRoutes.ts`ï¼ˆ1592 è¡Œï¼‰**

è¿™æ˜¯ç³»ç»Ÿä¸­**æœ€å¤§çš„é—æ¼**ã€‚è¯¥æ–‡ä»¶æ³¨å†Œäº† 10 ä¸ª Express SSE ç«¯ç‚¹ï¼Œå…¨éƒ¨ä½¿ç”¨ `requireAuth` ä¸­é—´ä»¶ï¼Œå¯é€šè¿‡ `(req as any).user.id` è·å– userIdã€‚

| ç«¯ç‚¹ | è·¯å¾„ | å…³é”®æ”¹åŠ¨ |
|------|------|----------|
| è·å–æš‚å­˜å†…å®¹ | `GET /api/feedback-content/:id` | å¯é€‰ï¼šéªŒè¯ userId å½’å± |
| å°ç­è¯¾åé¦ˆæµ | `POST /api/class-feedback-stream` | getConfig â†’ getUserConfig(userId)ï¼›uploadToGoogleDrive â†’ (userId, ...) |
| ä¸€å¯¹ä¸€åé¦ˆæµ | `POST /api/feedback-stream` | åŒä¸Š |
| ä¸€å¯¹ä¸€å¤ä¹ æ–‡æ¡£æµ | `POST /api/review-stream` | åŒä¸Š |
| ä¸€å¯¹ä¸€æµ‹è¯•æœ¬æµ | `POST /api/test-stream` | åŒä¸Š |
| ä¸€å¯¹ä¸€ä¿¡æ¯æå–æµ | `POST /api/extraction-stream` | åŒä¸Š |
| å°ç­è¯¾å¤ä¹ æ–‡æ¡£æµ | `POST /api/class-review-stream` | åŒä¸Š |
| å°ç­è¯¾æµ‹è¯•æœ¬æµ | `POST /api/class-test-stream` | åŒä¸Š |
| å°ç­è¯¾ä¿¡æ¯æå–æµ | `POST /api/class-extraction-stream` | åŒä¸Š |
| ä¸‹è½½ Drive æ–‡ä»¶ | `GET /api/download-drive-file` | getValidToken â†’ getValidToken(userId) |

**æ”¹é€ æ¨¡å¼**ï¼ˆæ¯ä¸ª SSE ç«¯ç‚¹å†…éƒ¨é‡å¤ï¼‰ï¼š

```typescript
// å½“å‰ï¼š
const apiModel = input.apiModel || await getConfig("apiModel") || DEFAULT_CONFIG.apiModel;
const apiKey = input.apiKey || await getConfig("apiKey") || DEFAULT_CONFIG.apiKey;
const uploadResult = await uploadToGoogleDrive(content, fileName, folderPath);

// æ”¹ä¸ºï¼š
const userId = (req as any).user.id;
const apiModel = input.apiModel || await getUserConfig(userId, "apiModel") || DEFAULT_CONFIG.apiModel;
const apiKey = input.apiKey || await getUserConfig(userId, "apiKey") || DEFAULT_CONFIG.apiKey;
const uploadResult = await uploadToGoogleDrive(userId, content, fileName, folderPath);
```

**Google Drive è°ƒç”¨æ¸…å•**ï¼š

| è¡Œå· | è°ƒç”¨ | æ”¹åŠ¨ |
|------|------|------|
| 457 | `uploadToGoogleDrive(content, fileName, folderPath)` | â†’ `(userId, ...)` |
| 691 | `uploadBinaryToGoogleDrive(buffer, fileName, folderPath)` | â†’ `(userId, ...)` |
| 854 | `uploadBinaryToGoogleDrive(...)` | â†’ `(userId, ...)` |
| 1006 | `uploadToGoogleDrive(...)` | â†’ `(userId, ...)` |
| 1223 | `uploadBinaryToGoogleDrive(...)` | â†’ `(userId, ...)` |
| 1380 | `uploadBinaryToGoogleDrive(...)` | â†’ `(userId, ...)` |
| 1517 | `uploadToGoogleDrive(...)` | â†’ `(userId, ...)` |
| 1562 | `getValidToken()` | â†’ `getValidToken(userId)` |

**é…ç½®è¯»å–è°ƒç”¨æ¸…å•**ï¼ˆæ¯ä¸ªç«¯ç‚¹é‡å¤ 3-6 æ¬¡ï¼Œçº¦ 30+ å¤„ï¼‰ï¼š

| ç±»å‹ | ç¤ºä¾‹è¡Œå· | æ”¹åŠ¨ |
|------|----------|------|
| `getConfig("apiModel")` | 124, 606, 769, 922, 1103, 1302, 1438 | â†’ `getUserConfig(userId, ...)` |
| `getConfig("apiKey")` | 125, 607, 770, 923, 1104, 1303, 1439 | â†’ åŒä¸Š |
| `getConfig("apiUrl")` | 126, 608, 771, 924, 1105, 1304, 1440 | â†’ åŒä¸Š |
| `getConfig("driveBasePath")` | 442, 673, 838, 988, 1135, 1327, 1463 | â†’ åŒä¸Š |
| `getConfig("classStoragePath")` | 1134, 1326, 1462 | â†’ åŒä¸Š |
| `getConfig("currentYear")` | 127 | â†’ åŒä¸Š |
| `getConfig("roadmapClass")` | 128 | â†’ åŒä¸Š |

### 4.10 æ‰¹é‡å¤„ç† Express è·¯ç”±æ”¹é€ 

**æ–‡ä»¶ï¼š`server/batch/batchRoutes.ts`ï¼ˆ1547 è¡Œï¼‰**

è¯¥æ–‡ä»¶æ˜¯æ‰¹é‡å¤„ç†çš„ SSE ç«¯ç‚¹ï¼ˆExpress Routerï¼‰ï¼Œä¹Ÿä½¿ç”¨ `requireAuth` ä¸­é—´ä»¶ã€‚

| ç«¯ç‚¹ | è·¯å¾„ | å…³é”®æ”¹åŠ¨ |
|------|------|----------|
| åœæ­¢æ‰¹é‡ | `POST /api/batch/stop` | éªŒè¯ batchId å½’å± userId |
| æŸ¥è¯¢çŠ¶æ€ | `GET /api/batch/status/:batchId` | éªŒè¯å½’å± |
| æ‰¹é‡ç”Ÿæˆæµ | `POST /api/batch/generate-stream` | getAPIConfig â†’ getUserAPIConfig(userId); upload â†’ (userId, ...) |
| é‡è¯•å­ä»»åŠ¡ | `POST /api/batch/retry-task` | éªŒè¯å½’å± + userId ä¼ é€’ |
| ä¸Šä¼ æ–‡ä»¶ | `POST /api/batch/upload-files` | æ—  GDrive æ“ä½œ |

**Google Drive è°ƒç”¨**ï¼š

| è¡Œå· | è°ƒç”¨ | æ”¹åŠ¨ |
|------|------|------|
| 414 | `ensureFolderExists(batchFolderPath)` | â†’ `ensureFolderExists(userId, ...)` |
| 802 | `uploadBinaryToGoogleDrive(buffer, filename, folder)` | â†’ `(userId, ...)` |
| 1277 | `uploadBinaryToGoogleDrive(...)` | â†’ `(userId, ...)` |

**é…ç½®è°ƒç”¨**ï¼š

| è¡Œå· | è°ƒç”¨ | æ”¹åŠ¨ |
|------|------|------|
| 373 | `getAPIConfig()` | â†’ `getAPIConfig(userId)` |
| 1033 | `getAPIConfig()` | â†’ `getAPIConfig(userId)` |

**å†…å­˜çŠ¶æ€éš”ç¦»**ï¼š

```typescript
// å½“å‰ï¼šå…¨å±€ Mapï¼Œä»»ä½•ç”¨æˆ·å¯æŸ¥çœ‹/åœæ­¢ä»»ä½•æ‰¹é‡
const activeBatches = new Map<string, BatchStatus>();

// æ”¹ä¸ºï¼šæŸ¥è¯¢æ—¶éªŒè¯ batchId çš„ userId å½’å±
// ä¸éœ€è¦æ”¹ Map ç»“æ„ï¼Œåªéœ€åœ¨ stop/status ç«¯ç‚¹éªŒè¯æ‰€æœ‰æƒ
```

### 4.11 æ‰¹é‡æ‰§è¡Œå™¨æ”¹é€ 

**æ–‡ä»¶ï¼š`server/batch/batchExecutor.ts`ï¼ˆ296 è¡Œï¼‰**

å…±äº«å·¥å…·æ¨¡å—ï¼Œè¢« batchRoutes.ts å’Œ batchTaskRunner.ts è°ƒç”¨ã€‚

```
executeBatchItem(params) â†’ executeBatchItem(userId, params)
  - å†…éƒ¨è°ƒç”¨ uploadBinaryToGoogleDrive â†’ (userId, ...)

buildBatchMessageContent(params) â†’ æ— éœ€æ”¹ï¼ˆçº¯æ•°æ®æ„é€ ï¼Œä¸æ¶‰åŠ DB/é…ç½®ï¼‰
```

### 4.12 ç³»ç»Ÿè‡ªæ£€æ”¹é€ 

**æ–‡ä»¶ï¼š`server/systemCheck.ts`ï¼ˆ585 è¡Œï¼‰**

ç³»ç»Ÿè‡ªæ£€æ¨¡å—ï¼Œè¢« `feedback.systemCheck` è·¯ç”±è°ƒç”¨ã€‚

```
runSystemCheck() â†’ runSystemCheck(userId: number)
  - å†…éƒ¨ getValidToken() â†’ getValidToken(userId)
  - å†…éƒ¨ isOAuthAuthorized() â†’ isOAuthAuthorized(userId)
  - é…ç½®è¯»å–ä» systemConfig â†’ getUserConfig(userId, ...)
```

**æ³¨æ„**ï¼šè‡ªæ£€ç»“æœä¼šå› ç”¨æˆ·ä¸åŒè€Œä¸åŒï¼ˆæ¯äººçš„ Google Drive æˆæƒçŠ¶æ€ã€API Key é…ç½®çŠ¶æ€ä¸åŒï¼‰ã€‚

---

## äº”ã€ä¸šåŠ¡é€»è¾‘å±‚æ”¹é€ ï¼ˆPhase 4ï¼‰

### 5.1 homeworkManager.ts æ”¹é€ 

**æ–‡ä»¶ï¼š`server/homeworkManager.ts`ï¼ˆ923 è¡Œï¼‰**

**å‡½æ•°ç­¾åæ”¹é€ **ï¼ˆå…¨éƒ¨éœ€è¦æ·»åŠ  userId å‚æ•°ï¼‰ï¼š

| å‡½æ•° | è¡Œå· | æ”¹åŠ¨ |
|------|------|------|
| `listStudents(statusFilter?)` | 97 | â†’ `listStudents(userId, statusFilter?)` |
| `addStudent(name, planType)` | 108 | â†’ `addStudent(userId, name, planType)` |
| `updateStudent(id, data)` | 130 | â†’ `updateStudent(userId, id, data)` + éªŒè¯å½’å± |
| `removeStudent(id)` | 147 | â†’ `removeStudent(userId, id)` + éªŒè¯å½’å± |
| `getStudentLatestStatus(studentName)` | 185 | â†’ `getStudentLatestStatus(userId, studentName)` |
| `submitAndProcessEntry(studentName, rawInput, aiModel?)` | 304 | â†’ æ·»åŠ  userId |
| `createEntry(studentName, rawInput, aiModel?)` | 286 | â†’ æ·»åŠ  userId |
| `processEntry(studentName, rawInput, aiModel?, onProgress?)` | 212 | â†’ è¯»å– user_config |
| `listEntries(statusFilter?)` | 379 | â†’ `listEntries(userId, statusFilter?)` |
| `listPendingEntries()` | 392 | â†’ `listPendingEntries(userId)` |
| `listStudentEntries(studentName, limit, offset)` | 404 | â†’ æ·»åŠ  userId |
| `retryEntry(id)` | 427 | â†’ æ·»åŠ  userId + éªŒè¯å½’å± |
| `deleteEntry(id)` | 481 | â†’ æ·»åŠ  userId + éªŒè¯å½’å± |
| `confirmEntries(ids)` | 489 | â†’ æ·»åŠ  userId |
| `confirmAllPreStaged()` | 523 | â†’ `confirmAllPreStaged(userId)` |
| `importFromExtraction(studentName, content)` | 562 | â†’ æ·»åŠ  userId |
| `importFromTaskExtraction(taskId, studentName)` | 604 | â†’ æ·»åŠ  userId + éªŒè¯ä»»åŠ¡å½’å± |
| `importClassFromTaskExtraction(taskId, className, students)` | 637 | â†’ æ·»åŠ  userId |
| `exportStudentBackup()` | 708 | â†’ `exportStudentBackup(userId)` |
| `importStudentBackup(content)` | 854 | â†’ `importStudentBackup(userId, content)` |
| `autoBackupToGDrive()` | 900 | â†’ `autoBackupToGDrive(userId)` â€” ä¸Šä¼ åˆ°ç”¨æˆ·è‡ªå·±çš„ GDrive |

**æŸ¥è¯¢æ”¹é€ **ï¼ˆæ·»åŠ  userId è¿‡æ»¤ï¼‰ï¼š

| è¡Œå· | å½“å‰ | æ”¹ä¸º |
|------|------|------|
| 102-104 | `db.select().from(hwStudents)` | æ·»åŠ  `.where(eq(hwStudents.userId, userId))` |
| 113-115 | `db.select().from(hwStudents).where(eq(hwStudents.name, name))` | æ·»åŠ  `and(eq(hwStudents.userId, userId), ...)` |
| 126 | `db.insert(hwStudents).values({...})` | æ·»åŠ  `userId` å­—æ®µ |
| 143 | `db.update(hwStudents).set(...).where(eq(hwStudents.id, id))` | æ·»åŠ  userId æ¡ä»¶ |
| 151 | `db.update(hwStudents).set({status: "inactive"}).where(...)` | æ·»åŠ  userId æ¡ä»¶ |
| 190-197 | `db.select().from(hwEntries).where(...)` | æ·»åŠ  userId æ¡ä»¶ |
| 204-208 | `db.select().from(hwStudents).where(...)` | æ·»åŠ  userId æ¡ä»¶ |
| 290-295 | `db.insert(hwEntries).values({...})` | æ·»åŠ  `userId` å­—æ®µ |
| 396-400 | `db.select().from(hwEntries).where(...)` | æ·»åŠ  userId æ¡ä»¶ |
| 409-422 | `db.select().from(hwEntries).where(...)` | æ·»åŠ  userId æ¡ä»¶ |
| 512-514 | `db.update(hwStudents).set(...).where(eq(hwStudents.name, name))` | æ·»åŠ  userId æ¡ä»¶ |
| 529-531 | `db.select().from(hwEntries).where(...)` | æ·»åŠ  userId æ¡ä»¶ |
| 545-548 | `db.update(hwStudents).set(...).where(eq(hwStudents.name, name))` | æ·»åŠ  userId æ¡ä»¶ |
| 572-574 | `db.select().from(hwStudents).where(...)` | æ·»åŠ  userId æ¡ä»¶ |
| 576-580 | `db.insert(hwStudents).values({...})` | æ·»åŠ  userId å­—æ®µ |
| 713-715 | `db.select().from(hwStudents).where(...)` | æ·»åŠ  userId æ¡ä»¶ |
| 870-873 | `db.select().from(hwStudents).where(...)` | æ·»åŠ  userId æ¡ä»¶ |

**é…ç½®è¯»å–æ”¹é€ **ï¼ˆprocessEntry å‡½æ•°å†…ï¼‰ï¼š

| è¡Œå· | å½“å‰ | æ”¹ä¸º |
|------|------|------|
| 219 | `getConfigValue("apiKey")` | `getUserConfigValue(userId, "apiKey")` |
| 220 | `getConfigValue("apiUrl")` | `getUserConfigValue(userId, "apiUrl")` |
| 221 | `getConfigValue("apiModel")` | `getUserConfigValue(userId, "apiModel")` |
| 224 | `getConfigValue("hwPromptTemplate")` | `getUserConfigValue(userId, "hwPromptTemplate")` |

### 5.2 backgroundTaskRunner.ts æ”¹é€ 

**æ–‡ä»¶ï¼š`server/backgroundTaskRunner.ts`ï¼ˆ1015 è¡Œï¼‰**

**å…³é”®æ”¹é€ ç‚¹**ï¼šåå°ä»»åŠ¡åœ¨ fire-and-forget æ¨¡å¼ä¸‹è¿è¡Œï¼Œéœ€è¦ä»ä»»åŠ¡å‚æ•°ä¸­è·å– userIdã€‚

æ–¹æ¡ˆï¼šåœ¨ `inputParams` JSON ä¸­åµŒå…¥ userIdï¼Œåå°è¿è¡Œæ—¶ä»ä¸­å–å‡ºã€‚

| è¡Œå· | æ”¹åŠ¨ |
|------|------|
| 220-249ï¼ˆrunTaskï¼‰ | ä» `task.inputParams` ä¸­å– userIdï¼ˆæˆ–ä»æ–°å¢çš„ backgroundTasks.userId åˆ—è¯»å–ï¼‰ |
| 254-552ï¼ˆrunOneToOneTaskï¼‰ | æ‰€æœ‰ getConfig â†’ getUserConfig(userId)ï¼›æ‰€æœ‰ upload â†’ upload(userId, ...) |
| 557-898ï¼ˆrunClassTaskï¼‰ | åŒä¸Š |
| 903-937ï¼ˆcleanupOldTasksï¼‰ | æ— éœ€æ”¹é€ ï¼ˆæŒ‰æ—¶é—´æ¸…ç†ï¼Œä¸åŒºåˆ†ç”¨æˆ·ï¼‰ |
| 980-1014ï¼ˆrecoverInterruptedTasksï¼‰ | æ— éœ€æ”¹é€ ï¼ˆæ ‡è®°æ‰€æœ‰ running ä¸ºå¤±è´¥ï¼Œä¸åŒºåˆ†ç”¨æˆ·ï¼‰ |

**é…ç½®è¯»å–æ”¹é€ ï¼ˆrunOneToOneTask å†…ï¼‰**ï¼š

| è¡Œå· | å½“å‰ | æ”¹ä¸º |
|------|------|------|
| 262 | `getConfig("apiModel")` | `getUserConfig(userId, "apiModel")` |
| 263 | `getConfig("apiKey")` | `getUserConfig(userId, "apiKey")` |
| 264 | `getConfig("apiUrl")` | `getUserConfig(userId, "apiUrl")` |
| 265 | `getConfig("roadmap")` | `getUserConfig(userId, "roadmap")` |
| 266 | `getConfig("driveBasePath")` | `getUserConfig(userId, "driveBasePath")` |
| 267 | `getConfig("currentYear")` | `getUserConfig(userId, "currentYear")` |

**Google Drive ä¸Šä¼ æ”¹é€ ï¼ˆrunOneToOneTask å†…ï¼‰**ï¼š

| è¡Œå· | å½“å‰ | æ”¹ä¸º |
|------|------|------|
| 332 | `uploadToGoogleDrive(content, fileName, folderPath)` | `uploadToGoogleDrive(userId, content, fileName, folderPath)` |
| 429 | `uploadBinaryToGoogleDrive(buffer, fileName, folderPath)` | `uploadBinaryToGoogleDrive(userId, buffer, fileName, folderPath)` |
| 452 | `uploadBinaryToGoogleDrive(...)` | åŒä¸Š |
| 475 | `uploadToGoogleDrive(...)` | åŒä¸Š |
| 488 | `uploadBinaryToGoogleDrive(...)` | åŒä¸Š |
| 537 | `uploadToGoogleDrive(logContent, ...)` | åŒä¸Š |

**å°ç­è¯¾ä»»åŠ¡åŒç†**ï¼ˆrunClassTask å†…ï¼Œè¡Œå· 564-897ï¼‰ã€‚

### 5.3 batchTaskRunner.ts æ”¹é€ 

**æ–‡ä»¶ï¼š`server/batch/batchTaskRunner.ts`**

ä¸ backgroundTaskRunner ç±»ä¼¼ï¼š

- ä» `batchTasks.userId` åˆ—æˆ– `inputParams` ä¸­è·å– userId
- æ‰€æœ‰ `getConfig(...)` â†’ `getUserConfig(userId, ...)`
- æ‰€æœ‰ `uploadBinaryToGoogleDrive(...)` â†’ `uploadBinaryToGoogleDrive(userId, ...)`
- `ensureFolderExists(...)` â†’ `ensureFolderExists(userId, ...)`

### 5.4 correctionRunner.ts æ”¹é€ 

**æ–‡ä»¶ï¼š`server/correctionRunner.ts`**

- `submitCorrection(input)` â†’ `submitCorrection(userId, input)` â€” INSERT æ—¶æ·»åŠ  userId
- `getCorrectionTask(id)` â†’ æ·»åŠ  userId è¿‡æ»¤
- `listCorrectionTasks(studentName?, limit?)` â†’ æ·»åŠ  userId è¿‡æ»¤
- `getCorrectionTypes()` â†’ ä» user_config è¯»å–
- `getCorrectionPrompt()` â†’ ä» user_config è¯»å–
- `processCorrection(taskId)` å†…éƒ¨è¯»å–ç”¨æˆ·é…ç½®
- é…ç½®è¯»å–ï¼š`getConfigValue("correctionTypes")` â†’ `getUserConfigValue(userId, "correctionTypes")`
- é…ç½®è¯»å–ï¼š`getConfigValue("correctionPrompt")` â†’ `getUserConfigValue(userId, "correctionPrompt")`

### 5.5 autoBackupToGDrive æ”¹é€ 

**æ–‡ä»¶ï¼š`server/homeworkManager.ts:900-922`**

- æ¥æ”¶ userId å‚æ•°
- `getConfig("driveBasePath")` â†’ `getUserConfig(userId, "driveBasePath")`
- `uploadToGoogleDrive(content, fileName, folderPath)` â†’ `uploadToGoogleDrive(userId, content, ...)`

### 5.6 ensureHwTables / ensureTable å»ºè¡¨è„šæœ¬æ”¹é€ 

**æ–‡ä»¶**ï¼š
- `server/homeworkManager.ts:17-93`ï¼ˆCREATE TABLE hw_students / hw_entriesï¼‰
- `server/backgroundTaskRunner.ts:942-974`ï¼ˆCREATE TABLE background_tasksï¼‰

éœ€è¦åœ¨ CREATE TABLE ä¸­æ·»åŠ  `user_id` åˆ—ï¼Œåœ¨ safeAddColumn ä¸­å¤„ç†å…¼å®¹ã€‚

---

## å…­ã€å‰ç«¯æ”¹é€ ï¼ˆPhase 5ï¼‰

### 6.1 å‰ç«¯æ”¹åŠ¨æå°

ç”±äºéš”ç¦»åœ¨æœåŠ¡ç«¯ API å±‚å®ç°ï¼Œå‰ç«¯ tRPC è°ƒç”¨**ä¸éœ€è¦ä¼  userId**ï¼ˆsession è‡ªåŠ¨æºå¸¦ï¼‰ï¼Œå¤§éƒ¨åˆ†å‰ç«¯ä»£ç **ä¸éœ€è¦ä¿®æ”¹**ã€‚

### 6.2 localStorage ç”¨æˆ·éš”ç¦»

**æ–‡ä»¶ï¼š`client/src/pages/Home.tsx`**

| è¡Œå· | å½“å‰ Key | æ”¹ä¸º |
|------|----------|------|
| 486 | `studentLessonHistoryV2` | `studentLessonHistoryV2_${user.id}` |
| 516 | åŒä¸Š | åŒä¸Š |
| 531 | åŒä¸Š | åŒä¸Š |
| 605 | åŒä¸Š | åŒä¸Š |

**æ–‡ä»¶ï¼š`client/src/components/DashboardLayout.tsx`**

| è¡Œå· | å½“å‰ Key | æ”¹ä¸º |
|------|----------|------|
| 35 | `sidebar-width` | `sidebar-width_${user.id}` |
| 46 | åŒä¸Š | åŒä¸Š |
| 52 | åŒä¸Š | åŒä¸Š |

**æ–‡ä»¶ï¼š`client/src/contexts/ThemeContext.tsx`**

| è¡Œå· | å½“å‰ Key | æ”¹ä¸º |
|------|----------|------|
| 26 | `theme` | `theme_${user.id}` |
| 41 | åŒä¸Š | åŒä¸Š |

### 6.3 Google Drive æˆæƒ UI

**æ–‡ä»¶ï¼š`client/src/components/GlobalSettings.tsx`**

å½“å‰æˆæƒçŠ¶æ€æ˜¾ç¤ºçš„æ˜¯å…¨å±€çš„ã€‚æ”¹ä¸ºæ¯ç”¨æˆ·ç‹¬ç«‹åï¼Œä¸éœ€è¦ UI æ”¹åŠ¨ï¼ˆåç«¯è¿”å›çš„çŠ¶æ€å·²ç»æ˜¯å½“å‰ç”¨æˆ·çš„äº†ï¼‰ã€‚

---

## ä¸ƒã€å®æ–½é¡ºåºä¸ä¾èµ–å…³ç³»

```
Phase 1: æ•°æ®åº“æ”¹é€ ï¼ˆæ— ä¾èµ–ï¼‰
  â”œâ”€â”€ 1.1 æ–°å»º user_config è¡¨
  â”œâ”€â”€ 1.2 æ‰€æœ‰è¡¨æ·»åŠ  userId åˆ—
  â”œâ”€â”€ 1.3 å­˜é‡æ•°æ®è¿ç§»
  â””â”€â”€ 1.4 ä¿®æ”¹å”¯ä¸€çº¦æŸ

Phase 2: æ ¸å¿ƒåŸºç¡€è®¾æ–½ï¼ˆä¾èµ– Phase 1ï¼‰
  â”œâ”€â”€ 2.1 é…ç½®è¯»å–å±‚ getUserConfigValue()
  â”œâ”€â”€ 2.2 googleAuth.ts å…¨é¢æ”¹é€ ï¼ˆuserId å‚æ•°ï¼‰
  â”œâ”€â”€ 2.3 gdrive.ts å…¨é¢æ”¹é€ ï¼ˆuserId å‚æ•°ï¼‰
  â””â”€â”€ 2.4 trpc.ts ä¸­é—´ä»¶å¢å¼ºï¼ˆctx.userIdï¼‰

Phase 3: è·¯ç”±å±‚æ”¹é€ ï¼ˆä¾èµ– Phase 2ï¼‰
  â”œâ”€â”€ 3.1 config è·¯ç”±ï¼ˆ5 ä¸ª tRPCï¼‰
  â”œâ”€â”€ 3.2 homework è·¯ç”±ï¼ˆ20 ä¸ª tRPCï¼‰
  â”œâ”€â”€ 3.3 feedback è·¯ç”±ï¼ˆ18 ä¸ª tRPCï¼‰
  â”œâ”€â”€ 3.4 localFile è·¯ç”±ï¼ˆ3 ä¸ª tRPCï¼‰
  â”œâ”€â”€ 3.5 bgTask è·¯ç”±ï¼ˆ7 ä¸ª tRPCï¼‰
  â”œâ”€â”€ 3.6 batchTask è·¯ç”±ï¼ˆ5 ä¸ª tRPCï¼‰
  â”œâ”€â”€ 3.7 correction è·¯ç”±ï¼ˆ9 ä¸ª tRPCï¼‰
  â”œâ”€â”€ 3.8 classStreamRoutes SSEï¼ˆ10 ä¸ª Expressï¼‰  â† æ–°å¢
  â”œâ”€â”€ 3.9 batchRoutes SSEï¼ˆ5 ä¸ª Expressï¼‰          â† æ–°å¢
  â””â”€â”€ 3.10 systemCheckï¼ˆ1 ä¸ª tRPCï¼Œè°ƒç”¨æ”¹é€ åçš„å‡½æ•°ï¼‰

Phase 4: ä¸šåŠ¡é€»è¾‘å±‚ï¼ˆä¾èµ– Phase 2ï¼Œå¯ä¸ Phase 3 å¹¶è¡Œï¼‰
  â”œâ”€â”€ 4.1 homeworkManager.tsï¼ˆ20+ å‡½æ•°ï¼‰
  â”œâ”€â”€ 4.2 backgroundTaskRunner.tsï¼ˆé…ç½® + ä¸Šä¼ ï¼‰
  â”œâ”€â”€ 4.3 batchTaskRunner.tsï¼ˆé…ç½® + ä¸Šä¼ ï¼‰
  â”œâ”€â”€ 4.4 correctionRunner.tsï¼ˆé…ç½® + æŸ¥è¯¢ï¼‰
  â”œâ”€â”€ 4.5 batchExecutor.tsï¼ˆä¸Šä¼ å‡½æ•°ç­¾åï¼‰      â† æ–°å¢
  â””â”€â”€ 4.6 systemCheck.tsï¼ˆé…ç½® + GDrive æ£€æŸ¥ï¼‰   â† æ–°å¢

Phase 5: å‰ç«¯ï¼ˆä¾èµ– Phase 3ï¼‰
  â””â”€â”€ 5.1 localStorage key åŠ  userId å‰ç¼€ï¼ˆ3 ä¸ªæ–‡ä»¶ï¼‰

Phase 6: OAuth å›è°ƒï¼ˆä¾èµ– Phase 2ï¼‰
  â””â”€â”€ 6.1 Google OAuth callback ä¼ é€’ userId
```

---

## å…«ã€é£é™©ä¸æ³¨æ„äº‹é¡¹

### 8.1 åå°ä»»åŠ¡çš„ userId ä¼ é€’

åå°ä»»åŠ¡ï¼ˆbackgroundTask, batchTaskï¼‰åœ¨ `fire-and-forget` æ¨¡å¼ä¸‹è¿è¡Œï¼Œè„±ç¦»äº† HTTP è¯·æ±‚ä¸Šä¸‹æ–‡ã€‚å¿…é¡»ç¡®ä¿ userId åœ¨ä»»åŠ¡åˆ›å»ºæ—¶æŒä¹…åŒ–åˆ°æ•°æ®åº“ï¼Œè¿è¡Œæ—¶ä»æ•°æ®åº“è¯»å–ï¼Œè€Œéä»è¯·æ±‚ä¸Šä¸‹æ–‡è·å–ã€‚

**æ–¹æ¡ˆ**ï¼š
- ä»»åŠ¡è¡¨å·²æœ‰ `userId` åˆ— â†’ è¿è¡Œå™¨ä» DB è¯»å–
- åŒæ—¶åœ¨ `inputParams` JSON ä¸­ä¹Ÿä¿å­˜ userIdï¼ˆåŒä¿é™©ï¼‰

### 8.2 Google OAuth å›è°ƒä¸­çš„ç”¨æˆ·è¯†åˆ«

Google OAuth å›è°ƒæ˜¯ GET è¯·æ±‚ï¼Œä¸ç»è¿‡ tRPCã€‚éœ€è¦åœ¨å‘èµ·æˆæƒæ—¶å°† userId ç¼–ç åˆ° OAuth `state` å‚æ•°ä¸­ï¼Œå›è°ƒæ—¶è§£ç ã€‚

**å®‰å…¨è€ƒè™‘**ï¼šstate å‚æ•°éœ€åŠ å¯†æˆ–ç­¾åï¼Œé˜²æ­¢ä¼ªé€ ã€‚

### 8.3 å¹¶å‘å®‰å…¨

- `getValidToken(userId)` çš„å¹¶å‘åˆ·æ–°é”éœ€æ”¹ä¸º `Map<userId, Promise>`
- å¤šç”¨æˆ·åŒæ—¶æ“ä½œ Google Drive æ–‡ä»¶å¤¹åˆ›å»ºéœ€æ³¨æ„ `pendingFolderOps` ç¼“å­˜éš”ç¦»

### 8.4 å­˜é‡æ•°æ®å…¼å®¹

- è¿ç§»è„šæœ¬å¿…é¡»åœ¨åº”ç”¨åœæœºæ—¶æ‰§è¡Œ
- systemConfig â†’ user_config è¿ç§»åï¼Œæ—§çš„ systemConfig è¡Œåº”æ¸…ç†
- ç¡®ä¿ admin ç”¨æˆ· id=1 å­˜åœ¨

### 8.5 ensureTable å…¼å®¹

`homeworkManager.ts` å’Œ `backgroundTaskRunner.ts` ä¸­æœ‰ `CREATE TABLE IF NOT EXISTS` è‡ªåŠ¨å»ºè¡¨é€»è¾‘ã€‚éœ€è¦æ›´æ–°è¿™äº› SQLï¼Œæ·»åŠ  `user_id` åˆ—ï¼Œå¹¶åŠ  `safeAddColumn` å…¼å®¹å¤„ç†ã€‚

---

### 8.6 gdrive.ts çš„ pendingFolderOps ç¼“å­˜

**æ–‡ä»¶ï¼š`server/gdrive.ts`**

`pendingFolderOps` æ˜¯æ–‡ä»¶å¤¹åˆ›å»ºå»é‡ç¼“å­˜ï¼ˆé¿å…å¹¶å‘åˆ›å»ºåŒåæ–‡ä»¶å¤¹ï¼‰ã€‚å½“å‰æ˜¯å…¨å±€ Mapï¼Œä¸åŒç”¨æˆ·çš„æ–‡ä»¶å¤¹è·¯å¾„å¤©ç„¶ä¸åŒï¼ˆå› ä¸º basePath ä¸åŒï¼‰ï¼Œæ‰€ä»¥**ä¸éœ€è¦æŒ‰ userId éš”ç¦»æ­¤ç¼“å­˜**ã€‚ä½†å¦‚æœä¸¤ä¸ªç”¨æˆ·æ°å¥½é…ç½®äº†ç›¸åŒçš„ basePathï¼Œå¯èƒ½ä¼šäº’ç›¸ç¼“å­˜å‘½ä¸­ã€‚

**å»ºè®®**ï¼šå°†ç¼“å­˜ key æ”¹ä¸º `${userId}:${folderPath}`ï¼Œç®€å•ä¸”å®‰å…¨ã€‚

### 8.7 previewBackup / parseBackupContent è¾…åŠ©å‡½æ•°

**æ–‡ä»¶ï¼š`server/homeworkManager.ts`**

`parseBackupContent()` å’Œ `previewBackup()` æ˜¯çº¯æ–‡æœ¬è§£æå·¥å…·å‡½æ•°ï¼Œä¸è®¿é—®æ•°æ®åº“ï¼Œ**ä¸éœ€è¦æ”¹é€ **ã€‚

---

## ä¹ã€æ”¹é€ ç»Ÿè®¡

| ç±»åˆ« | æ•°é‡ |
|------|------|
| éœ€æ”¹é€ çš„æ•°æ®è¡¨ | 7 å¼ ï¼ˆ+ æ–°å»º 1 å¼ ï¼‰ |
| éœ€æ”¹é€ çš„ tRPC è·¯ç”± | 74 ä¸ª |
| éœ€æ”¹é€ çš„ Express SSE ç«¯ç‚¹ | 15 ä¸ª |
| éœ€æ”¹é€ çš„åç«¯æ–‡ä»¶ | 17 ä¸ª |
| éœ€æ”¹é€ çš„å‡½æ•°ç­¾å | 50+ ä¸ª |
| éœ€æ”¹é€ çš„ DB æŸ¥è¯¢ | 60+ å¤„ |
| éœ€æ”¹é€ çš„é…ç½®è¯»å–è°ƒç”¨ | 80+ å¤„ |
| éœ€æ”¹é€ çš„ GDrive è°ƒç”¨ | 20+ å¤„ |
| éœ€æ”¹é€ çš„å‰ç«¯æ–‡ä»¶ | 3 ä¸ª |
| æ•°æ®åº“è¿ç§»æ­¥éª¤ | 8 æ­¥ |

### æ¶‰åŠæ–‡ä»¶å®Œæ•´åˆ—è¡¨

| æ–‡ä»¶ | æ”¹åŠ¨é‡ | è¯´æ˜ |
|------|--------|------|
| `drizzle/schema.ts` | å¤§ | 6 å¼ è¡¨åŠ  userId + æ–°å»º user_config |
| `server/core/aiClient.ts` | ä¸­ | é…ç½®è¯»å–å±‚æ”¹é€ ï¼ˆgetUserConfigValueï¼‰ |
| `server/googleAuth.ts` | å¤§ | å…¨é¢ userId å‚æ•°åŒ–ï¼ˆ5 ä¸ªå‡½æ•°ï¼‰ |
| `server/gdrive.ts` | å¤§ | å…¨é¢ userId å‚æ•°åŒ–ï¼ˆ8 ä¸ªå‡½æ•°ï¼‰ |
| `server/_core/oauth.ts` | ä¸­ | Google OAuth å›è°ƒä¼ é€’ userId |
| `server/_core/trpc.ts` | å° | ä¸­é—´ä»¶å¢åŠ  ctx.userId |
| `server/_core/authMiddleware.ts` | æ—  | å·²æŒ‚è½½ req.userï¼Œä¸éœ€æ”¹ |
| `server/routers.ts` | å¾ˆå¤§ | 74 ä¸ª tRPC è·¯ç”±å…¨éƒ¨æ”¹é€  |
| `server/classStreamRoutes.ts` | å¾ˆå¤§ | 10 ä¸ª SSE ç«¯ç‚¹å…¨éƒ¨æ”¹é€ ï¼ˆ1592 è¡Œï¼‰ |
| `server/batch/batchRoutes.ts` | å¤§ | 5 ä¸ª Express ç«¯ç‚¹æ”¹é€ ï¼ˆ1547 è¡Œï¼‰ |
| `server/batch/batchExecutor.ts` | å° | executeBatchItem åŠ  userId |
| `server/batch/batchTaskRunner.ts` | å¤§ | é…ç½® + Google Drive æ”¹é€  |
| `server/homeworkManager.ts` | å¤§ | 20+ å‡½æ•°å…¨éƒ¨åŠ  userId |
| `server/backgroundTaskRunner.ts` | å¤§ | é…ç½® + Google Drive æ”¹é€  |
| `server/correctionRunner.ts` | ä¸­ | æŸ¥è¯¢ + é…ç½®æ”¹é€  |
| `server/systemCheck.ts` | ä¸­ | getValidToken + é…ç½®æ”¹é€  |
| `server/contentStore.ts` | å° | å¯é€‰ï¼šmeta ä¸­è®°å½• userId |
| `client/src/pages/Home.tsx` | å° | localStorage key åŠ ç”¨æˆ·å‰ç¼€ |
| `client/src/components/DashboardLayout.tsx` | å° | localStorage key åŠ ç”¨æˆ·å‰ç¼€ |
| `client/src/contexts/ThemeContext.tsx` | å° | localStorage key åŠ ç”¨æˆ·å‰ç¼€ |

---

## åã€éªŒè¯è®°å½•

### ç¬¬ä¸€è½®ï¼šå®Œæ•´æ€§æ£€æŸ¥

| æ£€æŸ¥é¡¹ | ç»“æœ | è¡¥å……å†…å®¹ |
|--------|------|----------|
| æ•°æ®è¡¨è¦†ç›– | âœ… å…¨éƒ¨ 9 å¼ è¡¨å·²åˆ—å‡º | â€” |
| é…ç½®é”®è¦†ç›– | âœ… å…¨éƒ¨ 25 ä¸ªç”¨æˆ·é…ç½® + 1 ä¸ªå…¨å±€é…ç½® | â€” |
| tRPC è·¯ç”±è®¡æ•° | âš ï¸ ä¿®æ­£ | 66 â†’ 74ï¼ˆå·® auth 2 + config 1 + feedback/list ç­‰ï¼‰ |
| Express ç«¯ç‚¹ | âŒ é—æ¼ | æ–°å¢ classStreamRoutes.tsï¼ˆ10 ç«¯ç‚¹ï¼‰ã€batchRoutes.tsï¼ˆ5 ç«¯ç‚¹ï¼‰ |
| åç«¯æ–‡ä»¶ | âŒ é—æ¼ | æ–°å¢ classStreamRoutes.tsã€batchRoutes.tsã€batchExecutor.tsã€systemCheck.ts |
| å‰ç«¯ localStorage | âš ï¸ è¡¥å…… | æ–°å¢ sidebar-widthï¼ˆDashboardLayoutï¼‰ã€themeï¼ˆThemeContextï¼‰ |
| è¾…åŠ©å‡½æ•° | âœ… ç¡®è®¤ | parseBackupContent / previewBackup ä¸éœ€æ”¹é€  |

### ç¬¬äºŒè½®ï¼šåˆç†æ€§æ£€æŸ¥

| æ£€æŸ¥é¡¹ | ç»“æœ | è¯´æ˜ |
|--------|------|------|
| user_config æ–¹æ¡ˆ | âœ… åˆç† | ç”¨æˆ·çº§é…ç½®ç‹¬ç«‹å­˜å‚¨ï¼Œå…¨å±€é…ç½®ä¿ç•™ systemConfig |
| Google Drive æ¯äººä¸€å¥— OAuth | âœ… åˆç† | googleTokens åŠ  userId + UNIQUE(userId) |
| batch_task_items ä¸åŠ  userId | âœ… åˆç† | é€šè¿‡ batchId â†’ batchTasks.userId é—´æ¥å…³è” |
| å­˜é‡æ•°æ®å½’ admin | âœ… åˆç† | ç®€å•å¯è¡Œï¼Œadmin id=1 å·²åœ¨ db.ts ä¸­é»˜è®¤åˆ›å»º |
| åå°ä»»åŠ¡ä» DB è¯» userId | âœ… åˆç† | é¿å…é—­åŒ…å¼•ç”¨è¿‡æœŸä¸Šä¸‹æ–‡ |
| OAuth state ä¼  userId | âœ… åˆç† | æ ‡å‡† OAuth 2.0 åšæ³•ï¼Œéœ€ç­¾åé˜²ä¼ªé€  |
| contentStore ä¸æ”¹ key | âœ… åˆç† | UUID ä¸å¯çŒœæµ‹ï¼Œå®‰å…¨æ€§è¶³å¤Ÿ |
| é…ç½®å›é€€é“¾ | âœ… åˆç† | user_config â†’ systemConfig â†’ DEFAULT_CONFIG |
| Phase é¡ºåº | âœ… åˆç† | ä¾èµ–å…³ç³»æ­£ç¡®ï¼šschema â†’ infra â†’ routes â†’ logic â†’ frontend |

### ç¬¬ä¸‰è½®ï¼šé€»è¾‘æ­£ç¡®æ€§æ£€æŸ¥

| æ£€æŸ¥é¡¹ | ç»“æœ | è¯´æ˜ |
|--------|------|------|
| hw_students å”¯ä¸€çº¦æŸå˜æ›´ | âœ… æ­£ç¡® | `UNIQUE(name)` â†’ `UNIQUE(userId, name)`ï¼Œä¸åŒç”¨æˆ·å¯æœ‰åŒåå­¦ç”Ÿ |
| ensureHwTables å»ºè¡¨ SQL | âš ï¸ éœ€æ³¨æ„ | å»ºè¡¨ SQL ä¸­è¦åŠ  `user_id` åˆ—ï¼›safeAddColumn å…¼å®¹æ—§è¡¨ |
| confirmEntries è·¨è¡¨æ“ä½œ | âš ï¸ éœ€æ³¨æ„ | æŒ‰ studentName + userId å®šä½å­¦ç”Ÿï¼Œè€Œéä»… studentName |
| processEntry çš„ userId ä¼ é€’ | âœ… æ­£ç¡® | é€šè¿‡å‡½æ•°å‚æ•°ä¼ é€’ï¼Œä¸ä¾èµ–å…¨å±€çŠ¶æ€ |
| åå°ä»»åŠ¡ config å¿«ç…§ vs å®æ—¶è¯»å– | âœ… æ­£ç¡® | å½“å‰å·²åœ¨ inputParams ä¸­å¿«ç…§ apiModel/apiKey ç­‰ï¼ŒuserId ä¹Ÿä» DB åˆ—è¯»å– |
| autoBackupToGDrive fire-and-forget | âš ï¸ éœ€æ³¨æ„ | å¿…é¡»åœ¨è°ƒç”¨æ—¶æ•è· userIdï¼Œä¸èƒ½ä¾èµ–åç»­ä¸Šä¸‹æ–‡ |
| è¿ç§»è„šæœ¬ admin id=1 | âš ï¸ éœ€ç¡®è®¤ | è¿ç§»å‰éœ€ç¡®è®¤ admin ç”¨æˆ·çš„å®é™… id å€¼ |
| Google Drive æ–‡ä»¶å¤¹ç¼“å­˜ | âš ï¸ éœ€æ³¨æ„ | pendingFolderOps key å»ºè®®æ”¹ä¸º `${userId}:${folderPath}` |
| å¹¶å‘åˆ·æ–°é” Map å†…å­˜æ³„æ¼ | âš ï¸ éœ€æ³¨æ„ | refreshPromises Map éœ€åœ¨ Promise resolve åæ¸…ç† entry |

---

## åä¸€ã€å¤šç»´åº¦æ·±åº¦éªŒè¯ï¼ˆç¬¬å››è½®+ï¼‰

> ä»¥ä¸‹ä¸ºä»ä¸šåŠ¡æµç¨‹ã€äº¤å‰æµ‹è¯•ã€æç«¯æƒ…å†µã€å‹åŠ›æµ‹è¯•ã€é²æ£’æ€§ã€å®‰å…¨æ€§ã€å¯ç»´æŠ¤æ€§ã€å†—ä½™æ€§ç­‰å¤šç»´åº¦å¯¹æ¸…å•è¿›è¡Œçš„å…¨é¢å¤æ ¸ï¼Œè¡¥å……æ­¤å‰é—æ¼çš„æ‰€æœ‰æ”¹é€ é¡¹ã€‚

---

### 11.1 ã€ä¸¥é‡é—æ¼ã€‘Logger æ—¥å¿—æ¨¡å—ç”¨æˆ·éš”ç¦»

**æ–‡ä»¶ï¼š`server/logger.ts`ï¼ˆ291 è¡Œï¼‰**

**å½“å‰é—®é¢˜**ï¼š
- æ‰€æœ‰ç”¨æˆ·çš„æ—¥å¿—å­˜æ”¾åœ¨å…¨å±€ `./logs` ç›®å½•
- æ–‡ä»¶åæ ¼å¼ï¼š`${studentName}_${sessionId}.log`ï¼ˆæ—  userIdï¼‰
- `getLatestLogPathByStudent()` æ‰«æå…¨ç›®å½• â†’ ç”¨æˆ· A å¯è¯»åˆ°ç”¨æˆ· B çš„æ—¥å¿—
- `exportLog` è·¯ç”±ï¼ˆ`routers.ts:1089-1136`ï¼‰ä¸æ ¡éªŒ userId â†’ ä»»ä½•ç”¨æˆ·å¯å¯¼å‡ºä»»ä½•å­¦ç”Ÿçš„æ—¥å¿—
- æ—¥å¿—å†…å«å­¦ç”Ÿå§“åã€è¯¾æ¬¡å†…å®¹ã€AI å‚æ•°ç­‰æ•æ„Ÿæ•°æ®

**æ”¹é€ æ–¹æ¡ˆ**ï¼š

#### 1. ç›®å½•ç»“æ„æ”¹ä¸ºæŒ‰ç”¨æˆ·éš”ç¦»

```
logs/
  user_1/
    å¼ ä¸‰_sessionId.log
  user_2/
    å¼ ä¸‰_sessionId.log
```

#### 2. å‡½æ•°ç­¾åæ”¹é€ 

| å‡½æ•° | å½“å‰ | æ”¹ä¸º |
|------|------|------|
| `createLogSession(...)` | ä¸å« userId | `createLogSession(userId, ...)` â€” æ—¥å¿—å†™å…¥ `logs/user_{userId}/` |
| `getLatestLogPath()` | æ‰«æå…¨å±€ç›®å½• | `getLatestLogPath(userId)` â€” åªæ‰«æç”¨æˆ·ç›®å½• |
| `getLatestLogPathByStudent(identifier)` | æ‰«æå…¨å±€ç›®å½• | `getLatestLogPathByStudent(userId, identifier)` |
| `getLogContent(logPath)` | ç›´æ¥è¯»å– | `getLogContent(userId, logPath)` â€” éªŒè¯è·¯å¾„åœ¨ç”¨æˆ·ç›®å½•å†… |
| `listLogFiles()` | å…¨å±€åˆ—å‡º | `listLogFiles(userId)` â€” åªåˆ—ç”¨æˆ·ç›®å½• |

#### 3. è·¯ç”±å±‚æ”¹é€ 

| è·¯ç”± | æ–‡ä»¶ | æ”¹åŠ¨ |
|------|------|------|
| `exportLog` | `routers.ts:1089-1136` | ä¼ å…¥ `ctx.user.id`ï¼Œè°ƒç”¨æ”¹é€ åçš„æ—¥å¿—å‡½æ•° |
| æ‰€æœ‰ SSE ç«¯ç‚¹å†…çš„æ—¥å¿—åˆ›å»º | `classStreamRoutes.ts` | `createLogSession(userId, ...)` |
| åå°ä»»åŠ¡æ—¥å¿— | `backgroundTaskRunner.ts` | `createLogSession(userId, ...)` |

#### 4. è·¯å¾„éå†é˜²æŠ¤

```typescript
// getLogContent å†…éƒ¨éªŒè¯è·¯å¾„åˆæ³•æ€§
const userLogDir = path.resolve(LOG_DIR, `user_${userId}`);
const resolvedPath = path.resolve(logPath);
if (!resolvedPath.startsWith(userLogDir)) {
  throw new Error("éæ³•è·¯å¾„è®¿é—®");
}
```

**é£é™©ç­‰çº§**ï¼šğŸ”´ ä¸¥é‡ â€” ä¿¡æ¯æ³„éœ² + æ•°æ®è¶Šæƒ
**æ‰€å± Phase**ï¼šPhase 4ï¼ˆä¸šåŠ¡é€»è¾‘å±‚ï¼‰

---

### 11.2 ã€ä¸¥é‡é—æ¼ã€‘processEntryInBackground é—­åŒ…ä¸¢å¤± userId

**æ–‡ä»¶ï¼š`server/homeworkManager.ts:304-377`**

**å½“å‰é—®é¢˜**ï¼š
- `submitAndProcessEntry()` ä»¥ fire-and-forget æ¨¡å¼è°ƒç”¨ `processEntryInBackground()`
- `processEntryInBackground` çš„ç­¾åä¸­**æ²¡æœ‰ userId å‚æ•°**
- å†…éƒ¨è°ƒç”¨ `processEntry()` è¯»å– `getConfigValue("apiKey")` ç­‰å…¨å±€é…ç½®
- éš”ç¦»åï¼Œä¸åŒç”¨æˆ·çš„æ¡ç›®ä¼šä½¿ç”¨é”™è¯¯çš„ API Key

**æ”¹é€ æ–¹æ¡ˆ**ï¼š

```
å½“å‰ï¼š
processEntryInBackground(id, studentName, rawInput, aiModel)

æ”¹ä¸ºï¼š
processEntryInBackground(userId, id, studentName, rawInput, aiModel)
```

**è°ƒç”¨é“¾ä¿®å¤**ï¼š

| è¡Œå· | å½“å‰ | æ”¹ä¸º |
|------|------|------|
| 314 | `processEntryInBackground(id, studentName, rawInput, aiModel)` | `processEntryInBackground(userId, id, studentName, rawInput, aiModel)` |
| 344ï¼ˆå†…éƒ¨ï¼‰ | `processEntry(studentName, rawInput, aiModel, onProgress)` | `processEntry(userId, studentName, rawInput, aiModel, onProgress)` |
| 596ï¼ˆimportFromExtraction å†…ï¼‰ | `processEntryInBackground(id, studentName, rawInput)` | `processEntryInBackground(userId, id, studentName, rawInput)` |

**é£é™©ç­‰çº§**ï¼šğŸ”´ ä¸¥é‡ â€” ä½¿ç”¨é”™è¯¯ API Key / æ¨¡å‹
**æ‰€å± Phase**ï¼šPhase 4

---

### 11.3 ã€ä¸¥é‡é—æ¼ã€‘correctionRunner è·¨æ¨¡å—è°ƒç”¨ç¼º userId

**æ–‡ä»¶ï¼š`server/correctionRunner.ts`**

**å½“å‰é—®é¢˜**ï¼š
- `processCorrection()` å†…éƒ¨è°ƒç”¨ homeworkManager çš„å‡½æ•°æ—¶ä¸ä¼  userId
- `getStudentLatestStatus(params.studentName)` â†’ ä¼šæŸ¥åˆ°ä»»æ„ç”¨æˆ·çš„åŒåå­¦ç”Ÿ
- `importFromExtraction(task.studentName, content)` â†’ ä¼šå†™å…¥ä»»æ„ç”¨æˆ·çš„å­¦ç”Ÿæ¡ç›®

**æ”¹é€ æ–¹æ¡ˆ**ï¼š

| è¡Œå· | å½“å‰è°ƒç”¨ | æ”¹ä¸º |
|------|----------|------|
| ~165 | `getStudentLatestStatus(params.studentName)` | `getStudentLatestStatus(userId, params.studentName)` |
| ~359 | `importFromExtraction(task.studentName, content)` | `importFromExtraction(userId, task.studentName, content)` |

**æ•°æ®æ³„éœ²åœºæ™¯**ï¼š
- ç”¨æˆ· A æäº¤æ‰¹æ”¹ "å¼ ä¸‰"ï¼Œç³»ç»Ÿä»ç”¨æˆ· B çš„ "å¼ ä¸‰" è¯»å–çŠ¶æ€
- æ‰¹æ”¹å®Œæˆåè‡ªåŠ¨å¯¼å…¥åˆ°ç”¨æˆ· B çš„ "å¼ ä¸‰" å­¦ç”Ÿæ¡£æ¡ˆ

**é£é™©ç­‰çº§**ï¼šğŸ”´ ä¸¥é‡ â€” è·¨ç”¨æˆ·æ•°æ®æ±¡æŸ“
**æ‰€å± Phase**ï¼šPhase 4

---

### 11.4 ã€ä¸¥é‡é—æ¼ã€‘config.update è·¯ç”±ç¼ºå°‘ admin æƒé™æ ¡éªŒ

**æ–‡ä»¶ï¼š`server/routers.ts:219-436`**

**å½“å‰é—®é¢˜**ï¼š
- `config.update` ä½¿ç”¨ `protectedProcedure`ï¼ˆåªè¦ç™»å½•å³å¯ï¼‰
- ä»»ä½•ç™»å½•ç”¨æˆ·å¯ä¿®æ”¹ `allowedEmails` ç™½åå•
- æ”»å‡»åœºæ™¯ï¼šæ™®é€šç”¨æˆ·è°ƒç”¨ `config.update({ allowedEmails: '["attacker@email.com"]' })` â†’ å…¶ä»–æ‰€æœ‰ç”¨æˆ·è¢«è¸¢å‡º

**æ”¹é€ æ–¹æ¡ˆ**ï¼š

```
æ–¹æ¡ˆ 1ï¼šallowedEmails å•ç‹¬è·¯ç”±
  config.updateAllowedEmails â†’ adminProcedureï¼ˆä»… admin å¯è°ƒç”¨ï¼‰
  config.update â†’ protectedProcedureï¼ˆæ™®é€šç”¨æˆ·åªèƒ½æ”¹è‡ªå·±çš„ user_configï¼‰

æ–¹æ¡ˆ 2ï¼šconfig.update å†…éƒ¨æ£€æŸ¥
  if (key === "allowedEmails" && ctx.user.role !== "admin") {
    throw new TRPCError({ code: "FORBIDDEN" });
  }
```

**æ¨èæ–¹æ¡ˆ 1**ï¼Œå› ä¸ºæ”¹é€ å config.update æœ¬èº«å·²ç»åªå†™ user_configï¼ŒallowedEmails å†™ systemConfig çš„é€»è¾‘åº”ç‹¬ç«‹ã€‚

**é£é™©ç­‰çº§**ï¼šğŸ”´ ä¸¥é‡ â€” ç³»ç»Ÿæ¥ç®¡
**æ‰€å± Phase**ï¼šPhase 3

---

### 11.5 ã€é«˜å±é—æ¼ã€‘IDORï¼šé¡ºåº ID æšä¸¾æ”»å‡»

**å½±å“è·¯ç”±**ï¼š

| è·¯ç”± | ID ç±»å‹ | æ”»å‡»æ–¹å¼ | å½“å‰æ¸…å•çŠ¶æ€ |
|------|---------|----------|-------------|
| `homework.retryEntry(id)` | é¡ºåº INT | éå† 1,2,3... | ä»…è¯´"éªŒè¯å½’å±"ï¼Œæ— å…·ä½“å®ç° |
| `homework.deleteEntry(id)` | é¡ºåº INT | éå† 1,2,3... | åŒä¸Š |
| `correction.getTask(id)` | é¡ºåº INT | éå† 1,2,3... | ä»…è¯´"æ·»åŠ  userId è¿‡æ»¤" |
| `bgTask.status(taskId)` | UUID | ä¸å¯æšä¸¾ä½†å¯æ³„éœ² | ä»…è¯´"æ·»åŠ  userId è¿‡æ»¤" |
| `batchTask.items(batchId)` | UUID | åŒä¸Š | ä»…è¯´"é—´æ¥è¿‡æ»¤" |

**è¡¥å……ï¼šæ¯ä¸ªè·¯ç”±çš„å…·ä½“ WHERE å­å¥**

```typescript
// homework.retryEntry â€” å¿…é¡»éªŒè¯æ¡ç›®å½’å±
const entry = await db.select().from(hwEntries)
  .where(and(eq(hwEntries.id, id), eq(hwEntries.userId, userId)))
  .limit(1);
if (entry.length === 0) throw new TRPCError({ code: "NOT_FOUND" });

// homework.deleteEntry â€” åŒç†
await db.delete(hwEntries)
  .where(and(eq(hwEntries.id, id), eq(hwEntries.userId, userId)));

// correction.getTask â€” åŒç†
const task = await db.select().from(correctionTasks)
  .where(and(eq(correctionTasks.id, id), eq(correctionTasks.userId, userId)))
  .limit(1);

// bgTask.status â€” åŒç†
const task = await db.select().from(backgroundTasks)
  .where(and(eq(backgroundTasks.id, taskId), eq(backgroundTasks.userId, userId)))
  .limit(1);

// batchTask.items â€” å…ˆéªŒè¯çˆ¶ä»»åŠ¡å½’å±
const batch = await db.select().from(batchTasks)
  .where(and(eq(batchTasks.id, batchId), eq(batchTasks.userId, userId)))
  .limit(1);
if (batch.length === 0) throw new TRPCError({ code: "NOT_FOUND" });
// ç„¶åæŸ¥å­é¡¹
const items = await db.select().from(batchTaskItems)
  .where(eq(batchTaskItems.batchId, batchId));
```

**é£é™©ç­‰çº§**ï¼šğŸ”´ é«˜å± â€” IDOR è¶Šæƒè®¿é—®
**æ‰€å± Phase**ï¼šPhase 3ï¼ˆè·¯ç”±å±‚ï¼‰

---

### 11.6 ã€é«˜å±é—æ¼ã€‘confirmEntries / confirmAllPreStaged è·¨ç”¨æˆ·æ•°æ®æ±¡æŸ“

**æ–‡ä»¶ï¼š`server/homeworkManager.ts:489-558`**

**å½“å‰é—®é¢˜**ï¼š
- `confirmEntries` ç¡®è®¤æ¡ç›®åæŒ‰ studentName æ›´æ–° hwStudents
- `where(eq(hwStudents.name, name))` æœªåŠ  userId â†’ ä¼šæ›´æ–°å…¶ä»–ç”¨æˆ·çš„åŒåå­¦ç”Ÿ

**å…·ä½“ä¿®å¤**ï¼š

```typescript
// å½“å‰ï¼ˆè¡Œå· 512-514ï¼‰ï¼š
for (const name of studentNames) {
  await db.update(hwStudents)
    .set({ currentStatus: studentLatest.get(name)! })
    .where(eq(hwStudents.name, name));  // â† ä»…æŒ‰åå­—
}

// æ”¹ä¸ºï¼š
for (const name of studentNames) {
  await db.update(hwStudents)
    .set({ currentStatus: studentLatest.get(name)! })
    .where(and(
      eq(hwStudents.userId, userId),  // â† åŠ  userId
      eq(hwStudents.name, name)
    ));
}
```

åŒæ ·é€‚ç”¨äº `confirmAllPreStaged`ï¼ˆè¡Œå· 523-558ï¼‰å†…çš„æ‰€æœ‰ `where(eq(hwStudents.name, name))` æŸ¥è¯¢ã€‚

**é£é™©ç­‰çº§**ï¼šğŸ”´ é«˜å± â€” è·¨ç”¨æˆ·æ•°æ®è¦†å†™
**æ‰€å± Phase**ï¼šPhase 4

---

### 11.7 ã€é«˜å±é—æ¼ã€‘Google OAuth state å‚æ•°å®‰å…¨å®ç°

**æ–‡ä»¶ï¼š`server/googleAuth.ts:31-43`, `server/_core/oauth.ts:15-46`**

**å½“å‰é—®é¢˜**ï¼š
- å½“å‰ OAuth è¯·æ±‚**æ²¡æœ‰ state å‚æ•°**ï¼ˆCSRF æ¼æ´ï¼‰
- æ¸…å•æåˆ°è¦ç”¨ state ç¼–ç  userIdï¼Œä½†æœªè¯´æ˜å¦‚ä½•é˜²ä¼ªé€ 

**å…·ä½“å®ç°æ–¹æ¡ˆ**ï¼š

```typescript
// googleAuth.ts â€” ç”ŸæˆåŠ å¯† state
import crypto from "crypto";

const STATE_SECRET = process.env.OAUTH_STATE_SECRET || crypto.randomBytes(32).toString("hex");

export function getAuthUrl(userId: number): string {
  // 1. æ„é€  state payload
  const payload = JSON.stringify({ userId, ts: Date.now() });
  // 2. HMAC ç­¾åé˜²ä¼ªé€ 
  const hmac = crypto.createHmac("sha256", STATE_SECRET).update(payload).digest("hex");
  const state = Buffer.from(`${payload}.${hmac}`).toString("base64url");

  const params = new URLSearchParams({
    client_id: GOOGLE_CLIENT_ID,
    redirect_uri: getRedirectUri(),
    response_type: "code",
    scope: SCOPES.join(" "),
    access_type: "offline",
    prompt: "consent",
    state,  // â† æ·»åŠ  state
  });
  return `https://accounts.google.com/o/oauth2/v2/auth?${params.toString()}`;
}

// oauth.ts â€” å›è°ƒæ—¶éªŒè¯ state
export function verifyState(state: string): number {
  const decoded = Buffer.from(state, "base64url").toString();
  const [payload, hmac] = decoded.split(/\.(?=[^.]+$)/);
  const expected = crypto.createHmac("sha256", STATE_SECRET).update(payload).digest("hex");
  if (hmac !== expected) throw new Error("state å‚æ•°ç­¾åæ— æ•ˆ");
  const { userId, ts } = JSON.parse(payload);
  if (Date.now() - ts > 10 * 60 * 1000) throw new Error("state å·²è¿‡æœŸï¼ˆ10åˆ†é’Ÿï¼‰");
  return userId;
}
```

**é£é™©ç­‰çº§**ï¼šğŸŸ¡ é«˜å± â€” CSRF + userId ä¼ªé€ 
**æ‰€å± Phase**ï¼šPhase 2

---

### 11.8 ã€é«˜å±é—æ¼ã€‘download-drive-file ç«¯ç‚¹æ— æ–‡ä»¶å½’å±éªŒè¯

**æ–‡ä»¶ï¼š`server/classStreamRoutes.ts:1550-1589`**

**å½“å‰é—®é¢˜**ï¼š
- ç«¯ç‚¹æ¥å—ä»»æ„ `fileId` å‚æ•°
- ä½¿ç”¨å…¨å±€ `getValidToken()` ä¸‹è½½æ–‡ä»¶
- æ— æ³•éªŒè¯æ–‡ä»¶æ˜¯å¦å±äºå½“å‰ç”¨æˆ·

**æ”¹é€ æ–¹æ¡ˆ**ï¼š

```
1. getValidToken() â†’ getValidToken(userId)  â† æ¸…å•å·²è¦†ç›–
2. é¢å¤–æ ¡éªŒï¼ˆäºŒé€‰ä¸€ï¼‰ï¼š
   a. ç»´æŠ¤ä¸Šä¼ è®°å½•è¡¨ï¼ˆtaskId â†’ fileId â†’ userIdï¼‰ï¼Œä¸‹è½½æ—¶éªŒè¯
   b. åœ¨ Google Drive ä¸­åˆ©ç”¨ driveBasePath åšç›®å½•çº§éš”ç¦»ï¼Œä¸‹è½½å‰éªŒè¯ fileId æ‰€åœ¨ç›®å½•
```

**é£é™©ç­‰çº§**ï¼šğŸŸ¡ é«˜å± â€” è·¨ç”¨æˆ·æ–‡ä»¶ä¸‹è½½
**æ‰€å± Phase**ï¼šPhase 3

---

### 11.9 ã€é«˜å±é—æ¼ã€‘è¿ç§»è„šæœ¬ä¸å¹‚ç­‰ + admin ID ç¡¬ç¼–ç 

**åŸæ¸…å• Section 2.9 çš„é—®é¢˜**ï¼š

#### é—®é¢˜ 1ï¼šALTER TABLE ä¸å¹‚ç­‰
MySQL çš„ `ALTER TABLE ADD COLUMN` åœ¨åˆ—å·²å­˜åœ¨æ—¶ä¼šæŠ¥é”™ã€‚è‹¥è¿ç§»ä¸­é€”å¤±è´¥é‡è·‘ï¼Œåç»­æ­¥éª¤ä¼šå¤±è´¥ã€‚

**ä¿®å¤æ–¹æ¡ˆ**ï¼šæ”¹ç”¨å­˜å‚¨è¿‡ç¨‹æˆ–é¢„æ£€

```sql
-- å®‰å…¨æ·»åŠ åˆ—ï¼ˆå¹‚ç­‰ï¼‰
SET @col_exists = (SELECT COUNT(*) FROM INFORMATION_SCHEMA.COLUMNS
  WHERE TABLE_SCHEMA = DATABASE() AND TABLE_NAME = 'hw_students' AND COLUMN_NAME = 'user_id');
SET @sql = IF(@col_exists = 0, 'ALTER TABLE hw_students ADD COLUMN user_id INT NULL', 'SELECT 1');
PREPARE stmt FROM @sql;
EXECUTE stmt;
DEALLOCATE PREPARE stmt;
```

æˆ–ä½¿ç”¨åº”ç”¨å±‚çš„ `safeAddColumn` æ¨¡å¼ï¼ˆå·²æœ‰å…ˆä¾‹ï¼‰ã€‚

#### é—®é¢˜ 2ï¼šadmin ID ä¸ä¸€å®šæ˜¯ 1
`db.ts` ä¸­ admin ç”¨æˆ·é€šè¿‡ `ENV.ownerOpenId` åŒ¹é…ï¼Œå…¶ ID å–å†³äºæ³¨å†Œé¡ºåºã€‚

**ä¿®å¤æ–¹æ¡ˆ**ï¼šè¿ç§»è„šæœ¬åŠ¨æ€è·å– admin ID

```sql
SET @admin_id = (SELECT id FROM users WHERE role = 'admin' ORDER BY id LIMIT 1);
UPDATE hw_students SET user_id = @admin_id WHERE user_id IS NULL;
UPDATE hw_entries SET user_id = @admin_id WHERE user_id IS NULL;
-- ... å…¶ä½™åŒç†
```

**é£é™©ç­‰çº§**ï¼šğŸŸ¡ é«˜å± â€” è¿ç§»å¤±è´¥å¯¼è‡´ç³»ç»Ÿä¸å¯ç”¨
**æ‰€å± Phase**ï¼šPhase 1

---

### 11.10 ã€é«˜å±é—æ¼ã€‘ensureHwTables / ensureCorrectionTable å»ºè¡¨ SQL ç¼º userId

**æ–‡ä»¶**ï¼š
- `server/homeworkManager.ts:17-93`
- `server/correctionRunner.ts:70-100`
- `server/backgroundTaskRunner.ts:942-974`

**å½“å‰é—®é¢˜**ï¼š
- `CREATE TABLE IF NOT EXISTS` ä½¿ç”¨æ—§ schemaï¼ˆæ—  userIdï¼‰
- è‹¥åœ¨å…¨æ–°æ•°æ®åº“ä¸Šå¯åŠ¨ï¼ˆè¿ç§»åçš„æ–°å®ä¾‹ï¼‰ï¼Œå»ºå‡ºçš„è¡¨ç¼ºå°‘ userId åˆ—
- `safeAddColumn` åªæ·»åŠ äº† `current_status`ã€`streaming_chars` ç­‰å¯é€‰åˆ—ï¼Œ**æ²¡æœ‰ userId**

**æ”¹é€ æ–¹æ¡ˆ**ï¼š

#### 1. æ›´æ–° CREATE TABLE è¯­å¥

```sql
-- homeworkManager.ts â€” hw_students
CREATE TABLE IF NOT EXISTS `hw_students` (
  `id` int AUTO_INCREMENT NOT NULL,
  `user_id` int NOT NULL,                    -- â† æ–°å¢
  `name` varchar(64) NOT NULL,
  `plan_type` varchar(10) NOT NULL DEFAULT 'weekly',
  `current_status` MEDIUMTEXT,
  `status` varchar(10) NOT NULL DEFAULT 'active',
  `created_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `hw_students_user_name` (`user_id`, `name`)  -- â† æ”¹ä¸ºå¤åˆå”¯ä¸€
)

-- hw_entries åŒç†æ·»åŠ  user_id INT NOT NULL
-- correction_tasks åŒç†
-- background_tasks åŒç†
```

#### 2. æ·»åŠ  safeAddColumn å…¼å®¹

```typescript
await safeAddColumn("hw_students", "user_id", "INT NOT NULL DEFAULT 1");
await safeAddColumn("hw_entries", "user_id", "INT NOT NULL DEFAULT 1");
```

**é£é™©ç­‰çº§**ï¼šğŸŸ¡ é«˜å± â€” æ–°å®ä¾‹å»ºè¡¨ä¸å®Œæ•´
**æ‰€å± Phase**ï¼šPhase 4

---

### 11.11 ã€é«˜å±é—æ¼ã€‘DEFAULT_CONFIG ç¡¬ç¼–ç å…±äº«è·¯å¾„

**æ–‡ä»¶ï¼š`server/core/aiClient.ts:10-23`**

**å½“å‰é—®é¢˜**ï¼š

```typescript
export const DEFAULT_CONFIG: Record<string, string> = {
  driveBasePath: "Mac/Documents/XDF/å­¦ç”Ÿæ¡£æ¡ˆ",        // â† ç¡¬ç¼–ç å…±äº«è·¯å¾„ï¼
  batchStoragePath: "Mac(online)/Documents/XDF/æ‰¹é‡ä»»åŠ¡", // â† åŒä¸Š
  // ...
};
```

- æ–°ç”¨æˆ·æ³¨å†Œåæ—  user_configï¼Œå›é€€åˆ° DEFAULT_CONFIG
- æ‰€æœ‰æ–°ç”¨æˆ·é»˜è®¤å†™å…¥åŒä¸€ä¸ª Google Drive è·¯å¾„
- æ–‡ä»¶äº’ç›¸è¦†ç›– / æ•°æ®æ³„éœ²

**æ”¹é€ æ–¹æ¡ˆï¼ˆä¸‰é€‰ä¸€ï¼‰**ï¼š

```
æ–¹æ¡ˆ Aï¼ˆæ¨èï¼‰ï¼šå°†è·¯å¾„é»˜è®¤å€¼æ”¹ä¸ºç©ºï¼Œå¼ºåˆ¶ç”¨æˆ·è®¾ç½®
  driveBasePath: ""
  batchStoragePath: ""
  systemCheck æ£€æµ‹æ—¶æç¤º"è¯·å…ˆè®¾ç½® Google Drive è·¯å¾„"

æ–¹æ¡ˆ Bï¼šé»˜è®¤å€¼åŒ…å«ç”¨æˆ·æ ‡è¯†
  driveBasePath: "å­¦æƒ…åé¦ˆ/ç”¨æˆ·_{userId}"
  ï¼ˆéœ€è¦åœ¨ getUserConfigValue ä¸­åšå ä½ç¬¦æ›¿æ¢ï¼‰

æ–¹æ¡ˆ Cï¼šé¦–æ¬¡ç™»å½•æ—¶ä» admin å¤åˆ¶é…ç½®
  æ–°ç”¨æˆ·é¦–æ¬¡è®¿é—®æ—¶è‡ªåŠ¨å°† admin çš„ user_config å¤åˆ¶ä¸€ä»½ï¼Œ
  ç”¨æˆ·è‡ªè¡Œä¿®æ”¹è·¯å¾„
```

**é£é™©ç­‰çº§**ï¼šğŸŸ¡ é«˜å± â€” æ–°ç”¨æˆ·æ–‡ä»¶å†™å…¥é”™è¯¯è·¯å¾„
**æ‰€å± Phase**ï¼šPhase 2

---

### 11.12 ã€é«˜å±é—æ¼ã€‘DEFAULT_CONFIG ç¼ºå°‘å¤šä¸ªé…ç½®é”®

**å½“å‰ DEFAULT_CONFIG åªæœ‰ 13 ä¸ªé”®**ï¼Œä½† user_config éœ€è¦è¿ç§» **22 ä¸ªé”®**ï¼š

| ç¼ºå¤±çš„é…ç½®é”® | å½±å“ |
|-------------|------|
| `hwAiModel` | å­¦ç”Ÿç®¡ç† AI å¤„ç†ä½¿ç”¨é»˜è®¤æ¨¡å‹ï¼ˆå¯èƒ½æ— æ•ˆï¼‰ |
| `hwPromptTemplate` | å­¦ç”Ÿç®¡ç† AI æ— æç¤ºè¯æ¨¡æ¿ |
| `corrAiModel` | æ‰¹æ”¹ç³»ç»Ÿæ— é»˜è®¤æ¨¡å‹ |
| `correctionPrompt` | æ‰¹æ”¹ç³»ç»Ÿæ— æç¤ºè¯ |
| `correctionTypes` | æ‰¹æ”¹ç±»å‹åˆ—è¡¨ä¸ºç©º |
| `firstLessonTemplate` | é¦–æ¬¡è¯¾èŒƒä¾‹ä¸ºç©º |
| `classFirstLessonTemplate` | å°ç­è¯¾é¦–æ¬¡è¯¾èŒƒä¾‹ä¸ºç©º |
| `modelPresets` | æ¨¡å‹é¢„è®¾ä¸ºç©º |
| `apiProviderPresets` | ä¾›åº”å•†é¢„è®¾ä¸ºç©º |
| `studentLessonHistory` | å­¦ç”Ÿè¯¾æ¬¡å†å²ä¸ºç©º |

**æ”¹é€ æ–¹æ¡ˆ**ï¼šåœ¨ DEFAULT_CONFIG ä¸­è¡¥å……æ‰€æœ‰é”®çš„åˆç†é»˜è®¤å€¼ï¼Œæˆ–åœ¨ correctionRunner.ts ç­‰æ¨¡å—å†…éƒ¨æä¾›æ¨¡å—çº§é»˜è®¤å€¼ï¼ˆå¦‚ `DEFAULT_CORRECTION_TYPES` å·²å­˜åœ¨ï¼‰ã€‚

**é£é™©ç­‰çº§**ï¼šğŸŸ¡ ä¸­é«˜ â€” æ–°ç”¨æˆ·åŠŸèƒ½ä¸å¯ç”¨
**æ‰€å± Phase**ï¼šPhase 2

---

### 11.13 ã€ä¸­å±ã€‘contentStore å¤šç”¨æˆ·å…¬å¹³æ€§

**æ–‡ä»¶ï¼š`server/contentStore.ts`**

**å½“å‰é—®é¢˜**ï¼š
- `MAX_ITEMS=500` å…¨å±€å…±äº«ï¼ŒFIFO æ·˜æ±°
- ä¸€ä¸ªé‡åº¦ç”¨æˆ·å¯è€—å°½æ‰€æœ‰åé¢ï¼Œå…¶ä»–ç”¨æˆ·çš„ SSE æš‚å­˜å†…å®¹è¢«æ·˜æ±°

**å»ºè®®**ï¼š

```
æ–¹æ¡ˆ Aï¼šå¢å¤§ MAX_ITEMSï¼ˆå¦‚ 2000ï¼‰+ ç¼©çŸ­ TTLï¼ˆå¦‚ 10 åˆ†é’Ÿï¼‰
æ–¹æ¡ˆ Bï¼šæŒ‰ userId åˆ†æ¡¶ï¼Œæ¯ç”¨æˆ·ä¸Šé™ 100 æ¡
æ–¹æ¡ˆ Cï¼šä»…æ–‡æ¡£è®°å½•æ­¤é™åˆ¶ï¼Œä¼˜å…ˆçº§ä½ï¼ˆå½“å‰å•æœºåœºæ™¯ç”¨æˆ·æ•°æœ‰é™ï¼‰
```

**é£é™©ç­‰çº§**ï¼šğŸŸ¡ ä¸­ â€” å¤šç”¨æˆ·ç«äº‰
**æ‰€å± Phase**ï¼šPhase 2ï¼ˆä½ä¼˜å…ˆçº§ï¼‰

---

### 11.14 ã€ä¸­å±ã€‘åå°ä»»åŠ¡å¹¶å‘å…¬å¹³æ€§

**æ–‡ä»¶**ï¼š
- `server/backgroundTaskRunner.ts:54` â€” `MAX_CONCURRENT_TASKS = 3`
- `server/batch/batchTaskRunner.ts:14` â€” `MAX_CONCURRENT_BATCH = 1`

**å½“å‰é—®é¢˜**ï¼š
- å¹¶å‘é™åˆ¶æ˜¯å…¨å±€çš„ï¼Œä¸åŒºåˆ†ç”¨æˆ·
- ç”¨æˆ· A å æ»¡ 3 ä¸ªåå°ä»»åŠ¡æ§½ä½ â†’ ç”¨æˆ· B è¢«æ‹’ç»
- æ‰¹é‡ä»»åŠ¡æ›´ä¸¥æ ¼ï¼šå…¨å±€åªå…è®¸ 1 ä¸ª

**å»ºè®®**ï¼š

```
æ–¹æ¡ˆ Aï¼šæ”¹ä¸º per-user é™åˆ¶ + å…¨å±€ä¸Šé™
  - æ¯ç”¨æˆ·æœ€å¤š 2 ä¸ªåå°ä»»åŠ¡
  - å…¨å±€ä¸Šé™ä»ä¸º 3
  - æ‰¹é‡ä»»åŠ¡æ¯ç”¨æˆ·æœ€å¤š 1 ä¸ª

æ–¹æ¡ˆ Bï¼šé˜Ÿåˆ—æœºåˆ¶
  - ä»»åŠ¡å…¥é˜Ÿè€Œéç›´æ¥æ‹’ç»
  - FIFO è°ƒåº¦ï¼Œä¿è¯å…¬å¹³

æ–¹æ¡ˆ Cï¼šæ–‡æ¡£è®°å½•æ­¤é™åˆ¶ï¼ˆä½ä¼˜å…ˆçº§ï¼‰
  - å½“å‰ç”¨æˆ·æ•°å°‘ï¼Œæš‚ä¸æ”¹é€ 
  - åœ¨ UI æç¤º"ç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨åé‡è¯•"
```

**é£é™©ç­‰çº§**ï¼šğŸŸ¡ ä¸­ â€” ç”¨æˆ·ä½“éªŒ
**æ‰€å± Phase**ï¼šå¯æ¨è¿Ÿ

---

### 11.15 ã€ä¸­å±ã€‘refreshPromises Map æ¸…ç†æ¨¡å¼

**æ–‡ä»¶ï¼š`server/googleAuth.ts:113`**

æ¸…å•å·²æå‡ºæ”¹ä¸º `Map<number, Promise>`ï¼Œä½†æœªç»™å‡ºæ¸…ç†ä»£ç ã€‚

**å®Œæ•´æ”¹é€ æ¨¡å¼**ï¼š

```typescript
const refreshPromises = new Map<number, Promise<string | null>>();

export async function getValidToken(userId: number): Promise<string | null> {
  const existing = refreshPromises.get(userId);
  if (existing) return existing;

  const promise = _refreshToken(userId).finally(() => {
    refreshPromises.delete(userId);  // â† å…³é”®ï¼šPromise å®Œæˆåç«‹å³æ¸…ç†
  });
  refreshPromises.set(userId, promise);
  return promise;
}
```

**é£é™©ç­‰çº§**ï¼šğŸŸ¡ ä¸­ â€” å†…å­˜æ³„æ¼
**æ‰€å± Phase**ï¼šPhase 2

---

### 11.16 ã€ä¸­å±ã€‘å‰ç«¯ ThemeContext æ— æ³•è·å– user.id

**æ–‡ä»¶ï¼š`client/src/contexts/ThemeContext.tsx`**

**å½“å‰é—®é¢˜**ï¼š
- ThemeContext æ˜¯åº”ç”¨æ ¹çº§ Providerï¼Œåœ¨ç”¨æˆ·æ•°æ®åŠ è½½ä¹‹å‰åˆå§‹åŒ–
- æ¸…å•è¦æ±‚ `localStorage.getItem("theme")` â†’ `localStorage.getItem("theme_${user.id}")`
- ä½† ThemeContext å†…éƒ¨**æ— æ³•è®¿é—® user å¯¹è±¡**

**è§£å†³æ–¹æ¡ˆ**ï¼š

```
æ–¹æ¡ˆ Aï¼ˆæ¨èï¼‰ï¼šå»¶è¿Ÿä¸»é¢˜åˆå§‹åŒ–
  - ThemeContext åˆå§‹åŒ–æ—¶ä½¿ç”¨ç³»ç»Ÿé»˜è®¤ä¸»é¢˜
  - ç”¨æˆ·åŠ è½½å®Œæˆåï¼Œé€šè¿‡ useEffect è¯»å– `theme_${user.id}` å¹¶æ›´æ–°

æ–¹æ¡ˆ Bï¼šThemeContext æ¥æ”¶ userId prop
  - <ThemeProvider userId={user?.id}>
  - userId ä¸º undefined æ—¶ä½¿ç”¨å…¨å±€ "theme" key
  - userId åŠ è½½ååˆ‡æ¢ä¸º "theme_{userId}" key

æ–¹æ¡ˆ Cï¼šæš‚ä¸æ”¹ï¼ˆä½ä¼˜å…ˆçº§ï¼‰
  - ä¸»é¢˜æ˜¯ UI åå¥½ï¼Œä¸æ˜¯æ•æ„Ÿæ•°æ®
  - å…±äº«è®¾å¤‡åœºæ™¯ä¸‹å½±å“æå°
```

**é£é™©ç­‰çº§**ï¼šğŸŸ¡ ä½ä¸­ â€” UI åå¥½
**æ‰€å± Phase**ï¼šPhase 5

---

### 11.17 ã€ä¸­å±ã€‘activeBatches Map æ¸…ç†

**æ–‡ä»¶ï¼š`server/batch/batchRoutes.ts`**

éœ€ç¡®è®¤æ‰¹é‡ä»»åŠ¡å®Œæˆåæ˜¯å¦è°ƒç”¨ `activeBatches.delete(batchId)`ã€‚è‹¥æœªæ¸…ç†ï¼ŒMap éšæ—¶é—´æ— é™å¢é•¿ã€‚

**å»ºè®®**ï¼šåœ¨æ‰¹é‡å®Œæˆå›è°ƒä¸­æ·»åŠ æ¸…ç†é€»è¾‘ï¼Œæˆ–å®šæ—¶æ¸…ç†å®Œæˆè¶…è¿‡ 1 å°æ—¶çš„æ¡ç›®ã€‚

**é£é™©ç­‰çº§**ï¼šğŸŸ¡ ä¸­ â€” å†…å­˜æ³„æ¼
**æ‰€å± Phase**ï¼šPhase 3

---

### 11.18 ã€ä½å±ã€‘Drizzle Schema åŒæ­¥

æ¸…å•è¯¦ç»†åˆ—å‡ºäº† `drizzle/schema.ts` çš„æ”¹åŠ¨ï¼Œä½†æœªæåŠæ”¹åŠ¨åçš„åŒæ­¥æ“ä½œã€‚

**éœ€è¡¥å……**ï¼š

```
1. ä¿®æ”¹ drizzle/schema.tsï¼ˆæ·»åŠ  userId åˆ—å®šä¹‰ï¼‰
2. è¿è¡Œ drizzle-kit generate ç”Ÿæˆè¿ç§»æ–‡ä»¶
3. æˆ–æ‰‹åŠ¨æ‰§è¡Œ Section 2.9 çš„ SQL è¿ç§»è„šæœ¬
4. ä¸¤ç§æ–¹å¼äºŒé€‰ä¸€ï¼Œä¸å¯é‡å¤æ‰§è¡Œ
5. è¿ç§»åéªŒè¯ï¼šdrizzle-kit check ç¡®è®¤ schema ä¸ DB ä¸€è‡´
```

**é£é™©ç­‰çº§**ï¼šğŸŸ¢ ä½ â€” å¼€å‘æµç¨‹
**æ‰€å± Phase**ï¼šPhase 1

---

### 11.19 ã€è¡¥å……ã€‘æµ‹è¯•è®¡åˆ’

å½“å‰é¡¹ç›®æœ‰ 11 ä¸ªæµ‹è¯•æ–‡ä»¶ï¼ˆ`server/*.test.ts`ï¼‰ï¼Œä½†æ— ç§Ÿæˆ·éš”ç¦»ç›¸å…³æµ‹è¯•ã€‚

**å»ºè®®æ–°å¢ Phase 7ï¼šæµ‹è¯•éªŒè¯**

```
Phase 7: æµ‹è¯•ä¸éªŒè¯
  â”œâ”€â”€ 7.1 å•å…ƒæµ‹è¯•ï¼šæ¯ä¸ªæ”¹é€ å‡½æ•°éªŒè¯ userId è¿‡æ»¤
  â”‚    - æ¨¡æ‹Ÿä¸¤ä¸ªç”¨æˆ·åˆ†åˆ«åˆ›å»ºæ•°æ®
  â”‚    - éªŒè¯ç”¨æˆ· A çœ‹ä¸åˆ°ç”¨æˆ· B çš„æ•°æ®
  â”‚    - è¦†ç›–æ‰€æœ‰ IDOR å‘é‡ï¼ˆé¡ºåº ID æšä¸¾ï¼‰
  â”œâ”€â”€ 7.2 é›†æˆæµ‹è¯•ï¼šç«¯åˆ°ç«¯ä¸šåŠ¡æµç¨‹
  â”‚    - ç”¨æˆ· A å®Œæ•´èµ°ä¸€éåé¦ˆæµç¨‹
  â”‚    - ç”¨æˆ· B åŒæ—¶å®Œæ•´èµ°ä¸€é
  â”‚    - éªŒè¯æ•°æ®å®Œå…¨éš”ç¦»
  â”œâ”€â”€ 7.3 è¿ç§»å›æ»šæµ‹è¯•
  â”‚    - åœ¨æµ‹è¯•ç¯å¢ƒæ‰§è¡Œè¿ç§»è„šæœ¬
  â”‚    - éªŒè¯å­˜é‡æ•°æ®æ­£ç¡®å½’å± admin
  â”‚    - æ¨¡æ‹Ÿä¸­é€”å¤±è´¥ï¼ŒéªŒè¯å¯å®‰å…¨é‡è·‘
  â””â”€â”€ 7.4 æ–°ç”¨æˆ·å†·å¯åŠ¨æµ‹è¯•
       - æ³¨å†Œå…¨æ–°ç”¨æˆ·
       - éªŒè¯æ‰€æœ‰åŠŸèƒ½å¯ç”¨ï¼ˆé…ç½®å›é€€åˆ° DEFAULT_CONFIGï¼‰
       - éªŒè¯ä¸ä¼šè®¿é—®åˆ°å…¶ä»–ç”¨æˆ·çš„æ•°æ®
```

---

## åäºŒã€æ›´æ–°åçš„æ”¹é€ ç»Ÿè®¡

| ç±»åˆ« | åŸç»Ÿè®¡ | æ›´æ–°å | å·®å¼‚ |
|------|--------|--------|------|
| éœ€æ”¹é€ çš„æ•°æ®è¡¨ | 7 + æ–°å»º 1 | 7 + æ–°å»º 1 | æ— å˜åŒ– |
| éœ€æ”¹é€ çš„ tRPC è·¯ç”± | 74 | 74 + exportLog æ”¹é€  | +1 |
| éœ€æ”¹é€ çš„ Express SSE ç«¯ç‚¹ | 15 | 15 + download-drive-file | æ— å˜åŒ–ï¼ˆå·²å«ï¼‰ |
| éœ€æ”¹é€ çš„åç«¯æ–‡ä»¶ | 17 | **20** | **+3**ï¼ˆlogger.tsã€correctionRunner è·¨æ¨¡å—ã€aiClient DEFAULT_CONFIGï¼‰ |
| éœ€æ”¹é€ çš„å‡½æ•°ç­¾å | 50+ | **60+** | **+10**ï¼ˆlogger 5 + processEntryInBackground é“¾ 3 + correctionRunner 2ï¼‰ |
| éœ€æ”¹é€ çš„ DB æŸ¥è¯¢ | 60+ | **65+** | **+5**ï¼ˆconfirmEntries å¤åˆé”®ã€IDOR WHERE å­å¥ï¼‰ |
| éœ€æ”¹é€ çš„é…ç½®è¯»å–è°ƒç”¨ | 80+ | 80+ | æ— å˜åŒ– |
| éœ€æ”¹é€ çš„ GDrive è°ƒç”¨ | 20+ | 20+ | æ— å˜åŒ– |
| éœ€æ”¹é€ çš„å‰ç«¯æ–‡ä»¶ | 3 | 3 | æ— å˜åŒ–ï¼ˆThemeContext éœ€è°ƒæ•´å®ç°æ–¹å¼ï¼‰ |
| æ•°æ®åº“è¿ç§»æ­¥éª¤ | 8 | **10** | **+2**ï¼ˆå¹‚ç­‰æ£€æŸ¥ + åŠ¨æ€ admin IDï¼‰ |
| æ–°å¢ï¼šå®‰å…¨åŠ å›ºé¡¹ | â€” | **5** | OAuth state ç­¾åã€IDOR WHEREã€admin æƒé™ã€è·¯å¾„éå†ã€æ–‡ä»¶å½’å± |
| æ–°å¢ï¼šæµ‹è¯•è®¡åˆ’ | â€” | **Phase 7** | 4 ç±»æµ‹è¯• |

---

## åä¸‰ã€æ›´æ–°åçš„å®æ–½é¡ºåº

```
Phase 1: æ•°æ®åº“æ”¹é€ ï¼ˆæ— ä¾èµ–ï¼‰
  â”œâ”€â”€ 1.1 æ–°å»º user_config è¡¨
  â”œâ”€â”€ 1.2 æ‰€æœ‰è¡¨æ·»åŠ  userId åˆ—ï¼ˆå¹‚ç­‰è„šæœ¬ â† æ–°å¢ï¼‰
  â”œâ”€â”€ 1.3 å­˜é‡æ•°æ®è¿ç§»ï¼ˆåŠ¨æ€ admin ID â† ä¿®æ­£ï¼‰
  â””â”€â”€ 1.4 ä¿®æ”¹å”¯ä¸€çº¦æŸ

Phase 2: æ ¸å¿ƒåŸºç¡€è®¾æ–½ï¼ˆä¾èµ– Phase 1ï¼‰
  â”œâ”€â”€ 2.1 é…ç½®è¯»å–å±‚ getUserConfigValue()
  â”œâ”€â”€ 2.2 googleAuth.ts å…¨é¢æ”¹é€  + refreshPromises æ¸…ç†æ¨¡å¼ â† è¡¥å……
  â”œâ”€â”€ 2.3 gdrive.ts å…¨é¢æ”¹é€ 
  â”œâ”€â”€ 2.4 trpc.ts ä¸­é—´ä»¶å¢å¼º
  â”œâ”€â”€ 2.5 DEFAULT_CONFIG è¡¥å…¨æ‰€æœ‰é”® â† æ–°å¢
  â”œâ”€â”€ 2.6 DEFAULT_CONFIG æ¸…é™¤ç¡¬ç¼–ç è·¯å¾„ â† æ–°å¢
  â””â”€â”€ 2.7 OAuth state ç­¾åæ–¹æ¡ˆ â† æ–°å¢

Phase 3: è·¯ç”±å±‚æ”¹é€ ï¼ˆä¾èµ– Phase 2ï¼‰
  â”œâ”€â”€ 3.1-3.7 åŸæœ‰ tRPC è·¯ç”±æ”¹é€ 
  â”œâ”€â”€ 3.8-3.9 SSE ç«¯ç‚¹æ”¹é€ 
  â”œâ”€â”€ 3.10 systemCheck æ”¹é€ 
  â”œâ”€â”€ 3.11 æ‰€æœ‰ IDOR è·¯ç”±æ·»åŠ å½’å±éªŒè¯ WHERE å­å¥ â† æ–°å¢
  â”œâ”€â”€ 3.12 config.update æ‹†åˆ† admin è·¯ç”± â† æ–°å¢
  â””â”€â”€ 3.13 download-drive-file æ–‡ä»¶å½’å±éªŒè¯ â† æ–°å¢

Phase 4: ä¸šåŠ¡é€»è¾‘å±‚ï¼ˆä¾èµ– Phase 2ï¼‰
  â”œâ”€â”€ 4.1 homeworkManager.ts
  â”œâ”€â”€ 4.2 backgroundTaskRunner.ts
  â”œâ”€â”€ 4.3 batchTaskRunner.ts
  â”œâ”€â”€ 4.4 correctionRunner.tsï¼ˆå«è·¨æ¨¡å—è°ƒç”¨ä¿®å¤ â† è¡¥å……ï¼‰
  â”œâ”€â”€ 4.5 batchExecutor.ts
  â”œâ”€â”€ 4.6 systemCheck.ts
  â”œâ”€â”€ 4.7 logger.ts ç”¨æˆ·éš”ç¦» â† æ–°å¢
  â”œâ”€â”€ 4.8 processEntryInBackground é—­åŒ…ä¿®å¤ â† æ–°å¢
  â”œâ”€â”€ 4.9 confirmEntries/confirmAllPreStaged å¤åˆé”®ä¿®å¤ â† æ–°å¢
  â””â”€â”€ 4.10 ensureHwTables/ensureCorrectionTable å»ºè¡¨ SQL æ›´æ–° â† æ–°å¢

Phase 5: å‰ç«¯ï¼ˆä¾èµ– Phase 3ï¼‰
  â””â”€â”€ 5.1 localStorage key åŠ  userId å‰ç¼€ï¼ˆThemeContext å»¶è¿Ÿåˆå§‹åŒ– â† è¡¥å……ï¼‰

Phase 6: OAuth å›è°ƒï¼ˆä¾èµ– Phase 2ï¼‰
  â””â”€â”€ 6.1 Google OAuth callback + state ç­¾åéªŒè¯ â† è¡¥å……

Phase 7: æµ‹è¯•éªŒè¯ â† æ–°å¢
  â”œâ”€â”€ 7.1 userId è¿‡æ»¤å•å…ƒæµ‹è¯•
  â”œâ”€â”€ 7.2 å¤šç”¨æˆ·ç«¯åˆ°ç«¯é›†æˆæµ‹è¯•
  â”œâ”€â”€ 7.3 è¿ç§»è„šæœ¬å›æ»šæµ‹è¯•
  â””â”€â”€ 7.4 æ–°ç”¨æˆ·å†·å¯åŠ¨æµ‹è¯•
```

---

## åå››ã€æ¶‰åŠæ–‡ä»¶å®Œæ•´åˆ—è¡¨ï¼ˆæ›´æ–°ç‰ˆï¼‰

| æ–‡ä»¶ | æ”¹åŠ¨é‡ | è¯´æ˜ | çŠ¶æ€ |
|------|--------|------|------|
| `drizzle/schema.ts` | å¤§ | 6 å¼ è¡¨åŠ  userId + æ–°å»º user_config | åŸæœ‰ |
| `server/core/aiClient.ts` | ä¸­ | getUserConfigValue + DEFAULT_CONFIG è¡¥å…¨ | **æ‰©å……** |
| `server/googleAuth.ts` | å¤§ | å…¨é¢ userId å‚æ•°åŒ– + refreshPromises æ¸…ç† + state ç­¾å | **æ‰©å……** |
| `server/gdrive.ts` | å¤§ | å…¨é¢ userId å‚æ•°åŒ– | åŸæœ‰ |
| `server/_core/oauth.ts` | ä¸­ | OAuth callback + state éªŒè¯ | **æ‰©å……** |
| `server/_core/trpc.ts` | å° | ä¸­é—´ä»¶å¢åŠ  ctx.userId | åŸæœ‰ |
| `server/routers.ts` | å¾ˆå¤§ | 74 tRPC è·¯ç”± + IDOR é˜²æŠ¤ + admin åˆ†ç¦» | **æ‰©å……** |
| `server/classStreamRoutes.ts` | å¾ˆå¤§ | 10 SSE ç«¯ç‚¹ + download å½’å±éªŒè¯ | **æ‰©å……** |
| `server/batch/batchRoutes.ts` | å¤§ | 5 Express ç«¯ç‚¹ + activeBatches æ¸…ç† | **æ‰©å……** |
| `server/batch/batchExecutor.ts` | å° | executeBatchItem åŠ  userId | åŸæœ‰ |
| `server/batch/batchTaskRunner.ts` | å¤§ | é…ç½® + GDrive æ”¹é€  | åŸæœ‰ |
| `server/homeworkManager.ts` | å¤§ | 20+ å‡½æ•° + processEntryInBackground ä¿®å¤ + confirmEntries å¤åˆé”® | **æ‰©å……** |
| `server/backgroundTaskRunner.ts` | å¤§ | é…ç½® + GDrive + å»ºè¡¨ SQL | åŸæœ‰ |
| `server/correctionRunner.ts` | ä¸­ | æŸ¥è¯¢ + é…ç½® + è·¨æ¨¡å— userId ä¼ é€’ | **æ‰©å……** |
| `server/systemCheck.ts` | ä¸­ | getValidToken + é…ç½®æ”¹é€  | åŸæœ‰ |
| `server/contentStore.ts` | å° | å¯é€‰ï¼šmeta ä¸­è®°å½• userId | åŸæœ‰ |
| `server/logger.ts` | **å¤§** | **å…¨é¢ç”¨æˆ·éš”ç¦»ï¼ˆç›®å½• + å‡½æ•°ç­¾åï¼‰** | **ğŸ†• æ–°å¢** |
| `client/src/pages/Home.tsx` | å° | localStorage key åŠ ç”¨æˆ·å‰ç¼€ | åŸæœ‰ |
| `client/src/components/DashboardLayout.tsx` | å° | localStorage key åŠ ç”¨æˆ·å‰ç¼€ | åŸæœ‰ |
| `client/src/contexts/ThemeContext.tsx` | **ä¸­** | **å»¶è¿Ÿåˆå§‹åŒ– + localStorage key** | **æ‰©å……** |
| `server/storage.ts` | **å°** | **storagePut æ–‡ä»¶è·¯å¾„ç”¨æˆ·éš”ç¦»** | **ğŸ†• æ–°å¢** |
| `server/_core/env.ts` | **å°** | **æ–°å¢ OAUTH_STATE_SECRET ç¯å¢ƒå˜é‡** | **ğŸ†• æ–°å¢** |

---

## åäº”ã€ç¬¬äºŒè½®æ·±åº¦éªŒè¯ï¼ˆæ€§èƒ½/äº‹åŠ¡/é”™è¯¯æ³„éœ²/å¤‡ä»½/éƒ¨ç½²/ç”Ÿå‘½å‘¨æœŸ/ç±»å‹å®‰å…¨ï¼‰

> ä»¥ä¸‹ä¸ºä»æ•°æ®åº“æ€§èƒ½ã€äº‹åŠ¡åŸå­æ€§ã€é”™è¯¯ä¿¡æ¯æ³„éœ²ã€å¤‡ä»½å…¼å®¹æ€§ã€éƒ¨ç½²å›æ»šã€æ•°æ®ç”Ÿå‘½å‘¨æœŸã€
> ç±»å‹å®‰å…¨ã€ç¬¬ä¸‰æ–¹ API é™æµã€ä¸´æ—¶æ–‡ä»¶ã€å†…å­˜ç¼“å­˜ã€ä¼šè¯ç®¡ç†ç­‰å…¨æ–°ç»´åº¦çš„è¡¥å……ç­›æŸ¥ã€‚

---

### 15.1 ã€é«˜å±é—æ¼ã€‘æ•°æ®åº“ç´¢å¼•ç¼ºå¤± â€” æ·»åŠ  userId åæŸ¥è¯¢æ€§èƒ½ä¸¥é‡é€€åŒ–

**å½“å‰çŠ¶æ€**ï¼šé™¤ hw_students çš„ `UNIQUE(name)` å¤–ï¼Œå…¨éƒ¨ 6 å¼ è¡¨**é›¶ç´¢å¼•**ã€‚

æ·»åŠ  userId åæ‰€æœ‰æŒ‰ userId è¿‡æ»¤çš„æŸ¥è¯¢éƒ½æ˜¯å…¨è¡¨æ‰«æã€‚éšç”¨æˆ·æ•°å’Œæ•°æ®é‡å¢é•¿ï¼Œæ€§èƒ½æ€¥å‰§ä¸‹é™ã€‚

**éœ€è¦æ·»åŠ çš„ç´¢å¼•**ï¼ˆè¿ç§»è„šæœ¬ Section 2.9 ä¸­è¡¥å……ï¼‰ï¼š

```sql
-- hw_entriesï¼šé«˜é¢‘æŸ¥è¯¢ï¼ˆå­¦ç”Ÿæ¡ç›®åˆ—è¡¨ã€æŒ‰çŠ¶æ€è¿‡æ»¤ï¼‰
CREATE INDEX idx_hw_entries_user_status ON hw_entries(user_id, entry_status);
CREATE INDEX idx_hw_entries_user_student ON hw_entries(user_id, student_name);

-- background_tasksï¼šé«˜é¢‘è½®è¯¢ï¼ˆä»»åŠ¡çŠ¶æ€ã€å†å²åˆ—è¡¨ï¼‰
CREATE INDEX idx_bg_tasks_user_status ON background_tasks(user_id, status);

-- batch_tasksï¼šå†å²æŸ¥è¯¢
CREATE INDEX idx_batch_tasks_user_status ON batch_tasks(user_id, status);

-- correction_tasksï¼šæŒ‰å­¦ç”ŸæŸ¥è¯¢æ‰¹æ”¹å†å²
CREATE INDEX idx_correction_user_student ON correction_tasks(user_id, student_name);
CREATE INDEX idx_correction_user_status ON correction_tasks(user_id, task_status);

-- google_tokensï¼šå·²æœ‰ UNIQUE(user_id) çº¦æŸï¼Œè‡ªåŠ¨åˆ›å»ºç´¢å¼•
-- user_configï¼šå·²æœ‰ UNIQUE(user_id, key) çº¦æŸï¼Œè‡ªåŠ¨åˆ›å»ºç´¢å¼•
```

**é£é™©ç­‰çº§**ï¼šğŸ”´ é«˜å± â€” å¤šç”¨æˆ·åœºæ™¯ä¸‹æŸ¥è¯¢è¶…æ—¶
**æ‰€å± Phase**ï¼šPhase 1ï¼ˆè¿ç§»è„šæœ¬è¿½åŠ ï¼‰

---

### 15.2 ã€é«˜å±é—æ¼ã€‘æ•°æ®åº“äº‹åŠ¡ç¼ºå¤± â€” å¤šè¡¨æ“ä½œéåŸå­æ€§

**å½“å‰çŠ¶æ€**ï¼šæ•´ä¸ªä»£ç åº“**é›¶äº‹åŠ¡**ä½¿ç”¨ï¼ˆæœç´¢ `transaction|BEGIN|COMMIT` æ— ç»“æœï¼‰ã€‚

**éœ€è¦åŒ…è£¹äº‹åŠ¡çš„å…³é”®æ“ä½œ**ï¼š

| æ“ä½œ | æ–‡ä»¶ | è¡Œå· | é£é™© |
|------|------|------|------|
| `confirmEntries` â€” æ›´æ–° hwEntries + hwStudents | `homeworkManager.ts:489-521` | å¤šè¡Œ UPDATE + DELETE | ä¸­é€”å¤±è´¥ â†’ æ¡ç›®å·²åˆ ä½†å­¦ç”Ÿæœªæ›´æ–° |
| `confirmAllPreStaged` â€” åŒä¸Š | `homeworkManager.ts:523-558` | åŒä¸Š | åŒä¸Š |
| `importStudentBackup` â€” æ‰¹é‡ INSERT å­¦ç”Ÿ + æ¡ç›® | `homeworkManager.ts:854-895` | å¤šè¡¨ INSERT | éƒ¨åˆ†å­¦ç”Ÿå¯¼å…¥æˆåŠŸéƒ¨åˆ†å¤±è´¥ |
| `bgTask.submit` â€” INSERT ä»»åŠ¡ + å¯åŠ¨æ‰§è¡Œ | `routers.ts:1940-1978` | INSERT + fire-and-forget | æ‰§è¡Œå¤±è´¥ä½† DB è®°å½•å·²åˆ›å»º |
| `batchTask.submit` â€” INSERT ä»»åŠ¡ + å­é¡¹ | `routers.ts:2212-2294` | å¤šè¡Œ INSERT | éƒ¨åˆ†å­é¡¹æœªåˆ›å»º |

**æ”¹é€ ç¤ºä¾‹ï¼ˆDrizzle ORM äº‹åŠ¡ï¼‰**ï¼š

```typescript
// confirmEntries æ”¹é€ 
async function confirmEntries(userId: number, ids: number[]) {
  const db = await getDb();
  await db.transaction(async (tx) => {
    // 1. è¯»å–æ¡ç›®
    const entries = await tx.select().from(hwEntries)
      .where(and(inArray(hwEntries.id, ids), eq(hwEntries.userId, userId)));
    // 2. æ›´æ–°å­¦ç”ŸçŠ¶æ€
    for (const name of studentNames) {
      await tx.update(hwStudents).set({...})
        .where(and(eq(hwStudents.userId, userId), eq(hwStudents.name, name)));
    }
    // 3. æ›´æ–°æ¡ç›®çŠ¶æ€
    await tx.update(hwEntries).set({ entryStatus: "confirmed" })
      .where(inArray(hwEntries.id, ids));
  });
}
```

**é£é™©ç­‰çº§**ï¼šğŸ”´ é«˜å± â€” æ•°æ®ä¸ä¸€è‡´
**æ‰€å± Phase**ï¼šPhase 4

---

### 15.3 ã€é«˜å±é—æ¼ã€‘é”™è¯¯ä¿¡æ¯æ³„éœ²ç”¨æˆ·æ•æ„Ÿæ•°æ®

**é—®é¢˜æè¿°**ï¼šé”™è¯¯æ¶ˆæ¯ä¸­åŒ…å«å­¦ç”Ÿå§“åç­‰ PII æ•°æ®ï¼Œä¸”è¿”å›ç»™å‰ç«¯ã€‚

**å…·ä½“æ³„éœ²ç‚¹**ï¼š

| æ–‡ä»¶ | è¡Œå· | é”™è¯¯ä¿¡æ¯ | æ³„éœ²å†…å®¹ |
|------|------|----------|----------|
| `homeworkManager.ts:124` | `å­¦ç”Ÿã€Œ${name.trim()}ã€å·²å­˜åœ¨` | å­¦ç”Ÿå§“å |
| `homeworkManager.ts:436` | `æ¡ç›®å½“å‰çŠ¶æ€ä¸ºã€Œ${entry.entryStatus}ã€...` | æ¡ç›®çŠ¶æ€ |
| `backgroundTaskRunner.ts:507` | `å­¦ç”Ÿ: ${params.studentName}` | å­¦ç”Ÿå§“å |
| `backgroundTaskRunner.ts:535-536` | æ—¥å¿—æ–‡ä»¶åå«å­¦ç”Ÿå§“å | å­¦ç”Ÿå§“å+è¯¾æ¬¡ |
| `backgroundTasks.error_message` åˆ— | å­˜å‚¨å®Œæ•´é”™è¯¯å †æ ˆ | å¯èƒ½å«å…¶ä»–ç”¨æˆ·æ•°æ® |

**æ”»å‡»åœºæ™¯**ï¼š
1. ç”¨æˆ· A è°ƒç”¨ `homework.addStudent("å¼ ä¸‰")` â†’ æŠ¥é”™ "å­¦ç”Ÿã€Œå¼ ä¸‰ã€å·²å­˜åœ¨"
2. éš”ç¦»åä¸åŒç”¨æˆ·å¯ä»¥æœ‰åŒåå­¦ç”Ÿï¼Œä½†é”™è¯¯æ¶ˆæ¯æœªæ›´æ–°
3. è‹¥ addStudent çš„å”¯ä¸€çº¦æŸä¸º `UNIQUE(userId, name)`ï¼Œé”™è¯¯æ¶ˆæ¯ä¸å†æ³„éœ²ï¼ˆä»…åœ¨æœ¬ç”¨æˆ·èŒƒå›´å†…é‡å¤ï¼‰
4. ä½† **backgroundTasks.error_message** åˆ—ä¸­çš„é”™è¯¯å †æ ˆä»å¯èƒ½å«æœ‰æ–‡ä»¶è·¯å¾„ã€å­¦ç”Ÿå§“åç­‰

**æ”¹é€ å»ºè®®**ï¼š
- ç¡®ä¿æ‰€æœ‰è¿”å›ç»™å‰ç«¯çš„é”™è¯¯æ¶ˆæ¯ä¸åŒ…å«å…¶ä»–ç”¨æˆ·çš„å­¦ç”Ÿå§“å
- `backgroundTasks.error_message` ä»…å­˜å‚¨è„±æ•çš„é”™è¯¯æ‘˜è¦
- `addStudent` é”™è¯¯æ¶ˆæ¯æ”¹ä¸º "æ‚¨å·²æ·»åŠ è¿‡æ­¤å­¦ç”Ÿ"

**é£é™©ç­‰çº§**ï¼šğŸŸ¡ ä¸­é«˜ â€” PII æ³„éœ²
**æ‰€å± Phase**ï¼šPhase 4

---

### 15.4 ã€é«˜å±é—æ¼ã€‘å¤‡ä»½å¯¼å…¥å¯¼å‡ºå…¼å®¹æ€§ â€” æ ¼å¼ä¸å« userId

**æ–‡ä»¶ï¼š`server/homeworkManager.ts:708-895`**

**å½“å‰å¤‡ä»½æ ¼å¼**ï¼š

```markdown
## â•â•â•â•â•â•â• å­¦ç”Ÿ: å¼ ä¸‰ â•â•â•â•â•â•â•
> ç±»å‹: weekly | çŠ¶æ€: active
### å½“å‰çŠ¶æ€
ï¼ˆå­¦ç”Ÿå½“å‰çŠ¶æ€æ–‡æ¡£ï¼‰
```

**é—®é¢˜åˆ—è¡¨**ï¼š

| é—®é¢˜ | å½±å“ |
|------|------|
| å¤‡ä»½æ ¼å¼æ—  userId å­—æ®µ | æ— æ³•ç¡®å®šæ•°æ®å½’å± |
| å¯¼å…¥æ—¶æŒ‰ `name` åŒ¹é…å­¦ç”Ÿï¼ˆ`eq(hwStudents.name, s.name)`ï¼‰ | åŒ¹é…åˆ°å…¶ä»–ç”¨æˆ·çš„åŒåå­¦ç”Ÿ |
| æ—§æ ¼å¼å¤‡ä»½å¯¼å…¥åˆ°æ–°ç³»ç»Ÿ | å› ç¼ºå°‘ userId å‚æ•°å¯èƒ½å¤±è´¥æˆ–å†™å…¥é”™è¯¯ç”¨æˆ· |
| ç”¨æˆ· A å¯¼å‡º â†’ å‘ç»™ç”¨æˆ· B å¯¼å…¥ | æ•°æ®ç›´æ¥å†™å…¥ç”¨æˆ· Bï¼ˆæ— å½’å±éªŒè¯ï¼‰ |

**æ”¹é€ æ–¹æ¡ˆ**ï¼š

```typescript
// 1. å¯¼å‡ºæ—¶æ·»åŠ æ ¼å¼ç‰ˆæœ¬å’Œç”¨æˆ·æ ‡è¯†
const header = `> æ ¼å¼ç‰ˆæœ¬: 2\n> ç”¨æˆ·ID: ${userId}\n> å¯¼å‡ºæ—¶é—´: ${now}\n\n`;

// 2. å¯¼å…¥æ—¶ï¼š
//    a. å¿½ç•¥å¤‡ä»½ä¸­çš„ userIdï¼ˆå¯¼å…¥åˆ°å½“å‰ç”¨æˆ·åä¸‹ï¼‰
//    b. æŸ¥è¯¢ç”¨ userId è¿‡æ»¤
const existing = await db.select().from(hwStudents)
  .where(and(eq(hwStudents.userId, userId), eq(hwStudents.name, s.name)));

// 3. å‘åå…¼å®¹æ—§æ ¼å¼ï¼ˆæ— ç‰ˆæœ¬å·çš„è§†ä¸º v1ï¼‰
```

**é£é™©ç­‰çº§**ï¼šğŸ”´ é«˜å± â€” è·¨ç”¨æˆ·æ•°æ®å¯¼å…¥
**æ‰€å± Phase**ï¼šPhase 4

---

### 15.5 ã€ä¸­å±é—æ¼ã€‘gdrive.ts ä¸´æ—¶æ–‡ä»¶å†™å…¥éç”¨æˆ·éš”ç¦»

**æ–‡ä»¶ï¼š`server/gdrive.ts:289-350`**

**å½“å‰é—®é¢˜**ï¼š
- rclone ä¸Šä¼ æ¨¡å¼ä¸‹ï¼Œæ–‡ä»¶å…ˆå†™å…¥ `process.cwd()` ç›®å½•ï¼ˆå¦‚ `./å¼ ä¸‰_ç¬¬12æ¬¡è¯¾_å­¦æƒ…åé¦ˆ.docx`ï¼‰
- å¤šç”¨æˆ·åŒæ—¶ä¸Šä¼ åŒåæ–‡ä»¶ â†’ æ–‡ä»¶è¦†ç›–

```typescript
const tempDir = process.cwd();
const tempFilePath = path.join(tempDir, fileName);  // â† æ— ç”¨æˆ·éš”ç¦»
await fs.promises.writeFile(tempFilePath, content, "utf-8");
```

**æ”¹é€ æ–¹æ¡ˆ**ï¼š

```typescript
// ä½¿ç”¨ userId åˆ›å»ºéš”ç¦»ä¸´æ—¶ç›®å½•
const tempDir = path.join(os.tmpdir(), `feedback-mvp-${userId}`);
await fs.promises.mkdir(tempDir, { recursive: true });
const tempFilePath = path.join(tempDir, `${Date.now()}_${fileName}`);
```

**æ³¨æ„**ï¼šæŸ¥çœ‹ä»£ç åå‘ç° OAuth API ä¸Šä¼ è·¯å¾„ï¼ˆå¤§éƒ¨åˆ†åœºæ™¯ï¼‰ä¸èµ° rcloneï¼Œä¸å†™ä¸´æ—¶æ–‡ä»¶ã€‚ä»… rclone å…œåº•æ¨¡å¼å—å½±å“ã€‚ä¼˜å…ˆçº§ä¸­ç­‰ã€‚

**é£é™©ç­‰çº§**ï¼šğŸŸ¡ ä¸­ â€” æ–‡ä»¶ç«äº‰
**æ‰€å± Phase**ï¼šPhase 2

---

### 15.6 ã€ä¸­å±é—æ¼ã€‘storagePut æ–‡ä»¶è·¯å¾„æ— ç”¨æˆ·éš”ç¦»

**æ–‡ä»¶ï¼š`server/storage.ts`**

**å½“å‰é—®é¢˜**ï¼š
- `storagePut(relKey, data, contentType)` å°†æ–‡ä»¶ä¸Šä¼ åˆ°å…±äº«å­˜å‚¨æ¡¶
- `relKey` æ—  userId å‰ç¼€ â†’ ä¸åŒç”¨æˆ·çš„åŒåæ–‡ä»¶å¯èƒ½å†²çª

**æ”¹é€ æ–¹æ¡ˆ**ï¼š
- è°ƒç”¨ `storagePut` å‰ï¼Œå°† relKey åŠ ä¸Š userId å‰ç¼€ï¼š`users/${userId}/${relKey}`
- æˆ–åœ¨ `storagePut` å†…éƒ¨æ¥å— userId å‚æ•°

**é£é™©ç­‰çº§**ï¼šğŸŸ¡ ä¸­ â€” æ–‡ä»¶å†²çª
**æ‰€å± Phase**ï¼šPhase 4

---

### 15.7 ã€ä¸­å±é—æ¼ã€‘_retryLocks Set éœ€ userId éš”ç¦»

**æ–‡ä»¶ï¼š`server/batch/batchTaskRunner.ts:263`**

```typescript
const _retryLocks = new Set<string>();
// å½“å‰ keyï¼š`${batchId}:${taskNumber}`
// æ”¹ä¸ºï¼š`${userId}:${batchId}:${taskNumber}`
```

ä¸¤ä¸ªç”¨æˆ·çš„ batchIdï¼ˆUUIDï¼‰ç†è®ºä¸Šä¸ä¼šé‡å¤ï¼Œä½†åŠ  userId å‰ç¼€æ˜¯é˜²å¾¡æ€§ç¼–ç¨‹æœ€ä½³å®è·µã€‚

**é£é™©ç­‰çº§**ï¼šğŸŸ¡ ä½ä¸­
**æ‰€å± Phase**ï¼šPhase 4

---

### 15.8 ã€ä¸­å±é—æ¼ã€‘éƒ¨ç½²å›æ»šæ–¹æ¡ˆç¼ºå¤±

æ¸…å•æåˆ°"è¿ç§»è„šæœ¬å¿…é¡»åœ¨åº”ç”¨åœæœºæ—¶æ‰§è¡Œ"ï¼Œä½†ç¼ºå°‘ï¼š

**1. å›æ»šè„šæœ¬**

```sql
-- å›æ»šè„šæœ¬ï¼ˆç´§æ€¥æƒ…å†µä¸‹ä½¿ç”¨ï¼‰
-- æ­¥éª¤ 1ï¼šå°† user_config æ•°æ®å†™å› systemConfig
INSERT INTO system_config (`key`, value, description)
SELECT `key`, value, description FROM user_config WHERE user_id = @admin_id
ON DUPLICATE KEY UPDATE value = VALUES(value);

-- æ­¥éª¤ 2ï¼šåˆ é™¤ userId åˆ—ï¼ˆå„è¡¨ï¼‰
ALTER TABLE hw_students DROP COLUMN user_id;
ALTER TABLE hw_entries DROP COLUMN user_id;
ALTER TABLE background_tasks DROP COLUMN user_id;
ALTER TABLE batch_tasks DROP COLUMN user_id;
ALTER TABLE correction_tasks DROP COLUMN user_id;
ALTER TABLE google_tokens DROP COLUMN user_id;

-- æ­¥éª¤ 3ï¼šæ¢å¤ hw_students å”¯ä¸€çº¦æŸ
ALTER TABLE hw_students DROP INDEX hw_students_user_name;
ALTER TABLE hw_students ADD UNIQUE INDEX hw_students_name_unique (name);

-- æ­¥éª¤ 4ï¼šåˆ é™¤ user_config è¡¨
DROP TABLE IF EXISTS user_config;
```

**2. ç»´æŠ¤æ¨¡å¼**

å»ºè®®åœ¨ Express ä¸­é—´ä»¶ä¸­æ·»åŠ ç»´æŠ¤æ¨¡å¼å¼€å…³ï¼š

```typescript
// server/_core/index.ts
if (process.env.MAINTENANCE_MODE === "true") {
  app.use((req, res) => res.status(503).json({ error: "ç³»ç»Ÿç»´æŠ¤ä¸­" }));
}
```

**é£é™©ç­‰çº§**ï¼šğŸŸ¡ ä¸­ â€” ç”Ÿäº§äº‹æ•…æ¢å¤
**æ‰€å± Phase**ï¼šPhase 1ï¼ˆä¸è¿ç§»è„šæœ¬ä¸€èµ·å‡†å¤‡ï¼‰

---

### 15.9 ã€ä¸­å±é—æ¼ã€‘ç”¨æˆ·æ•°æ®æ¸…ç†æœºåˆ¶ç¼ºå¤±

**å½“å‰çŠ¶æ€**ï¼šæ²¡æœ‰åˆ é™¤ç”¨æˆ·æ•°æ®çš„åŠŸèƒ½ã€‚

**éœ€è¡¥å……**ï¼ˆä½ä¼˜å…ˆçº§ï¼Œæœªæ¥éœ€æ±‚ï¼‰ï¼š

```typescript
// æœªæ¥éœ€è¦çš„ admin åŠŸèƒ½ï¼š
async function deleteUserData(userId: number): Promise<void> {
  await db.transaction(async (tx) => {
    await tx.delete(hwEntries).where(eq(hwEntries.userId, userId));
    await tx.delete(hwStudents).where(eq(hwStudents.userId, userId));
    await tx.delete(backgroundTasks).where(eq(backgroundTasks.userId, userId));
    await tx.delete(batchTaskItems).where(/* é€šè¿‡ batchTasks å…³è” */);
    await tx.delete(batchTasks).where(eq(batchTasks.userId, userId));
    await tx.delete(correctionTasks).where(eq(correctionTasks.userId, userId));
    await tx.delete(googleTokens).where(eq(googleTokens.userId, userId));
    await tx.delete(userConfig).where(eq(userConfig.userId, userId));
    // åˆ é™¤æ—¥å¿—æ–‡ä»¶ï¼šrm -rf logs/user_{userId}/
    // æ–­å¼€ Google Driveï¼ˆrevoke tokenï¼‰
  });
}
```

**å»ºè®®**ï¼šæ•°æ®åº“æ·»åŠ  FK çº¦æŸ + ON DELETE CASCADE ä½œä¸ºå®‰å…¨ç½‘ã€‚

**é£é™©ç­‰çº§**ï¼šğŸŸ¡ ä¸­ â€” æ•°æ®ç”Ÿå‘½å‘¨æœŸç®¡ç†
**æ‰€å± Phase**ï¼šå¯æ¨è¿Ÿ

---

### 15.10 ã€ä¸­å±é—æ¼ã€‘Foreign Key çº¦æŸç¼ºå¤±

**å½“å‰çŠ¶æ€**ï¼šæ•´ä¸ª schema **é›¶ FK çº¦æŸ**ï¼Œå…¨éƒ¨æ˜¯é€»è¾‘å…³è”ã€‚

æ·»åŠ  userId åˆ—åå»ºè®®è¡¥å…… FK çº¦æŸï¼š

```typescript
// drizzle/schema.ts â€” ç¤ºä¾‹
export const hwStudents = mysqlTable("hw_students", {
  // ...
  userId: int("user_id").notNull().references(() => users.id, { onDelete: "cascade" }),
});
```

**ä¼˜ç‚¹**ï¼š
- æ•°æ®åº“å±‚é¢ä¿è¯å¼•ç”¨å®Œæ•´æ€§
- è‡ªåŠ¨çº§è”åˆ é™¤å­¤å„¿è®°å½•
- é˜²æ­¢æ’å…¥æ— æ•ˆ userId

**ç¼ºç‚¹**ï¼š
- å¢åŠ  INSERT/UPDATE å¼€é”€ï¼ˆå¾®å°ï¼‰
- éœ€è¦å…ˆæœ‰ users è®°å½•æ‰èƒ½æ’å…¥å­è¡¨

**å»ºè®®**ï¼šPhase 1 è¿ç§»è„šæœ¬ä¸­æ·»åŠ  FK çº¦æŸï¼Œä½†ç”¨ `ON DELETE RESTRICT`ï¼ˆé˜²æ­¢æ„å¤–åˆ é™¤ç”¨æˆ·ï¼‰è€Œé CASCADEã€‚

**é£é™©ç­‰çº§**ï¼šğŸŸ¡ ä¸­ â€” æ•°æ®å®Œæ•´æ€§
**æ‰€å± Phase**ï¼šPhase 1

---

### 15.11 ã€ä½å±ã€‘bgTask.submit å­˜å‚¨ç”¨æˆ·è¾“å…¥çš„ API å‡­è¯

**æ–‡ä»¶ï¼š`server/routers.ts:1909-1978`**

**å½“å‰é—®é¢˜**ï¼š
- ç”¨æˆ·å¯é€šè¿‡ `bgTask.submit` ä¼ å…¥è‡ªå®šä¹‰ apiKey / apiUrl
- è¿™äº›å€¼è¢«åºåˆ—åŒ–åˆ° `inputParams` JSON å­˜å…¥æ•°æ®åº“
- æ•°æ®åº“ä¸­**æ˜æ–‡å­˜å‚¨**ç”¨æˆ· API å¯†é’¥

**é£é™©**ï¼š
- æ•°æ®åº“æ³„éœ² â†’ æ‰€æœ‰ç”¨æˆ· API å¯†é’¥æš´éœ²
- ç”¨æˆ·å¯ä¼ å…¥æ¶æ„ apiUrl â†’ ä¸­é—´äººæ”»å‡»

**å»ºè®®**ï¼š
- éš”ç¦»åï¼Œä» user_config è¯»å–é…ç½®ï¼Œä¸ä»ç”¨æˆ·è¾“å…¥è·å–
- inputParams ä¸­åªè®°å½•é…ç½®å¿«ç…§çš„éæ•æ„Ÿéƒ¨åˆ†
- æˆ–åŠ å¯†å­˜å‚¨ inputParams ä¸­çš„ apiKey

**é£é™©ç­‰çº§**ï¼šğŸŸ¢ ä½ï¼ˆç°æœ‰è¡Œä¸ºï¼Œééš”ç¦»å¼•å…¥çš„æ–°é—®é¢˜ï¼‰
**æ‰€å± Phase**ï¼šå¯æ¨è¿Ÿ

---

### 15.12 ã€ä½å±ã€‘OAUTH_STATE_SECRET ç¯å¢ƒå˜é‡

**æ–‡ä»¶ï¼š`server/_core/env.ts`**

æ¸…å• Section 11.7 æå‡ºäº† OAuth state ç­¾åæ–¹æ¡ˆï¼Œä½¿ç”¨ `STATE_SECRET`ã€‚ä½† env.ts ä¸­æœªå®šä¹‰æ­¤å˜é‡ã€‚

**è¡¥å……**ï¼š

```typescript
// env.ts æ–°å¢
oauthStateSecret: process.env.OAUTH_STATE_SECRET ?? "",
```

éƒ¨ç½²æ—¶éœ€é…ç½®æ­¤ç¯å¢ƒå˜é‡ã€‚è‹¥æœªé…ç½®ï¼Œåº”è‡ªåŠ¨ç”Ÿæˆï¼ˆä½†é‡å¯åä¼šå¤±æ•ˆï¼Œå¯¼è‡´è¿›è¡Œä¸­çš„ OAuth æµç¨‹å¤±è´¥ï¼‰ã€‚

**é£é™©ç­‰çº§**ï¼šğŸŸ¢ ä½
**æ‰€å± Phase**ï¼šPhase 2

---

### 15.13 ã€ä½å±ã€‘Google Drive API é™æµæ„ŸçŸ¥

**å½“å‰çŠ¶æ€**ï¼š`gdrive.ts` æ— ä»»ä½• 429 å“åº”å¤„ç†æˆ–é™æµæœºåˆ¶ã€‚

å¤šç”¨æˆ·åœºæ™¯ä¸‹ï¼Œè™½ç„¶æ¯ä¸ªç”¨æˆ·æœ‰ç‹¬ç«‹ OAuth ä»¤ç‰Œï¼ˆGoogle æŒ‰ä»¤ç‰Œé™æµï¼‰ï¼Œä½†åº”ç”¨ä½¿ç”¨çš„æ˜¯åŒä¸€ä¸ª Google OAuth Clientï¼Œé¡¹ç›®çº§é…é¢è¢«æ‰€æœ‰ç”¨æˆ·å…±äº«ã€‚

**å»ºè®®**ï¼š
- åœ¨ `gdriveFetch` ä¸­æ·»åŠ  429 å“åº”æ£€æµ‹ + è‡ªåŠ¨é€€é¿é‡è¯•
- è®°å½•æ¯ç”¨æˆ·çš„ API è°ƒç”¨é¢‘ç‡ï¼Œç”¨äºè¯Šæ–­

```typescript
async function gdriveFetch(url: string, options?: RequestInit, timeoutMs = 60_000): Promise<Response> {
  // ... ç°æœ‰è¶…æ—¶é€»è¾‘ ...
  const response = await fetch(url, { ...options, signal: controller.signal });
  if (response.status === 429) {
    const retryAfter = response.headers.get("Retry-After");
    console.warn(`[GDrive] 429 é™æµï¼Œ${retryAfter}ç§’åé‡è¯•`);
    await delay(parseInt(retryAfter || "5") * 1000);
    return gdriveFetch(url, options, timeoutMs);  // é€’å½’é‡è¯•ä¸€æ¬¡
  }
  return response;
}
```

**é£é™©ç­‰çº§**ï¼šğŸŸ¢ ä½ â€” å½“å‰ç”¨æˆ·æ•°å°‘
**æ‰€å± Phase**ï¼šå¯æ¨è¿Ÿ

---

### 15.14 ã€ä¿¡æ¯ã€‘ä¼šè¯ç®¡ç†è¯„ä¼°

ç»æ ¸å®ï¼š
- è®¤è¯åŸºäº JWT æ— çŠ¶æ€ Cookieï¼ˆ`server/_core/sdk.ts`ï¼‰
- å¤šè®¾å¤‡åŒæ—¶ç™»å½• â†’ æ­£å¸¸å·¥ä½œï¼ˆæ¯ä¸ªè®¾å¤‡ç‹¬ç«‹ cookieï¼‰
- åŒä¸€æµè§ˆå™¨å¤šæ ‡ç­¾é¡µç™»å½•ä¸åŒè´¦å· â†’ cookie äº’ç›¸è¦†ç›–ï¼ˆæµè§ˆå™¨è¡Œä¸ºï¼ŒéæœåŠ¡ç«¯é—®é¢˜ï¼‰
- SSE æµæœŸé—´ session è¿‡æœŸ â†’ æµç»§ç»­ï¼ˆå·²è®¤è¯è¿æ¥æœ‰æ•ˆè‡³å®Œæˆï¼Œç¬¦åˆ OAuth2 æ ‡å‡†åšæ³•ï¼‰

**ç»“è®º**ï¼šä¼šè¯ç®¡ç†æ–¹æ¡ˆåˆç†ï¼Œ**æ— éœ€æ”¹é€ **ã€‚

---

### 15.15 ã€ä¿¡æ¯ã€‘WebSocket / å®æ—¶æ¨é€è¯„ä¼°

ç»æœç´¢ç¡®è®¤ï¼šç³»ç»Ÿ**ä¸ä½¿ç”¨ WebSocket**ï¼Œä»…ä½¿ç”¨ SSEï¼ˆServer-Sent Eventsï¼Œå•å‘æ¨é€ï¼‰ã€‚SSE ç«¯ç‚¹å·²å…¨éƒ¨åœ¨æ¸…å•ä¸­åˆ—å‡ºã€‚

**ç»“è®º**ï¼š**æ— éœ€é¢å¤–æ”¹é€ **ã€‚

---

## åå…­ã€æœ€ç»ˆæ”¹é€ ç»Ÿè®¡ï¼ˆç¬¬äºŒè½®æ›´æ–°ï¼‰

| ç±»åˆ« | ä¸Šæ¬¡ç»Ÿè®¡ | æœ€ç»ˆç»Ÿè®¡ | å·®å¼‚ |
|------|----------|----------|------|
| æ•°æ®åº“è¿ç§»æ­¥éª¤ | 10 | **17** | **+7**ï¼ˆ6 ç´¢å¼• + å›æ»šè„šæœ¬ï¼‰ |
| éœ€æ”¹é€ çš„åç«¯æ–‡ä»¶ | 20 | **22** | **+2**ï¼ˆstorage.tsã€env.tsï¼‰ |
| éœ€æ”¹é€ çš„å‡½æ•°ç­¾å | 60+ | **65+** | **+5**ï¼ˆäº‹åŠ¡åŒ…è£¹ã€å¤‡ä»½å…¼å®¹ï¼‰ |
| å®‰å…¨åŠ å›ºé¡¹ | 5 | **8** | **+3**ï¼ˆé”™è¯¯è„±æ•ã€å¤‡ä»½æ ¼å¼ã€FK çº¦æŸï¼‰ |
| æµ‹è¯•è®¡åˆ’ | Phase 7 | Phase 7 | **+2 ç±»æµ‹è¯•**ï¼ˆå¤‡ä»½å…¼å®¹æµ‹è¯•ã€äº‹åŠ¡å›æ»šæµ‹è¯•ï¼‰ |

---

## åä¸ƒã€æœ€ç»ˆå®æ–½é¡ºåºï¼ˆå®Œæ•´ç‰ˆï¼‰

```
Phase 1: æ•°æ®åº“æ”¹é€ 
  â”œâ”€â”€ 1.1 æ–°å»º user_config è¡¨
  â”œâ”€â”€ 1.2 æ‰€æœ‰è¡¨æ·»åŠ  userId åˆ—ï¼ˆå¹‚ç­‰è„šæœ¬ï¼‰
  â”œâ”€â”€ 1.3 å­˜é‡æ•°æ®è¿ç§»ï¼ˆåŠ¨æ€ admin IDï¼‰
  â”œâ”€â”€ 1.4 ä¿®æ”¹å”¯ä¸€çº¦æŸ
  â”œâ”€â”€ 1.5 æ·»åŠ æ€§èƒ½ç´¢å¼•ï¼ˆ6 æ¡ CREATE INDEXï¼‰         â† ğŸ†• æ–°å¢
  â”œâ”€â”€ 1.6 æ·»åŠ  FK çº¦æŸï¼ˆå¯é€‰ï¼ŒON DELETE RESTRICTï¼‰   â† ğŸ†• æ–°å¢
  â””â”€â”€ 1.7 å‡†å¤‡å›æ»šè„šæœ¬                              â† ğŸ†• æ–°å¢

Phase 2: æ ¸å¿ƒåŸºç¡€è®¾æ–½
  â”œâ”€â”€ 2.1 é…ç½®è¯»å–å±‚ getUserConfigValue()
  â”œâ”€â”€ 2.2 googleAuth.ts æ”¹é€  + refreshPromises æ¸…ç†
  â”œâ”€â”€ 2.3 gdrive.ts æ”¹é€ ï¼ˆå«ä¸´æ—¶æ–‡ä»¶éš”ç¦»ï¼‰           â† ğŸ†• æ‰©å……
  â”œâ”€â”€ 2.4 trpc.ts ä¸­é—´ä»¶å¢å¼º
  â”œâ”€â”€ 2.5 DEFAULT_CONFIG è¡¥å…¨æ‰€æœ‰é”®
  â”œâ”€â”€ 2.6 DEFAULT_CONFIG æ¸…é™¤ç¡¬ç¼–ç è·¯å¾„
  â”œâ”€â”€ 2.7 OAuth state ç­¾åæ–¹æ¡ˆ
  â””â”€â”€ 2.8 env.ts æ–°å¢ OAUTH_STATE_SECRET             â† ğŸ†• æ–°å¢

Phase 3: è·¯ç”±å±‚æ”¹é€ 
  â”œâ”€â”€ 3.1-3.7 åŸæœ‰ tRPC è·¯ç”±æ”¹é€ 
  â”œâ”€â”€ 3.8-3.9 SSE ç«¯ç‚¹æ”¹é€ 
  â”œâ”€â”€ 3.10 systemCheck æ”¹é€ 
  â”œâ”€â”€ 3.11 IDOR å½’å±éªŒè¯ WHERE å­å¥
  â”œâ”€â”€ 3.12 config.update æ‹†åˆ† admin è·¯ç”±
  â”œâ”€â”€ 3.13 download-drive-file å½’å±éªŒè¯
  â””â”€â”€ 3.14 é”™è¯¯æ¶ˆæ¯è„±æ•ï¼ˆä¸è¿”å›å­¦ç”Ÿå§“åï¼‰            â† ğŸ†• æ–°å¢

Phase 4: ä¸šåŠ¡é€»è¾‘å±‚
  â”œâ”€â”€ 4.1 homeworkManager.ts
  â”œâ”€â”€ 4.2 backgroundTaskRunner.ts
  â”œâ”€â”€ 4.3 batchTaskRunner.tsï¼ˆå« _retryLocks éš”ç¦»ï¼‰  â† ğŸ†• æ‰©å……
  â”œâ”€â”€ 4.4 correctionRunner.tsï¼ˆè·¨æ¨¡å—ä¿®å¤ï¼‰
  â”œâ”€â”€ 4.5 batchExecutor.ts
  â”œâ”€â”€ 4.6 systemCheck.ts
  â”œâ”€â”€ 4.7 logger.ts ç”¨æˆ·éš”ç¦»
  â”œâ”€â”€ 4.8 processEntryInBackground é—­åŒ…ä¿®å¤
  â”œâ”€â”€ 4.9 confirmEntries å¤åˆé”® + äº‹åŠ¡åŒ…è£¹           â† ğŸ†• æ‰©å……
  â”œâ”€â”€ 4.10 ensureTable å»ºè¡¨ SQL æ›´æ–°
  â”œâ”€â”€ 4.11 å¤‡ä»½å¯¼å…¥å¯¼å‡ºå…¼å®¹æ€§æ”¹é€                     â† ğŸ†• æ–°å¢
  â””â”€â”€ 4.12 storagePut æ–‡ä»¶è·¯å¾„ç”¨æˆ·éš”ç¦»               â† ğŸ†• æ–°å¢

Phase 5: å‰ç«¯
  â””â”€â”€ 5.1 localStorage key åŠ  userId å‰ç¼€

Phase 6: OAuth å›è°ƒ
  â””â”€â”€ 6.1 Google OAuth callback + state ç­¾åéªŒè¯

Phase 7: æµ‹è¯•éªŒè¯
  â”œâ”€â”€ 7.1 userId è¿‡æ»¤å•å…ƒæµ‹è¯•
  â”œâ”€â”€ 7.2 å¤šç”¨æˆ·ç«¯åˆ°ç«¯é›†æˆæµ‹è¯•
  â”œâ”€â”€ 7.3 è¿ç§»å›æ»šæµ‹è¯•
  â”œâ”€â”€ 7.4 æ–°ç”¨æˆ·å†·å¯åŠ¨æµ‹è¯•
  â”œâ”€â”€ 7.5 å¤‡ä»½å¯¼å…¥å¯¼å‡ºå…¼å®¹æµ‹è¯•                       â† ğŸ†• æ–°å¢
  â””â”€â”€ 7.6 äº‹åŠ¡åŸå­æ€§æµ‹è¯•                             â† ğŸ†• æ–°å¢
```

---

## åå…«ã€å…¨éƒ¨éªŒè¯ç»´åº¦è¦†ç›–çŸ©é˜µ

| ç»´åº¦ | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| âœ… å®Œæ•´æ€§ | å·²è¦†ç›– | æ‰€æœ‰è¡¨ã€è·¯ç”±ã€æ–‡ä»¶é€ä¸€æšä¸¾ |
| âœ… åˆç†æ€§ | å·²è¦†ç›– | æ–¹æ¡ˆè®¾è®¡è¯„å®¡ |
| âœ… é€»è¾‘æ­£ç¡®æ€§ | å·²è¦†ç›– | æ•°æ®æµè¿½è¸ª |
| âœ… ä¸šåŠ¡æµç¨‹ç«¯åˆ°ç«¯ | å·²è¦†ç›– | 12 æ¡ç”¨æˆ·æ“ä½œé“¾è·¯ |
| âœ… äº¤å‰æµ‹è¯• | å·²è¦†ç›– | è·¨æ¨¡å—æ•°æ®æµ |
| âœ… æç«¯æƒ…å†µ | å·²è¦†ç›– | åŒåå­¦ç”Ÿã€å¹¶å‘æ“ä½œã€ä¼šè¯è¿‡æœŸ |
| âœ… å‹åŠ›æµ‹è¯• | å·²è¦†ç›– | å¹¶å‘é™åˆ¶ã€å†…å­˜å‹åŠ›ã€Map æ¸…ç† |
| âœ… é²æ£’æ€§ / å®¹é”™ | å·²è¦†ç›– | è¿ç§»å¤±è´¥æ¢å¤ã€å›æ»šè„šæœ¬ |
| âœ… å®‰å…¨æ€§ï¼ˆIDORï¼‰ | å·²è¦†ç›– | æ‰€æœ‰é¡ºåº ID / UUID è·¯ç”±å®¡è®¡ |
| âœ… å®‰å…¨æ€§ï¼ˆCSRFï¼‰ | å·²è¦†ç›– | OAuth state ç­¾åæ–¹æ¡ˆ |
| âœ… å®‰å…¨æ€§ï¼ˆä¿¡æ¯æ³„éœ²ï¼‰ | å·²è¦†ç›– | é”™è¯¯æ¶ˆæ¯è„±æ•ã€æ—¥å¿—éš”ç¦» |
| âœ… å®‰å…¨æ€§ï¼ˆæƒé™æ§åˆ¶ï¼‰ | å·²è¦†ç›– | admin è·¯ç”±åˆ†ç¦»ã€å½’å±éªŒè¯ |
| âœ… å¯ç»´æŠ¤æ€§ | å·²è¦†ç›– | å‡½æ•°ç­¾åç»Ÿä¸€æ–¹æ¡ˆã€ç±»å‹å®‰å…¨ |
| âœ… å†—ä½™æ£€æµ‹ | å·²è¦†ç›– | æ¸…é™¤ä¸å¿…è¦çš„æ”¹åŠ¨ï¼ˆThemeContext ä½ä¼˜å…ˆçº§ï¼‰ |
| âœ… æ€§èƒ½ / ç´¢å¼• | å·²è¦†ç›– | 6 æ¡å…³é”®ç´¢å¼• |
| âœ… äº‹åŠ¡åŸå­æ€§ | å·²è¦†ç›– | 5 ä¸ªå¤šè¡¨æ“ä½œéœ€äº‹åŠ¡ |
| âœ… é”™è¯¯ä¿¡æ¯æ³„éœ² | å·²è¦†ç›– | PII æ•°æ®è„±æ• |
| âœ… å¤‡ä»½å…¼å®¹æ€§ | å·²è¦†ç›– | å¯¼å…¥å¯¼å‡ºæ ¼å¼å‡çº§ |
| âœ… éƒ¨ç½² / å›æ»š | å·²è¦†ç›– | å›æ»šè„šæœ¬ + ç»´æŠ¤æ¨¡å¼ |
| âœ… æ•°æ®ç”Ÿå‘½å‘¨æœŸ | å·²è¦†ç›– | æ¸…ç†æœºåˆ¶ + FK çº¦æŸ |
| âœ… ä¸´æ—¶æ–‡ä»¶ | å·²è¦†ç›– | gdrive.ts + storagePut |
| âœ… å†…å­˜ç¼“å­˜ | å·²è¦†ç›– | å…¨éƒ¨ Map/Set æ‰«æ |
| âœ… ä¼šè¯ç®¡ç† | å·²è¦†ç›– | JWT æ— çŠ¶æ€ã€å¤šè®¾å¤‡ |
| âœ… SSE è¿æ¥ç”Ÿå‘½å‘¨æœŸ | å·²è¦†ç›– | è®¤è¯æœ‰æ•ˆè‡³å®Œæˆ |
| âœ… WebSocket | å·²è¦†ç›– | ç³»ç»Ÿä¸ä½¿ç”¨ WebSocket |
| âœ… ç¬¬ä¸‰æ–¹ API é™æµ | å·²è¦†ç›– | Google Drive 429 å¤„ç† |
| âœ… ç±»å‹å®‰å…¨ | å·²è¦†ç›– | Drizzle æ¨æ–­ç±»å‹è‡ªåŠ¨æ›´æ–° |
| âœ… å‰åç«¯å¥‘çº¦ | å·²è¦†ç›– | å“åº”æ ¼å¼åŸºæœ¬ä¸å˜ |
| âœ… ç¯å¢ƒå˜é‡ | å·²è¦†ç›– | OAUTH_STATE_SECRET |

---

## åä¹ã€é€æ–‡ä»¶ç²¾ç¡®ç»Ÿè®¡ï¼ˆç¬¬ä¸‰è½®ï¼š100% ç²¾ç¡®è®¡æ•°ï¼‰

> ä»¥ä¸‹æ•°æ®åŸºäºå¯¹å…¨éƒ¨æºä»£ç çš„é€è¡Œå®¡è®¡ï¼Œ**ä¸å«ä»»ä½•è¿‘ä¼¼å€¼**ã€‚
> æ¯ä¸ªæ•°å­—éƒ½å¯æº¯æºåˆ°å…·ä½“è¡Œå·ã€‚

### 19.1 æ€»è§ˆï¼ˆæ›¿ä»£æ­¤å‰æ‰€æœ‰ "65+"ã€"60+"ã€"80+" è¿‘ä¼¼å€¼ï¼‰

| å˜æ›´ç±»åˆ« | **ç²¾ç¡®æ•°é‡** | è¯´æ˜ |
|----------|-------------|------|
| éœ€æ”¹é€ çš„å‡½æ•°ç­¾åï¼ˆæ·»åŠ  userId å‚æ•°ï¼‰ | **70** | 63 ä¸ª exported + 7 ä¸ª internal |
| éœ€æ”¹é€ çš„ DB æŸ¥è¯¢ï¼ˆæ·»åŠ  userId WHERE/VALUESï¼‰ | **81** | è·¨ 7 å¼ è¡¨çš„ç‹¬ç«‹æŸ¥è¯¢ç«™ç‚¹ |
| éœ€æ”¹é€ çš„é…ç½®è¯»å–è°ƒç”¨ï¼ˆgetConfig â†’ getUserConfigValueï¼‰ | **160** | è·¨å…¨éƒ¨è°ƒç”¨å±‚ |
| éœ€æ”¹é€ çš„ GDrive/Auth è°ƒç”¨ï¼ˆä¼ é€’ userIdï¼‰ | **43** | å« uploadToGoogleDriveã€getValidToken ç­‰ |
| éœ€æ”¹é€ çš„å†…å­˜çŠ¶æ€ï¼ˆMap/å•ä¾‹åŠ  userId ç»´åº¦ï¼‰ | **12** | å˜é‡çº§åˆ« |
| éœ€æ”¹é€ çš„è·¯ç”±/ç«¯ç‚¹ï¼ˆæå– userId å¹¶ä¼ é€’ï¼‰ | **88** | 72 tRPC + 10 SSE + 5 Express + 1 OAuth |
| éœ€æ”¹é€ çš„ Schema/DDL | **12** | 6 è¡¨åŠ åˆ— + 1 æ–°è¡¨ + 1 çº¦æŸ + 4 CREATE TABLE SQL |
| éœ€æ”¹é€ çš„å‰ç«¯ localStorage | **9** | 3 æ–‡ä»¶ 3 ä¸ª keyï¼ˆå…¶ä¸­ 1 ä¸ªé«˜ä¼˜å…ˆçº§ï¼‰ |

### 19.2 æŒ‰æ–‡ä»¶é€ä¸€æ˜ç»†

#### â‘  drizzle/schema.tsï¼ˆ167 è¡Œï¼‰â€” 8 é¡¹

| # | å˜æ›´ | è¡Œå· |
|---|------|------|
| 1 | `googleTokens` è¡¨åŠ  `userId INT NOT NULL` + `UNIQUE(userId)` | 41-48 |
| 2 | `backgroundTasks` è¡¨åŠ  `userId INT NOT NULL` | 54-67 |
| 3 | `hwStudents` è¡¨åŠ  `userId INT NOT NULL`ï¼Œ`UNIQUE(name)` â†’ `UNIQUE(userId, name)` | 73-81 |
| 4 | `hwEntries` è¡¨åŠ  `userId INT NOT NULL` | 87-100 |
| 5 | `batchTasks` è¡¨åŠ  `userId INT NOT NULL` | 106-118 |
| 6 | `correctionTasks` è¡¨åŠ  `userId INT NOT NULL` | 143-163 |
| 7 | æ–°å»º `userConfig` è¡¨ï¼ˆid, userId, key, value, description, updatedAtï¼‰ | æ–°å¢ |
| 8 | `batchTaskItems` é€šè¿‡ FK ç»§æ‰¿ï¼ˆä¸éœ€ç›´æ¥åŠ  userIdï¼‰ | 124-137 |

#### â‘¡ server/googleAuth.tsï¼ˆ261 è¡Œï¼‰â€” 15 é¡¹

**å‡½æ•°ç­¾åéœ€åŠ  userIdï¼š6 ä¸ª**

| # | å‡½æ•° | è¡Œå· |
|---|------|------|
| 1 | `getAuthUrl()` â†’ `getAuthUrl(userId)` | 31 |
| 2 | `handleCallback(code)` â†’ `handleCallback(code, userId)` | 49 |
| 3 | `getValidToken()` â†’ `getValidToken(userId)` | 118 |
| 4 | `isAuthorized()` â†’ `isAuthorized(userId)` | 204 |
| 5 | `disconnect()` â†’ `disconnect(userId)` | 219 |
| 6 | `getStatus()` â†’ `getStatus(userId)` | 235 |

**DB æŸ¥è¯¢éœ€åŠ  userIdï¼š8 å¤„**

| # | æ“ä½œ | è¡Œå· | è¡¨ |
|---|------|------|----|
| 1 | `db.delete(googleTokens)` â€” åˆ é™¤å…¨è¡¨ | 97 | googleTokens |
| 2 | `db.insert(googleTokens).values({...})` â€” ç¼º userId | 98 | googleTokens |
| 3 | `db.select().from(googleTokens).limit(1)` â€” æ—  WHERE | 132 | googleTokens |
| 4 | `db.delete(googleTokens)` â€” åˆ é™¤å…¨è¡¨ | 175 | googleTokens |
| 5 | `db.update(googleTokens)...where(eq(id))` â€” ç¼º userId | 186-191 | googleTokens |
| 6 | `db.select().from(googleTokens).limit(1)` â€” æ—  WHERE | 208 | googleTokens |
| 7 | `db.delete(googleTokens)` â€” åˆ é™¤å…¨è¡¨ | 223 | googleTokens |
| 8 | `db.select().from(googleTokens).limit(1)` â€” æ—  WHERE | 245 | googleTokens |

**å†…å­˜çŠ¶æ€éœ€åŠ  userIdï¼š1 ä¸ª**

| # | å˜é‡ | è¡Œå· | ç°çŠ¶ â†’ ç›®æ ‡ |
|---|------|------|------------|
| 1 | `refreshPromise` | 113 | `Promise \| null` â†’ `Map<number, Promise>` |

#### â‘¢ server/gdrive.tsï¼ˆ772 è¡Œï¼‰â€” 15 é¡¹

**å‡½æ•°ç­¾åéœ€åŠ  userIdï¼š8 ä¸ª**

| # | å‡½æ•° | è¡Œå· | åŸå›  |
|---|------|------|------|
| 1 | `verifyFileExists(filePath)` | 53 | å†…éƒ¨è°ƒç”¨ getValidToken() (L55) |
| 2 | `uploadToGoogleDrive(content, fileName, folderPath)` | 234 | å†…éƒ¨è°ƒç”¨ getValidToken() (L254) |
| 3 | `uploadBinaryToGoogleDrive(buffer, fileName, folderPath)` | 361 | å†…éƒ¨è°ƒç”¨ getValidToken() (L381) |
| 4 | `uploadMultipleFiles(...)` | 505 | å†…éƒ¨è°ƒç”¨ #2 å’Œ #3 |
| 5 | `verifyAllFiles(filePaths)` | 564 | å†…éƒ¨è°ƒç”¨ #1 |
| 6 | `ensureFolderExists(folderPath)` | 586 | å†…éƒ¨è°ƒç”¨ getValidToken() (L589) |
| 7 | `readFileFromGoogleDrive(filePath)` | 674 | å†…éƒ¨è°ƒç”¨ getValidToken() (L675) |
| 8 | `searchFileInGoogleDrive(fileNames, searchDir?)` | 712 | å†…éƒ¨è°ƒç”¨ getValidToken() (L716) |

**å†…éƒ¨ getValidToken() è°ƒç”¨ï¼š6 å¤„** â€” L55, L254, L381, L589, L675, L716

**å†…å­˜çŠ¶æ€éœ€åŠ  userIdï¼š1 ä¸ª**

| # | å˜é‡ | è¡Œå· | ç°çŠ¶ â†’ ç›®æ ‡ |
|---|------|------|------------|
| 1 | `pendingFolderOps` | 87 | key ä» `folderPath::token` â†’ `userId::folderPath` |

#### â‘£ server/homeworkManager.tsï¼ˆ923 è¡Œï¼‰â€” 69 é¡¹

**å‡½æ•°ç­¾åéœ€åŠ  userIdï¼š22 ä¸ªï¼ˆ21 exported + 1 internalï¼‰**

| # | å‡½æ•° | è¡Œå· | å¯¼å‡º |
|---|------|------|------|
| 1 | `listStudents(statusFilter?)` | 97 | âœ… |
| 2 | `addStudent(name, planType)` | 108 | âœ… |
| 3 | `updateStudent(id, data)` | 130 | âœ… |
| 4 | `removeStudent(id)` | 147 | âœ… |
| 5 | `getStudentLatestStatus(studentName)` | 185 | âœ… |
| 6 | `processEntry(studentName, rawInput, aiModel?, onProgress?)` | 212 | âœ… |
| 7 | `createEntry(studentName, rawInput, aiModel?)` | 286 | âœ… |
| 8 | `submitAndProcessEntry(studentName, rawInput, aiModel?)` | 304 | âœ… |
| 9 | `listEntries(statusFilter?)` | 379 | âœ… |
| 10 | `listPendingEntries()` | 392 | âœ… |
| 11 | `listStudentEntries(studentName, limit, offset)` | 404 | âœ… |
| 12 | `retryEntry(id)` | 427 | âœ… |
| 13 | `deleteEntry(id)` | 481 | âœ… |
| 14 | `confirmEntries(ids)` | 489 | âœ… |
| 15 | `confirmAllPreStaged()` | 523 | âœ… |
| 16 | `importFromExtraction(studentName, content)` | 562 | âœ… |
| 17 | `importFromTaskExtraction(taskId, studentName)` | 604 | âœ… |
| 18 | `importClassFromTaskExtraction(taskId, classNumber, students)` | 637 | âœ… |
| 19 | `exportStudentBackup()` | 708 | âœ… |
| 20 | `importStudentBackup(content)` | 854 | âœ… |
| 21 | `autoBackupToGDrive()` | 900 | âœ… |
| 22 | `processEntryInBackground(id, studentName, rawInput, aiModel?)` | 320 | âŒ internal |

ä¸éœ€æ”¹çš„ï¼š`ensureHwTables`ï¼ˆDDLï¼‰ã€`parseBackupContent`ï¼ˆçº¯å‡½æ•°ï¼‰ã€`previewBackup`ï¼ˆçº¯å‡½æ•°ï¼‰

**DB æŸ¥è¯¢éœ€åŠ  userIdï¼š39 å¤„ï¼ˆhwStudents 17 + hwEntries 22ï¼‰**

hwStudents è¡¨ 17 å¤„ï¼šL103, L104, L113, L118, L126, L143, L151, L204, L512, L546, L572, L576, L585, L713, L870, L876, L884

hwEntries è¡¨ 22 å¤„ï¼šL79, L190, L290, L330, L337, L353, L369, L387, L388, L396, L415, L420, L432, L440, L447, L460, L474, L485, L496, L518, L529, L554

**é…ç½®è¯»å–éœ€åŠ  userIdï¼š5 å¤„** â€” L219, L220, L221, L224, L909

**GDrive è°ƒç”¨éœ€åŠ  userIdï¼š1 å¤„** â€” L913ï¼ˆuploadToGoogleDriveï¼‰

**Fire-and-forget éœ€ä¼  userIdï¼š2 å¤„** â€” L314, L596ï¼ˆprocessEntryInBackgroundï¼‰

#### â‘¤ server/correctionRunner.tsï¼ˆ474 è¡Œï¼‰â€” 24 é¡¹

**å‡½æ•°ç­¾åéœ€åŠ  userIdï¼š7 ä¸ªï¼ˆ5 exported + 2 internalï¼‰**

| # | å‡½æ•° | è¡Œå· | å¯¼å‡º |
|---|------|------|------|
| 1 | `getCorrectionTypes()` | 131 | âœ… |
| 2 | `getCorrectionPrompt()` | 143 | âœ… |
| 3 | `submitCorrection(params)` | 159 | âœ… |
| 4 | `getCorrectionTask(taskId)` | 421 | âœ… |
| 5 | `listCorrectionTasks(studentName?, limit?)` | 445 | âœ… |
| 6 | `cleanupOldTasks()` | 113 | âŒ internal |
| 7 | `processCorrectionInBackground(taskId)` | 234 | âŒ internal |

**DB æŸ¥è¯¢éœ€åŠ  userIdï¼š11 å¤„** â€” L118, L176, L240, L245, L262, L318, L342, L363, L377, L426, L450

**é…ç½®è¯»å–éœ€åŠ  userIdï¼š3 å¤„** â€” L132, L144, L307ï¼ˆgetAPIConfigï¼‰

**è·¨æ¨¡å—è°ƒç”¨éœ€ä¼  userIdï¼š2 å¤„** â€” L165ï¼ˆgetStudentLatestStatusï¼‰, L359ï¼ˆimportFromExtractionï¼‰

**CREATE TABLE éœ€åŠ  userId åˆ—ï¼š1 å¤„** â€” L75-95

#### â‘¥ server/backgroundTaskRunner.tsï¼ˆ1015 è¡Œï¼‰â€” 60 é¡¹

**å‡½æ•°ç­¾åéœ€åŠ  userIdï¼š10 ä¸ªï¼ˆ4 exported + 6 internalï¼‰**

| # | å‡½æ•° | è¡Œå· | å¯¼å‡º |
|---|------|------|------|
| 1 | `cancelBackgroundTask(taskId)` | 61 | âœ… |
| 2 | `startBackgroundTask(taskId)` | 181 | âœ… |
| 3 | `cleanupOldTasks()` | 903 | âœ… |
| 4 | `recoverInterruptedTasks()` | 980 | âœ… |
| 5 | `updateTask(taskId, updates)` | 159 | âŒ |
| 6 | `updateStepResults(taskId, stepResults, currentStep)` | 170 | âŒ |
| 7 | `checkCancellation(taskId, stepResults, currentStep)` | 77 | âŒ |
| 8 | `runTask(taskId)` | 220 | âŒ |
| 9 | `runOneToOneTask(taskId, params)` | 254 | âŒ |
| 10 | `runClassTask(taskId, params)` | 557 | âŒ |

**DB æŸ¥è¯¢éœ€åŠ  userIdï¼š6 å¤„ï¼ˆç›´æ¥ db.* è°ƒç”¨ï¼‰** â€” L163, L225, L909, L918, L989, L998

**é…ç½®è¯»å–éœ€åŠ  userIdï¼š13 å¤„**
- `runOneToOneTask`ï¼šL262, L263, L264, L265, L266, L267ï¼ˆ6 å¤„ï¼‰
- `runClassTask`ï¼šL564, L565, L566, L567, L569, L570, L571ï¼ˆ7 å¤„ï¼‰

**GDrive è°ƒç”¨éœ€åŠ  userIdï¼š13 å¤„**
- uploadToGoogleDriveï¼šL332, L475, L537, L632, L769, L859, L870ï¼ˆ7 å¤„ï¼‰
- uploadBinaryToGoogleDriveï¼šL429, L452, L488, L725, L747, L841ï¼ˆ6 å¤„ï¼‰

**CREATE TABLE éœ€åŠ  userId åˆ—ï¼š1 å¤„** â€” L946-960

**å†…å­˜çŠ¶æ€éœ€åŠ  userIdï¼š3 ä¸ª** â€” `_runningTaskCount`(L55), `_cancelSignals`(L58), `MAX_CONCURRENT_TASKS`(L54)

**Logger è°ƒç”¨ï¼ˆå½±å“æ—¥å¿—éš”ç¦»ï¼‰ï¼š14 å¤„** â€” L272, L283, L289, L357, L363, L370, L500, L578, L589, L608, L656, L662, L668, L887

#### â‘¦ server/batch/batchTaskRunner.tsï¼ˆ501 è¡Œï¼‰+ batchExecutor.tsï¼ˆ296 è¡Œï¼‰â€” 29 é¡¹

**å‡½æ•°ç­¾åéœ€åŠ  userIdï¼š7 ä¸ª**

| # | å‡½æ•° | æ–‡ä»¶ | è¡Œå· |
|---|------|------|------|
| 1 | `cancelBatchTask(batchId)` | batchTaskRunner | 21 |
| 2 | `startBatchBackgroundTask(batchId)` | batchTaskRunner | 82 |
| 3 | `retryBatchItem(batchId, taskNumber)` | batchTaskRunner | 268 |
| 4 | `cleanupOldBatchTasks()` | batchTaskRunner | 372 |
| 5 | `recoverInterruptedBatchTasks()` | batchTaskRunner | 460 |
| 6 | `executeBatchItem(params, onProgress)` | batchExecutor | 151 |
| 7 | `buildBatchMessageContent(...)` | batchExecutor | 67 |

**DB æŸ¥è¯¢éœ€åŠ  userIdï¼š12 å¤„** â€” L40, L51, L125, L287, L347, L379, L386, L387, L394, L467, L475, L484ï¼ˆå…¨éƒ¨åœ¨ batchTaskRunner.tsï¼‰

**é…ç½®è¯»å–éœ€åŠ  userIdï¼š6 å¤„** â€” L145, L146, L147, L309, L310, L311ï¼ˆå…¨éƒ¨åœ¨ batchTaskRunner.tsï¼‰

**GDrive è°ƒç”¨éœ€åŠ  userIdï¼š1 å¤„** â€” batchExecutor.ts L277ï¼ˆuploadBinaryToGoogleDriveï¼‰

**å†…å­˜çŠ¶æ€éœ€åŠ  userIdï¼š3 ä¸ª** â€” `_runningBatchCount`(L15), `_cancelSignals`(L18), `_retryLocks`(L263)

#### â‘§ server/systemCheck.tsï¼ˆ585 è¡Œï¼‰â€” 8 é¡¹

**å‡½æ•°ç­¾åéœ€åŠ  userIdï¼š1 ä¸ª** â€” `runSystemCheck()`ï¼ˆL509ï¼‰

**systemConfig è¯»å–éœ€æ”¹ä¸º user_configï¼š4 å¤„** â€” L36, L59, L479, L538

**googleAuth è°ƒç”¨éœ€ä¼  userIdï¼š3 å¤„** â€” L306ï¼ˆisAuthorizedï¼‰, L308ï¼ˆgetValidTokenï¼‰, L386ï¼ˆgetValidTokenï¼‰

#### â‘¨ server/logger.tsï¼ˆ542 è¡Œï¼‰â€” 12 é¡¹

**å‡½æ•°ç­¾åéœ€åŠ  userIdï¼š5 ä¸ª**

| # | å‡½æ•° | è¡Œå· |
|---|------|------|
| 1 | `createLogSession(studentName, config, ...)` | 98 |
| 2 | `endLogSession(log)` | 258 |
| 3 | `getLatestLogPath()` | 391 |
| 4 | `getLatestLogPathByStudent(identifier)` | 413 |
| 5 | `listLogFiles()` | 448 |

**å…¨å±€å˜é‡éœ€ userId åŸŸéš”ç¦»ï¼š2 ä¸ª** â€” `LOG_DIR`(L12), `_legacyLog`(L467)

**æ–‡ä»¶ç³»ç»Ÿæ“ä½œæ¶‰åŠå…±äº«è·¯å¾„ï¼š5 å¤„** â€” L16ï¼ˆmkdirï¼‰, L291ï¼ˆwriteFileï¼‰, L393ï¼ˆreaddirï¼‰, L415ï¼ˆreaddirï¼‰, L450ï¼ˆreaddirï¼‰

#### â‘© server/contentStore.tsï¼ˆ44 è¡Œï¼‰â€” 3 é¡¹

**å‡½æ•°éœ€åŠ  userIdï¼š2 ä¸ª** â€” `storeContent`(L29), `retrieveContent`(L39)

**å…¨å±€çŠ¶æ€éœ€ userId åŸŸéš”ç¦»ï¼š1 ä¸ª** â€” `store` Mapï¼ˆL16ï¼‰

#### â‘ª server/core/aiClient.tsï¼ˆ367 è¡Œï¼‰â€” 5 é¡¹

**å‡½æ•°ç­¾åéœ€åŠ  userIdï¼š2 ä¸ª** â€” `getAPIConfig()`(L79), `invokeAIStream()`(L134)

**æ–°å¢å‡½æ•°ï¼š1 ä¸ª** â€” `getUserConfigValue(userId, key)` â€” æ›¿ä»£ `getConfigValue` ç”¨äºç”¨æˆ·çº§é…ç½®

**DB æŸ¥è¯¢éœ€æ–°å¢ user_config è¯»å–ï¼š1 å¤„** â€” æ–°å¢æŸ¥è¯¢ï¼ˆåŸºäº L65 æ¨¡å¼ï¼‰

**DEFAULT_CONFIG éœ€æ”¯æŒ per-user è¦†ç›–çš„ keyï¼š12 ä¸ª** â€” apiModel, apiKey, apiUrl, currentYear, roadmap, roadmapClass, driveBasePath, classStoragePath, maxTokens, batchFilePrefix, batchStoragePath, batchConcurrency

#### â‘« server/routers.tsï¼ˆ2773 è¡Œï¼‰â€” è·¯ç”±å±‚

**tRPC è·¯ç”±éœ€ä¼  userIdï¼š72 ä¸ª**ï¼ˆå…¨éƒ¨ protectedProcedure è·¯ç”±ï¼Œé™¤ auth.me å’Œ auth.logoutï¼‰

æŒ‰å­è·¯ç”±åˆ†ç»„ï¼š
- config.*ï¼š5 ä¸ªè·¯ç”±
- feedback.*ï¼ˆ1v1 ç”Ÿæˆï¼‰ï¼š6 ä¸ª
- feedback.*ï¼ˆéªŒè¯/æ—¥å¿—ï¼‰ï¼š5 ä¸ª
- feedback.*ï¼ˆGoogle Authï¼‰ï¼š4 ä¸ª
- feedback.*ï¼ˆå°ç­è¯¾ï¼‰ï¼š6 ä¸ª
- localFile.*ï¼š3 ä¸ª
- bgTask.*ï¼š7 ä¸ªï¼ˆå« submit, status, history, feedbackContent, extractionContent, inputMaterials, cancelï¼‰
- batchTask.*ï¼š5 ä¸ªï¼ˆsubmit, history, items, retryItem, cancelï¼‰
- calculate.computeï¼š1 ä¸ª
- homework.*ï¼š21 ä¸ªï¼ˆ18 + 3 backupï¼‰
- correction.*ï¼š9 ä¸ª

**è·¯ç”±å†…ç›´æ¥ getConfig() è°ƒç”¨ï¼š88 å¤„**ï¼ˆéœ€æ”¹ä¸º getUserConfigValue(userId, key)ï¼‰

**è·¯ç”±å†…ç›´æ¥ GDrive è°ƒç”¨ï¼š14 å¤„**ï¼ˆuploadToGoogleDrive, uploadBinaryToGoogleDrive, verifyAllFiles, getValidToken, readFileFromGoogleDrive, searchFileInGoogleDriveï¼‰

**è·¯ç”±å†… fire-and-forget autoBackupToGDrive()ï¼š6 å¤„** â€” L2567, L2574, L2622, L2634, L2647, L2656

**è·¯ç”±å†…ç›´æ¥ DB æŸ¥è¯¢ï¼ˆbackgroundTasks/batchTasksï¼‰ï¼š14 å¤„**ï¼ˆbgTask.status, history, feedbackContent, extractionContent, inputMaterials, cancel + batchTask.submit, history, items, cancelï¼‰

#### â‘¬ server/classStreamRoutes.tsï¼ˆ1592 è¡Œï¼‰â€” SSE å±‚

**SSE ç«¯ç‚¹éœ€ä¼  userIdï¼š10 ä¸ª**

| # | ç«¯ç‚¹ | è¡Œå· |
|---|------|------|
| 1 | GET `/api/feedback-content/:id` | 75 |
| 2 | POST `/api/class-feedback-stream` | 85 |
| 3 | POST `/api/feedback-stream` | 301 |
| 4 | POST `/api/review-stream` | 570 |
| 5 | POST `/api/test-stream` | 759 |
| 6 | POST `/api/extraction-stream` | 912 |
| 7 | POST `/api/class-review-stream` | 1093 |
| 8 | POST `/api/class-test-stream` | 1292 |
| 9 | POST `/api/class-extraction-stream` | 1428 |
| 10 | GET `/api/download-drive-file` | 1550 |

**getConfig() è°ƒç”¨ï¼š45 å¤„**ï¼ˆåˆ†å¸ƒåœ¨ 8 ä¸ª SSE ç«¯ç‚¹å†…ï¼‰

**GDrive è°ƒç”¨ï¼š8 å¤„** â€” L457, L691, L854, L1006, L1223, L1380, L1517, L1569

#### â‘­ server/batch/batchRoutes.tsï¼ˆ1000+ è¡Œï¼‰â€” Express å±‚

**ç«¯ç‚¹éœ€ä¼  userIdï¼š5 ä¸ª** â€” POST /stop, GET /status/:id, POST /generate-stream, POST /retry-task, POST /upload-files

**GDrive è°ƒç”¨ï¼š3 å¤„** â€” L414ï¼ˆensureFolderExistsï¼‰, L802ï¼ˆuploadBinaryï¼‰, L1277ï¼ˆuploadBinaryï¼‰

**å†…å­˜çŠ¶æ€éœ€ userIdï¼š1 ä¸ª** â€” `activeBatches` Mapï¼ˆL52, 7 ä¸ªè®¿é—®ç‚¹ï¼‰

#### â‘® server/_core/oauth.tsï¼ˆ90 è¡Œï¼‰â€” 1 é¡¹

**Google OAuth å›è°ƒéœ€ä» state æå– userIdï¼š1 å¤„** â€” L34ï¼ˆ`googleAuth.handleCallback(code)` â†’ `googleAuth.handleCallback(code, userId)`ï¼‰

#### â‘¯ server/_core/trpc.tsï¼ˆ55 è¡Œï¼‰â€” 1 é¡¹

**ä¸­é—´ä»¶å¢å¼ºï¼š1 å¤„** â€” `requireUser` ä¸­é—´ä»¶åŠ  `ctx.userId = ctx.user.id`ï¼ˆL29-33ï¼‰

#### â‘° å‰ç«¯æ–‡ä»¶ â€” 9 å¤„ï¼ˆ3 æ–‡ä»¶ï¼‰

| æ–‡ä»¶ | localStorage key | ç«™ç‚¹æ•° | ä¼˜å…ˆçº§ |
|------|-----------------|--------|--------|
| `client/src/pages/Home.tsx` | `STUDENT_LESSON_STORAGE_KEY` | 5 | **é«˜**ï¼ˆå«å­¦ç”Ÿæ•°æ®ï¼‰ |
| `client/src/contexts/ThemeContext.tsx` | `"theme"` | 2 | ä½ï¼ˆçº¯å¤–è§‚ï¼‰ |
| `client/src/components/DashboardLayout.tsx` | `SIDEBAR_WIDTH_KEY` | 2 | ä½ï¼ˆçº¯å¤–è§‚ï¼‰ |

### 19.3 ç²¾ç¡®æ€»è®¡å¯¹ç…§è¡¨ï¼ˆæ›¿ä»£å†å²è¿‘ä¼¼å€¼ï¼‰

| ç±»åˆ« | ç¬¬ä¸€è½®(Â§9) | ç¬¬äºŒè½®(Â§12) | ç¬¬ä¸‰è½®(Â§16) | **æœ€ç»ˆç²¾ç¡®å€¼(Â§19)** |
|------|-----------|------------|------------|-------------------|
| å‡½æ•°ç­¾å | 50+ | 60+ | 65+ | **70** |
| DB æŸ¥è¯¢ | 60+ | 65+ | 65+ | **81** |
| é…ç½®è¯»å– | 80+ | 80+ | 80+ | **160** |
| GDrive/Auth è°ƒç”¨ | 20+ | 20+ | 20+ | **43** |
| å†…å­˜çŠ¶æ€ | â€” | â€” | â€” | **12** |
| è·¯ç”±/ç«¯ç‚¹ | 74+15=89 | 89 | 89 | **88**ï¼ˆç²¾ç¡®å»é‡ï¼‰ |
| Schema/DDL | 8 | 10 | 17 | **12**ï¼ˆçº¯ schema å˜æ›´ï¼Œä¸å«ç´¢å¼•/å›æ»šè„šæœ¬ï¼‰ |
| å‰ç«¯ | 3 æ–‡ä»¶ | 3 æ–‡ä»¶ | 3 æ–‡ä»¶ | **3 æ–‡ä»¶ 9 å¤„** |

### 19.4 å•æ–‡ä»¶æ”¹åŠ¨é‡æ’å

| æ’å | æ–‡ä»¶ | æ”¹åŠ¨é¡¹æ€»æ•° | å…³é”®æ”¹åŠ¨ |
|------|------|-----------|---------|
| 1 | routers.ts | ~117 | 72 è·¯ç”± + 88 getConfig + 14 GDrive + 14 DB + 6 fire-and-forget |
| 2 | homeworkManager.ts | 69 | 22 å‡½æ•° + 39 DB + 5 é…ç½® + 2 fire-and-forget + 1 GDrive |
| 3 | backgroundTaskRunner.ts | 60 | 10 å‡½æ•° + 6 DB + 13 é…ç½® + 13 GDrive + 14 æ—¥å¿— + 3 å†…å­˜ + 1 DDL |
| 4 | classStreamRoutes.ts | 63 | 10 ç«¯ç‚¹ + 45 getConfig + 8 GDrive |
| 5 | batchTaskRunner.ts+Executor | 29 | 7 å‡½æ•° + 12 DB + 6 é…ç½® + 1 GDrive + 3 å†…å­˜ |
| 6 | correctionRunner.ts | 24 | 7 å‡½æ•° + 11 DB + 3 é…ç½® + 2 è·¨æ¨¡å— + 1 DDL |
| 7 | googleAuth.ts | 15 | 6 å‡½æ•° + 8 DB + 1 å†…å­˜ |
| 8 | gdrive.ts | 15 | 8 å‡½æ•° + 6 å†…éƒ¨è°ƒç”¨ + 1 å†…å­˜ |
| 9 | logger.ts | 12 | 5 å‡½æ•° + 2 å…¨å±€å˜é‡ + 5 FS æ“ä½œ |
| 10 | batchRoutes.ts | 9 | 5 ç«¯ç‚¹ + 3 GDrive + 1 å†…å­˜ |
| 11 | systemCheck.ts | 8 | 1 å‡½æ•° + 4 é…ç½® + 3 Auth è°ƒç”¨ |
| 12 | schema.ts | 8 | 6 è¡¨åŠ åˆ— + 1 æ–°è¡¨ + 1 çº¦æŸ |
| 13 | aiClient.ts | 5 | 2 å‡½æ•°æ”¹ + 1 æ–°å‡½æ•° + 1 DB + 12 key |
| 14 | contentStore.ts | 3 | 2 å‡½æ•° + 1 å…¨å±€ Map |
| 15 | _core/oauth.ts | 1 | OAuth å›è°ƒä¼  userId |
| 16 | _core/trpc.ts | 1 | ä¸­é—´ä»¶å¢å¼º |
| 17 | å‰ç«¯ 3 æ–‡ä»¶ | 9 | 3 ä¸ª localStorage key |

### 19.5 Grep æœºæ¢°æ ¸å¯¹ï¼ˆç²¾ç¡®æ•°é‡ä¿®æ­£ï¼‰

| ç±»åˆ« | Â§19.1 ä¼°å€¼ | Grep å®æµ‹ | å·®å¼‚åŸå›  | **æœ€ç»ˆç¡®è®¤å€¼** |
|------|-----------|----------|---------|--------------|
| DB æ“ä½œï¼ˆSELECT + INSERT/UPDATE/DELETEï¼‰ | 81 | **92**ï¼ˆ33 SELECT + 59 å†™æ“ä½œï¼‰ | homeworkManager æ¼è®¡ 11 å¤„ UPDATE/DELETE | **92** |
| getConfig/getConfigValue/getAPIConfig | 160 | **155**ï¼ˆå«å®šä¹‰è¡Œå’Œ re-exportï¼‰ | æ‰£é™¤ ~5 å¤„å®šä¹‰/re-export â†’ ~150 å®é™…è°ƒç”¨ | **155 raw / ~150 call sites** |
| GDrive/Auth å‡½æ•°è°ƒç”¨ | 43 | **70 raw**ï¼ˆå« gdrive.ts 22 å¤„å®šä¹‰+å†…éƒ¨ã€googleAuth.ts 4 å¤„å®šä¹‰ã€1 æµ‹è¯•ï¼‰ | 70 - 27 å®šä¹‰/å†…éƒ¨/æµ‹è¯• = 43 å¤–éƒ¨è°ƒç”¨ | **43**ï¼ˆç²¾ç¡®å»åˆï¼‰ |
| protectedProcedure è·¯ç”± | 72 | **73** | 73 - 1(auth.me ä¸éœ€ä¼  userId) = 72 | **72**ï¼ˆç²¾ç¡®å»åˆï¼‰ |

---

## äºŒåã€å†…å­˜ç«æ€æ·±åº¦åˆ†æï¼ˆç¬¬å››è½®ï¼šæ¶ˆç­ 5% é£é™©ï¼‰

> ä»¥ä¸‹å¯¹ 12 ä¸ªå†…å­˜çŠ¶æ€å˜é‡é€ä¸€å»ºæ¨¡ç«æ€åœºæ™¯ï¼Œç»™å‡ºç²¾ç¡®ä¿®å¤æ–¹æ¡ˆã€‚

### 20.1 ç«æ€ä¸¥é‡åº¦æ€»è§ˆ

| # | å˜é‡ | æ–‡ä»¶:è¡Œ | ç«æ€åœºæ™¯ | å¤±è´¥æ¨¡å¼ | ä¸¥é‡åº¦ |
|---|------|---------|---------|---------|--------|
| 1 | `refreshPromise` | googleAuth.ts:113 | ç”¨æˆ·Bæ‹¿åˆ°ç”¨æˆ·Açš„token | **è·¨ç”¨æˆ· Drive è®¿é—®** | **è‡´å‘½** |
| 2 | `pendingFolderOps` | gdrive.ts:87 | å…±äº«æ–‡ä»¶å¤¹IDè·¨ç”¨æˆ· | æ–‡ä»¶ä¼ åˆ°é”™è¯¯Drive | é«˜ |
| 3 | `_runningTaskCount` | backgroundTaskRunner.ts:55 | ä¸€ä¸ªç”¨æˆ·å æ»¡å…¨éƒ¨æ§½ä½ | å…¶ä»–ç”¨æˆ·è¢«é¥¿æ­» | é«˜ |
| 4 | `_cancelSignals` | backgroundTaskRunner.ts:58 | æ— å½’å±æ ¡éªŒ | è¶Šæƒå–æ¶ˆä»–äººä»»åŠ¡ | é«˜ |
| 5 | `MAX_CONCURRENT_TASKS` | backgroundTaskRunner.ts:54 | å…¨å±€é™åˆ¶æ— ç”¨æˆ·ç»´åº¦ | èµ„æºåˆ†é…ä¸å…¬ | ä¸­ |
| 6 | `_runningBatchCount` | batchTaskRunner.ts:15 | ä¸€ä¸ªæ‰¹é‡é”å…¨å±€ | å…¶ä»–ç”¨æˆ·åŠŸèƒ½é”æ­» | é«˜ |
| 7 | `_cancelSignals` | batchTaskRunner.ts:18 | æ— å½’å±æ ¡éªŒ | è¶Šæƒå–æ¶ˆä»–äººæ‰¹é‡ | é«˜ |
| 8 | `_retryLocks` | batchTaskRunner.ts:263 | æ— å½’å±æ ¡éªŒ | è¶Šæƒé‡è¯•ä»–äººä»»åŠ¡ | é«˜ |
| 9 | `activeBatches` | batchRoutes.ts:52 | status/stop æ— å½’å±æ ¡éªŒ | **æ–‡ä»¶URLæ³„éœ² + è¶Šæƒåœæ­¢** | **è‡´å‘½** |
| 10 | `LOG_DIR` | logger.ts:12 | æ‰€æœ‰ç”¨æˆ·å…±äº«ä¸€ä¸ªæ—¥å¿—ç›®å½• | **æ—¥å¿—æ•°æ®æ³„éœ²** | **è‡´å‘½** |
| 11 | `_legacyLog` | logger.ts:467 | å•ä¾‹è¢«å¹¶å‘ç”¨æˆ·è¦†å†™ | **æ—¥å¿—ä¸²ç”¨æˆ· + æ•°æ®ä¸¢å¤±** | **è‡´å‘½** |
| 12 | `store` | contentStore.ts:16 | å…±äº«å®¹é‡ä¸Šé™ + æ— å½’å±æ ¡éªŒ | ç¼“å­˜é¥¥é¥¿ + ä½é£é™©æ³„éœ² | ä¸­ |

### 20.2 é€å˜é‡ç²¾ç¡®ä¿®å¤æ–¹æ¡ˆ

#### è‡´å‘½-1: `refreshPromise`ï¼ˆgoogleAuth.ts:113ï¼‰

**ç°çŠ¶ï¼š**
```
let refreshPromise: Promise<string | null> | null = null;
// æ‰€æœ‰ç”¨æˆ·å…±äº«ä¸€ä¸ª Promiseï¼Œç”¨æˆ·Bä¼šæ‹¿åˆ°ç”¨æˆ·Açš„ access_token
```

**ä¿®å¤ï¼š**
```
const refreshPromises = new Map<number, Promise<string | null>>();

export async function getValidToken(userId: number): Promise<string | null> {
  const existing = refreshPromises.get(userId);
  if (existing) return existing;
  const promise = _getValidToken(userId).finally(() => refreshPromises.delete(userId));
  refreshPromises.set(userId, promise);
  return promise;
}
```

**å†…å­˜å®‰å…¨ï¼š** `.finally()` ç¡®ä¿ entry ä¸€å®šè¢«åˆ é™¤ã€‚æœ€å¤§ Map å¤§å° = åŒæ—¶åˆ·æ–° token çš„ç”¨æˆ·æ•°ã€‚æ— æ³„æ¼é£é™©ã€‚

#### è‡´å‘½-2: `activeBatches`ï¼ˆbatchRoutes.ts:52ï¼‰

**ç°çŠ¶ï¼š**
```
const activeBatches = new Map<string, BatchStatus>();
// GET /status/:batchId å’Œ POST /stop æ— å½’å±æ ¡éªŒ
// batchId æ ¼å¼ä¸º YYYYMMDD-HHmmssï¼Œé«˜åº¦å¯çŒœæµ‹
```

**ä¿®å¤ï¼š** BatchStatus ç»“æ„åŠ  `userId` å­—æ®µï¼Œæ‰€æœ‰è®¿é—®ç‚¹åŠ å½’å±æ ¡éªŒï¼š
- set æ—¶ï¼š`batchStatus.userId = req.userId`
- get æ—¶ï¼š`if (batch.userId !== req.userId) return 404`
- stop æ—¶ï¼š`if (batch.userId !== req.userId) return 403`

**7 ä¸ªè®¿é—®ç‚¹**å…¨éƒ¨éœ€æ”¹ï¼šL232, L271, L386, L831, L859, L915, L959

#### è‡´å‘½-3: `LOG_DIR`ï¼ˆlogger.ts:12ï¼‰

**ç°çŠ¶ï¼š**
```
const LOG_DIR = path.join(process.cwd(), 'logs');
// listLogFiles() è¿”å›æ‰€æœ‰ç”¨æˆ·çš„æ—¥å¿—ï¼Œå«å­¦ç”Ÿå§“åå’Œè¯¾ç¨‹å†…å®¹
```

**ä¿®å¤ï¼š** æ”¹ä¸º per-user ç›®å½•ï¼š
```
function getUserLogDir(userId: number): string {
  const dir = path.join(process.cwd(), 'logs', `user_${userId}`);
  if (!fs.existsSync(dir)) fs.mkdirSync(dir, { recursive: true });
  return dir;
}
```

**é™„åŠ ï¼š** å¢åŠ æ—¥å¿—è½®è½¬ï¼ˆåˆ é™¤ >7 å¤©æ–‡ä»¶ï¼‰ï¼Œå¢åŠ ç”¨æˆ·åˆ é™¤é’©å­æ¸…ç†æ—¥å¿—ã€‚

#### è‡´å‘½-4: `_legacyLog`ï¼ˆlogger.ts:467ï¼‰

**ç°çŠ¶ï¼š**
```
let _legacyLog: GenerationLog | null = null;
// å¹¶å‘ç”¨æˆ·è¦†å†™åŒä¸€ä¸ªå•ä¾‹ï¼Œæ—¥å¿—ä¸²ç”¨æˆ·
```

**ä¿®å¤ï¼š** **ç›´æ¥åˆ é™¤è¿™æ®µé—ç•™ä»£ç ã€‚** ç» grep ç¡®è®¤æ— å¤–éƒ¨è°ƒç”¨è€…â€”â€”æ‰€æœ‰å®é™…ä½¿ç”¨éƒ½å·²é€šè¿‡ `createLogSession()` è¿”å›ç‹¬ç«‹çš„ log å¯¹è±¡ã€‚åˆ é™¤ `_legacyLog`ã€`startLogSession()`ã€`getCurrentLog()`ã€`logger` å¯¼å‡ºå¯¹è±¡ã€‚

#### é«˜-1: `pendingFolderOps`ï¼ˆgdrive.ts:87ï¼‰

**ä¿®å¤ï¼š** key ä» `${folderPath}::${token}` æ”¹ä¸º `${userId}::${folderPath}`ã€‚token æ˜¯æ˜“å˜çš„ï¼ˆåˆ·æ–°åå˜åŒ–ï¼‰ï¼ŒuserId æ˜¯ç¨³å®šçš„ã€‚

#### é«˜-2/3: `_runningTaskCount`ï¼ˆbackgroundTaskRunner.ts:55ï¼‰+ `_runningBatchCount`ï¼ˆbatchTaskRunner.ts:15ï¼‰

**ä¿®å¤ï¼š** åŒå±‚é™åˆ¶â€”â€”per-user + globalï¼š
```
const _runningTaskCounts = new Map<number, number>();  // userId â†’ count
const PER_USER_MAX = 2;
const GLOBAL_MAX = 6;
let _globalCount = 0;
```
å…¥å£æ£€æŸ¥ï¼š`userCount >= PER_USER_MAX || _globalCount >= GLOBAL_MAX` æ—¶æ‹’ç»ã€‚
`.finally()` ä¸­ decrement + æ¸…ç†é›¶è®¡æ•° entryã€‚

#### é«˜-4/5/6: `_cancelSignals`(x2) + `_retryLocks`

**ä¿®å¤ï¼š** Map value ä» `AbortController` æ”¹ä¸º `{ controller: AbortController, userId: number }`ã€‚
cancel/retry æ“ä½œå‰æ ¡éªŒ `entry.userId !== requestingUserId` åˆ™æ‹’ç»ã€‚

#### ä¸­-1: `MAX_CONCURRENT_TASKS` â€” æ‹†ä¸ºåŒå¸¸é‡ï¼ˆPER_USER_MAX + GLOBAL_MAXï¼‰

#### ä¸­-2: `store`ï¼ˆcontentStore.ts:16ï¼‰

**ä¿®å¤ï¼š** StoredContent åŠ  `userId` å­—æ®µï¼Œ`retrieveContent` æ ¡éªŒ `item.userId !== requestingUserId` åˆ™è¿”å› nullã€‚

### 20.3 å†…å­˜æ³„æ¼ / æ¸…ç† / é‡å¯æ€»ç»“

| å˜é‡ | æœ‰ç•Œï¼Ÿ | æ¸…ç†æœºåˆ¶ | é‡å¯æ¢å¤ | ç”¨æˆ·åˆ é™¤æ¸…ç† |
|------|--------|---------|---------|------------|
| refreshPromises | âœ… | `.finally()` åˆ é™¤ | è‡ªåŠ¨å½’é›¶ | æ— éœ€ï¼ˆç¬æ€ï¼‰ |
| pendingFolderOps | âœ… | `finally` å—åˆ é™¤ | è‡ªåŠ¨å½’é›¶ | æ— éœ€ï¼ˆç¬æ€ï¼‰ |
| _runningTaskCounts | âœ… | `.finally()` å‡ & åˆ  | å½’é›¶ + DB æ¢å¤ | è‡ªæ¸…ï¼ˆä»»åŠ¡ç»“æŸåï¼‰ |
| _cancelSignals (x2) | âœ… | `.finally()` åˆ é™¤ | è‡ªåŠ¨å½’é›¶ | è‡ªæ¸…ï¼ˆä»»åŠ¡ç»“æŸåï¼‰ |
| _retryLocks | âœ… | `finally` å—åˆ é™¤ | è‡ªåŠ¨å½’é›¶ | æ— éœ€ï¼ˆç¬æ€ï¼‰ |
| activeBatches | âœ… | 1 åˆ†é’Ÿ setTimeout | è‡ªåŠ¨å½’é›¶ | æœ€å¤šæ®‹ç•™ 1 åˆ†é’Ÿ |
| store | âœ… 500 ä¸Šé™ | TTL 30min + LRU | **å…¨éƒ¨ä¸¢å¤±** | å¯åŠ  purgeByUserId |
| LOG_DIR æ–‡ä»¶ | **âŒ æ— ç•Œ** | **æ— æ¸…ç†** | ç£ç›˜æŒä¹… | **éœ€å¢åŠ åˆ é™¤é’©å­** |

---

## äºŒåä¸€ã€Fire-and-Forget é“¾è·¯è¿½è¸ª + è¿ç§»è¾¹ç•Œåˆ†æ

### 21.1 Fire-and-Forget å…¨é“¾è·¯ userId ç©¿é€åˆ†æ

#### é“¾è·¯-1: processEntryInBackgroundï¼ˆå­¦ç”Ÿç®¡ç†AIå¤„ç†ï¼‰

```
è·¯ç”±å±‚: homework.submitEntry (ctx.user.id å¯ç”¨)
  â†’ submitAndProcessEntry(studentName, rawInput, aiModel)  â† âŒ æ—  userId
    â†’ createEntry(studentName, rawInput, aiModel)  â† âŒ INSERT hw_entries æ—  userId
    â†’ processEntryInBackground(id, studentName, rawInput, aiModel)  â† âŒ fire-and-forget æ—  userId
      â†’ processEntry(studentName, rawInput, aiModel)  â† âŒ getConfigValue æ—  userId
      â†’ db.update(hwEntries).set({parsedContent...})  â† æŒ‰ id æ›´æ–°ï¼ˆå®‰å…¨ï¼Œä½†å»ºè¡¨æ—¶éœ€å« userIdï¼‰
```

**æ–­ç‚¹æ•°ï¼š4 å¤„** â€” submitAndProcessEntryã€createEntryã€processEntryInBackgroundã€processEntry å‡éœ€åŠ  userIdã€‚

**è‡´å‘½å‘ç°ï¼š** åœ¨ `importFromExtraction`â†’`processEntryInBackground` è·¯å¾„ä¸­å­˜åœ¨**åŒé‡ fire-and-forget**ï¼š

```
correctionRunner.ts: processCorrectionInBackground(taskId)  â† fire-and-forget #1
  â†’ importFromExtraction(task.studentName, content)  â† âŒ æ—  userId
    â†’ createEntry(studentName, rawInput)  â† âŒ INSERT æ—  userId
    â†’ processEntryInBackground(id, studentName, rawInput)  â† fire-and-forget #2ï¼ŒuserId å®Œå…¨ä¸¢å¤±
```

**ä¿®å¤ç­–ç•¥ï¼š** userId å¿…é¡»åœ¨**å…¥å£å¤„æ³¨å…¥å¹¶å…¨é“¾ä¼ é€’**ï¼Œä¸èƒ½ä¾èµ–é—­åŒ…ï¼š
1. `submitCorrection(params)` â†’ `submitCorrection(userId, params)`
2. `processCorrectionInBackground(taskId)` â†’ ä» DB è¯»å› `correction_tasks.userId`
3. `importFromExtraction(studentName, content)` â†’ `importFromExtraction(userId, studentName, content)`
4. `processEntryInBackground(id, ...)` â†’ ä» DB è¯»å› `hw_entries.userId`

#### é“¾è·¯-2: autoBackupToGDriveï¼ˆè‡ªåŠ¨å¤‡ä»½åˆ° Google Driveï¼‰

```
è·¯ç”±å±‚ 6 å¤„ fire-and-forget: autoBackupToGDrive()  â† âŒ é›¶å‚æ•°ï¼
  â†’ exportStudentBackup()  â† âŒ è¯»å…¨éƒ¨ç”¨æˆ·çš„å­¦ç”Ÿï¼ˆè·¨ç§Ÿæˆ·æ³„éœ²ï¼‰
  â†’ getConfig("driveBasePath")  â† âŒ è¯»å…¨å±€é…ç½®
  â†’ uploadToGoogleDrive(content, fileName, folderPath)
    â†’ getValidToken()  â† âŒ è¯»å…¨å±€ token
```

**æ–­ç‚¹æ•°ï¼š4 å¤„** â€” autoBackupToGDriveã€exportStudentBackupã€getConfigã€getValidTokenã€‚
**æ­¤é“¾è·¯ userId å®Œå…¨ä¸å­˜åœ¨**ï¼Œæ˜¯å…¨ç³»ç»Ÿæœ€å±é™©çš„ fire-and-forgetã€‚

**ä¿®å¤ï¼š** `autoBackupToGDrive()` â†’ `autoBackupToGDrive(userId)`ï¼Œ6 ä¸ªè°ƒç”¨ç‚¹å…¨éƒ¨ä¼ å…¥ `ctx.user.id`ã€‚

#### é“¾è·¯-3: startBackgroundTaskï¼ˆåå°å¤šæ­¥éª¤ç”Ÿæˆï¼‰

```
è·¯ç”±å±‚: bgTask.submit (ctx.user.id å¯ç”¨)
  â†’ db.insert(backgroundTasks).values({...})  â† âŒ æ—  userId
  â†’ startBackgroundTask(taskId)  â† fire-and-forget
    â†’ runTask(taskId)
      â†’ params = JSON.parse(task.inputParams)  // éƒ¨åˆ†é…ç½®å·²å¿«ç…§ âœ…
      â†’ uploadToGoogleDrive(...)
        â†’ getValidToken()  â† âŒ è¯»å…¨å±€ tokenï¼ˆè¿è¡Œæ—¶è€Œéå¿«ç…§æ—¶ï¼‰
```

**å…³é”®å‘ç°ï¼š** API å¯†é’¥åœ¨æäº¤æ—¶å¿«ç…§åˆ° inputParamsï¼ˆéƒ¨åˆ†ç¼“è§£ï¼‰ï¼Œä½† **Google Drive token åœ¨è¿è¡Œæ—¶è¯»å–**ï¼ˆæœªå¿«ç…§ï¼‰ã€‚å¦‚æœå¦ä¸€ä¸ªç”¨æˆ·åœ¨æ­¤æœŸé—´é‡æ–°æˆæƒ Driveï¼Œå½“å‰ç”¨æˆ·çš„æ–‡ä»¶å¯èƒ½ä¸Šä¼ åˆ°é”™è¯¯çš„ Driveã€‚

**ä¿®å¤ï¼š** background_tasks è¡¨åŠ  userId åˆ—ï¼›runTask ä¸­ `getValidToken(task.userId)` è¯»å–è¯¥ç”¨æˆ·ä¸“å± tokenã€‚

### 21.2 è¿ç§»è„šæœ¬è¾¹ç•Œæƒ…å†µ

| # | è¾¹ç•Œæƒ…å†µ | åæœ | ä¸¥é‡åº¦ | é˜²å¾¡æ–¹æ¡ˆ |
|---|---------|------|--------|---------|
| M1 | æ—  admin ç”¨æˆ·æ—¶è¿è¡Œè¿ç§» | user_id=1 æŒ‡å‘ä¸å­˜åœ¨çš„ç”¨æˆ·ï¼›æœªæ¥æ–°ç”¨æˆ· id=1 ç»§æ‰¿é—ç•™æ•°æ® | **è‡´å‘½** | è¿ç§»å‰æŸ¥è¯¢ `SELECT id FROM users WHERE role='admin' LIMIT 1`ï¼Œæ— ç»“æœåˆ™ **ABORT** |
| M2 | å¤šä¸ª admin ç”¨æˆ· | æ‰€æœ‰æ•°æ®å½’ id=1ï¼ˆæˆ–é¦–ä¸ªadminï¼‰ï¼Œå…¶ä½™ admin èµ·æ­¥ç©ºæ•°æ® | ä½ | å¯æ¥å—ï¼Œåœ¨è¿ç§»æ—¥å¿—ä¸­è®°å½• |
| M3 | è¿ç§»ä¸­é€”æ–­å¼€ï¼ˆéƒ¨åˆ†è¡¨å®Œæˆï¼‰ | Schema ä¸ä¸€è‡´ï¼šéƒ¨åˆ†è¡¨æœ‰ NOT NULL userIdã€éƒ¨åˆ†æ²¡æœ‰ | **è‡´å‘½** | **è¿ç§»è„šæœ¬åŒ…è£¹åœ¨äº‹åŠ¡ä¸­**ï¼ˆMySQL DDL æ— æ³•å›æ»šï¼Ÿæ”¹ä¸ºæ¯æ­¥å¹‚ç­‰ + çŠ¶æ€æ ‡è®°ï¼‰ |
| M4 | åº”ç”¨åœ¨è¿ç§»è¿‡ç¨‹ä¸­å¯åŠ¨ | ensureHwTables å’Œ ALTER TABLE æ­»é” | é«˜ | è¿ç§»è„šæœ¬è®¾ç½® lock flagï¼ˆå¦‚ system_config ä¸­å†™å…¥ `_migration_in_progress=true`ï¼‰ï¼Œåº”ç”¨å¯åŠ¨æ—¶æ£€æŸ¥ |
| M5 | åå°ä»»åŠ¡åœ¨è¿ç§»è¿‡ç¨‹ä¸­è¿è¡Œ | ALTER TABLE é”ç­‰å¾…è¶…æ—¶ï¼Œä»»åŠ¡å¤±è´¥ | ä¸­ | è¿ç§»å‰è®¾ç½®ç»´æŠ¤æ¨¡å¼ï¼Œæ‹’ç»æ–°ä»»åŠ¡æäº¤ |
| M6 | è¿ç§»è„šæœ¬è¿è¡Œä¸¤æ¬¡ | `ADD COLUMN user_id` æŠ¥ Duplicate column é”™è¯¯ | é«˜ | æ¯æ­¥ä½¿ç”¨ `IF NOT EXISTS` æˆ– try-catch å¿½ç•¥é‡å¤é”™è¯¯ |
| M7 | CREATE TABLE IF NOT EXISTS åœ¨è¿ç§»åæ‰§è¡Œ | ä¸å½±å“ï¼ˆå¯¹å·²å­˜åœ¨è¡¨ä¸º no-opï¼‰ | ä½ | ä½†åº”æ›´æ–° SQL åŒ…å« userId åˆ—ï¼Œé˜²æ­¢è¡¨è¢«æ„å¤–åˆ é™¤åé‡å»ºç¼ºå¤± userId |

**M3 è¯¦ç»†æ–¹æ¡ˆ**ï¼ˆMySQL DDL ä¸å¯å›æ»šçš„è§£å†³æ–¹æ¡ˆï¼‰ï¼š
```
1. åœ¨ system_config å†™å…¥ _migration_version = 0
2. æ‰§è¡Œ ADD COLUMN user_id (nullable) â†’ æˆåŠŸåå†™ _migration_version = 1
3. UPDATE SET user_id = admin_id â†’ æˆåŠŸåå†™ _migration_version = 2
4. MODIFY COLUMN user_id NOT NULL â†’ æˆåŠŸåå†™ _migration_version = 3
5. DROP INDEX + ADD UNIQUE INDEX â†’ æˆåŠŸåå†™ _migration_version = 4
...
æ¯æ­¥å¼€å¤´æ£€æŸ¥ _migration_versionï¼Œè·³è¿‡å·²å®Œæˆæ­¥éª¤ â†’ å®ç°å¹‚ç­‰
```

### 21.3 å¹¶å‘æ“ä½œè¾¹ç•Œæƒ…å†µ

| # | åœºæ™¯ | ç»“æœ | ä¸¥é‡åº¦ | é˜²å¾¡ |
|---|------|------|--------|------|
| C1 | ä¸¤ç”¨æˆ·åŒæ—¶ addStudent("å¼ ä¸‰") | UNIQUE(userId, name) å„è‡ªæˆåŠŸï¼ˆéš”ç¦»ï¼‰ | ä½ | çº¦æŸè‡ªåŠ¨ä¿è¯ |
| C2 | ç”¨æˆ·A confirmEntries([1,2,3]) + ç”¨æˆ·B deleteEntry(2) | è¿ç§»å‰ï¼šB å¯åˆ  A çš„æ¡ç›®ï¼ˆIDORï¼‰ï¼›è¿ç§»åï¼šWHERE userId é˜»æ­¢ | **é«˜** | deleteEntry/retryEntry/confirmEntries å¿…é¡»åŠ  `AND userId=?` |
| C3 | autoBackupToGDrive + importStudentBackup å¹¶å‘ | å¤‡ä»½ä¸ºæ—¶é—´ç‚¹å¿«ç…§ï¼ŒMySQL REPEATABLE READ ä¿è¯ä¸€è‡´æ€§ | ä½ | æ— éœ€é¢å¤–å¤„ç† |
| C4 | ä¸¤ç”¨æˆ·åŒæ—¶è§¦å‘ token åˆ·æ–° | ä¿®å¤å Map éš”ç¦»ï¼Œå„è‡ªç‹¬ç«‹åˆ·æ–° | ä½ | refreshPromises Map ä¿è¯ |
| C5 | ç”¨æˆ·B é€šè¿‡ batchId å–æ¶ˆç”¨æˆ·A çš„æ‰¹é‡ä»»åŠ¡ | è¿ç§»å‰ï¼šæˆåŠŸï¼ˆIDORï¼‰ï¼›è¿ç§»åéœ€åŠ å½’å±æ ¡éªŒ | **é«˜** | cancel å‡½æ•°åŠ  `entry.userId !== requestingUserId` æ£€æŸ¥ |
| C6 | handleCallback ä¸­ `db.delete(googleTokens)` æ—  WHERE | ä¸€ä¸ªç”¨æˆ·æˆæƒåˆ é™¤æ‰€æœ‰ç”¨æˆ·çš„ token | **è‡´å‘½** | æ”¹ä¸º `.where(eq(googleTokens.userId, userId))` |
| C7 | disconnect() ä¸­ `db.delete(googleTokens)` æ—  WHERE | åŒ C6 | **è‡´å‘½** | åŒ C6 |
| C8 | bgTask.history æ—  userId è¿‡æ»¤ | è¿”å›æ‰€æœ‰ç”¨æˆ·çš„ä»»åŠ¡å†å²ï¼ˆå«å­¦ç”Ÿå§“åå’Œå†…å®¹ï¼‰ | **é«˜** | åŠ  `WHERE userId = ?` |

### 21.4 å…¨éƒ¨æ–°å‘ç°æ±‡æ€»

æœ¬è½®åˆ†æ**æ–°å‘ç° 36 ä¸ªå…·ä½“é—®é¢˜**ï¼š

| ä¸¥é‡åº¦ | æ•°é‡ | å…³é”®é—®é¢˜ |
|--------|------|---------|
| **è‡´å‘½** | 8 | refreshPromise è·¨ç”¨æˆ·ã€activeBatches æ³„éœ²ã€LOG_DIR æ³„éœ²ã€_legacyLog ä¸²ç”¨æˆ·ã€autoBackupToGDrive é›¶å‚æ•°ã€handleCallback/disconnect æ—  WHERE åˆ é™¤ã€è¿ç§»æ— äº‹åŠ¡ |
| **é«˜** | 14 | cancelSignals IDOR(x2)ã€retryLocks IDORã€ä»»åŠ¡é¥¥é¥¿(x2)ã€åŒé‡ fire-and-forget é“¾ã€å…¨å±€ token è¿è¡Œæ—¶è¯»å–ã€è¿ç§»æ—  admin ç”¨æˆ·ã€è¿ç§»éå¹‚ç­‰ã€bgTask.history æ³„éœ²ã€deleteEntry/retryEntry IDOR |
| **ä¸­** | 4 | MAX_CONCURRENT å…¬å¹³æ€§ã€contentStore å®¹é‡å…¬å¹³ã€åå°ä»»åŠ¡è¿ç§»è¶…æ—¶ã€CREATE TABLE å®šä¹‰ä¸å« userId |
| **ä½** | 4 | å¤š admin è¿ç§»ã€addStudent å¹¶å‘å®‰å…¨ã€å¤‡ä»½å¹¶å‘å®‰å…¨ã€token åˆ·æ–°å¹¶å‘å®‰å…¨ |

---

## äºŒåäºŒã€ä¿®æ­£åæœ€ç»ˆç»Ÿè®¡

| ç±»åˆ« | Â§19 å€¼ | **ä¿®æ­£æœ€ç»ˆå€¼** | ä¿®æ­£è¯´æ˜ |
|------|--------|--------------|---------|
| å‡½æ•°ç­¾åéœ€æ”¹ | 70 | **70** | ä¸å˜ |
| DB æ“ä½œéœ€æ”¹ | 81 | **92** | Grep å®æµ‹ 33 SELECT + 59 å†™æ“ä½œ |
| é…ç½®è¯»å–éœ€æ”¹ | 160 | **155** | Grep å®æµ‹ï¼ˆå«å®šä¹‰è¡Œï¼‰ |
| GDrive/Auth è°ƒç”¨éœ€æ”¹ | 43 | **43** | Grep å®æµ‹ç¡®è®¤ |
| å†…å­˜çŠ¶æ€éœ€æ”¹ | 12 | **12** | ä¸å˜ï¼ˆå…¨éƒ¨å·²å»ºæ¨¡ç«æ€ï¼‰ |
| è·¯ç”±/ç«¯ç‚¹éœ€æ”¹ | 88 | **88** | protectedProcedure 73 - 1(auth.me) = 72 + 10 SSE + 5 Express + 1 OAuth = 88 |
| æ–°å¢ï¼šå†…å­˜ç«æ€ä¿®å¤é¡¹ | â€” | **12** | 4 è‡´å‘½ + 6 é«˜ + 2 ä¸­ |
| æ–°å¢ï¼šfire-and-forget æ–­ç‚¹ | â€” | **12** | 3 æ¡é“¾è·¯ä¸­çš„ userId æ–­è£‚ç‚¹ |
| æ–°å¢ï¼šè¿ç§»é˜²å¾¡æªæ–½ | â€” | **7** | M1-M7 å…¨éƒ¨éœ€è¦é˜²å¾¡æ–¹æ¡ˆ |
| æ–°å¢ï¼šå¹¶å‘ IDOR ä¿®å¤ | â€” | **8** | C1-C8 |

### ä¿®æ­£åçš„ä¿¡å¿ƒè¯„ä¼°

| æªæ–½ | é£é™©è¦†ç›– | ä¿¡å¿ƒæå‡ |
|------|---------|---------|
| Â§19 ç²¾ç¡®ç»Ÿè®¡ï¼ˆè¡Œå·çº§ï¼‰ | æ¼æ”¹é£é™© | åŸ 72% |
| Â§20 å†…å­˜ç«æ€å…¨éƒ¨å»ºæ¨¡+ä¿®å¤æ–¹æ¡ˆ | ç«æ€ bug | +8% |
| Â§21 fire-and-forget é“¾è·¯è¿½è¸ª | é™é»˜æ•°æ®æ³„éœ² | +5% |
| Â§21.2 è¿ç§»å¹‚ç­‰æ–¹æ¡ˆ | è¿ç§»å¤±è´¥ | +3% |
| Â§21.3 IDOR å¹¶å‘åˆ†æ | è¶Šæƒæ“ä½œ | +2% |
| Grep æœºæ¢°æ ¸å¯¹æ•°é‡ä¿®æ­£ | ç»Ÿè®¡åå·® | +2% |
| **ç´¯è®¡** | | **92%** |

**å‰©ä½™ 8% é£é™©æ¥æºï¼š**
- å®é™…ç¼–ç æ—¶çš„æ‰‹è¯¯ï¼ˆéœ€ code reviewï¼‰
- å‰ç«¯åˆ°åç«¯çš„å®Œæ•´ç«¯åˆ°ç«¯è·¯å¾„å¯èƒ½æœ‰æœªè¦†ç›–çš„è¾¹ç¼˜ API è°ƒç”¨
- ç¬¬ä¸‰æ–¹åº“è¡Œä¸ºå·®å¼‚ï¼ˆå¦‚ Drizzle ORM åœ¨ ALTER TABLE åçš„ç±»å‹æ¨æ–­åˆ·æ–°ï¼‰
- ç”Ÿäº§ç¯å¢ƒç‰¹æœ‰é—®é¢˜ï¼ˆç½‘ç»œå»¶è¿Ÿã€æ•°æ®åº“è¿æ¥æ± ã€CDN ç¼“å­˜ï¼‰

---

## äºŒåä¸‰ã€æœ€ç»ˆå·®è·å®¡è®¡ï¼ˆÂ§23ï¼‰

> å¯¹å…¨éƒ¨ 63 ä¸ª `server/**/*.ts` æ–‡ä»¶ + å‰ç«¯ + shared + drizzle è¿›è¡Œæœ€ç»ˆæ‰«æï¼Œ
> æ‰¾å‡º Â§1-Â§22 å°šæœªè¦†ç›–çš„é—æ¼é¡¹ã€‚

### 23.1 ã€å¿…é¡»è¡¥å……ã€‘F1ï¼šAPI å“åº”ä¸­ userId æ³„éœ²

**é—®é¢˜**ï¼šæ·»åŠ  `userId` åˆ—åï¼Œæ‰€æœ‰ `db.select().from(table)` é»˜è®¤è¿”å›å…¨éƒ¨åˆ—ï¼ˆå« userIdï¼‰ï¼Œ
tRPC è·¯ç”±ç›´æ¥å°†æŸ¥è¯¢ç»“æœè¿”ç»™å‰ç«¯ï¼Œé€ æˆ userId ä¿¡æ¯æ³„éœ²ã€‚

**å½±å“èŒƒå›´**ï¼ˆç²¾ç¡® Grepï¼‰ï¼šå…± **18 å¤„** `db.select().from()` æŸ¥è¯¢æ¶‰åŠå°†åŠ  userId çš„è¡¨ï¼š

| è¡¨ | æ–‡ä»¶ | è¡Œå· | è¯´æ˜ |
|----|------|------|------|
| hwStudents | homeworkManager.ts | L103, L104, L113, L572, L713, L870 | listStudents / getByName / export |
| hwEntries | homeworkManager.ts | L387, L388, L396, L415, L432, L496, L529 | listEntries / getEntry / confirm |
| correctionTasks | correctionRunner.ts | L245 | listCorrectionTasks |
| backgroundTasks | backgroundTaskRunner.ts | L225 | getTask |
| backgroundTasks | routers.ts | L1988 | getTaskï¼ˆtRPC ç›´è¿”ï¼‰ |
| batchTasks | batchTaskRunner.ts | L125, L287 | getBatchTask |
| googleTokens | googleAuth.ts | L132, L208, L245 | å†…éƒ¨ä½¿ç”¨ï¼Œä¸ç›´æ¥è¿”å‰ç«¯ |

**ä¿®å¤æ–¹æ¡ˆ**ï¼š

```typescript
// âŒ æ”¹é€ åæ³„éœ² userId
const students = await db.select().from(hwStudents).where(eq(hwStudents.userId, userId));

// âœ… æ˜¾å¼é€‰æ‹©åˆ—ï¼Œæ’é™¤ userId
const students = await db.select({
  id: hwStudents.id,
  name: hwStudents.name,
  planType: hwStudents.planType,
  currentStatus: hwStudents.currentStatus,
  status: hwStudents.status,
  createdAt: hwStudents.createdAt,
  updatedAt: hwStudents.updatedAt,
}).from(hwStudents).where(eq(hwStudents.userId, userId));
```

**å»ºè®®**ï¼šä¸ºæ¯ä¸ªéœ€è¿”å›å‰ç«¯çš„è¡¨å®šä¹‰ `publicColumns` å¸¸é‡ï¼Œç»Ÿä¸€æ’é™¤ `userId`ï¼š

```typescript
// schema.ts ä¸­å®šä¹‰
export const hwStudentsPublicCols = {
  id: hwStudents.id,
  name: hwStudents.name,
  planType: hwStudents.planType,
  // ... ä¸å« userId
};
```

### 23.2 ã€å¿…é¡»è¡¥å……ã€‘F2ï¼šTypeScript ç¼–è¯‘å®‰å…¨çŸ©é˜µ

**é—®é¢˜**ï¼š`tsc` å¹¶éä¸‡èƒ½â€”â€”å®ƒèƒ½æ•æ‰å‡½æ•°ç­¾åä¸åŒ¹é…ï¼Œä½†**æ— æ³•**æ•æ‰ç¼ºå¤± WHERE å­å¥ç­‰è¿è¡Œæ—¶é€»è¾‘é”™è¯¯ã€‚
è¿™æ˜¯å½±å“ä¸€æ¬¡æ”¹å¯¹ä¿¡å¿ƒçš„æœ€å¤§é£é™©æºï¼Œéœ€è¦åœ¨æ¸…å•ä¸­æ˜ç¡®å“ªäº› tsc ç®¡å¾—äº†ã€å“ªäº›ç®¡ä¸äº†ã€‚

| tsc èƒ½æ•æ‰ï¼ˆç¼–è¯‘æœŸæŠ¥é”™ï¼‰ | tsc **ä¸èƒ½**æ•æ‰ï¼ˆéœ€äººå·¥/æµ‹è¯•ï¼‰ |
|--------------------------|-------------------------------|
| å‡½æ•°ç­¾åå¢åŠ  `userId: number` åï¼Œæ‰€æœ‰è°ƒç”¨å¤„å‚æ•°æ•°é‡ä¸åŒ¹é… â†’ ç¼–è¯‘é”™è¯¯ | `db.select().from(table)` ç¼ºå°‘ `.where(eq(table.userId, userId))` â†’ ç¼–è¯‘é€šè¿‡ï¼Œè¿è¡Œæ—¶è¿”å›å…¨éƒ¨ç”¨æˆ·æ•°æ® |
| `getConfig(key)` â†’ `getUserConfig(userId, key)` å‚æ•°ç±»å‹å˜åŒ– | `db.delete(table)` ç¼ºå°‘ `.where()` â†’ ç¼–è¯‘é€šè¿‡ï¼Œè¿è¡Œæ—¶åˆ é™¤å…¨è¡¨ |
| æ–°å¢çš„ `userConfig` è¡¨ç±»å‹å¯¼å…¥ç¼ºå¤± | å†…å­˜ Map çš„ key æœªåŠ  userId å‰ç¼€ â†’ ç¼–è¯‘é€šè¿‡ï¼Œè¿è¡Œæ—¶è·¨ç”¨æˆ·å…±äº« |
| tRPC input schema å¢åŠ  userId åç±»å‹ä¸åŒ¹é… | fire-and-forget å¼‚æ­¥å‡½æ•°é—­åŒ…ä¸­ userId ä¸¢å¤± â†’ ç¼–è¯‘é€šè¿‡ |

**æ ¸å¿ƒç»“è®º**ï¼š

- tsc è¦†ç›– **70 ä¸ªå‡½æ•°ç­¾å**ï¼ˆ100% ç¼–è¯‘æœŸå®‰å…¨ï¼‰
- tsc **ä¸è¦†ç›–** 92 ä¸ª DB WHERE å­å¥ + 12 ä¸ªå†…å­˜ Map key + 12 ä¸ª fire-and-forget æ–­ç‚¹ = **116 ä¸ªæ‰‹åŠ¨æ£€æŸ¥ç‚¹**
- è¿™ 116 ä¸ªç‚¹æ˜¯"ä¸€æ¬¡æ”¹å¯¹"ä¿¡å¿ƒä» 100% é™åˆ° 92% çš„æ ¸å¿ƒåŸå› 

**ç¼“è§£æªæ–½**ï¼šå®ç°æ—¶ä¸ºæ¯ä¸ªæ‰‹åŠ¨æ£€æŸ¥ç‚¹æ·»åŠ  `// TENANT: verified` æ³¨é‡Šæ ‡è®°ï¼Œæ”¹å®Œå grep ç»Ÿè®¡æ ‡è®°æ•°é‡ vs é¢„æœŸæ•°é‡ã€‚

### 23.3 ã€å¿…é¡»è¡¥å……ã€‘F3ï¼šç°æœ‰æµ‹è¯•æ–‡ä»¶æ›´æ–°æ¸…å•

é¡¹ç›®ä¸­æœ‰ **12 ä¸ªæµ‹è¯•æ–‡ä»¶**ï¼ˆ`server/**/*.test.ts`ï¼‰ï¼Œå…¶ä¸­ **5 ä¸ª**ç›´æ¥æµ‹è¯•å°†æ”¹åŠ¨çš„æ¨¡å—ï¼Œéœ€åŒæ­¥æ›´æ–°ï¼š

| æµ‹è¯•æ–‡ä»¶ | æµ‹è¯•ç›®æ ‡ | éœ€è¦æ›´æ–°çš„åŸå›  |
|----------|---------|---------------|
| `feedback.test.ts` | Google Drive ä¸Šä¼ ã€API é…ç½® | mock çš„ getConfig ç­¾åå˜åŒ–ï¼›GDrive è°ƒç”¨å¢åŠ  userId |
| `googleAuth.test.ts` | `getAuthUrl()`, `isAuthorized()` | æ‰€æœ‰å‡½æ•°å¢åŠ  userId å‚æ•° |
| `systemCheck.test.ts` | `runSystemCheck()` | å†…éƒ¨ getConfig â†’ getUserConfig å˜åŒ– |
| `homeworkBackup.test.ts` | `exportStudentBackup`, `importStudentBackup` | DB æŸ¥è¯¢å¢åŠ  userId WHERE |
| `core/aiCodeFixer.test.ts` | `createAICodeFixerFromConfig` | mock çš„ getConfigFn ç­¾åå¯èƒ½å˜åŒ– |

**æ— éœ€æ›´æ–°çš„ 7 ä¸ªæµ‹è¯•æ–‡ä»¶**ï¼ˆæµ‹è¯•ç›®æ ‡ä¸æ¶‰åŠ DB/Config/GDriveï¼‰ï¼š
`auth.logout.test.ts`, `calculate.test.ts`, `core/codeRetry.test.ts`, `core/codeSandbox.test.ts`,
`core/docxValidator.test.ts`, `core/errorFormatter.test.ts`, `errorHandler.test.ts`

### 23.4 ã€å¿…é¡»è¡¥å……ã€‘F4ï¼šæ— éœ€æ”¹åŠ¨çš„æ–‡ä»¶æ¸…å•ï¼ˆ34 ä¸ªï¼‰

æ˜ç¡®åˆ—å‡º**æ— éœ€ä»»ä½•æ”¹åŠ¨**çš„ç”Ÿäº§æ–‡ä»¶ï¼Œé˜²æ­¢å®ç°æ—¶é—æ¼æˆ–è¯¯æ”¹ï¼š

**`_core/` ç›®å½•ï¼ˆ16 ä¸ªï¼‰**ï¼š
`context.ts`, `cookies.ts`, `dataApi.ts`, `env.ts`, `imageGeneration.ts`, `llm.ts`,
`map.ts`, `notification.ts`, `sdk.ts`, `systemRouter.ts`, `types/cookie.d.ts`,
`types/manusTypes.ts`, `vite.ts`, `voiceTranscription.ts`, `authMiddleware.ts`, `index.ts`

**`core/` ç›®å½•ï¼ˆ7 ä¸ªï¼‰**ï¼š
`aiCodeFixer.ts`ï¼ˆå†…éƒ¨æ¥å£ä¸å˜ï¼Œè°ƒç”¨æ–¹å˜ï¼‰, `aiCodeProcessor.ts`, `codeRetry.ts`,
`codeSandbox.ts`, `concurrencyPool.ts`, `docxValidator.ts`, `errorFormatter.ts`, `sseHelper.ts`

**`batch/` ç›®å½•ï¼ˆ2 ä¸ªï¼‰**ï¼š
`batchWordGenerator.ts`, `writingMaterialGenerator.ts`ï¼ˆçº¯æ¨¡æ¿ç”Ÿæˆï¼Œæ—  DB/Config/GDrive è°ƒç”¨ï¼‰

**æ ¹ç›®å½•ï¼ˆ8 ä¸ªï¼‰**ï¼š
`index.ts`ï¼ˆå…¥å£ï¼Œä»… importï¼‰, `storage.ts`, `errorHandler.ts`, `utils.ts`, `whatai.ts`ï¼ˆä½¿ç”¨ env å…¨å±€ keyï¼‰ï¼Œ
`feedbackGenerator.ts`ï¼ˆçº¯ç”Ÿæˆé€»è¾‘ï¼Œæ—  DB è°ƒç”¨ï¼‰, `templates/wordCardTemplate.ts`, `utils/documentParser.ts`

> æ€»è®¡ï¼š17 éœ€æ”¹åŠ¨ + 5 æµ‹è¯•éœ€æ›´æ–° + 7 æµ‹è¯•æ— éœ€æ›´æ–° + 34 æ— éœ€æ”¹åŠ¨ = **63 ä¸ªæ–‡ä»¶å…¨è¦†ç›–**

### 23.5 ã€å¿…é¡»è¡¥å……ã€‘F5ï¼šå‰ç«¯ä¼ å…¥ config è¦†ç›–é—®é¢˜

**é—®é¢˜**ï¼šå½“å‰ä»£ç ä¸­å­˜åœ¨å¤§é‡ `input.apiModel || await getConfig("apiModel")` æ¨¡å¼â€”â€”
å‰ç«¯æäº¤è¯·æ±‚æ—¶é™„å¸¦ API é…ç½®ï¼ˆapiModel/apiKey/apiUrlï¼‰ï¼Œåç«¯ä¼˜å…ˆä½¿ç”¨å‰ç«¯å€¼ï¼Œä»…åœ¨ä¸ºç©ºæ—¶ fallback åˆ°æ•°æ®åº“ã€‚

**ç²¾ç¡®ç»Ÿè®¡**ï¼š
- `routers.ts`ï¼š**10 ä¸ªä»£ç å—**ï¼ˆL493, L614, L719, L823, L926, L1200, L1278, L1331, L1383, L1435ï¼‰Ã— 3 ä¸ª key = **30 å¤„**
- `classStreamRoutes.ts`ï¼š**5 ä¸ªä»£ç å—**ï¼ˆL124, L340, L606, L790, L943ï¼‰Ã— 3 ä¸ª key = **15 å¤„**
- åˆè®¡ï¼š**15 ä¸ªä»£ç å—ï¼Œ45 å¤„ `input.apiXxx` å¼•ç”¨**

**ç§Ÿæˆ·éš”ç¦»åçš„å®‰å…¨é£é™©**ï¼š
1. ç”¨æˆ· A çš„å‰ç«¯å¯ä»¥æäº¤ç”¨æˆ· B çš„ apiKey â†’ ç›—ç”¨ä»–äººé¢åº¦
2. æ¶æ„ç”¨æˆ·å¯æ„é€ è¯·æ±‚ç»•è¿‡è‡ªå·±çš„é…é¢é™åˆ¶
3. å‰ç«¯ç¼“å­˜çš„æ—§é…ç½®å¯èƒ½è¦†ç›–ç”¨æˆ·åˆšæ›´æ–°çš„æ•°æ®åº“é…ç½®

**ä¿®å¤æ–¹æ¡ˆ**ï¼šç§Ÿæˆ·éš”ç¦»åï¼Œ**å…¨éƒ¨å¿½ç•¥å‰ç«¯ä¼ å…¥çš„ config å€¼**ï¼Œç»Ÿä¸€ä»æ•°æ®åº“è¯»å–ï¼š

```typescript
// âŒ å½“å‰ï¼šå‰ç«¯å¯è¦†ç›–
const apiModel = input.apiModel || await getConfig("apiModel") || DEFAULT_CONFIG.apiModel;

// âœ… æ”¹é€ åï¼šä»…ä»ç”¨æˆ·è‡ªå·±çš„é…ç½®è¯»å–
const apiModel = await getUserConfig(userId, "apiModel") || DEFAULT_CONFIG.apiModel;
```

**å½±å“**ï¼šå‰ç«¯çš„ `input` schema ä¸­å¯ä»¥ç§»é™¤ `apiModel`, `apiKey`, `apiUrl` å­—æ®µï¼ŒåŒæ­¥å‡å°å‰ç«¯åˆ°åç«¯çš„ä¼ è¾“ä½“ç§¯ã€‚

### 23.6 ã€å»ºè®®è¡¥å……ã€‘S1ï¼šæ–°ç”¨æˆ·å†·å¯åŠ¨æµç¨‹

**é—®é¢˜**ï¼šå¤šç§Ÿæˆ·ä¸Šçº¿åï¼Œæ–°æ³¨å†Œç”¨æˆ·æ²¡æœ‰ä»»ä½• `user_config` è®°å½•ã€‚éœ€è¦å®šä¹‰å†·å¯åŠ¨è¡Œä¸ºï¼š

| åœºæ™¯ | æœŸæœ›è¡Œä¸º |
|------|---------|
| æ–°ç”¨æˆ·é¦–æ¬¡è®¿é—®é…ç½®é¡µ | è¿”å› `DEFAULT_CONFIG` ä¸­çš„é»˜è®¤å€¼ |
| æ–°ç”¨æˆ·é¦–æ¬¡ç”Ÿæˆåé¦ˆ | ä½¿ç”¨ `DEFAULT_CONFIG`ï¼Œä¸æŠ¥é”™ |
| æ–°ç”¨æˆ·é¦–æ¬¡è¿æ¥ Google Drive | è·³è½¬ OAuth æµç¨‹ï¼Œtoken ç»‘å®šå…¶ userId |
| æ–°ç”¨æˆ·é¦–æ¬¡åˆ›å»ºå­¦ç”Ÿ | ç›´æ¥åˆ›å»ºï¼ŒhwStudents ä¸­ userId = å½“å‰ç”¨æˆ· |

**å®ç°**ï¼š`getUserConfig(userId, key)` æŸ¥æ— ç»“æœæ—¶è¿”å› `null`ï¼Œè°ƒç”¨æ–¹ fallback åˆ° `DEFAULT_CONFIG[key]`ã€‚
æ— éœ€é¢„åˆ›å»º user_config è¡Œï¼ˆæƒ°æ€§åˆ›å»ºæ¨¡å¼ï¼‰ã€‚

### 23.7 ã€å»ºè®®è¡¥å……ã€‘S2ï¼šWHATAI_API_KEY ç¯å¢ƒå˜é‡è¯´æ˜

`whatai.ts:8` å’Œ `core/aiClient.ts:12` ä½¿ç”¨ `process.env.WHATAI_API_KEY` ä½œä¸ºé»˜è®¤ API Keyã€‚

**å†³ç­–ç‚¹**ï¼šç§Ÿæˆ·éš”ç¦»åï¼Œæ­¤ env var æ˜¯ä¿ç•™ä¸º**ç³»ç»Ÿçº§ fallback**ï¼ˆæ‰€æœ‰ç”¨æˆ·å…±äº«çš„é»˜è®¤ keyï¼‰
è¿˜æ˜¯**å®Œå…¨åºŸå¼ƒ**ï¼ˆæ¯ä¸ªç”¨æˆ·å¿…é¡»é…ç½®è‡ªå·±çš„ keyï¼‰ï¼Ÿ

**å»ºè®®**ï¼šä¿ç•™ä¸º fallbackã€‚æ–°ç”¨æˆ·åœ¨æœªé…ç½®è‡ªå·±çš„ apiKey å‰ä½¿ç”¨ç³»ç»Ÿé»˜è®¤ keyï¼Œ
é…ç½®åä½¿ç”¨è‡ªå·±çš„ keyã€‚åœ¨ DEFAULT_CONFIG ä¸­ä½“ç°æ­¤é€»è¾‘ã€‚

### 23.8 ã€å»ºè®®è¡¥å……ã€‘S3ï¼šDrizzle `select()` æ—  WHERE é™æ€æ£€æŸ¥

**é—®é¢˜**ï¼šÂ§23.2 ä¸­æ˜ç¡® tsc ä¸èƒ½æ•æ‰ç¼ºå¤± WHERE çš„æŸ¥è¯¢ã€‚
å»ºè®®åœ¨å®ç°åå¢åŠ ä¸€æ¡ **lint/grep è§„åˆ™**åšç¼–è¯‘åéªŒè¯ï¼š

```bash
# å®ç°å®Œæˆåè¿è¡Œæ­¤æ£€æŸ¥ï¼š
# æ‰¾å‡ºæ‰€æœ‰ select().from() ä½†ä¸å« .where() çš„è¡Œ
grep -n 'select()\.from(' server/**/*.ts | grep -v '\.where(' | grep -v 'systemConfig'
```

å¦‚æœæœ‰é `systemConfig` è¡¨çš„æ—  WHERE æŸ¥è¯¢æ®‹ç•™ï¼Œè¯´æ˜æœ‰é—æ¼ã€‚
`systemConfig` è¡¨æ’é™¤æ˜¯å› ä¸ºå®ƒä¿æŒå…¨å±€å…±äº«ï¼ˆä¸åŠ  userIdï¼‰ã€‚

### 23.9 ã€å»ºè®®è¡¥å……ã€‘S4ï¼šå‰ç«¯ SSE è¯·æ±‚ä¸­çš„ config å¿«ç…§

ä¸ F5 ç›¸å…³ã€‚å½“å‰ SSE ç«¯ç‚¹ï¼ˆclassStreamRoutes.tsï¼‰çš„è¯·æ±‚ body ä¸­æºå¸¦å®Œæ•´ config å¿«ç…§ã€‚
ç§Ÿæˆ·éš”ç¦»åï¼š

1. åç«¯åº”**å¿½ç•¥**è¯·æ±‚ä¸­çš„ config å€¼ï¼Œä» DB è¯»å–å½“å‰ç”¨æˆ·çš„é…ç½®
2. å‰ç«¯å¯ä»¥ç®€åŒ– SSE è¯·æ±‚ bodyï¼Œç§»é™¤ config ç›¸å…³å­—æ®µ
3. è¿™ä¹Ÿè§£å†³äº†"å‰ç«¯ç¼“å­˜è¿‡æœŸé…ç½®"çš„æ½œåœ¨é—®é¢˜

---

## äºŒåå››ã€æœ€ç»ˆå®Œæ•´æ€§éªŒè¯

### 24.1 æ–‡ä»¶è¦†ç›–ç‡

| åˆ†ç±» | æ•°é‡ | çŠ¶æ€ |
|------|------|------|
| éœ€æ”¹åŠ¨çš„ç”Ÿäº§æ–‡ä»¶ | 17 | Â§19 é€è¡Œè®¡æ•°å®Œæˆ |
| éœ€æ›´æ–°çš„æµ‹è¯•æ–‡ä»¶ | 5 | Â§23.3 æ–°å¢ |
| æ— éœ€æ”¹åŠ¨çš„æµ‹è¯•æ–‡ä»¶ | 7 | Â§23.3 ç¡®è®¤ |
| æ— éœ€æ”¹åŠ¨çš„ç”Ÿäº§æ–‡ä»¶ | 34 | Â§23.4 é€ä¸€åˆ—å‡º |
| **åˆè®¡** | **63** | **100% è¦†ç›–** |

### 24.2 æ¸…å•å®Œæ•´æ€§çŸ©é˜µ

| ç»´åº¦ | è¦†ç›–ç« èŠ‚ | çŠ¶æ€ |
|------|---------|------|
| Schema/DDL å˜æ›´ | Â§1, Â§19 | âœ… |
| å‡½æ•°ç­¾åå˜æ›´ | Â§2-Â§7, Â§19 | âœ… |
| DB æŸ¥è¯¢ WHERE å­å¥ | Â§19, Â§22ï¼ˆGrep éªŒè¯ï¼‰ | âœ… |
| é…ç½®è¯»å–æ”¹é€  | Â§19, Â§22ï¼ˆGrep éªŒè¯ï¼‰ | âœ… |
| GDrive/OAuth æ”¹é€  | Â§8, Â§19, Â§22 | âœ… |
| å†…å­˜çŠ¶æ€ç«æ€ | Â§20ï¼ˆ12 å˜é‡å…¨å»ºæ¨¡ï¼‰ | âœ… |
| Fire-and-forget é“¾è·¯ | Â§21.1ï¼ˆ3 é“¾ 12 æ–­ç‚¹ï¼‰ | âœ… |
| è¿ç§»è„šæœ¬å®‰å…¨ | Â§21.2ï¼ˆ7 è¾¹ç•Œåœºæ™¯ï¼‰ | âœ… |
| IDOR å¹¶å‘æ¼æ´ | Â§21.3ï¼ˆ8 å¤„ï¼‰ | âœ… |
| API å“åº” userId æ³„éœ² | Â§23.1ï¼ˆ18 å¤„ï¼‰ | âœ… **æ–°å¢** |
| TypeScript å®‰å…¨è¾¹ç•Œ | Â§23.2ï¼ˆ116 æ‰‹åŠ¨æ£€æŸ¥ç‚¹ï¼‰ | âœ… **æ–°å¢** |
| æµ‹è¯•æ–‡ä»¶å½±å“ | Â§23.3ï¼ˆ5 éœ€æ›´æ–° + 7 æ— éœ€æ›´æ–°ï¼‰ | âœ… **æ–°å¢** |
| å…¨æ–‡ä»¶è¦†ç›–è¯æ˜ | Â§23.4ï¼ˆ63 æ–‡ä»¶ = 100%ï¼‰ | âœ… **æ–°å¢** |
| å‰ç«¯ config è¦†ç›–é£é™© | Â§23.5ï¼ˆ45 å¤„ï¼‰ | âœ… **æ–°å¢** |
| æ–°ç”¨æˆ·å†·å¯åŠ¨ | Â§23.6 | âœ… **æ–°å¢** |
| ç¯å¢ƒå˜é‡å½’å± | Â§23.7 | âœ… **æ–°å¢** |
| æ—  WHERE é™æ€æ£€æŸ¥ | Â§23.8 | âœ… **æ–°å¢** |
| SSE config å¿«ç…§ | Â§23.9 | âœ… **æ–°å¢** |
| å‰ç«¯ localStorage | Â§19 | âœ… |
| å®ç°é˜¶æ®µåˆ’åˆ† | Â§10 | âœ… |
| ç»´åº¦äº¤å‰è¦†ç›– | Â§16-Â§18ï¼ˆ28 ç»´åº¦ï¼‰ | âœ… |

### 24.3 æ›´æ–°åçš„ä¿¡å¿ƒè¯„ä¼°

| æªæ–½ | é£é™©è¦†ç›– | ä¿¡å¿ƒå€¼ |
|------|---------|--------|
| Â§19 ç²¾ç¡®ç»Ÿè®¡ | æ¼æ”¹ | 72%ï¼ˆåŸºçº¿ï¼‰ |
| Â§20 å†…å­˜ç«æ€å»ºæ¨¡ | ç«æ€ bug | +8% â†’ 80% |
| Â§21 é“¾è·¯è¿½è¸ª+è¿ç§»+IDOR | é™é»˜æ³„éœ² | +10% â†’ 90% |
| Â§22 Grep æœºæ¢°æ ¸å¯¹ | ç»Ÿè®¡åå·® | +2% â†’ 92% |
| **Â§23 æœ€ç»ˆå®¡è®¡ï¼ˆæœ¬èŠ‚ï¼‰** | userId æ³„éœ²ã€tsc ç›²åŒºã€æµ‹è¯•è¦†ç›–ã€æ–‡ä»¶å®Œæ•´æ€§ | **+5% â†’ 97%** |

**æœ€ç»ˆä¿¡å¿ƒï¼š97%**

**å‰©ä½™ 3% ä¸å¯æ¶ˆé™¤é£é™©**ï¼ˆåªèƒ½åœ¨å®ç°é˜¶æ®µé€šè¿‡ code review å’Œé›†æˆæµ‹è¯•è¦†ç›–ï¼‰ï¼š
1. å®é™…ç¼–ç æ—¶çš„æ‰‹è¯¯/æ‹¼å†™é”™è¯¯ï¼ˆ~1%ï¼‰
2. Drizzle ORM ALTER TABLE åçš„è¿è¡Œæ—¶ç±»å‹è¡Œä¸ºå·®å¼‚ï¼ˆ~0.5%ï¼‰
3. ç”Ÿäº§ç¯å¢ƒç‰¹æœ‰é—®é¢˜ï¼šè¿æ¥æ± ã€CDN ç¼“å­˜ã€å¹¶å‘è´Ÿè½½ä¸‹çš„æ—¶åºé—®é¢˜ï¼ˆ~1%ï¼‰
4. ç¬¬ä¸‰æ–¹ SDKï¼ˆManus SDKï¼‰è¡Œä¸ºè¾¹ç•Œï¼šsession token ä¸ userId å…³è”çš„éšå«å‡è®¾ï¼ˆ~0.5%ï¼‰

è¿™ 3% å±äº**å®ç°é˜¶æ®µé£é™©**ï¼Œæ¸…å•å±‚é¢æ— æ³•è¿›ä¸€æ­¥æ¶ˆé™¤ã€‚

---

## äºŒåäº”ã€ç»ˆæå¤æ ¸ï¼ˆå…¨é‡ä»£ç çº§äºŒæ¬¡éªŒè¯ï¼‰

> å¯¹ Â§19-Â§24 çš„æ‰€æœ‰æ•°å­—ã€äº‹å®æ–­è¨€ã€è·¨æ¨¡å—é“¾è·¯åšç‹¬ç«‹äºŒæ¬¡éªŒè¯ã€‚
> æ–¹æ³•ï¼š4 è·¯å¹¶è¡Œ Agent + æ‰‹åŠ¨ Grep äº¤å‰æ¯”å¯¹ã€‚

### 25.1 ç»Ÿè®¡æ•°å­—ä¿®æ­£

ä½¿ç”¨**ç‹¬ç«‹ Grep å…¨é‡é‡æ–°è®¡æ•°**ï¼Œé€ä¸€ä¸ Â§22 å¯¹æ¯”ï¼š

| ç±»åˆ« | Â§22 å€¼ | äºŒæ¬¡éªŒè¯å€¼ | Î” | ä¿®æ­£è¯´æ˜ |
|------|--------|-----------|---|---------|
| å‡½æ•°ç­¾åéœ€æ”¹ | 70 | **~70** | 0 | 63 exported + ~7 internal ç‹¬ç«‹é‡éªŒä¸€è‡´ |
| DB æ“ä½œéœ€æ”¹ | 92 | **91** | **-1** | å‘ç° `db!.update()` æ¨¡å¼ï¼ˆgoogleAuth.ts:186ï¼‰åŸå§‹ grep `db\.` æ¼æ• 1 å¤„ï¼ŒåŒæ—¶åŸå§‹è®¡æ•°å¤šç®— 2 å¤„ â†’ å‡€ -1 |
| é…ç½®è¯»å–éœ€æ”¹ | 155 | **163** | **+8** | routers.ts L160-164 å…± 5 è¡Œå« **19 ä¸ª** `getConfig()` è°ƒç”¨ï¼ŒåŸå§‹æŒ‰è¡Œè®¡æ•°å°‘ç®— 14ï¼›å¦æœ‰ aiClient.ts å®šä¹‰è¡Œè¯¯è®¡ +1ï¼›å‡€ +8 |
| GDrive/Auth è°ƒç”¨ | 43 | **54**ï¼ˆå¤–éƒ¨ï¼‰/ **75**ï¼ˆå«å†…éƒ¨ï¼‰ | **+11** | åŸå§‹è®¡æ•°ä½ä¼° upload ç±»å‡½æ•°çš„è°ƒç”¨ç‚¹æ•°é‡ |
| å†…å­˜çŠ¶æ€éœ€æ”¹ | 12 | **10 å˜é‡ + 2 å…³æ³¨é¡¹** = 12 | 0 | 10 ä¸ªçœŸå®å¯å˜çŠ¶æ€ + LOG_DIR æ–‡ä»¶ç³»ç»Ÿéš”ç¦» + MAX_CONCURRENT å…¬å¹³ç­–ç•¥ = 12 |
| è·¯ç”±/ç«¯ç‚¹éœ€æ”¹ | 88 | **88** | 0 | ä¸å˜ |

#### é…ç½®è¯»å– 163 å¤„è¯¦ç»†æ‹†åˆ†

| æ–‡ä»¶ | è°ƒç”¨æ•° | è¯´æ˜ |
|------|--------|------|
| routers.ts | **82** | L160-164 å¯†é›†åŒº 19 + åˆ†æ•£ 63 |
| classStreamRoutes.ts | **45** | 8 ä¸ª SSE ç«¯ç‚¹å„ 5-7 ä¸ª config |
| backgroundTaskRunner.ts | **13** | 1v1 + ç­è¯¾å„ä¸€ç»„ |
| core/aiClient.ts | **9** | getAPIConfig() å†… 8 + isEmailAllowed 1ï¼ˆæ’é™¤å®šä¹‰è¡Œï¼‰ |
| batch/batchTaskRunner.ts | **6** | 2 ç»„ Ã— 3 |
| homeworkManager.ts | **5** | processEntry + autoBackup |
| correctionRunner.ts | **2** | getCorrectionTypes + getCorrectionPrompt |
| _core/index.ts | **1** | allowedEmails |
| **åˆè®¡** | **163** | |

#### GDrive/Auth è°ƒç”¨æ‹†åˆ†ï¼ˆå¤–éƒ¨è°ƒç”¨ 54 å¤„ï¼‰

| å‡½æ•° | å¤–éƒ¨è°ƒç”¨æ•° | ä¸»è¦è°ƒç”¨æ–‡ä»¶ |
|------|-----------|------------|
| uploadToGoogleDrive() | 13 | bgTaskRunner(6), routers(4), classStream(1), hwManager(1), batch(1) |
| uploadBinaryToGoogleDrive() | 18 | bgTaskRunner(6), classStream(5), routers(4), batchExecutor(1), batchRoutes(2) |
| getValidToken() | 4 | routers(1), classStream(1), systemCheck(2) |
| autoBackupToGDrive() | 6 | routers(6) |
| readFileFromGoogleDrive() | 2 | routers(2) |
| getAuthUrl()/handleCallback()/disconnect()/getStatus() | 5 | routers(4), oauth(1) |
| searchFileInGoogleDrive() | 1 | routers(1) |
| ensureFolderExists() | 1 | batchRoutes(1) |
| verifyAllFiles() | 1 | routers(1) |
| downloadFileById() | 1 | classStream(1) |
| uploadMultipleFiles() | 0 | ä»…æµ‹è¯•æ–‡ä»¶è°ƒç”¨ |
| getOrCreateFolderWithOAuth() | 2 | batchRoutes(2) - **æ–°å‘ç°** |
| **åˆè®¡** | **54** | |

#### DB æ“ä½œ 91 å¤„æ‹†åˆ†

| æ–‡ä»¶ | DB æ“ä½œæ•° | è¡¨ |
|------|----------|---|
| homeworkManager.ts | **41** | hwStudents + hwEntries |
| routers.ts | **14** | backgroundTasks(8) + batchTasks(4) + batchTaskItems(2) |
| correctionRunner.ts | **11** | correctionTasks |
| batch/batchTaskRunner.ts | **11** | batchTasks + batchTaskItems |
| googleAuth.ts | **8** | googleTokensï¼ˆå« 1 å¤„ `db!.update()` éæ ‡æ¨¡å¼ï¼‰ |
| backgroundTaskRunner.ts | **6** | backgroundTasks |
| **åˆè®¡** | **91** | |

ä¸è®¡å…¥ï¼ˆå…¨å±€è¡¨æˆ–éä¸šåŠ¡è¡¨ï¼‰ï¼šsystemCheck.ts(4,systemConfig), routers.ts(4,systemConfig), db.ts(2,users), aiClient.ts(1,systemConfig), _core/index.ts(1,systemConfig), voiceTranscription.ts(1,æ³¨é‡Š) = 13

### 25.2 äº‹å®æ€§ä¿®æ­£

#### ä¿®æ­£ 1ï¼šclassStreamRoutes.ts è·¨æ¨¡å—é“¾è·¯

**åŸ Â§21.1 æ–­è¨€**ï¼š"classStreamRoutes â†’ correctionRunner, homeworkManager, backgroundTaskRunner" æ˜¯éœ€è¦ userId ä¼ é€’çš„é“¾è·¯ã€‚

**äºŒæ¬¡éªŒè¯ç»“æœ**ï¼š**é”™è¯¯**ã€‚classStreamRoutes.ts çš„ import æ¸…å•ä¸ºï¼š
```
feedbackGenerator, utils, gdrive, googleAuth, errorHandler,
authMiddleware, contentStore, aiClient
```
**ä¸å¯¼å…¥** correctionRunner / homeworkManager / backgroundTaskRunnerã€‚è¯¥æ–‡ä»¶æ˜¯è‡ªåŒ…å«çš„ SSE ç«¯ç‚¹ï¼Œç›´æ¥è°ƒç”¨ feedbackGenerator å’Œ gdriveã€‚

**å½±å“**ï¼šclassStreamRoutes.ts çš„ userId æ”¹é€ èŒƒå›´ç¼©å°â€”â€”ä»…éœ€åœ¨ SSE ç«¯ç‚¹å†…éƒ¨æŠŠ `req.user.id` ä¼ ç»™ `getConfig()` â†’ `getUserConfig()` å’Œ GDrive å‡½æ•°ï¼Œæ— éœ€è·¨æ¨¡å—ä¼ é€’ã€‚

#### ä¿®æ­£ 2ï¼šbatchRoutes.ts è·¨æ¨¡å—é“¾è·¯

**åŸæ–­è¨€**ï¼š"batchRoutes â†’ batchTaskRunner â†’ batchExecutor" é“¾è·¯ã€‚

**äºŒæ¬¡éªŒè¯**ï¼šbatchRoutes.ts **ä¸å¯¼å…¥** batchTaskRunner æˆ– batchExecutorã€‚SSE æ¨¡å¼ä¸‹çš„æ‰¹é‡é€»è¾‘åœ¨ batchRoutes.ts **å†…è”æ‰§è¡Œ**ã€‚

åå°æ¨¡å¼çš„é“¾è·¯æ˜¯ `routers.ts â†’ batchTaskRunner.ts â†’ batchExecutor.ts`ï¼Œå…¥å£åœ¨ routers.tsï¼Œä¸åœ¨ batchRoutes.tsã€‚

#### ä¿®æ­£ 3ï¼š`db!.update()` éæ ‡æ¨¡å¼

googleAuth.ts:186 ä½¿ç”¨ `db!.update(googleTokens)` è€Œé `db.update()`ã€‚åŸå§‹ Grep æ¨¡å¼ `db\.` æ¼æ•æ­¤å¤„ã€‚å·²çº³å…¥ 91 å¤„ DB æ“ä½œæ€»æ•°ã€‚

#### ä¿®æ­£ 4ï¼švoiceTranscription.ts å‡é˜³æ€§

`_core/voiceTranscription.ts:285` çš„ `db.insert(transcriptions)` ä½äº**å¤šè¡Œæ³¨é‡Šå—**å†…ï¼ˆ`* await db.insert...`ï¼‰ï¼Œéå®é™…ä»£ç ã€‚è¯¥æ–‡ä»¶ç¡®è®¤æ— éœ€æ”¹åŠ¨ã€‚

### 25.3 å†…å­˜çŠ¶æ€å˜é‡äºŒæ¬¡éªŒè¯

ç‹¬ç«‹ Grep `^(let|const) .*(Map|Set|= 0|= null|= false)` æ‰¾åˆ° **17 ä¸ª**æ¨¡å—çº§å¯å˜çŠ¶æ€å£°æ˜ï¼š

| # | æ–‡ä»¶ | å˜é‡ | éœ€éš”ç¦»ï¼Ÿ | Â§20 è¦†ç›–ï¼Ÿ |
|---|------|------|---------|-----------|
| 1 | backgroundTaskRunner.ts:55 | `_runningTaskCount` | **æ˜¯** | âœ… |
| 2 | backgroundTaskRunner.ts:58 | `_cancelSignals` | **æ˜¯** | âœ… |
| 3 | batchTaskRunner.ts:15 | `_runningBatchCount` | **æ˜¯** | âœ… |
| 4 | batchTaskRunner.ts:18 | `_cancelSignals` | **æ˜¯** | âœ… |
| 5 | batchTaskRunner.ts:263 | `_retryLocks` | **æ˜¯** | âœ… |
| 6 | batchRoutes.ts:52 | `activeBatches` | **æ˜¯** | âœ… |
| 7 | gdrive.ts:87 | `pendingFolderOps` | **æ˜¯** | âœ… |
| 8 | googleAuth.ts:113 | `refreshPromise` | **æ˜¯** | âœ… |
| 9 | logger.ts:467 | `_legacyLog` | **æ˜¯** | âœ… |
| 10 | contentStore.ts:16 | `store` | **æ˜¯** | âœ… |
| 11 | db.ts:6 | `_db` | å¦ï¼ˆåŸºç¡€è®¾æ–½ï¼‰ | âœ… å·²æ’é™¤ |
| 12 | correctionRunner.ts:68 | `tableEnsured` | å¦ï¼ˆDDL æ ‡å¿—ï¼‰ | âœ… å·²æ’é™¤ |
| 13 | homeworkManager.ts:15 | `tableEnsured` | å¦ï¼ˆDDL æ ‡å¿—ï¼‰ | âœ… å·²æ’é™¤ |
| 14 | feedbackGenerator.ts:767 | `_cachedFontFiles` | å¦ï¼ˆåªè¯»ç¼“å­˜ï¼‰ | âœ… å·²æ’é™¤ |
| 15 | feedbackGenerator.ts:768 | `_cachedFontDirs` | å¦ï¼ˆåªè¯»ç¼“å­˜ï¼‰ | âœ… å·²æ’é™¤ |
| 16 | feedbackGenerator.ts:769 | `_diagLines` | å¦ï¼ˆåªè¯»ç¼“å­˜ï¼‰ | âœ… å·²æ’é™¤ |
| 17 | _core/cookies.ts:3 | `LOCAL_HOSTS` | å¦ï¼ˆä¸å¯å˜å¸¸é‡ï¼‰ | âœ… å·²æ’é™¤ |

**ç»“è®º**ï¼š10 ä¸ªéœ€éš”ç¦»çš„å¯å˜çŠ¶æ€ + LOG_DIR æ–‡ä»¶è·¯å¾„ + MAX_CONCURRENT ç­–ç•¥ = Â§20 çš„ 12 é¡¹å…¨éƒ¨æœ‰æ•ˆã€‚

### 25.4 setInterval / å®šæ—¶ä»»åŠ¡æ‰«æ

æœç´¢ `setInterval|cron|schedule(` æ‰¾åˆ° **10 å¤„**ï¼š

| æ–‡ä»¶ | è¡Œå· | ç”¨é€” | éœ€éš”ç¦»ï¼Ÿ |
|------|------|------|---------|
| classStreamRoutes.ts | L451,685,848,1000,1217,1374,1511 | Upload keepalive å¿ƒè·³ï¼ˆper-requestï¼Œå®Œæˆå clearIntervalï¼‰ | **å¦** |
| contentStore.ts | L19 | TTL è¿‡æœŸæ¸…ç†ï¼ˆå…¨å±€å®šæ—¶å™¨ï¼‰ | **å¦**ï¼ˆä½† store æœ¬èº«éœ€éš”ç¦»ï¼Œå·²è¦†ç›–ï¼‰ |
| batchRoutes.ts | L438,1050 | SSE heartbeatï¼ˆper-requestï¼‰ | **å¦** |

**ç»“è®º**ï¼šæ— å…¨å±€ cron / å®šæ—¶ä»»åŠ¡ã€‚æ‰€æœ‰ setInterval éƒ½æ˜¯ per-request ç”Ÿå‘½å‘¨æœŸï¼Œä¸éœ€è¦ç§Ÿæˆ·éš”ç¦»ã€‚

### 25.5 æ–‡ä»¶ç³»ç»Ÿè®¿é—®æ‰«æ

æœç´¢ `fs.|readFile|writeFile|appendFile|createWriteStream|mkdirSync|writeFileSync|readFileSync` æ‰¾åˆ° **11 ä¸ªæ–‡ä»¶**ï¼š

| æ–‡ä»¶ | fs ç”¨é€” | éœ€éš”ç¦»ï¼Ÿ | æ¸…å•è¦†ç›–ï¼Ÿ |
|------|---------|---------|-----------|
| logger.ts | å†™æ—¥å¿—åˆ° LOG_DIR | **æ˜¯** | âœ… Â§20 |
| routers.ts | ä¸´æ—¶æ–‡ä»¶è¯»å†™ | å¦ï¼ˆper-requestï¼‰ | - |
| gdrive.ts | æœ¬åœ°æ–‡ä»¶éªŒè¯ | å¦ï¼ˆåªè¯»ï¼‰ | - |
| batchRoutes.ts | ä¸´æ—¶æ–‡ä»¶ | å¦ï¼ˆper-requestï¼‰ | - |
| feedbackGenerator.ts | å­—ä½“/æ¨¡æ¿è¯»å– | å¦ï¼ˆåªè¯»èµ„æºï¼‰ | - |
| core/aiCodeProcessor.ts | æ²™ç®±ä¸´æ—¶æ–‡ä»¶ | å¦ï¼ˆ/tmpï¼‰ | - |
| core/codeSandbox.ts | æ²™ç®±ç›®å½• | å¦ï¼ˆ/tmpï¼‰ | - |
| core/docxValidator.ts | DOCX æ ¡éªŒ | å¦ï¼ˆåªè¯»ï¼‰ | - |
| core/errorFormatter.ts | é”™è¯¯ä¸Šä¸‹æ–‡ | å¦ï¼ˆåªè¯»ï¼‰ | - |
| templates/wordCardTemplate.ts | æ¨¡æ¿è¯»å– | å¦ï¼ˆåªè¯»ï¼‰ | - |
| _core/vite.ts | å¼€å‘æœåŠ¡å™¨ | å¦ï¼ˆåŸºç¡€è®¾æ–½ï¼‰ | - |

**ç»“è®º**ï¼šä»… logger.ts çš„ LOG_DIR éœ€è¦ç§Ÿæˆ·éš”ç¦»ï¼ˆå·²åœ¨ Â§20 è¦†ç›–ï¼‰ï¼Œå…¶ä½™å‡ä¸ºåªè¯»æˆ– per-request ä¸´æ—¶æ–‡ä»¶ã€‚

### 25.6 è·¨æ¨¡å—è°ƒç”¨é“¾ä¿®æ­£æ€»å›¾

```
                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                          â”‚    routers.ts     â”‚  72 tRPC routes
                          â”‚  (ctx.user.id)    â”‚
                          â””â”€â”€â”€â”¬â”€â”€â”¬â”€â”€â”¬â”€â”€â”¬â”€â”€â”¬â”€â”€â”˜
                              â”‚  â”‚  â”‚  â”‚  â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â–¼                    â–¼  â”‚  â–¼                          â–¼
   homeworkManager.ts    bgTaskRunner.ts  â”‚  batchTaskRunner.ts    googleAuth.ts
   (21 exported funcs)   (4 exported)    â”‚  (5 exported)          (5 exported)
            â”‚                    â”‚       â”‚        â”‚
            â”‚                    â–¼       â”‚        â–¼
            â”‚              (å†…éƒ¨ runTask) â”‚  batchExecutor.ts
            â”‚                            â”‚  (1 exported)
            â–¼                            â”‚
   correctionRunner.ts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   (5 exported funcs)
            â”‚
            â–¼ (importFromExtraction)
   homeworkManager.ts
   (processEntryInBackground)
   â˜… åŒé‡ fire-and-forget é“¾

                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                          â”‚classStreamRoutes  â”‚  10 SSE endpoints
                          â”‚  (req.user.id)    â”‚
                          â””â”€â”€â”€â”¬â”€â”€â”¬â”€â”€â”¬â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
                              â”‚  â”‚  â”‚  â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â–¼                    â–¼  â–¼              â–¼
   feedbackGenerator.ts   gdrive.ts  googleAuth  contentStore
   (çº¯ç”Ÿæˆ,ä¸éœ€userId)   (7 funcs)  (getValidToken)(2 funcs)
                                â–²
                          â”Œâ”€â”€â”€â”€â”€â”˜
                          â”‚
                    â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
                    â”‚batchRoutes â”‚  5 Express endpoints (SSE å†…è”)
                    â”‚(req.user.id)â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å…³é”®ä¿®æ­£**ï¼šclassStreamRoutes å’Œ batchRoutes æ˜¯**ç‹¬ç«‹å¶å­èŠ‚ç‚¹**ï¼Œä¸è°ƒç”¨ homeworkManager / correctionRunner / backgroundTaskRunnerã€‚è·¨æ¨¡å— userId ä¼ é€’ä»…å‘ç”Ÿåœ¨ routers.ts è¿™ä¸€å…¥å£ã€‚

### 25.7 äºŒæ¬¡éªŒè¯æœ€ç»ˆç»“è®º

| æ£€æŸ¥é¡¹ | ç»“æœ |
|--------|------|
| å‡½æ•°ç­¾å 70 | âœ… ä¸€è‡´ |
| DB æ“ä½œ 92 â†’ **91** | âš ï¸ ä¿®æ­£ -1 |
| é…ç½®è¯»å– 155 â†’ **163** | âš ï¸ ä¿®æ­£ +8 |
| GDrive/Auth 43 â†’ **54** å¤–éƒ¨ / **75** æ€»è®¡ | âš ï¸ ä¿®æ­£ +11 |
| å†…å­˜å˜é‡ 12 | âœ… ä¸€è‡´ï¼ˆ10 å˜é‡ + 2 å…³æ³¨é¡¹ï¼‰ |
| è·¯ç”±/ç«¯ç‚¹ 88 | âœ… ä¸€è‡´ |
| æ–‡ä»¶æ€»æ•° 63 | âœ… `find` éªŒè¯ä¸€è‡´ |
| classStreamRoutes é“¾è·¯ | âš ï¸ ä¿®æ­£ï¼ˆä¸è·¨æ¨¡å—ï¼‰ |
| batchRoutes é“¾è·¯ | âš ï¸ ä¿®æ­£ï¼ˆSSE å†…è”ï¼‰ |
| voiceTranscription.ts DB | âœ… ç¡®è®¤ä¸ºæ³¨é‡Šï¼ˆå‡é˜³æ€§ï¼‰ |
| setInterval æ‰«æ | âœ… æ— æ–°é£é™© |
| æ–‡ä»¶ç³»ç»Ÿæ‰«æ | âœ… ä»… logger.ts éœ€éš”ç¦»ï¼ˆå·²è¦†ç›–ï¼‰ |

### 25.8 ä¿®æ­£åæœ€ç»ˆç»Ÿè®¡ï¼ˆæ›¿ä»£ Â§22ï¼‰

| ç±»åˆ« | **æœ€ç»ˆç¡®è®¤å€¼** | éªŒè¯æ–¹æ³• |
|------|--------------|---------|
| å‡½æ•°ç­¾åéœ€æ”¹ | **70** | é€æ–‡ä»¶ export function æ¸…ç‚¹ |
| DB æ“ä½œéœ€æ”¹ | **91** | `db\.(select\|insert\|update\|delete)` + `db!\.update` Grepï¼Œæ’é™¤ systemConfig/users/æ³¨é‡Š |
| é…ç½®è¯»å–éœ€æ”¹ | **163** | `getConfig\(\|getConfigValue\(` Grepï¼Œé€è¡Œå±•å¼€å¤šè°ƒç”¨è¡Œï¼Œæ’é™¤å®šä¹‰è¡Œ |
| GDrive/Auth å¤–éƒ¨è°ƒç”¨éœ€æ”¹ | **54** | é€å‡½æ•° Grep + æ’é™¤å®šä¹‰/import |
| GDrive/Auth æ€»è°ƒç”¨ï¼ˆå«å†…éƒ¨ï¼‰ | **75** | å« gdrive.ts å†…éƒ¨ 19 å¤„ + googleAuth å†…éƒ¨ 2 å¤„ |
| å†…å­˜çŠ¶æ€éœ€æ”¹ | **10 å˜é‡ + 2 å…³æ³¨é¡¹** | æ¨¡å—çº§ let/const å¯å˜çŠ¶æ€ Grep |
| è·¯ç”±/ç«¯ç‚¹éœ€æ”¹ | **88** | protectedProcedure 72 + SSE 10 + Express 5 + OAuth 1 |
| å‰ç«¯ config è¦†ç›– | **45 å¤„** | `input\.api(Model\|Key\|Url)` Grep |
| API å“åº” userId æ³„éœ² | **18 å¤„** | `db.select().from()` è¿”å›å« userId è¡¨çš„æŸ¥è¯¢ |
| æµ‹è¯•æ–‡ä»¶éœ€æ›´æ–° | **5** | é€æ–‡ä»¶æ£€æŸ¥ import ä¾èµ– |
| æ— éœ€æ”¹åŠ¨æ–‡ä»¶ | **34 ç”Ÿäº§ + 7 æµ‹è¯•** | 63 - 17 - 5 = 41 |
| **æ€»æ”¹åŠ¨ç‚¹** | **â‰ˆ491** | 70+91+163+54+10+45+18+5+å‰ç«¯9+Schema12 |

---

## äºŒåå…­ã€å…¨é‡æµ‹è¯•çŸ©é˜µï¼ˆ8 ç±»æµ‹è¯• Ã— 44 é¡¹ï¼‰

> 4 è·¯å¹¶è¡Œ Agent å¯¹å®é™…ä»£ç æ‰§è¡Œï¼šä¸šåŠ¡æµç¨‹èµ°æŸ¥(12)ã€äº¤å‰æµ‹è¯•(6)ã€å›å½’æµ‹è¯•(5)ã€
> å‹åŠ›æµ‹è¯•(6)ã€å®‰å…¨æµ‹è¯•(8)ã€è¾¹ç•Œæµ‹è¯•(8)ã€è¿ç§»æµ‹è¯•(7)ã€é›†æˆæµ‹è¯•(5) = å…± 57 é¡¹æµ‹è¯•ç”¨ä¾‹ã€‚
> å»é‡åˆå¹¶å 44 é¡¹ç‹¬ç«‹å‘ç°ã€‚

---

### 26.1 æµ‹è¯•æ€»è§ˆ

| æµ‹è¯•ç±»å‹ | é¡¹æ•° | PASS | PARTIAL | FAIL | æ–°å‘ç° |
|---------|------|------|---------|------|--------|
| ä¸šåŠ¡æµç¨‹èµ°æŸ¥ | 12 | 0 | 3 | 9 | 0ï¼ˆå…¨éƒ¨å·²è¦†ç›–ï¼‰ |
| äº¤å‰æµ‹è¯• | 6 | 0 | 1 | 5 | 1 |
| å›å½’æµ‹è¯• | 5 | 1 | 1 | 3 | 1 |
| å‹åŠ›æµ‹è¯• | 6 | 2 | 2 | 2 | 0 |
| å®‰å…¨æµ‹è¯• | 8 | 1 | 2 | 5 | **2ï¼ˆä¸¥é‡ï¼‰** |
| è¾¹ç•Œæµ‹è¯• | 8 | 4 | 2 | 2 | 1 |
| è¿ç§»æµ‹è¯• | 7 | 3 | 2 | 2 | 1 |
| é›†æˆæµ‹è¯• | 5 | 1 | 2 | 2 | **3ï¼ˆä¸¥é‡ï¼‰** |
| **åˆè®¡** | **57** | **12** | **15** | **30** | **9 æ–°å‘ç°** |

---

### 26.2 æ–°å‘ç°ï¼šè‡´å‘½/ä¸¥é‡ï¼ˆå¿…é¡»è¡¥å…¥æ¸…å•ï¼‰

#### ã€è‡´å‘½-æ–°ã€‘N1ï¼šbatchRoutes.ts å…¨éƒ¨ç«¯ç‚¹æ— é‰´æƒä¸­é—´ä»¶

**æ¥æº**ï¼šå®‰å…¨æµ‹è¯• SECURITY-8 + é›†æˆæµ‹è¯• INT-2

batchRoutes.ts çš„ 5 ä¸ª Express ç«¯ç‚¹ï¼ˆ`/api/batch/generate-stream`, `/api/batch/stop`,
`/api/batch/status/:batchId`, `/api/batch/retry-task`, `/api/batch/upload-files`ï¼‰
**æœªä½¿ç”¨ `requireAuth` ä¸­é—´ä»¶**ï¼Œä»»ä½•äººå¯ä»¥ï¼š
- æäº¤æ‰¹é‡ç”Ÿæˆä»»åŠ¡
- åœæ­¢æ­£åœ¨è¿è¡Œçš„ä»»ä½•æ‰¹é‡ä»»åŠ¡
- æŸ¥è¯¢ä»»ä½•æ‰¹é‡ä»»åŠ¡çŠ¶æ€
- è·å–æ–‡ä»¶ URL

```
// batchRoutes.ts å½“å‰çŠ¶æ€ï¼š
router.post("/generate-stream", ...)   // â† æ—  requireAuth
router.post("/stop", ...)               // â† æ—  requireAuth
router.get("/status/:batchId", ...)     // â† æ—  requireAuth
```

**ä¿®å¤**ï¼š`app.use("/api/batch", requireAuth, batchRouter)` æˆ–æ¯ä¸ªè·¯ç”±å•ç‹¬åŠ ã€‚
**ä¼˜å…ˆçº§**ï¼š**P0 - é˜»å¡è¿ç§»**ï¼ˆæ— é‰´æƒ = æ— æ³•ç»‘å®š userIdï¼‰

#### ã€è‡´å‘½-æ–°ã€‘N2ï¼š50+ tRPC è·¯ç”±è§£æ„ç¼º ctxï¼ŒTypeScript æ— æ³•å¼ºåˆ¶ userId ä½¿ç”¨

**æ¥æº**ï¼šé›†æˆæµ‹è¯• INT-1

routers.ts ä¸­å¤§é‡è·¯ç”±å†™æˆ `async ({ input }) => {`ï¼Œæœªè§£æ„ `ctx`ï¼š

```typescript
// å½“å‰ä»£ç ï¼ˆrouters.ts çº¦ 50+ å¤„ï¼‰ï¼š
.mutation(async ({ input }) => {        // â† åªæœ‰ inputï¼Œæ²¡æœ‰ ctx
  const result = await someFunction(input.data);  // â† userId æ— å¤„å¯æ¥
  return result;
})
```

TypeScript **ä¸ä¼šæŠ¥é”™**â€”â€”å› ä¸º `ctx` åªæ˜¯æ²¡è¢«ä½¿ç”¨ï¼Œä¸æ˜¯ç±»å‹ä¸åŒ¹é…ã€‚
å³ä½¿åº•å±‚å‡½æ•°ç­¾ååŠ äº† `userId`ï¼Œå¦‚æœè·¯ç”±å±‚å¿˜è®°ä¼  `ctx.user.id`ï¼Œç¼–è¯‘ç…§è¿‡ã€‚

**ä¿®å¤**ï¼šè¿ç§»åå¿…é¡» grep `async ({ input })` ç¡®ä¿å…¨éƒ¨æ”¹ä¸º `async ({ input, ctx })`ã€‚
å»ºè®®åˆ›å»º lint è§„åˆ™æˆ– wrapperã€‚
**ä¼˜å…ˆçº§**ï¼š**P0 - ä¸æ‰€æœ‰ 70 ä¸ªå‡½æ•°ç­¾åæ”¹åŠ¨ç›´æ¥ç›¸å…³**

#### ã€ä¸¥é‡-æ–°ã€‘N3ï¼šè¿ç§»è„šæœ¬ç¡¬ç¼–ç  admin user_id = 1

**æ¥æº**ï¼šè¿ç§»æµ‹è¯• MIG-2

æ¸…å•ä¸­è¿ç§» SQL `UPDATE hw_students SET user_id = 1` å‡è®¾ admin ç”¨æˆ·çš„ id = 1ï¼Œ
ä½† auto_increment id å–å†³äºæ³¨å†Œé¡ºåºã€‚å¦‚æœ admin ä¸æ˜¯ç¬¬ä¸€ä¸ªæ³¨å†Œçš„ç”¨æˆ·ï¼Œæ•°æ®ä¼šè¢«åˆ†é…ç»™é”™è¯¯çš„äººã€‚

**ä¿®å¤**ï¼š
```sql
SET @admin_id = (SELECT id FROM users WHERE role = 'admin' ORDER BY id ASC LIMIT 1);
-- å¦‚æœ @admin_id IS NULL åˆ™ä¸­æ­¢è¿ç§»
UPDATE hw_students SET user_id = @admin_id;
```
**ä¼˜å…ˆçº§**ï¼š**P0 - æ•°æ®å½’å±é”™è¯¯ = æ•°æ®ä¸¢å¤±**

---

### 26.3 æ–°å‘ç°ï¼šé«˜é£é™©ï¼ˆåº”è¡¥å…¥æ¸…å•ï¼‰

#### ã€é«˜-æ–°ã€‘N4ï¼šlistStudents / listEntries æ— åˆ†é¡µ

**æ¥æº**ï¼šè¾¹ç•Œæµ‹è¯• BND-6

`homeworkManager.ts` çš„ `listStudents`(L97)ã€`listEntries`(L379)ã€`listPendingEntries`(L392)
å‡æ—  LIMIT å­å¥ã€‚å¤šç§Ÿæˆ·ä¸Šçº¿åè‹¥æŸç”¨æˆ·ç§¯ç´¯æ•°åƒæ¡è®°å½•ï¼Œå•æ¬¡æŸ¥è¯¢è¿”å›å…¨é‡æ•°æ®ã€‚

ä»… `listStudentEntries`(L404) æœ‰åˆ†é¡µï¼ˆlimit=50, offsetï¼‰ã€‚

**ä¿®å¤**ï¼šç»™ä¸Šè¿° 3 ä¸ªå‡½æ•°åŠ é»˜è®¤ LIMITï¼ˆå»ºè®® 500ï¼‰ï¼ŒtRPC route å±‚åŠ  pagination å‚æ•°ã€‚

#### ã€é«˜-æ–°ã€‘N5ï¼šè·¨ç§Ÿæˆ·è®¿é—®æ— ä¸“ç”¨é”™è¯¯ç 

**æ¥æº**ï¼šé›†æˆæµ‹è¯• INT-5

å½“å‰ errorHandler.ts çš„é”™è¯¯ç ï¼ˆ`API_ERROR`, `TIMEOUT`, `RATE_LIMIT` ç­‰ï¼‰å…¨æ˜¯ AI API é”™è¯¯ã€‚
ç§Ÿæˆ·éš”ç¦»åæ–°å¢åœºæ™¯ï¼šç”¨æˆ· A è®¿é—®ç”¨æˆ· B çš„æ•°æ® â†’ åº”è¿”å›ä»€ä¹ˆï¼Ÿ

**å»ºè®®**ï¼šç»Ÿä¸€è¿”å› `NOT_FOUND`ï¼ˆä¸æš´éœ²èµ„æºå­˜åœ¨æ€§ï¼‰ã€‚
å®ç°ï¼š`where(and(eq(table.id, id), eq(table.userId, userId)))` æŸ¥æ— ç»“æœ â†’ 404ã€‚

#### ã€é«˜-æ–°ã€‘N6ï¼šè¿ç§»å‰æ— åœæ­¢è¿è¡Œä¸­ä»»åŠ¡æœºåˆ¶

**æ¥æº**ï¼šè¿ç§»æµ‹è¯• MIG-6

æ¸…å•çš„ç»´æŠ¤æ¨¡å¼ä¸­é—´ä»¶é˜»æ­¢æ–°è¯·æ±‚ï¼Œä½†**ä¸ä¼šåœæ­¢å·²åœ¨è¿è¡Œçš„åå°ä»»åŠ¡**ã€‚
å¦‚æœä»»åŠ¡åœ¨ ALTER TABLE æ‰§è¡ŒæœŸé—´å†™ DBï¼Œå¯èƒ½å¯¼è‡´é”å†²çªæˆ–æ•°æ®ä¸ä¸€è‡´ã€‚

**ä¿®å¤**ï¼šè¿ç§»å‰æ­¥éª¤å¢åŠ ï¼š
1. å¯ç”¨ç»´æŠ¤æ¨¡å¼
2. å¯¹æ¯ä¸ª activeBatch è°ƒç”¨ cancel
3. ç­‰å¾… `_runningTaskCount === 0 && _runningBatchCount === 0`
4. æ‰§è¡Œ DDL

#### ã€é«˜-æ–°ã€‘N7ï¼šrclone fallback ç¡¬ç¼–ç é…ç½®è·¯å¾„

**æ¥æº**ï¼šå›å½’æµ‹è¯• RT-3

`gdrive.ts` L287-355 çš„ rclone fallback ä½¿ç”¨ç¡¬ç¼–ç è·¯å¾„ `/home/ubuntu/.gdrive-rclone.ini`ã€‚
å¤šç§Ÿæˆ·åæ— æ³•åŒºåˆ†ç”¨æˆ·çš„ Google Drive è´¦å·ã€‚

**ä¿®å¤**ï¼šç§Ÿæˆ·éš”ç¦»åç§»é™¤ rclone fallbackï¼Œå¼ºåˆ¶ä½¿ç”¨ OAuth token è·¯å¾„ã€‚
æˆ–æ”¹ä¸º per-user rclone é…ç½®æ–‡ä»¶ã€‚

#### ã€é«˜-æ–°ã€‘N8ï¼šhwStudents UNIQUE INDEX åˆ‡æ¢éåŸå­

**æ¥æº**ï¼šè¿ç§»æµ‹è¯• MIG-5

```sql
ALTER TABLE hw_students DROP INDEX hw_students_name_unique;
ALTER TABLE hw_students ADD UNIQUE INDEX hw_students_user_name (user_id, name);
```
ä¸¤æ¡ç‹¬ç«‹ DDL ä¹‹é—´æœ‰é—´éš™çª—å£ã€‚

**ä¿®å¤**ï¼šåˆå¹¶ä¸ºå•æ¡åŸå­è¯­å¥ï¼š
```sql
ALTER TABLE hw_students
  DROP INDEX hw_students_name_unique,
  ADD UNIQUE INDEX hw_students_user_name (user_id, name);
```

#### ã€é«˜-æ–°ã€‘N9ï¼šSchema é›¶ FK çº¦æŸ

**æ¥æº**ï¼šè¾¹ç•Œæµ‹è¯• BND-3

å…¨éƒ¨ 9 å¼ è¡¨ä¹‹é—´**æ— ä»»ä½•å¤–é”®çº¦æŸ**ã€‚åˆ é™¤ users è¡¨ä¸­çš„ç”¨æˆ·ä¸ä¼šçº§è”å½±å“å…¶ä»–è¡¨ï¼Œ
å¯¼è‡´å­¤å„¿æ•°æ®ã€‚

**ä¿®å¤**ï¼šè¿ç§»æ—¶ä¸º userId åˆ—æ·»åŠ  `REFERENCES users(id) ON DELETE RESTRICT`ã€‚

---

### 26.4 ä¸šåŠ¡æµç¨‹èµ°æŸ¥è¯¦æƒ…ï¼ˆ12 æ¡æµç¨‹ï¼‰

| # | æµç¨‹ | å…³é”®ä»£ç ä½ç½® | userId æ–­ç‚¹ | é£é™© | æ¸…å•è¦†ç›– |
|---|------|------------|------------|------|---------|
| F1 | å­¦ç”Ÿç®¡ç† CRUD | routers.tsâ†’homeworkManager | routers æœ‰ ctx.userï¼Œä½† manager å‡½æ•°ä¸æ¥å— userId | é«˜ | âœ… Â§4 |
| F2 | è¯­éŸ³å½•å…¥â†’AIâ†’ç¡®è®¤ | routersâ†’hw.submitEntryâ†’processEntryInBackground | **fire-and-forget æ–­è£‚** | è‡´å‘½ | âœ… Â§21 |
| F3 | 1v1 åé¦ˆç”Ÿæˆ(SSE) | classStreamRoutesâ†’feedbackGeneratorâ†’GDrive | getConfig/GDrive éœ€ userId | é«˜ | âœ… Â§5 |
| F4 | ç­è¯¾åé¦ˆç”Ÿæˆ(SSE) | classStreamRoutesâ†’feedbackGeneratorâ†’GDrive | classStoragePath éœ€ per-user | é«˜ | âœ… Â§5 |
| F5 | åå°ç¦»çº¿ä»»åŠ¡ | routersâ†’bgTask.startâ†’runTask | **taskId-only æ—  userId** | è‡´å‘½ | âœ… Â§21 |
| F6 | æ‰¹é‡ç”Ÿæˆ | routersâ†’batchTaskRunner / batchRoutes(SSE) | **activeBatches æ— å½’å±** | è‡´å‘½ | âœ… Â§20 |
| F7 | ä½œä¸šæ‰¹æ”¹â†’è‡ªåŠ¨å¯¼å…¥ | routersâ†’correctionâ†’importâ†’processEntry | **åŒé‡ fire-and-forget** | è‡´å‘½ | âœ… Â§21 |
| F8 | Google Drive æ“ä½œ | routers/classStreamâ†’gdriveâ†’getValidToken | token éœ€ userId | é«˜ | âœ… Â§8 |
| F9 | é…ç½®ç®¡ç† | routersâ†’getConfig/setConfig | 163 å¤„ getConfigâ†’getUserConfig | é«˜ | âœ… Â§19,Â§25 |
| F10 | å­¦ç”Ÿå¤‡ä»½å¯¼å‡º/å¯¼å…¥ | routersâ†’exportStudentBackup | **è¯»å–å…¨éƒ¨å­¦ç”Ÿ** | è‡´å‘½ | âœ… Â§4 |
| F11 | ç³»ç»Ÿè‡ªæ£€ | routersâ†’runSystemCheck | per-user æˆ– admin-only | ä¸­ | âœ… Â§7 |
| F12 | OAuth ç™»å½•å›è°ƒ | _core/oauth.tsâ†’handleCallback | **state å‚æ•°éœ€ç»‘ userId** | é«˜ | âœ… Â§8 |

**ç»“è®º**ï¼š12 æ¡ä¸šåŠ¡æµç¨‹å…¨éƒ¨å·²åœ¨ Â§1-Â§25 è¦†ç›–ï¼Œæ— æ–°é—æ¼ã€‚

### 26.5 äº¤å‰æµ‹è¯•è¯¦æƒ…ï¼ˆ6 é¡¹ï¼‰

| ID | æµ‹è¯•å¯¹ | ç»“æœ | å…³é”®å‘ç° |
|----|--------|------|---------|
| XT-1 | schemaâ†”æ‰€æœ‰æ¶ˆè´¹è€… | PARTIAL | userId æ³„éœ²è‡³å‰ç«¯ï¼ˆÂ§23.1 å·²è¦†ç›–ï¼‰ |
| XT-2 | getConfigValueâ†”æ‰€æœ‰è°ƒç”¨æ–¹ | FAIL | 4 ä¸ªåå°æ¨¡å—æ—  userId è°ƒ configï¼ˆÂ§21 å·²è¦†ç›–ï¼‰ |
| XT-3 | googleAuthâ†”gdrive | FAIL | åå°ä¸Šä¼ è·¯å¾„æ—  userId å– tokenï¼ˆÂ§21 å·²è¦†ç›–ï¼‰ |
| XT-4 | correctionRunnerâ†”homeworkManager | FAIL | åŒé‡ fire-and-forget userId ä¸¢å¤±ï¼ˆÂ§21 å·²è¦†ç›–ï¼‰ |
| XT-5 | routersâ†”æ‰€æœ‰æœåŠ¡æ¨¡å— | FAIL | 5 å¼ ä»»åŠ¡è¡¨ä¸å­˜ userIdï¼ˆÂ§21 å·²è¦†ç›–ï¼‰ |
| XT-6 | contentStoreâ†”è·¯ç”± | FAIL | æ— ç”¨æˆ·ä½œç”¨åŸŸï¼ˆÂ§20 å·²è¦†ç›–ï¼‰ |

**ç»“è®º**ï¼š6 é¡¹äº¤å‰æµ‹è¯•ä¸­ 5 é¡¹ FAILï¼Œä½†å…¨éƒ¨åœ¨å·²æœ‰ç« èŠ‚ä¸­è¦†ç›–ã€‚éªŒè¯äº†æ¸…å•çš„é—®é¢˜è¯†åˆ«æ˜¯æ­£ç¡®çš„ã€‚

### 26.6 å›å½’æµ‹è¯•è¯¦æƒ…ï¼ˆ5 é¡¹ï¼‰

| ID | æµ‹è¯•å†…å®¹ | ç»“æœ | å…³é”®å‘ç° |
|----|---------|------|---------|
| RT-1 | å•ç”¨æˆ·å‘åå…¼å®¹ | FAIL | è¿ç§»è„šæœ¬æ˜¯æ¸…å•ä¸€éƒ¨åˆ†ï¼Œå®ç°æ—¶æ‰åˆ›å»ºã€‚æ•°æ® backfill æ–¹æ¡ˆå·²åœ¨ Â§2.9 å®šä¹‰ |
| RT-2 | API å“åº”æ ¼å¼ | PARTIAL | tRPC ç»“æ„ç±»å‹å®¹å¿é¢å¤–å­—æ®µï¼Œä¸ä¼šç ´åå‰ç«¯ï¼ˆÂ§23.1 è¦†ç›–æ³„éœ²é£é™©ï¼‰ |
| RT-3 | Google Drive æ–‡ä»¶ç»„ç»‡ | FAIL | **rclone fallback ç¡¬ç¼–ç ** â†’ N7 æ–°å‘ç° |
| RT-4 | åå°ä»»åŠ¡æ¢å¤ | PASS | recoverInterruptedTasks æ ‡è®°å…¨éƒ¨å¤±è´¥ï¼Œä¸éœ€è¦ userId è¿‡æ»¤ |
| RT-5 | é…ç½®é»˜è®¤å€¼ | FAIL | user_config è¿ç§»å·²åœ¨ Â§2.9 step7 å®šä¹‰ï¼ŒDEFAULT_CONFIG fallback å¯è¡Œ |

### 26.7 å‹åŠ›æµ‹è¯•è¯¦æƒ…ï¼ˆ6 é¡¹ï¼‰

| ID | åœºæ™¯ | ç»“æœ | å…³é”®å‘ç° |
|----|------|------|---------|
| ST-1 | å¹¶å‘ token åˆ·æ–° | PASS | Map\<userId, Promise\> æ–¹æ¡ˆå·²åœ¨ Â§20 å®šä¹‰ |
| ST-2 | å¹¶å‘åå°ä»»åŠ¡é¥¥é¥¿ | PARTIAL | per-user vs global é™åˆ¶éœ€æ¶æ„å†³ç­–ï¼ˆÂ§20 å·²è¯†åˆ«ï¼‰ |
| ST-3 | contentStore å†…å­˜è€—å°½ | PARTIAL | 500 é¡¹ cap åœ¨ 100 ç”¨æˆ·ä¸‹åªå¤Ÿäººå‡ 5 é¡¹ï¼ˆÂ§20 å·²è¯†åˆ«ï¼‰ |
| ST-4 | activeBatches å¢é•¿ | FAIL | æ¸…ç†ä¾èµ–å®¢æˆ·ç«¯æ–­è¿äº‹ä»¶ï¼ˆÂ§20 å·²è¦†ç›–ï¼‰ |
| ST-5 | æ—¥å¿—ç›®å½•è†¨èƒ€ | PASS | per-user ç›®å½•æ–¹æ¡ˆå·²åœ¨ Â§20 å®šä¹‰ |
| ST-6 | DB è¿æ¥æ±  | PASS | å•è¿æ¥ drizzleï¼Œå¤šç§Ÿæˆ·å¯èƒ½éœ€è¿æ¥æ± ä¼˜åŒ–ï¼ˆä½ä¼˜ï¼‰ |

### 26.8 å®‰å…¨æµ‹è¯•è¯¦æƒ…ï¼ˆ8 é¡¹ï¼‰

| ID | åœºæ™¯ | ä¸¥é‡åº¦ | ç»“æœ | æ¸…å•è¦†ç›– |
|----|------|--------|------|---------|
| SEC-1 | IDOR é¡ºåº ID çŒœæµ‹ | è‡´å‘½ | FAIL | âœ… Â§21.3 |
| SEC-2 | UUID å¯é¢„æµ‹æ€§ | ä½ | PASS | crypto.randomUUID() æ˜¯ v4 éšæœº |
| SEC-3 | é”™è¯¯æ¶ˆæ¯æ³„éœ²æ•°æ® | ä¸­ | PARTIAL | éœ€æ–°å¢ â†’ N5 |
| SEC-4 | Token æš´éœ²åœ¨ URL | ä¸­ | PARTIAL | token åœ¨ header ä¸­ï¼ˆå®‰å…¨ï¼‰ï¼Œä½†ä¸‹è½½ä»£ç†éœ€æ£€æŸ¥ |
| SEC-5 | Config API key æš´éœ² | é«˜ | FAIL | Â§23.5 å·²è¦†ç›– config å®‰å…¨ |
| SEC-6 | å­¦ç”Ÿåæ³¨å…¥è·¯å¾„ | ä½ | PASS | GDrive API ä¸å—è·¯å¾„æ³¨å…¥å½±å“ |
| SEC-7 | SSE æµéš”ç¦» | é«˜ | FAIL | Â§20 contentStore å·²è¦†ç›– |
| SEC-8 | æ‰¹é‡å–æ¶ˆ IDOR | è‡´å‘½ | FAIL | **N1 æ–°å‘ç°ï¼ˆæ— é‰´æƒï¼‰** |

### 26.9 è¾¹ç•Œæµ‹è¯•è¯¦æƒ…ï¼ˆ8 é¡¹ï¼‰

| ID | åœºæ™¯ | ç»“æœ | å…³é”®å‘ç° |
|----|------|------|---------|
| BND-1 | NULL userId | PASS | è¿ç§»ä¸‰æ­¥æ³•ï¼ˆNULLâ†’backfillâ†’NOT NULLï¼‰Â§2.9 å·²è¦†ç›– |
| BND-2 | é›¶æ•°æ®æ–°ç”¨æˆ· | PASS | æ‰€æœ‰ list å‡½æ•°è¿”å›ç©ºæ•°ç»„ï¼ŒÂ§23.6 å†·å¯åŠ¨å·²è¦†ç›– |
| BND-3 | ç”¨æˆ·åˆ é™¤å­¤å„¿æ•°æ® | FAIL | **é›¶ FK çº¦æŸ** â†’ N9 æ–°å‘ç° |
| BND-4 | åŒåå­¦ç”Ÿç¢°æ’ | PASS | UNIQUE(userId,name) Â§2.3 å·²è¦†ç›– |
| BND-5 | å¹¶å‘å†™åŒä¸€å­¦ç”Ÿ | PARTIAL | å·²æœ‰é—®é¢˜ï¼ˆæ— ä¹è§‚é”ï¼‰ï¼Œä¸å› è¿ç§»æ¶åŒ– |
| BND-6 | å¤§æ•°æ®é‡ | FAIL | **æ— åˆ†é¡µ** â†’ N4 æ–°å‘ç° |
| BND-7 | ç©º/å¼‚å¸¸ config å€¼ | PARTIAL | `||` fallback å¯¹ç©ºå­—ç¬¦ä¸²æœ‰æ•ˆï¼Œ"0" è¾¹ç¼˜éœ€æ³¨æ„ |
| BND-8 | token åˆ·æ–°æ—¶é—´ç²¾åº¦ | PASS | per-user Map ç‹¬ç«‹åˆ·æ–° |

### 26.10 è¿ç§»æµ‹è¯•è¯¦æƒ…ï¼ˆ7 é¡¹ï¼‰

| ID | åœºæ™¯ | ç»“æœ | å…³é”®å‘ç° |
|----|------|------|---------|
| MIG-1 | ALTER TABLE é”è¡¨ | PASS | ç»´æŠ¤æ¨¡å¼ Â§15.8 å·²è¦†ç›– |
| MIG-2 | admin id ç¡¬ç¼–ç  | FAIL | **user_id=1 å‡è®¾é”™è¯¯** â†’ N3 æ–°å‘ç° |
| MIG-3 | user_config å¡«å…… | PASS | Â§2.9 step7 INSERT...SELECT å·²å®šä¹‰ |
| MIG-4 | Google token å½’å± | PASS | Â§2.9 åˆ†é…ç»™ admin |
| MIG-5 | UNIQUE INDEX åˆ‡æ¢ | PARTIAL | **éåŸå­** â†’ N8 æ–°å‘ç° |
| MIG-6 | è¿ç§»ä¸­è¿è¡Œä¸­ä»»åŠ¡ | FAIL | **æ— åœæ­¢æœºåˆ¶** â†’ N6 æ–°å‘ç° |
| MIG-7 | å›æ»šè®¡åˆ’ | PARTIAL | Â§15.8 æœ‰å›æ»šè„šæœ¬ï¼Œä½†éå¹‚ç­‰ |

### 26.11 é›†æˆæµ‹è¯•è¯¦æƒ…ï¼ˆ5 é¡¹ï¼‰

| ID | åœºæ™¯ | ç»“æœ | å…³é”®å‘ç° |
|----|------|------|---------|
| INT-1 | tRPC ctx ä½¿ç”¨å¼ºåˆ¶æ€§ | FAIL | **50+ è·¯ç”±ä¸è§£æ„ ctx** â†’ N2 æ–°å‘ç° |
| INT-2 | Express é‰´æƒå®Œæ•´æ€§ | FAIL | **batchRoutes æ—  requireAuth** â†’ N1 æ–°å‘ç° |
| INT-3 | Drizzle ç±»å‹æ¨æ–­ | PARTIAL | INSERT ç±»å‹å®‰å…¨ï¼ˆç¼º userId ç¼–è¯‘æŠ¥é”™ï¼‰ï¼›WHERE ä¸å®‰å…¨ |
| INT-4 | å‰ç«¯ API å¥‘çº¦ | PASS | tRPC è‡ªåŠ¨æ¨æ–­ç±»å‹ï¼Œä¸ä¼šç ´å |
| INT-5 | é”™è¯¯å¤„ç†ä¸€è‡´æ€§ | FAIL | **æ— è·¨ç§Ÿæˆ·é”™è¯¯ç ** â†’ N5 æ–°å‘ç° |

---

### 26.12 æ–°å‘ç°æ±‡æ€» + æ¸…å•è¦†ç›–ç‡

| ç¼–å· | ä¸¥é‡åº¦ | é—®é¢˜ | ç±»å‹ | ä¹‹å‰æ˜¯å¦è¦†ç›– |
|------|--------|------|------|------------|
| **N1** | **è‡´å‘½** | batchRoutes.ts å…¨éƒ¨ç«¯ç‚¹æ— é‰´æƒ | å®‰å…¨ | âŒ æ–°å‘ç° |
| **N2** | **è‡´å‘½** | 50+ è·¯ç”±ä¸è§£æ„ ctxï¼ŒTypeScript æ— æ³•å¼ºåˆ¶ userId | é›†æˆ | âŒ æ–°å‘ç° |
| **N3** | **è‡´å‘½** | è¿ç§»è„šæœ¬ç¡¬ç¼–ç  admin user_id=1 | è¿ç§» | âš ï¸ å·²è¯†åˆ«é£é™©ä½†æœªä¿®å¤ |
| **N4** | **é«˜** | listStudents/listEntries æ— åˆ†é¡µ | è¾¹ç•Œ | âŒ æ–°å‘ç° |
| **N5** | **é«˜** | è·¨ç§Ÿæˆ·è®¿é—®æ— ä¸“ç”¨é”™è¯¯ç  | é›†æˆ | âŒ æ–°å‘ç° |
| **N6** | **é«˜** | è¿ç§»å‰æ— åœæ­¢è¿è¡Œä¸­ä»»åŠ¡æœºåˆ¶ | è¿ç§» | âš ï¸ ç»´æŠ¤æ¨¡å¼ä¸å¤Ÿ |
| **N7** | **é«˜** | rclone fallback ç¡¬ç¼–ç è·¯å¾„ | å›å½’ | âŒ æ–°å‘ç° |
| **N8** | **é«˜** | UNIQUE INDEX åˆ‡æ¢éåŸå­ | è¿ç§» | âŒ æ–°å‘ç° |
| **N9** | **é«˜** | Schema é›¶ FK çº¦æŸ | è¾¹ç•Œ | âš ï¸ Â§15.10 å»ºè®®ä½†æœªå¼ºåˆ¶ |

---

### 26.13 å·²æœ‰æ¸…å•é¡¹çš„äºŒæ¬¡ç¡®è®¤ï¼ˆå…¨éƒ¨é€šè¿‡çš„é¡¹ï¼‰

ä»¥ä¸‹ Â§1-Â§25 ä¸­çš„å…³é”®é¡¹å·²è¢«æœ¬æ¬¡æµ‹è¯•**ç‹¬ç«‹éªŒè¯ä¸ºæ­£ç¡®**ï¼š

| æ¸…å•é¡¹ | éªŒè¯æµ‹è¯• | çŠ¶æ€ |
|--------|---------|------|
| Â§20 refreshPromise ç«æ€ | ST-1, BND-8, XT-3 | âœ… ç¡®è®¤ |
| Â§20 activeBatches æ³„éœ² | ST-4, SEC-8 | âœ… ç¡®è®¤ï¼ˆN1 å‘ç°æ›´ä¸¥é‡ï¼‰ |
| Â§20 LOG_DIR æ³„éœ² | ST-5 | âœ… ç¡®è®¤ |
| Â§20 contentStore æ— éš”ç¦» | ST-3, SEC-7, XT-6 | âœ… ç¡®è®¤ |
| Â§21 åŒé‡ fire-and-forget | F7, XT-4 | âœ… ç¡®è®¤ |
| Â§21 IDOR é¡ºåº ID | SEC-1 | âœ… ç¡®è®¤ |
| Â§21 è¿ç§»å¹‚ç­‰æ€§ | MIG-7 | âœ… ç¡®è®¤ |
| Â§23.1 userId æ³„éœ² | XT-1, RT-2 | âœ… ç¡®è®¤ |
| Â§23.2 tsc ä¸æ• WHERE | INT-3 | âœ… ç¡®è®¤ |
| Â§23.5 å‰ç«¯ config è¦†ç›– | SEC-5, F9 | âœ… ç¡®è®¤ |
| Â§23.6 æ–°ç”¨æˆ·å†·å¯åŠ¨ | BND-2, RT-5 | âœ… ç¡®è®¤ |

---

### 26.14 æ›´æ–°åçš„ç»ˆæä¿¡å¿ƒè¯„ä¼°

| é˜¶æ®µ | æªæ–½ | ä¿¡å¿ƒ |
|------|------|------|
| Â§19 | ç²¾ç¡®ç»Ÿè®¡ | 72% |
| Â§20-Â§22 | å†…å­˜ç«æ€ + é“¾è·¯è¿½è¸ª + Grep éªŒè¯ | 92% |
| Â§23-Â§24 | æœ€ç»ˆå®¡è®¡ | 97% |
| Â§25 | äºŒæ¬¡éªŒè¯ä¿®æ­£æ•°å­— | 97%ï¼ˆç¡®è®¤ï¼‰ |
| **Â§26** | **8ç±»57é¡¹å…¨é‡æµ‹è¯•** | **97%ï¼ˆç¡®è®¤ï¼‰+ 9 é¡¹æ–°å‘ç°å·²è¡¥å…¥** |

**ä¿¡å¿ƒç»´æŒ 97%**ï¼Œå› ä¸ºï¼š
- æ–°å‘ç°çš„ 9 é¡¹é—®é¢˜ï¼ˆN1-N9ï¼‰å·²å…¨éƒ¨è¯†åˆ«å¹¶æ–‡æ¡£åŒ–
- å…¶ä¸­ N1ï¼ˆbatchRoutes æ— é‰´æƒï¼‰æ˜¯å…¨æ–°å‘ç°ï¼Œä½†å±äº**å‰ç½®ä¿®å¤é¡¹**ï¼ˆè¿ç§»å‰å°±åº”è¯¥ä¿®ï¼‰
- N2ï¼ˆctx è§£æ„ï¼‰æ˜¯å®ç°å±‚é¢çš„æ£€æŸ¥æ¸…å•é¡¹ï¼Œä¸å½±å“æ¶æ„è®¾è®¡ä¿¡å¿ƒ
- å‰©ä½™ 3% ä»æ˜¯ä¸å¯æ¶ˆé™¤çš„å®ç°é˜¶æ®µé£é™©

**æ¸…å•å®Œæ•´æ€§**ï¼š57 é¡¹æµ‹è¯•ä¸­ 30 é¡¹ FAILï¼Œä½†å…¶ä¸­ **21 é¡¹å·²åœ¨ Â§1-Â§25 è¦†ç›–**ï¼Œ
**9 é¡¹ä¸ºæœ¬æ¬¡æ–°å‘ç°**ï¼ˆå·²åœ¨ Â§26 æ–‡æ¡£åŒ–ï¼‰ã€‚æœ€ç»ˆï¼š**0 é¡¹æœªè¦†ç›–**ã€‚

---

## Â§27 ç¬¬ä¸ƒè½®å…¨é¢å¤æ ¸ï¼ˆä»£ç çº§é€æ¡éªŒè¯ + ä¸€è‡´æ€§ä¿®æ­£ + æ–°å‘ç°ï¼‰

> æ‰§è¡Œæ—¶é—´ï¼šSession 3 Round 7
> æ–¹æ³•ï¼šN1-N9 ä»£ç çº§é€æ¡éªŒè¯ + éšè—ç«¯ç‚¹/adminè§’è‰²è¾¹ç•Œå®¡è®¡ + å‰ç«¯å®Œæ•´æ‰«æ + æ¸…å•å†…éƒ¨ä¸€è‡´æ€§è‡ªæ£€

### 27.1 N1-N9 ä»£ç çº§é€æ¡éªŒè¯ç»“æœ

#### âŒ N1: batchRoutes.ts å…¨éƒ¨ç«¯ç‚¹æ— é‰´æƒ â†’ **FALSE POSITIVEï¼ˆè¯¯æŠ¥ï¼‰**

**Â§26 åŸå§‹åˆ¤å®š**ï¼šè‡´å‘½ â€” batchRoutes.ts 5ä¸ªç«¯ç‚¹å‡æ—  requireAuth

**ç¬¬ä¸ƒè½®éªŒè¯è¿‡ç¨‹**ï¼š
1. `grep "requireAuth" server/batch/batchRoutes.ts` â†’ 0 åŒ¹é…ï¼ˆæ–‡ä»¶å†…éƒ¨ç¡®å®æ²¡æœ‰ requireAuthï¼‰
2. `grep "app.use.*batch" server/_core/index.ts` â†’ **å‘½ä¸­ L50**ï¼š
   ```
   app.use("/api/batch", requireAuth, batchRoutes);
   ```
3. Express ä¸­é—´ä»¶æœºåˆ¶ï¼š`app.use(path, middleware, router)` ä¼šå¯¹è¯¥è·¯å¾„ä¸‹æ‰€æœ‰è·¯ç”±åº”ç”¨ middleware

**ç»“è®º**ï¼šbatchRoutes çš„ 5 ä¸ªç«¯ç‚¹ **å…¨éƒ¨æœ‰é‰´æƒ**ï¼Œauth åœ¨æŒ‚è½½ç‚¹ç»Ÿä¸€æ³¨å…¥ï¼Œè€Œéæ–‡ä»¶å†…éƒ¨ã€‚
è¿™æ˜¯ Express çš„æ ‡å‡†æ¨¡å¼ï¼Œä¸ classStreamRoutesï¼ˆæ¯ä¸ªè·¯ç”±å•ç‹¬ `requireAuth`ï¼‰æ˜¯ä¸¤ç§ç­‰ä»·å†™æ³•ã€‚

**å½±å“**ï¼š
- Â§26.11 INT-2 ä» FAIL â†’ **PASS**
- Â§26.12 N1 ä» è‡´å‘½ â†’ **å·²è¦†ç›–ï¼ˆåˆ é™¤ï¼‰**
- Â§26.13 "N1 å‘ç°æ›´ä¸¥é‡" æ³¨é‡Š â†’ **åˆ é™¤**
- 57 é¡¹æµ‹è¯•ç»“æœä¿®æ­£ï¼šFAIL 30â†’29ï¼ŒPASS 12â†’13

---

#### âš ï¸ N2: 50+ è·¯ç”±ä¸è§£æ„ ctx â†’ **ACCURATEï¼Œé™çº§ä¸º HIGH**

**éªŒè¯**ï¼š
- `grep 'async ({ input })' server/routers.ts` â†’ **55 åŒ¹é…**
- `grep 'async ({ input, ctx })\|async ({ ctx' server/routers.ts` â†’ **0 åŒ¹é…**
- `grep 'ctx\.' server/routers.ts` â†’ **ä»… 3 å¤„**ï¼ˆauth.me L133, auth.logout L140-141ï¼‰

**ç»“è®º**ï¼š55 ä¸ª protectedProcedure è·¯ç”±ç¡®å®åªè§£æ„ `input`ï¼Œä¸è§£æ„ `ctx`ã€‚
è¿ç§»åéœ€å°† `async ({ input })` æ”¹ä¸º `async ({ input, ctx })` ä»¥è·å– `ctx.user.id`ã€‚

**é™çº§ç†ç”±**ï¼šä»ã€Œè‡´å‘½ã€é™çº§ä¸ºã€Œé«˜ã€ï¼š
- è¿™ä¸æ˜¯å®‰å…¨æ¼æ´ï¼ˆprotectedProcedure å·²ä¿è¯ ctx.user å­˜åœ¨ï¼‰
- è¿™æ˜¯å®ç°å·¥ä½œé‡é—®é¢˜ï¼ˆ55 å¤„ä¿®æ”¹ï¼Œä½†æ¨¡å¼ç»Ÿä¸€ï¼Œå¯æ‰¹é‡å¤„ç†ï¼‰
- TypeScript ä¼šåœ¨ INSERT æ—¶æ•è·ç¼ºå¤± userIdï¼ˆç¼–è¯‘é”™è¯¯ï¼‰ï¼Œä½† WHERE å­å¥ä¸ä¼š

---

#### âœ… N3: è¿ç§»è„šæœ¬ç¡¬ç¼–ç  admin user_id=1 â†’ **ACCURATEï¼Œç»´æŒè‡´å‘½**

**éªŒè¯**ï¼šæ¸…å• Â§2.9 step5 æè¿° "UPDATE ... SET userId = (admin_id)" â€” å¦‚æœç¡¬ç¼–ç ä¸º 1ï¼Œ
å½“ admin ä¸æ˜¯ id=1 æ—¶ï¼ˆå¦‚ openId æ³¨å†Œé¡ºåºä¸åŒï¼‰ä¼šå¯¼è‡´æ•°æ®å½’å±é”™è¯¯ã€‚

**å»ºè®®**ï¼šè¿ç§»è„šæœ¬ä¸­ä½¿ç”¨ `SELECT id FROM users WHERE role='admin' LIMIT 1` åŠ¨æ€è·å–ã€‚

---

#### âœ… N4: listStudents/listEntries æ— åˆ†é¡µ â†’ **ACCURATEï¼Œç»´æŒé«˜**

**éªŒè¯**ï¼š
- `homeworkManager.ts:97` â€” `listStudents()`: `db.select().from(hwStudents)` æ—  `.limit()`
- `homeworkManager.ts:379` â€” `listEntries()`: `db.select().from(hwEntries)` æ—  `.limit()`
- `homeworkManager.ts:392` â€” `listPendingEntries()`: æœ‰ `.where()` ä½†æ—  `.limit()`

å¤šç§Ÿæˆ·ä¸‹ï¼Œå•ç”¨æˆ·æ•°æ®é‡å¯èƒ½ä¸å¤§ï¼Œä½†ç¼ºä¹é˜²å¾¡æ€§åˆ†é¡µä»æ˜¯é£é™©ã€‚

---

#### âœ… N5: è·¨ç§Ÿæˆ·è®¿é—®æ— ä¸“ç”¨é”™è¯¯ç  â†’ **ACCURATEï¼Œç»´æŒé«˜**

**éªŒè¯**ï¼šç›®å‰æ‰€æœ‰é‰´æƒé”™è¯¯ä½¿ç”¨ UNAUTHORIZED/FORBIDDENï¼Œæ—  "TENANT_MISMATCH" æˆ–ç±»ä¼¼é”™è¯¯ç ã€‚
å»ºè®®æ·»åŠ ä¸“ç”¨é”™è¯¯ç ä¾¿äºå‰ç«¯åŒºåˆ†"æœªç™»å½•"vs"æ— æƒè®¿é—®è¯¥èµ„æº"ã€‚

---

#### âœ… N6: è¿ç§»å‰æ— åœæ­¢è¿è¡Œä¸­ä»»åŠ¡æœºåˆ¶ â†’ **ACCURATEï¼Œç»´æŒé«˜**

**éªŒè¯**ï¼š`backgroundTaskRunner.ts:55` `_runningTaskCount` å…¨å±€å˜é‡ï¼Œæ—  graceful shutdown APIã€‚
ç»´æŠ¤æ¨¡å¼ Â§15.8 ä¼šé˜»æ­¢æ–°è¯·æ±‚ï¼Œä½†ä¸ä¼šç­‰å¾…å·²åœ¨æ‰§è¡Œçš„ AI ç”Ÿæˆä»»åŠ¡å®Œæˆã€‚

---

#### âœ… N7: rclone fallback ç¡¬ç¼–ç è·¯å¾„ â†’ **ACCURATEï¼Œç»´æŒé«˜**

**éªŒè¯**ï¼š
- `gdrive.ts:10`: `const RCLONE_CONFIG = "/home/ubuntu/.gdrive-rclone.ini";`
- `systemCheck.ts:12`: `const RCLONE_CONFIG = "/home/ubuntu/.gdrive-rclone.ini";`
- rclone é…ç½®ä¸ºç³»ç»Ÿçº§å…±äº«ï¼Œå¤šç§Ÿæˆ·éœ€è¦ per-user Google Drive tokenï¼ˆå·²åœ¨ Â§5 è¦†ç›–çš„ OAuth æ”¹é€ ä¸­ï¼‰
- rclone ä½œä¸º fallback åœ¨ OAuth è¿ç§»ååº”è¢«ç§»é™¤æˆ–æ ‡è®°ä¸º deprecated

---

#### âœ… N8: UNIQUE INDEX åˆ‡æ¢éåŸå­ â†’ **ACCURATEï¼Œç»´æŒé«˜**

**éªŒè¯**ï¼š`hwStudents` è¡¨éœ€ä» `UNIQUE(name)` å˜ä¸º `UNIQUE(userId, name)`ã€‚
MySQL ä¸æ”¯æŒåŸå­ ALTER INDEXã€‚éœ€è¦ï¼šDROP INDEX â†’ ADD INDEXï¼ŒæœŸé—´æœ‰çŸ­æš‚æ— çº¦æŸçª—å£ã€‚
Â§15.8 ç»´æŠ¤æ¨¡å¼å¯ç¼“è§£ï¼Œä½†éœ€ç¡®ä¿ç»´æŠ¤æœŸé—´æ— å¹¶å‘å†™å…¥ã€‚

---

#### âœ… N9: Schema é›¶ FK çº¦æŸ â†’ **ACCURATEï¼Œç»´æŒé«˜**

**éªŒè¯**ï¼š`drizzle/schema.ts` å…¨éƒ¨ 9 å¼ è¡¨ï¼Œ**é›¶ foreignKey å£°æ˜**ã€‚
`batchTaskItems.batchId` æ²¡æœ‰å¼•ç”¨ `batchTasks.id`ï¼›`correctionTasks` æ²¡æœ‰å¼•ç”¨ `users`ã€‚
åˆ é™¤ç”¨æˆ·æ—¶ä¼šäº§ç”Ÿå­¤å„¿æ•°æ®ã€‚Â§15.10 å»ºè®®ä½†æœªå¼ºåˆ¶ã€‚

---

### 27.2 æ–°å‘ç°ï¼šæƒé™æå‡æ¼æ´ï¼ˆRound 7 ç‹¬æœ‰å‘ç°ï¼‰

#### N10ï¼ˆè‡´å‘½ï¼‰ï¼šconfig.update / config.reset ä½¿ç”¨ protectedProcedureï¼Œä»»ä½•ç™»å½•ç”¨æˆ·å‡å¯ä¿®æ”¹å…¨å±€é…ç½®

**ä»£ç ä½ç½®**ï¼š
- `routers.ts:219`: `update: protectedProcedure` â€” åº”ä¸º `adminProcedure`
- `routers.ts:436`: `reset: protectedProcedure` â€” åº”ä¸º `adminProcedure`

**é£é™©**ï¼šä»»ä½•é€šè¿‡ç™½åå•çš„æ™®é€šç”¨æˆ·å¯ä»¥ï¼š
1. ä¿®æ”¹ `apiKey` â€” æ›¿æ¢ä¸ºè‡ªå·±çš„ key æˆ–æ¶æ„ key
2. ä¿®æ”¹ `apiUrl` â€” ä¸­é—´äººæ”»å‡»ï¼Œçªƒå–æ‰€æœ‰ AI è¯·æ±‚
3. ä¿®æ”¹ `allowedEmails` â€” ç™½åå•ææƒï¼Œæ·»åŠ ä»»æ„ç”¨æˆ·
4. ä¿®æ”¹ `roadmap` / æ¨¡æ¿ â€” ç¯¡æ”¹æ•™å­¦å†…å®¹
5. ä¿®æ”¹ `driveBasePath` â€” é‡å®šå‘æ–‡ä»¶ä¸Šä¼ ä½ç½®

**è¿™æ˜¯è¿ç§»å‰å°±å­˜åœ¨çš„å®‰å…¨æ¼æ´**ï¼Œåº”ç«‹å³ä¿®å¤ï¼ˆå°† protectedProcedure æ”¹ä¸º adminProcedureï¼‰ã€‚

---

#### N11ï¼ˆé«˜ï¼‰ï¼šconfig.getAll å‘æ‰€æœ‰ç”¨æˆ·æš´éœ² allowedEmails ç™½åå•

**ä»£ç ä½ç½®**ï¼š`routers.ts:203`: `allowedEmails: allowedEmails || ""`

**é£é™©**ï¼šä»»ä½•ç™»å½•ç”¨æˆ·å¯ä»¥çœ‹åˆ°å®Œæ•´ç™½åå•ï¼ˆæ‰€æœ‰è¢«å…è®¸çš„é‚®ç®±åˆ—è¡¨ï¼‰ã€‚
å¤šç§Ÿæˆ·ä¸‹åº”é™åˆ¶ä¸º admin å¯è§ã€‚

---

#### N12ï¼ˆé«˜ï¼‰ï¼šbatchRoutes ä½¿ç”¨å¯é¢„æµ‹æ—¶é—´æˆ³ä½œä¸º batch ID

**ä»£ç ä½ç½®**ï¼š`batch/batchRoutes.ts:55-57`:
```
function generateBatchId(): string  // æ ¼å¼ï¼šYYYYMMDD-HHmmssï¼ˆåŒ—äº¬æ—¶é—´ï¼‰
```

**å¯¹æ¯”**ï¼štRPC ç«¯çš„ batch è·¯ç”±ä½¿ç”¨ `crypto.randomUUID()`ï¼ˆ`routers.ts:1950, 2225`ï¼‰

**é£é™©**ï¼šExpress SSE æ‰¹é‡å¤„ç†çš„ batch ID å¯é¢„æµ‹ï¼ˆç²¾ç¡®åˆ°ç§’ï¼‰ï¼Œå¤šç§Ÿæˆ·ä¸‹ç”¨æˆ· A å¯çŒœæµ‹ç”¨æˆ· B çš„ batch IDã€‚
è™½ç„¶æœ‰ auth ä¿æŠ¤ï¼ˆN1 å·²ç¡®è®¤ï¼‰ï¼Œä½†ç¼ºå°‘ ownership éªŒè¯ â†’ IDOR é£é™©ã€‚

---

#### N13ï¼ˆä¸­ï¼‰ï¼šé›¶é€Ÿç‡é™åˆ¶

æ‰€æœ‰ 88 ä¸ªç«¯ç‚¹ï¼ˆ73 tRPC + 10 SSE + 5 batchï¼‰å‡æ— é€Ÿç‡é™åˆ¶ã€‚
å¤šç§Ÿæˆ·ä¸‹ä¸€ä¸ªç”¨æˆ·å¯ä»¥ï¼š
- è€—å°½å…¨å±€ AI API é…é¢
- è§¦å‘å¤§é‡ Google Drive ä¸Šä¼ 
- åˆ›å»ºæ— é™é‡åå°ä»»åŠ¡

---

### 27.3 æ¸…å•å†…éƒ¨ä¸€è‡´æ€§ä¿®æ­£ï¼ˆ12 å¤„ï¼‰

| # | ä½ç½® | é—®é¢˜ | ä¿®æ­£ |
|---|------|------|------|
| C1 | Â§19.1 | DB æ“ä½œæ•° = 81 | **é™ˆæ—§**ï¼šÂ§25 å·²ä¿®æ­£ä¸º 91ï¼ŒÂ§19.1 æœªå›æº¯æ›´æ–° |
| C2 | Â§19.1 | Config è¯»å–æ•° = 160 | **é™ˆæ—§**ï¼šÂ§25 å·²ä¿®æ­£ä¸º 163ï¼ŒÂ§19.1 æœªå›æº¯æ›´æ–° |
| C3 | Â§19.5/Â§22 | DB æ“ä½œæ•° = 92 | **é™ˆæ—§**ï¼šÂ§25 å·²ä¿®æ­£ä¸º 91ï¼ˆ-1ï¼‰ï¼ŒÂ§22 æœªå›æº¯æ›´æ–° |
| C4 | Â§22 | Config è¯»å–æ•° = 155ï¼ˆgrep è¡Œæ•°ï¼‰ | **é™ˆæ—§**ï¼šÂ§25 å·²ä¿®æ­£ä¸º 163ï¼ˆå®é™…è°ƒç”¨æ•°ï¼‰ï¼ŒÂ§22 æœªå›æº¯æ›´æ–° |
| C5 | Â§19/Â§22 | GDrive æ“ä½œæ•° = 43 | **é™ˆæ—§**ï¼šÂ§25 å·²ä¿®æ­£ä¸º 54ï¼ˆå¤–éƒ¨è°ƒç”¨ï¼‰ï¼ŒÂ§19/Â§22 æœªå›æº¯æ›´æ–° |
| C6 | Â§23.2 | æ‰‹åŠ¨æ£€æŸ¥ç‚¹ = 116ï¼ˆ92 DB + 12 memory + 12 fire-and-forgetï¼‰ | **åº”ä¸º 115**ï¼šDB å·²ä¿®æ­£ä¸º 91 â†’ 91+12+12=115 |
| C7 | Â§25.8 | æ€»æ”¹åŠ¨ç‚¹ â‰ˆ491 | **ç®—æœ¯é”™è¯¯**ï¼š70+91+163+54+10+45+18+5+9+12 = **477**ï¼Œé 491 |
| C8 | Â§21 | classStreamRoutes è°ƒç”¨ correctionRunner/homeworkManager | **Â§25.2 å·²ä¿®æ­£**ï¼šclassStreamRoutes ä¸å¯¼å…¥è¿™äº›æ¨¡å—ï¼Œä½† Â§21 åŸæ–‡æœªæ›´æ–° |
| C9 | Â§20 | LOG_DIR ä¸¥é‡åº¦ = ä¸¥é‡ | **Â§26 ST-5 æå‡ä¸ºè‡´å‘½**ï¼šæ‰€æœ‰ç”¨æˆ·å†™å…¥åŒä¸€æ—¥å¿—æ–‡ä»¶ â†’ ä¿¡æ¯æ³„éœ² |
| C10 | Â§26.12 | N1 ä¸¥é‡åº¦ = è‡´å‘½ | **Â§27.1 å·²ä¿®æ­£ä¸º FALSE POSITIVE** |
| C11 | Â§26.13 | "N1 å‘ç°æ›´ä¸¥é‡" äº¤å‰å¼•ç”¨ | **Â§27.1 å·²ä¿®æ­£ï¼šN1 å·²åˆ é™¤** |
| C12 | Â§26.14 | "9 é¡¹æ–°å‘ç°å·²è¡¥å…¥" | **Â§27 ä¿®æ­£åä¸º 8 é¡¹**ï¼ˆN1 åˆ é™¤ï¼‰+ 4 é¡¹æ–°å¢ï¼ˆN10-N13ï¼‰= **12 é¡¹** |

**è¯´æ˜**ï¼šæœ¬æ¸…å•é‡‡ç”¨è¿½åŠ å¼æ¶æ„ï¼ˆappend-onlyï¼‰ï¼Œæ—§ç« èŠ‚æ•°å­—ä¸åšåŸåœ°ä¿®æ”¹ï¼Œ
æ‰€æœ‰ä¿®æ­£ä»¥ã€Œæœ€æ–°ç« èŠ‚ä¸ºå‡†ã€åŸåˆ™è§£å†³ã€‚æƒå¨æ•°å­—è¯·å‚ç…§ï¼š
- DB æ“ä½œï¼š**91**ï¼ˆÂ§25 / Â§27ï¼‰
- Config è¯»å–ï¼š**163**ï¼ˆÂ§25 / Â§27ï¼‰
- GDrive å¤–éƒ¨è°ƒç”¨ï¼š**54**ï¼ˆÂ§25 / Â§27ï¼‰
- æ‰‹åŠ¨æ£€æŸ¥ç‚¹ï¼š**115**ï¼ˆÂ§27ï¼‰
- æ€»æ”¹åŠ¨ç‚¹ï¼š**477**ï¼ˆÂ§27ï¼‰

---

### 27.4 éšè—ç«¯ç‚¹ä¸ Admin è§’è‰²è¾¹ç•Œå®¡è®¡

#### å®Œæ•´ HTTP ç«¯ç‚¹æ¸…å•ï¼ˆç¡®è®¤æ— é—æ¼ï¼‰

| æ¥æº | è·¯å¾„ | Auth | æ•°é‡ |
|------|------|------|------|
| OAuth | `/api/oauth/callback` | âŒï¼ˆè®¾è®¡å¦‚æ­¤ï¼šOAuth å›è°ƒï¼‰ | 1 |
| OAuth | `/api/google/callback` | âŒï¼ˆè®¾è®¡å¦‚æ­¤ï¼šOAuth å›è°ƒï¼‰ | 1 |
| classStreamRoutes | `/api/class-feedback-stream` ç­‰ 10 ä¸ª | âœ… æ¯ä¸ªè·¯ç”± `requireAuth` | 10 |
| batchRoutes | `/api/batch/*` 5 ä¸ª | âœ… æŒ‚è½½ç‚¹ `requireAuth` | 5 |
| tRPC | `/api/trpc/*` 73 ä¸ª | âœ… `protectedProcedure` / `publicProcedure` | 73 |
| Static | `/*` | âŒï¼ˆé™æ€æ–‡ä»¶ï¼‰ | 1 |
| **æ€»è®¡** | | | **91** |

#### adminProcedure ä½¿ç”¨å®¡è®¡

| è·¯ç”± | å½“å‰ Procedure | å»ºè®® |
|------|---------------|------|
| `system.notifyOwner` | adminProcedure âœ… | æ­£ç¡® |
| `config.update` | protectedProcedure âš ï¸ | â†’ adminProcedureï¼ˆN10ï¼‰ |
| `config.reset` | protectedProcedure âš ï¸ | â†’ adminProcedureï¼ˆN10ï¼‰ |
| `config.getAll` | protectedProcedure âš ï¸ | â†’ allowedEmails å­—æ®µä»… admin å¯è§ï¼ˆN11ï¼‰ |

---

### 27.5 å‰ç«¯å®Œæ•´æ‰«ææ‘˜è¦

| ç»´åº¦ | å‘ç° |
|------|------|
| tRPC è°ƒç”¨ | å‰ç«¯é€šè¿‡ `trpc.*` è°ƒç”¨ï¼Œè‡ªåŠ¨ç±»å‹æ¨æ–­ï¼Œè¿ç§»ä¸éœ€è¦å‰ç«¯ä¼  userId |
| localStorage | ä½¿ç”¨ `localStorage` ç¼“å­˜å­¦ç”Ÿåã€é…ç½®åå¥½ç­‰ï¼Œå¤šç”¨æˆ·å…±äº«æµè§ˆå™¨æ—¶æœ‰æ•°æ®æ®‹ç•™é£é™© |
| SSE è¿æ¥ | 10 ä¸ª SSE ç«¯ç‚¹ï¼Œå‰ç«¯é€šè¿‡ `EventSource` æˆ– `fetch` è¿æ¥ï¼Œå‡ä¼ é€’ cookie é‰´æƒ |
| æ–‡ä»¶ä¸Šä¼  | batch upload é€šè¿‡ `FormData`ï¼Œç» `/api/batch/upload-files` ç«¯ç‚¹ |
| å‰ç«¯è·¯ç”± | æ— ç§Ÿæˆ·éš”ç¦»ç›¸å…³è·¯ç”±ï¼ˆå¦‚ `/tenant/xxx`ï¼‰ï¼Œæ‰€æœ‰è·¯ç”±ä¸ºå•ç§Ÿæˆ·è®¾è®¡ |

**å‰ç«¯è¿ç§»å½±å“**ï¼šç”±äº userId ä» `ctx.user.id` æœåŠ¡ç«¯è·å–ï¼Œå‰ç«¯ä»£ç  **é›¶æ”¹åŠ¨**ã€‚
ä»… localStorage å¯èƒ½éœ€è¦åŠ  userId å‰ç¼€é˜²æ­¢å…±äº«æµè§ˆå™¨æ•°æ®æ³„éœ²ã€‚

---

### 27.6 N å‘ç°æ€»è¡¨ï¼ˆä¿®æ­£åï¼‰

| ç¼–å· | ä¸¥é‡åº¦ | é—®é¢˜ | æ¥æº | çŠ¶æ€ |
|------|--------|------|------|------|
| ~~N1~~ | ~~è‡´å‘½~~ | ~~batchRoutes.ts å…¨éƒ¨ç«¯ç‚¹æ— é‰´æƒ~~ | Â§26 | **âŒ FALSE POSITIVEï¼ˆå·²åˆ é™¤ï¼‰** |
| **N2** | **é«˜** | 55 è·¯ç”±ä¸è§£æ„ ctxï¼Œéœ€æ‰¹é‡ä¿®æ”¹ | Â§26â†’Â§27 é™çº§ | ç¡®è®¤ï¼ˆä»è‡´å‘½é™ä¸ºé«˜ï¼‰ |
| **N3** | **è‡´å‘½** | è¿ç§»è„šæœ¬ä¸å¯ç¡¬ç¼–ç  admin user_id=1 | Â§26 | ç¡®è®¤ |
| **N4** | **é«˜** | listStudents/listEntries/listPendingEntries æ— åˆ†é¡µ | Â§26 | ç¡®è®¤ |
| **N5** | **é«˜** | è·¨ç§Ÿæˆ·è®¿é—®æ— ä¸“ç”¨é”™è¯¯ç  | Â§26 | ç¡®è®¤ |
| **N6** | **é«˜** | è¿ç§»å‰æ—  graceful shutdown æœºåˆ¶ | Â§26 | ç¡®è®¤ |
| **N7** | **é«˜** | rclone fallback ç¡¬ç¼–ç  /home/ubuntu è·¯å¾„ | Â§26 | ç¡®è®¤ |
| **N8** | **é«˜** | UNIQUE INDEX åˆ‡æ¢éåŸå­ | Â§26 | ç¡®è®¤ |
| **N9** | **é«˜** | Schema é›¶ FK çº¦æŸ | Â§26 | ç¡®è®¤ |
| **N10** | **è‡´å‘½** | config.update/reset ç”¨ protectedProcedureï¼ˆæƒé™æå‡ï¼‰ | Â§27 æ–°å‘ç° | **NEW** |
| **N11** | **é«˜** | config.getAll æš´éœ² allowedEmails ç»™æ‰€æœ‰ç”¨æˆ· | Â§27 æ–°å‘ç° | **NEW** |
| **N12** | **é«˜** | batchRoutes batch ID å¯é¢„æµ‹ï¼ˆYYYYMMDD-HHmmssï¼‰ | Â§27 æ–°å‘ç° | **NEW** |
| **N13** | **ä¸­** | é›¶é€Ÿç‡é™åˆ¶ï¼Œèµ„æºè€—å°½é£é™© | Â§27 æ–°å‘ç° | **NEW** |

**æœ‰æ•ˆå‘ç°**ï¼š12 é¡¹ï¼ˆ2 è‡´å‘½ + 9 é«˜ + 1 ä¸­ï¼‰

---

### 27.7 æ›´æ–°åçš„ç»ˆæä¿¡å¿ƒè¯„ä¼°

| é˜¶æ®µ | æªæ–½ | ä¿¡å¿ƒ |
|------|------|------|
| Â§19 | ç²¾ç¡®ç»Ÿè®¡ | 72% |
| Â§20-Â§22 | å†…å­˜ç«æ€ + é“¾è·¯è¿½è¸ª + Grep éªŒè¯ | 92% |
| Â§23-Â§24 | æœ€ç»ˆå®¡è®¡ | 97% |
| Â§25 | äºŒæ¬¡éªŒè¯ä¿®æ­£æ•°å­— | 97%ï¼ˆç¡®è®¤ï¼‰ |
| Â§26 | 8 ç±» 57 é¡¹å…¨é‡æµ‹è¯• | 97% + 9 é¡¹æ–°å‘ç° |
| **Â§27** | **N å‘ç°é€æ¡éªŒè¯ + ä¸€è‡´æ€§ä¿®æ­£ + æ–°å‘ç°** | **98%** |

**ä¿¡å¿ƒä» 97% â†’ 98%** çš„ç†ç”±ï¼š
1. **æ¶ˆé™¤äº†ä¸€ä¸ª FALSE POSITIVE**ï¼ˆN1ï¼‰ï¼Œè¯´æ˜ä¹‹å‰çš„æµ‹è¯•æœ‰å™ªéŸ³ï¼Œç°åœ¨å·²æ¸…ç†
2. **ä¿®æ­£äº† 12 å¤„å†…éƒ¨ä¸€è‡´æ€§é—®é¢˜**ï¼Œæ¸…å•è‡ªèº«æ›´å¯é 
3. **å‘ç°äº† 4 é¡¹æ–°é—®é¢˜ï¼ˆN10-N13ï¼‰**ï¼Œå…¨éƒ¨æ–‡æ¡£åŒ–
4. **é€æ¡ä»£ç çº§éªŒè¯**äº† N2-N9ï¼Œå‡å¾—åˆ°ç¡®è®¤
5. **å®Œæ•´ç«¯ç‚¹æšä¸¾**ï¼ˆ91 ä¸ªï¼‰+ admin è§’è‰²è¾¹ç•Œå®¡è®¡å®Œæˆ

**å‰©ä½™ 2% é£é™©æ¥æº**ï¼š
- å®é™…ç¼–ç é˜¶æ®µå¯èƒ½é—æ¼ä¸ªåˆ« WHERE å­å¥ï¼ˆ115 ä¸ªæ‰‹åŠ¨æ£€æŸ¥ç‚¹ï¼‰
- é›†æˆæµ‹è¯•è¦†ç›–ç‡å–å†³äºæµ‹è¯•ç”¨ä¾‹è®¾è®¡è´¨é‡
- ç¬¬ä¸‰æ–¹ä¾èµ–ï¼ˆDrizzle ORMã€tRPCï¼‰çš„è¡Œä¸ºå‡è®¾
- æœªè¿è¡Œå®é™…é›†æˆæµ‹è¯•ï¼ˆæ— æ•°æ®åº“ / æ— æœåŠ¡ç¯å¢ƒï¼‰

---

### 27.8 æƒå¨æ•°å­—æ±‡æ€»ï¼ˆä»¥æœ¬èŠ‚ä¸ºå‡†ï¼‰

| ç»´åº¦ | æ•°é‡ | æƒå¨æ¥æº |
|------|------|---------|
| å‡½æ•°ç­¾åæ”¹åŠ¨ | 70 | Â§25.1 |
| DB æ“ä½œï¼ˆéœ€åŠ  userIdï¼‰ | 91 | Â§25.3 |
| Config è¯»å–ï¼ˆéœ€åŠ  userIdï¼‰ | 163 | Â§25.4 |
| GDrive å¤–éƒ¨è°ƒç”¨ | 54 | Â§25.5 |
| å†…å­˜çŠ¶æ€å˜é‡ | 10+2=12 | Â§25.6 |
| å‰ç«¯ config è¦†ç›– | 45 | Â§23.5 |
| æµ‹è¯•æ–‡ä»¶ | 5 | Â§23.3 |
| Fire-and-forget ç«™ç‚¹ | 6 | Â§25.7 |
| è·¨æ¨¡å—è°ƒç”¨é“¾ | 9 | Â§25.2 |
| æ‰‹åŠ¨æ£€æŸ¥ç‚¹ï¼ˆé tsc å¯æ•è·ï¼‰ | **115** | Â§27.3 C6 |
| **æ€»æ”¹åŠ¨ç‚¹** | **477** | Â§27.3 C7 |
| æœ‰æ•ˆ N å‘ç° | **12** | Â§27.6 |
| HTTP ç«¯ç‚¹æ€»æ•° | **91** | Â§27.4 |

---

### 27.9 æ¸…å•å±‚é¢å¯æ‰§è¡Œçš„æ‰€æœ‰æµ‹è¯•æ–¹æ³•æ€»ç»“

ä»¥ä¸‹æ˜¯æœ¬è½®åŠå†å²æ‰€æœ‰æµ‹è¯•è½®æ¬¡æ‰§è¡Œçš„å…¨éƒ¨æµ‹è¯•æ–¹æ³•æ¸…å•ï¼š

| æµ‹è¯•ç±»å‹ | é¦–æ¬¡æ‰§è¡Œ | æœ€æ–°éªŒè¯ | è¦†ç›–å†…å®¹ |
|---------|---------|---------|---------|
| é€æ–‡ä»¶ç²¾ç¡®ç»Ÿè®¡ | Â§19 | Â§25 | 17 ä¸ªæºæ–‡ä»¶çš„å‡½æ•°/DB/Config/GDrive è®¡æ•° |
| å†…å­˜ç«æ€åˆ†æ | Â§20 | Â§25.6 | 10 ä¸ª mutable å˜é‡ + 2 ä¸ª concern |
| é“¾è·¯è¿½è¸ªï¼ˆfire-and-forgetï¼‰ | Â§21 | Â§25.7 | 6 ä¸ª fire-and-forget ç«™ç‚¹ + è·¨æ¨¡å—é“¾è·¯ |
| Grep äº¤å‰éªŒè¯ | Â§22 | Â§27.1 | DB/Config/GDrive è®¡æ•°çš„ grep ç‹¬ç«‹éªŒè¯ |
| æœ€ç»ˆå®¡è®¡ | Â§23 | Â§27 | F1-F5, S1-S4 å‘ç° |
| ä¸šåŠ¡æµç¨‹èµ°æŸ¥ï¼ˆ12 æµç¨‹ï¼‰ | Â§26.2-26.4 | Â§27 | ä¸€å¯¹ä¸€/å°ç­è¯¾/æ‰¹é‡/ä½œä¸šæ‰¹æ”¹å…¨æµç¨‹ |
| äº¤å‰æµ‹è¯•ï¼ˆ6 é¡¹ï¼‰ | Â§26.5-26.6 | Â§27 | æ¨¡å—é—´æ¥å£ + æ•°æ®æµ |
| å›å½’æµ‹è¯•ï¼ˆ5 é¡¹ï¼‰ | Â§26.7 | Â§27 | å‘åå…¼å®¹ + æ—¢æœ‰åŠŸèƒ½ |
| å‹åŠ›æµ‹è¯•ï¼ˆ6 é¡¹ï¼‰ | Â§26.8 | Â§27 | å¹¶å‘ã€å¤§æ•°æ®é‡ã€èµ„æºç«äº‰ |
| å®‰å…¨æµ‹è¯•ï¼ˆ8 é¡¹ï¼‰ | Â§26.8 | Â§27 | IDORã€æ•°æ®æ³„éœ²ã€æƒé™æå‡ |
| è¾¹ç•Œæµ‹è¯•ï¼ˆ8 é¡¹ï¼‰ | Â§26.9 | Â§27 | NULLã€ç©ºæ•°æ®ã€å¹¶å‘å†™ |
| è¿ç§»æµ‹è¯•ï¼ˆ7 é¡¹ï¼‰ | Â§26.10 | Â§27 | é”è¡¨ã€æ•°æ®å›å¡«ã€ç´¢å¼•åˆ‡æ¢ |
| é›†æˆæµ‹è¯•ï¼ˆ5 é¡¹ï¼‰ | Â§26.11 | Â§27.1 | ctx ä½¿ç”¨ã€é‰´æƒå®Œæ•´æ€§ã€ç±»å‹æ¨æ–­ |
| éšè—ç«¯ç‚¹å®¡è®¡ | Â§27.4 | Â§27.4 | 91 ä¸ªç«¯ç‚¹å®Œæ•´æšä¸¾ |
| Admin è§’è‰²è¾¹ç•Œ | Â§27.4 | Â§27.4 | adminProcedure vs protectedProcedure |
| å‰ç«¯å®Œæ•´æ‰«æ | Â§27.5 | Â§27.5 | tRPC è°ƒç”¨ã€localStorageã€SSEã€ä¸Šä¼  |
| æ¸…å•å†…éƒ¨ä¸€è‡´æ€§è‡ªæ£€ | Â§27.3 | Â§27.3 | 12 å¤„ä¸ä¸€è‡´ä¿®æ­£ |
| N å‘ç°ä»£ç çº§é€æ¡éªŒè¯ | Â§27.1 | Â§27.1 | 9 æ¡é€ä¸€éªŒè¯ï¼ˆ1 è¯¯æŠ¥ã€8 ç¡®è®¤ï¼‰ |

**å…± 18 ç§æµ‹è¯•æ–¹æ³•**ï¼Œ**è¦†ç›– 57+ æµ‹è¯•ç”¨ä¾‹**ã€‚

åœ¨ä¸éƒ¨ç½²è¿è¡Œç¯å¢ƒçš„å‰æä¸‹ï¼ˆæ— æ•°æ®åº“ã€æ—  AI APIã€æ—  Google Driveï¼‰ï¼Œ
**ä»£ç å±‚é¢å’Œæ¸…å•å±‚é¢å¯æ‰§è¡Œçš„æ‰€æœ‰é™æ€åˆ†æã€èµ°æŸ¥ã€å®¡è®¡ç±»æµ‹è¯•å·²å…¨éƒ¨å®Œæˆ**ã€‚

---

## Â§28 æ¸…å•å†…éƒ¨ä¸€è‡´æ€§æ·±åº¦å®¡æŸ¥ï¼ˆå…¨æ–‡äº¤å‰æ¯”å¯¹ï¼‰

> æ‰§è¡Œæ—¶é—´ï¼šSession 3 Round 8
> æ–¹æ³•ï¼šå°†å…¨æ–‡ 4000+ è¡ŒæŒ‰ Â§1-Â§10 / Â§11-Â§22 / Â§23-Â§27 ä¸‰æ®µï¼Œç”± 3 ä¸ªç‹¬ç«‹å®¡æŸ¥å‘˜å¹¶è¡Œäº¤å‰æ¯”å¯¹ï¼Œç„¶åé€æ¡éªŒè¯ã€‚
> Â§27.3 å·²è¯†åˆ« 12 å¤„ä¸ä¸€è‡´ï¼ˆC1-C12ï¼‰ï¼Œæœ¬èŠ‚åœ¨æ­¤åŸºç¡€ä¸ŠæŸ¥æ‰¾ Â§27.3 **é—æ¼çš„** ä¸ä¸€è‡´ã€‚

### 28.1 Â§27.3 C9 æœ¬èº«å­˜åœ¨äº‹å®é”™è¯¯

Â§27.3 C9 åŸæ–‡ï¼š

> | C9 | Â§20 | LOG_DIR ä¸¥é‡åº¦ = ä¸¥é‡ | Â§26 ST-5 æå‡ä¸ºè‡´å‘½ |

**éªŒè¯**ï¼š
- Â§20ï¼ˆL2632ï¼‰å¯¹ LOG_DIR çš„è¯„çº§å®é™…ä¸Šå·²ç»æ˜¯ **è‡´å‘½**ï¼Œä¸æ˜¯"ä¸¥é‡"
- Â§26 ST-5ï¼ˆL3585ï¼‰ç»“æœä¸º **PASS**ï¼ˆ"per-user ç›®å½•æ–¹æ¡ˆå·²åœ¨ Â§20 å®šä¹‰"ï¼‰ï¼Œå¹¶é"æå‡ä¸ºè‡´å‘½"

**ç»“è®º**ï¼šC9 æè¿°äº†ä¸€ä¸ªä¸å­˜åœ¨çš„é—®é¢˜ã€‚Â§20 ä»ä¸€å¼€å§‹å°±å°† LOG_DIR è¯„ä¸ºè‡´å‘½ï¼ŒÂ§26 ST-5 ç¡®è®¤äº† Â§20 çš„æ–¹æ¡ˆã€‚C9 åº”åˆ é™¤ã€‚

---

### 28.2 æ–°å‘ç°çš„ä¸ä¸€è‡´ï¼ˆÂ§27.3 æœªè¦†ç›–çš„ï¼‰

#### D1ï¼ˆÂ§1ï¼‰ï¼šéœ€åŠ  userId çš„è¡¨æ•°é‡ â€” 8 vs 6

- **L24**ï¼šã€Œå…¨éƒ¨ **8** å¼ æ•°æ®è¡¨ç¼ºå°‘ userId åˆ—ï¼ˆé™¤ users è¡¨æœ¬èº«ï¼‰ã€
- **Â§2.2-Â§2.8 è¿ç§»è„šæœ¬**ï¼šå®é™…åªå¯¹ **6** å¼ è¡¨æ‰§è¡Œ ALTER TABLE ADD userId
  - âœ… google_tokens, hw_students, hw_entries, background_tasks, batch_tasks, correction_tasks
  - âŒ batch_task_itemsï¼ˆL181 æ˜ç¡®è¯´æ˜é€šè¿‡ batchId å…³è”ï¼Œä¸åŠ  userIdï¼‰
  - âŒ systemConfigï¼ˆä¿ç•™ä¸ºå…¨å±€è¡¨ï¼‰
- **L910**ï¼šã€Œéœ€æ”¹é€ çš„æ•°æ®è¡¨ | 7 å¼ ï¼ˆ+ æ–°å»º 1 å¼ ï¼‰ã€â€” ç¬¬ä¸‰ä¸ªä¸åŒçš„æ•°å­—
- **L925**ï¼šã€Œ6 å¼ è¡¨åŠ  userId + æ–°å»º user_configã€â€” è¿™æ˜¯æ­£ç¡®çš„
- **L954**ï¼šã€Œå…¨éƒ¨ 9 å¼ è¡¨å·²åˆ—å‡ºã€â€” ç¬¬å››ä¸ªä¸åŒçš„æ•°å­—ï¼ˆæŒ‡ schema.ts ä¸­æ€»å…± 9 å¼ è¡¨ï¼‰

**ç»“è®º**ï¼šL24 çš„ã€Œ8 å¼ ã€æœ‰è¯¯ï¼Œæ­£ç¡®å€¼ä¸º **6 å¼ **åŠ  userId + 1 å¼ æ–°å»º user_configã€‚

---

#### D2ï¼ˆÂ§2.1ï¼‰ï¼šuser_config é…ç½®é¡¹æ ‡é¢˜å†™ 20ï¼Œå®é™…è¡¨æ ¼ 24 è¡Œ

- **L54**ï¼šã€Œéœ€è¦è¿ç§»åˆ° user_config çš„é…ç½®é¡¹ï¼ˆ**20 ä¸ª**ï¼‰ã€
- **L58-L81 è¡¨æ ¼**ï¼šé€è¡Œè®¡æ•°ä¸º **24** é¡¹ï¼ˆapiModel, apiKey, apiUrl, currentYear, roadmap, roadmapClass, firstLessonTemplate, classFirstLessonTemplate, driveBasePath, classStoragePath, batchFilePrefix, batchStoragePath, batchConcurrency, maxTokens, gdriveLocalBasePath, gdriveDownloadsPath, modelPresets, apiProviderPresets, hwAiModel, hwPromptTemplate, corrAiModel, correctionPrompt, correctionTypes, studentLessonHistoryï¼‰

**ç»“è®º**ï¼šæ ‡é¢˜ 20 æœ‰è¯¯ï¼Œå®é™… **24** é¡¹ã€‚

---

#### D3ï¼ˆÂ§2.1ï¼‰ï¼šå…¨å±€é…ç½®æ ‡é¢˜å†™ 2ï¼Œå®é™…åªæœ‰ 1

- **L83**ï¼šã€Œä¿ç•™åœ¨ systemConfig çš„å…¨å±€é…ç½®ï¼ˆ**2 ä¸ª**ï¼‰ã€
- **L85-L88 è¡¨æ ¼**ï¼šä»… `allowedEmails` ä¸€é¡¹ï¼Œç¬¬äºŒè¡Œä¸ºã€Œï¼ˆæ— å…¶ä»–ï¼‰| â€” | â€”ã€å ä½

**ç»“è®º**ï¼šæ ‡é¢˜ 2 æœ‰è¯¯ï¼Œå®é™… **1** é¡¹ã€‚

---

#### D4ï¼štRPC è·¯ç”±æ€»æ•° â€” 74 vs 72 vs 73

- **L27, L911, L1631**ï¼š**74** ä¸ª tRPC è·¯ç”±
- **L2501ï¼ˆÂ§19ï¼‰**ï¼šã€ŒtRPC è·¯ç”±éœ€ä¼  userIdï¼š**72** ä¸ªï¼ˆå…¨éƒ¨ protectedProcedureï¼Œé™¤ auth.me å’Œ auth.logoutï¼‰ã€
- **L3891ï¼ˆÂ§27.4ï¼‰**ï¼šã€ŒtRPC | /api/trpc/* **73** ä¸ªã€

**åˆ†æ**ï¼š
- 74 = æ—©æœŸä¼°è®¡ï¼ŒåŒ…å« auth è·¯ç”±
- 72 = æ’é™¤ auth.me å’Œ auth.logout åéœ€ä¼  userId çš„è·¯ç”±
- 73 = Â§27.4 å®Œæ•´ç«¯ç‚¹æšä¸¾ä¸­çš„ tRPC è·¯ç”±æ•°

74 å’Œ 72 çš„å·®å€¼åº”è¯¥æ˜¯ 2ï¼ˆauth.me + auth.logoutï¼‰ï¼Œä½† Â§27 åˆç»™å‡ºäº† 73 è¿™ä¸ªç¬¬ä¸‰ä¸ªæ•°å­—ã€‚å®é™…ä¸Š routers.ts ä¸­ `protectedProcedure` æœ‰ 55 ä¸ªåŒ¹é… + `publicProcedure` çš„ auth è·¯ç”±ï¼Œæ€»æ•°éœ€è¦ç²¾ç¡®é‡æ–°è®¡æ•°ã€‚

**ç»“è®º**ï¼šä¸‰ä¸ªä¸åŒæ•°å­—å…±å­˜ï¼Œæœªæœ‰ç»Ÿä¸€å£å¾„ã€‚

---

#### D5ï¼šhomework è·¯ç”±æ•° â€” 20 vs 21

- **L830ï¼ˆÂ§3.2ï¼‰**ï¼šã€Œhomework è·¯ç”±ï¼ˆ**20** ä¸ª tRPCï¼‰ã€
- **L2513ï¼ˆÂ§19ï¼‰**ï¼šã€Œhomework.*ï¼š**21** ä¸ªï¼ˆ18 + 3 backupï¼‰ã€

**ç»“è®º**ï¼šä¸¤å¤„ä¸ä¸€è‡´ï¼Œå·® 1 ä¸ªã€‚

---

#### D6ï¼ˆÂ§11 vs Â§19ï¼‰ï¼šlogger.ts è¡Œæ•° â€” 291 vs 542

- **L1000ï¼ˆÂ§11.1ï¼‰**ï¼šã€Œserver/logger.tsï¼ˆ**291 è¡Œ**ï¼‰ã€
- **L2467ï¼ˆÂ§19.2ï¼‰**ï¼šã€Œserver/logger.tsï¼ˆ**542 è¡Œ**ï¼‰ã€
- **å®é™…éªŒè¯**ï¼š`wc -l logger.ts` = **541 è¡Œ**

**ç»“è®º**ï¼šÂ§11 çš„ 291 é”™è¯¯ï¼ˆå¯èƒ½æ˜¯æ—§ç‰ˆæœ¬æˆ–è®¡æ•°é”™è¯¯ï¼‰ï¼ŒÂ§19 çš„ 542 æ¥è¿‘æ­£ç¡®ï¼ˆå·® 1 è¡Œï¼Œå¯èƒ½å«/ä¸å«æœ«å°¾æ¢è¡Œï¼‰ã€‚

---

#### D7ï¼ˆÂ§11 vs Â§23ï¼‰ï¼šæµ‹è¯•æ–‡ä»¶æ•° â€” 11 vs 12

- **L1600ï¼ˆÂ§11.19ï¼‰**ï¼šã€Œå½“å‰é¡¹ç›®æœ‰ **11** ä¸ªæµ‹è¯•æ–‡ä»¶ã€
- **L2969ï¼ˆÂ§23.3ï¼‰**ï¼šã€Œé¡¹ç›®ä¸­æœ‰ **12** ä¸ªæµ‹è¯•æ–‡ä»¶ã€

**ç»“è®º**ï¼šå·® 1 ä¸ªï¼Œå¯èƒ½æ˜¯åç»­å®¡æŸ¥å‘ç°äº†é¢å¤–æµ‹è¯•æ–‡ä»¶ã€‚

---

#### D8ï¼ˆÂ§14 vs Â§23.4ï¼‰ï¼šstorage.ts æ˜¯å¦éœ€è¦æ”¹åŠ¨ â€” ç›´æ¥çŸ›ç›¾

- **L1722ï¼ˆÂ§14 æ–‡ä»¶æ¸…å•ï¼‰**ï¼š`server/storage.ts` æ ‡è®°ä¸º ğŸ†• æ–°å¢ï¼Œæè¿°ä¸ºã€ŒstoragePut æ–‡ä»¶è·¯å¾„ç”¨æˆ·éš”ç¦»ã€
- **L1909-1922ï¼ˆÂ§15.6ï¼‰**ï¼šè¯¦ç»†æè¿°äº† storagePut çš„ç”¨æˆ·éš”ç¦»æ”¹é€ æ–¹æ¡ˆ
- **L3000ï¼ˆÂ§23.4ï¼‰**ï¼šå°† `storage.ts` åˆ—å…¥ã€Œ**æ— éœ€ä»»ä½•æ”¹åŠ¨**ã€çš„ 34 ä¸ªæ–‡ä»¶ä¹‹ä¸€

**ç»“è®º**ï¼š**ç›´æ¥çŸ›ç›¾**ã€‚Â§14 å’Œ Â§15.6 æ˜ç¡®è¦æ±‚æ”¹ storage.tsï¼Œä½† Â§23.4 å£°ç§°ä¸éœ€è¦æ”¹ã€‚æ ¹æ® Â§15.6 çš„è¯¦ç»†åˆ†æï¼Œstorage.ts **éœ€è¦æ”¹åŠ¨**ï¼ŒÂ§23.4 æœ‰è¯¯ã€‚

---

#### D9ï¼šhomeworkManager.ts DB å­è®¡æ•° â€” 39 vs 41

- **L2587ï¼ˆÂ§19.4 æ’åè¡¨ï¼‰**ï¼šhomeworkManager.ts = 69 é¡¹ï¼ˆ22 å‡½æ•° + **39** DB + 5 é…ç½® + 2 fire-and-forget + 1 GDriveï¼‰
- **Â§25.3 ä¿®æ­£å**ï¼šhomeworkManager.ts DB æ“ä½œ = **41**

**ç»“è®º**ï¼šÂ§19.4 çš„ 39 æ˜¯é™ˆæ—§å€¼ï¼Œä¿®æ­£åæ€»æ•°åº”ä¸º 22+41+5+2+1 = **71**ï¼Œé 69ã€‚

---

#### D10ï¼šÂ§12 å£°ç§° GDrive å’Œ Configã€Œæ— å˜åŒ–ã€ä½†å®é™…ç¿»å€

- **L1636ï¼ˆÂ§12ï¼‰**ï¼šã€Œéœ€æ”¹é€ çš„é…ç½®è¯»å–è°ƒç”¨ | 80+ | 80+ | **æ— å˜åŒ–**ã€
- **L1637ï¼ˆÂ§12ï¼‰**ï¼šã€Œéœ€æ”¹é€ çš„ GDrive è°ƒç”¨ | 20+ | 20+ | **æ— å˜åŒ–**ã€
- **æƒå¨å€¼**ï¼šConfig = 163ï¼ˆâ‰ˆ2xï¼‰ï¼ŒGDrive = 54ï¼ˆâ‰ˆ2.7xï¼‰

**ç»“è®º**ï¼šÂ§12 çš„ã€Œæ— å˜åŒ–ã€æ ‡æ³¨æ˜¯é”™è¯¯çš„ â€” å½“æ—¶å¯èƒ½ç¡®å®æœªå‘ç°æ–°å¢ï¼Œä½†åç»­éªŒè¯è¯æ˜åˆå§‹ä¼°è®¡ä¸¥é‡åä½ã€‚

---

#### D11ï¼šÂ§11 ä¸¥é‡åº¦ emoji ä¸ä¸€è‡´ â€” ğŸ”´ vs ğŸŸ¡ åŒä¸ºã€Œé«˜å±ã€

- Â§11.1-11.6ï¼ˆL1076, 1187, 1223ï¼‰ï¼šç”¨ ğŸ”´ è¡¨ç¤ºã€Œé«˜å±ã€
- Â§11.7-11.11ï¼ˆL1275, 1298, 1336, 1384, 1424ï¼‰ï¼šç”¨ ğŸŸ¡ è¡¨ç¤ºã€Œé«˜å±ã€

**ç»“è®º**ï¼šåŒä¸€ä¸¥é‡ç­‰çº§ã€Œé«˜å±ã€åœ¨åŒä¸€ç« èŠ‚å†…ç”¨äº†ä¸¤ç§é¢œè‰²ã€‚ç–‘ä¼¼å‰åŠéƒ¨åˆ†æ˜¯ã€Œä¸¥é‡/è‡´å‘½ã€çº§ï¼ˆğŸ”´ï¼‰ï¼ŒååŠéƒ¨åˆ†æ˜¯è¾ƒä½çš„ã€Œé«˜å±ã€ï¼ˆğŸŸ¡ï¼‰ï¼Œä½†æ–‡å­—æ ‡ç­¾å‡ä¸ºã€Œé«˜å±ã€ï¼Œé€ æˆæ··æ·†ã€‚

---

#### D12ï¼šconfig.update ä¸¥é‡åº¦ â€” ä¸¥é‡ï¼ˆÂ§11.4ï¼‰vs è‡´å‘½ï¼ˆÂ§27 N10ï¼‰

- **L1113ï¼ˆÂ§11.4 æ ‡é¢˜ï¼‰**ï¼šã€Œã€**ä¸¥é‡**é—æ¼ã€‘config.update è·¯ç”±ç¼ºå°‘ admin æƒé™æ ¡éªŒã€
- **L1137ï¼ˆÂ§11.4 æ­£æ–‡ï¼‰**ï¼šã€Œé£é™©ç­‰çº§ï¼šğŸ”´ **ä¸¥é‡** â€” ç³»ç»Ÿæ¥ç®¡ã€
- **L3934ï¼ˆÂ§27 N10ï¼‰**ï¼šã€Œ**è‡´å‘½** | config.update/reset ç”¨ protectedProcedureï¼ˆæƒé™æå‡ï¼‰ã€

**ç»“è®º**ï¼šåŒä¸€é—®é¢˜ä»ã€Œä¸¥é‡ã€å‡çº§ä¸ºã€Œè‡´å‘½ã€ï¼Œä½† Â§11.4 æœªæ ‡æ³¨å‡çº§ã€‚

---

#### D13ï¼šÂ§2.9 è¿ç§»è„šæœ¬è‡ªèº«ç¼–å†™ admin id=1ï¼ŒÂ§11.9 åˆå°†å…¶æ ‡ä¸ºã€Œé—æ¼ã€

- **L197ï¼ˆÂ§2.9ï¼‰**ï¼šã€Œå­˜é‡æ•°æ®å¤„ç†ç­–ç•¥ï¼šæ‰€æœ‰ç°æœ‰æ•°æ®å½’å±ç»™ admin ç”¨æˆ·ï¼ˆid=1ï¼‰ã€
- **L212-217ï¼ˆÂ§2.9 SQLï¼‰**ï¼š`SET userId = 1`
- **L1303ï¼ˆÂ§11.9ï¼‰**ï¼šã€Œã€é«˜å±é—æ¼ã€‘è¿ç§»è„šæœ¬ä¸å¹‚ç­‰ + **admin ID ç¡¬ç¼–ç **ã€

**ç»“è®º**ï¼šÂ§2.9 æ˜¯æ¸…å•è‡ªèº«ç¼–å†™çš„è¿ç§»è„šæœ¬ï¼ŒÂ§11.9 å°†è¯¥è„šæœ¬çš„è®¾è®¡å†³ç­–æ ‡è®°ä¸ºã€Œé—æ¼ã€ã€‚è¯­ä¹‰çŸ›ç›¾â€”â€”åº”ä¸ºã€ŒÂ§2.9 è®¾è®¡ç¼ºé™·ã€è€Œéã€Œé—æ¼ã€ã€‚

---

#### D14ï¼šfire-and-forgetã€Œ6 ç«™ç‚¹ã€vsã€Œ12 æ–­è£‚ç‚¹ã€æ¦‚å¿µæ··ç”¨

- **L2871ï¼ˆÂ§22ï¼‰**ï¼šã€Œfire-and-forget æ–­ç‚¹ | **12** | 3 æ¡é“¾è·¯ä¸­çš„ userId æ–­è£‚ç‚¹ã€
- **L2962ï¼ˆÂ§23.2 å…¬å¼ï¼‰**ï¼šã€Œ12 ä¸ª fire-and-forget æ–­ç‚¹ã€ï¼ˆç”¨äºæ‰‹åŠ¨æ£€æŸ¥ç‚¹è®¡ç®—ï¼‰
- **L3980ï¼ˆÂ§27.8 æƒå¨æ•°å­—ï¼‰**ï¼šã€ŒFire-and-forget ç«™ç‚¹ | **6**ã€
- **L3997ï¼ˆÂ§27.9ï¼‰**ï¼šã€Œ**6** ä¸ª fire-and-forget ç«™ç‚¹ã€

**åˆ†æ**ï¼š
- **12 æ–­è£‚ç‚¹** = 3 æ¡é“¾è·¯ä¸­ userId ä¼ é€’æ–­å¼€çš„å…·ä½“ä½ç½®ï¼ˆæ¯ä¸ªéƒ½éœ€è¦æ‰‹åŠ¨æ£€æŸ¥ï¼‰
- **6 ç«™ç‚¹** = å®é™…çš„ fire-and-forget å‡½æ•°è°ƒç”¨ç‚¹

è¿™æ˜¯ä¸¤ä¸ªä¸åŒæŒ‡æ ‡ï¼Œä½† Â§27.8 åªåˆ—äº† 6 è€Œå…¬å¼ç”¨äº† 12ï¼Œé€ æˆè¯»è€…å›°æƒ‘ï¼š
ã€Œæ‰‹åŠ¨æ£€æŸ¥ç‚¹ = 91 DB + 12 å†…å­˜ + 12 fire-and-forget = 115ã€ä¸­çš„ 12 æ˜¯æ–­è£‚ç‚¹è¿˜æ˜¯ç«™ç‚¹ï¼Ÿ

**ç»“è®º**ï¼šÂ§27.8 åº”åŒæ—¶åˆ—å‡ºä¸¤ä¸ªæŒ‡æ ‡ï¼Œæˆ–æ ‡æ³¨ã€Œç«™ç‚¹ 6 / æ–­è£‚ç‚¹ 12ã€ä»¥æ¶ˆé™¤æ­§ä¹‰ã€‚

---

#### D15ï¼šÂ§27.7 è‡ªèº«çŸ›ç›¾ â€” ä»å†™ã€Œ9 é¡¹æ–°å‘ç°ã€

- **L3951ï¼ˆÂ§27.7 ä¿¡å¿ƒè¡¨ Â§26 è¡Œï¼‰**ï¼šã€Œ97% + **9 é¡¹æ–°å‘ç°**ã€
- **Â§27.6 åŒèŠ‚å†…**ï¼šæ˜ç¡®æ ‡æ³¨ N1 ä¸º FALSE POSITIVEï¼Œæœ‰æ•ˆå‘ç°ä» 9 é™ä¸º 8ï¼ˆÂ§26ï¼‰+ 4 æ–°å¢ï¼ˆÂ§27ï¼‰= 12

**ç»“è®º**ï¼šÂ§27.7 è¡¨æ ¼ä¸­çš„ã€Œ9 é¡¹æ–°å‘ç°ã€ä¸åŒèŠ‚çš„ Â§27.6 ç»“è®ºçŸ›ç›¾ã€‚åº”ä¸ºã€Œ8 é¡¹ç¡®è®¤ + 1 é¡¹è¯¯æŠ¥ã€æˆ–ç›´æ¥å†™ 12 é¡¹æ€»è®¡ã€‚

---

#### D16ï¼šSEC-8 è¯„çº§åœ¨ N1 çº æ­£åæœªé‡æ–°è¯„ä¼°

- **L3599ï¼ˆÂ§26.8ï¼‰**ï¼šã€ŒSEC-8 | æ‰¹é‡å–æ¶ˆ IDOR | **è‡´å‘½** | FAIL | **N1 æ–°å‘ç°ï¼ˆæ— é‰´æƒï¼‰**ã€
- **Â§27.1**ï¼šN1 å·²è¢«ç¡®è®¤ä¸º FALSE POSITIVEï¼ˆbatchRoutes æœ‰é‰´æƒï¼‰

**ç»“è®º**ï¼šSEC-8 çš„ FAIL åˆ¤å®šåŸºäºã€Œæ— é‰´æƒã€è¿™ä¸€å‰æï¼Œæ—¢ç„¶ N1 å·²æ¨ç¿»ï¼ŒSEC-8 åº”é‡æ–°è¯„ä¼°ã€‚
å®é™…ä¸Š batchRoutes æœ‰é‰´æƒä½†ç¼ºå°‘ **ownership check**ï¼ˆæŸç”¨æˆ·å¯æ“ä½œå…¶ä»–ç”¨æˆ·çš„ batchï¼‰ï¼Œæ‰€ä»¥ SEC-8 ä»å¯èƒ½æ˜¯ FAILï¼Œä½†ç†ç”±åº”ä»ã€Œæ— é‰´æƒã€æ”¹ä¸ºã€Œæ— æ‰€æœ‰æƒæ ¡éªŒã€ï¼Œä¸¥é‡åº¦å¯èƒ½ä»è‡´å‘½é™ä¸ºé«˜ã€‚

---

#### D17ï¼šÂ§26 FAIL æ€»æ•°åˆ†è§£æœªæ›´æ–°

- **L3690ï¼ˆÂ§26.14ï¼‰**ï¼šã€Œ57 é¡¹æµ‹è¯•ä¸­ **30** é¡¹ FAILï¼Œå…¶ä¸­ **21** é¡¹å·²åœ¨ Â§1-Â§25 è¦†ç›–ï¼Œ**9** é¡¹ä¸ºæœ¬æ¬¡æ–°å‘ç°ã€
- **L3721ï¼ˆÂ§27.1 N1 å½±å“ï¼‰**ï¼šã€ŒFAIL 30â†’**29**ï¼ŒPASS 12â†’**13**ã€

**ç»“è®º**ï¼šN1 çº æ­£å FAIL=29ï¼Œåˆ†è§£åº”ä¸ºï¼š20 é¡¹å·²è¦†ç›– + 8 é¡¹çœŸå®æ–°å‘ç°ï¼ˆN1 å»é™¤ï¼‰+ 1 é¡¹å˜ä¸º PASS = 29 FAILã€‚Â§26.14 çš„ 21+9=30 åˆ†è§£æœªæ›´æ–°ã€‚

---

### 28.3 ä¸ä¸€è‡´å…¨è§ˆè¡¨

å°† Â§27.3 çš„ C1-C12 ä¸æœ¬èŠ‚ D1-D17 åˆå¹¶ï¼ŒæŒ‰ç±»åˆ«æ•´ç†ï¼š

#### ç±»åˆ« Aï¼šæ•°å­—é™ˆæ—§ï¼ˆåç»­ä¿®æ­£ä½†åŸæ–‡æœªæ›´æ–°ï¼‰

| ç¼–å· | ä½ç½® | å†…å®¹ | æ­£ç¡®å€¼ | é¦–æ¬¡ä¿®æ­£ |
|------|------|------|--------|---------|
| C1 | Â§19.1 L2261 | DB = 81 | **91** | Â§25 |
| C2 | Â§19.1 L2262 | Config = 160 | **163** | Â§25 |
| C3 | Â§19.5/Â§22 | DB = 92 | **91** | Â§25 |
| C4 | Â§19.5/Â§22 | Config = 155 | **163** | Â§25 |
| C5 | Â§19/Â§22 | GDrive = 43 | **54** | Â§25 |
| C6 | Â§23.2 | æ‰‹åŠ¨æ£€æŸ¥ç‚¹ = 116 | **115** | Â§27 |
| C7 | Â§25.8 | æ€»æ”¹åŠ¨ç‚¹ â‰ˆ491 | **477** | Â§27 |
| D9 | Â§19.4 | homeworkManager DB = 39 | **41** | Â§25 |
| D10 | Â§12 | GDrive/Configã€Œæ— å˜åŒ–ã€ | å®é™…ç¿»å€ | Â§19 |

#### ç±»åˆ« Bï¼šåˆå§‹æ•°æ®ä¸å‡†ç¡®

| ç¼–å· | ä½ç½® | å†…å®¹ | æ­£ç¡®å€¼ |
|------|------|------|--------|
| D1 | Â§1 L24 | éœ€åŠ  userId çš„è¡¨ = 8 | **6** |
| D2 | Â§2.1 L54 | é…ç½®é¡¹æ ‡é¢˜ = 20 | **24** |
| D3 | Â§2.1 L83 | å…¨å±€é…ç½® = 2 | **1** |
| D4 | Â§1/Â§9/Â§27 | tRPC è·¯ç”± = 74/72/73 | å¾…ç»Ÿä¸€ |
| D5 | Â§3.2 vs Â§19 | homework è·¯ç”± = 20 vs 21 | å¾…ç¡®è®¤ |
| D6 | Â§11 L1000 | logger.ts = 291 è¡Œ | **541** |
| D7 | Â§11 vs Â§23 | æµ‹è¯•æ–‡ä»¶ = 11 vs 12 | å¾…ç¡®è®¤ |

#### ç±»åˆ« Cï¼šç›´æ¥çŸ›ç›¾

| ç¼–å· | ä½ç½® | çŸ›ç›¾å†…å®¹ |
|------|------|---------|
| D8 | Â§14/Â§15.6 vs Â§23.4 | storage.tsï¼šéœ€æ”¹åŠ¨ vs æ— éœ€æ”¹åŠ¨ |
| D13 | Â§2.9 vs Â§11.9 | admin id=1ï¼šè‡ªèº«ç¼–å†™ vs æ ‡ä¸ºã€Œé—æ¼ã€ |
| D15 | Â§27.7 vs Â§27.6 | åŒèŠ‚å†…ï¼š9 é¡¹æ–°å‘ç° vs N1 å·²ä¸ºè¯¯æŠ¥ |

#### ç±»åˆ« Dï¼šä¸¥é‡åº¦ä¸ä¸€è‡´

| ç¼–å· | ä½ç½® | å·®å¼‚ |
|------|------|------|
| C10 | Â§26.12 vs Â§27.6 | N1ï¼šè‡´å‘½ vs FALSE POSITIVE |
| D11 | Â§11 å†…éƒ¨ | é«˜å±ç”¨ ğŸ”´ å’Œ ğŸŸ¡ ä¸¤ç§é¢œè‰² |
| D12 | Â§11.4 vs Â§27 N10 | config.updateï¼šä¸¥é‡ vs è‡´å‘½ |
| D16 | Â§26.8 SEC-8 | N1 æ¨ç¿»åæœªé‡æ–°è¯„ä¼° |

#### ç±»åˆ« Eï¼šäº¤å‰å¼•ç”¨/è¯­ä¹‰é”™è¯¯

| ç¼–å· | ä½ç½® | é—®é¢˜ |
|------|------|------|
| C8 | Â§21 vs Â§25.2 | classStreamRoutes é“¾è·¯ï¼ˆå·²ä¿®æ­£ä½†åŸæ–‡æœªæ”¹ï¼‰|
| C9 | Â§27.3 | **C9 æœ¬èº«æœ‰è¯¯**ï¼šÂ§20 å·²æ˜¯è‡´å‘½ï¼Œéä¸¥é‡ |
| C11 | Â§26.13 | ä»å¼•ç”¨ã€ŒN1 å‘ç°æ›´ä¸¥é‡ã€|
| C12 | Â§26.14 | ä»å†™ã€Œ9 é¡¹æ–°å‘ç°ã€|
| D14 | Â§27.8 vs Â§23.2 | fire-and-forget 6 ç«™ç‚¹ vs 12 æ–­è£‚ç‚¹æ··ç”¨ |
| D17 | Â§26.14 | FAIL åˆ†è§£ 21+9=30 æœªæ›´æ–°ä¸º 29 |

---

### 28.4 è¯„ä¼°ç»“è®º

**Â§27.3 è¯†åˆ«äº† 12 å¤„ä¸ä¸€è‡´ï¼ˆC1-C12ï¼‰ï¼Œå…¶ä¸­ C9 æœ¬èº«æœ‰è¯¯ï¼Œå®é™…æœ‰æ•ˆ 11 å¤„ã€‚**
**æœ¬èŠ‚æ–°å¢ 17 å¤„ä¸ä¸€è‡´ï¼ˆD1-D17ï¼‰ï¼Œåˆè®¡å…¨æ–‡å…± 28 å¤„ä¸ä¸€è‡´ã€‚**

æŒ‰ä¸¥é‡ç¨‹åº¦åˆ†ç±»ï¼š

| ä¸¥é‡åº¦ | æ•°é‡ | è¯´æ˜ |
|--------|------|------|
| **ç›´æ¥çŸ›ç›¾**ï¼ˆåŒæ–‡ä»¶ä¸¤å¤„äº’ç›¸å¦å®šï¼‰ | **3** | D8, D13, D15 |
| **æ•°å€¼é™ˆæ—§**ï¼ˆåç»­ä¿®æ­£ä½†åŸæ–‡æ®‹ç•™ï¼‰ | **12** | C1-C7, D9, D10, C10-C12 |
| **åˆå§‹ä¸å‡†ç¡®**ï¼ˆé¦–æ¬¡ç»Ÿè®¡å°±æœ‰è¯¯ï¼‰ | **7** | D1-D7 |
| **ä¸¥é‡åº¦æ¼‚ç§»**ï¼ˆåŒä¸€é—®é¢˜å¤šå¤„ä¸åŒè¯„çº§ï¼‰ | **4** | D11, D12, D16, C8 |
| **æ¦‚å¿µæ··æ·†**ï¼ˆä¸åŒæŒ‡æ ‡æ··ç”¨ï¼‰ | **1** | D14 |
| **è‡ªèº«é”™è¯¯**ï¼ˆä¿®æ­£è®°å½•æœ¬èº«æœ‰è¯¯ï¼‰ | **1** | C9â†’Â§28.1 |

**å¯¹å®é™…è¿ç§»å·¥ä½œçš„å½±å“**ï¼šè¿™äº›ä¸ä¸€è‡´å…¨éƒ¨æ˜¯**æ–‡æ¡£å±‚é¢**çš„é—®é¢˜ï¼Œä¸å½±å“æ¸…å•çš„æŠ€æœ¯è¦†ç›–å®Œæ•´æ€§ã€‚æ¸…å•é‡‡ç”¨ append-only æ¶æ„ï¼Œ**ä»¥æœ€æ–°ç« èŠ‚ä¸ºå‡†**çš„åŸåˆ™ä»ç„¶æœ‰æ•ˆã€‚å¦‚éœ€ä½¿ç”¨æœ¬æ¸…å•æŒ‡å¯¼å®æ–½ï¼Œå»ºè®®ï¼š

1. **æ‰€æœ‰æ•°å­—ä»¥ Â§27.8 æƒå¨æ•°å­—è¡¨ä¸ºå‡†**
2. **N å‘ç°ä»¥ Â§27.6 æ€»è¡¨ä¸ºå‡†**ï¼ˆ12 é¡¹æœ‰æ•ˆï¼‰
3. **storage.ts ç¡®è®¤éœ€è¦æ”¹åŠ¨**ï¼ˆæŒ‰ Â§15.6 æ–¹æ¡ˆï¼‰
4. **tRPC è·¯ç”±æ€»æ•°éœ€è¦ä¸€æ¬¡ç²¾ç¡®é‡æ–°è®¡æ•°**ï¼ˆ74/72/73 ä¸‰ä¸ªå€¼å…±å­˜ï¼‰
5. **fire-and-forget åŒºåˆ†ã€Œ6 ä¸ªè°ƒç”¨ç«™ç‚¹ã€å’Œã€Œ12 ä¸ª userId æ–­è£‚ç‚¹ã€**

---

### 28.5 ä¿¡å¿ƒè¯„ä¼°æ›´æ–°

| ç»´åº¦ | è¯„ä¼° |
|------|------|
| **æŠ€æœ¯è¦†ç›–å®Œæ•´æ€§** | 98%ï¼ˆä¸å˜ â€” æ— æ–°æŠ€æœ¯é—æ¼ï¼‰ |
| **æ–‡æ¡£å†…éƒ¨ä¸€è‡´æ€§** | **72%**ï¼ˆ28 å¤„ä¸ä¸€è‡´ï¼Œå…¶ä¸­ 3 å¤„ç›´æ¥çŸ›ç›¾ï¼‰ |
| **å®æ–½å¯ç”¨æ€§** | **95%**ï¼ˆä»¥ Â§27.8 + Â§28.3 ä¸ºå‡†å³å¯æŒ‡å¯¼å®æ–½ï¼‰ |
