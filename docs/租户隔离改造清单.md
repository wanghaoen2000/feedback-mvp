# 租户隔离改造清单（完全隔离方案）

> 目标：每个用户拥有独立的配置、数据、Google Drive 凭证和存储空间
> 编制时间：2026-02-13
> 当前状态：全系统零隔离 — 所有表无 userId，配置/凭证/数据全局共享

---

## 一、整体架构现状

### 1.1 已有基础设施（可复用）

| 组件 | 状态 | 位置 |
|------|------|------|
| 用户认证（Manus OAuth） | ✅ 已完成 | `server/_core/sdk.ts`, `server/_core/oauth.ts` |
| users 表（id, openId, email, role） | ✅ 已完成 | `drizzle/schema.ts:8-23` |
| tRPC 上下文传递 user 对象 | ✅ 已完成 | `server/_core/context.ts:5-28` |
| protectedProcedure 中间件（user 保证非 null） | ✅ 已完成 | `server/_core/trpc.ts:14-37` |
| 邮箱白名单访问控制 | ✅ 已完成 | `server/_core/trpc.ts:22-26` |
| admin 角色权限 | ✅ 已完成 | `server/_core/trpc.ts:39-54` |

### 1.2 核心缺失

- **全部 8 张数据表**缺少 `userId` 列（除 users 表本身）
- **systemConfig** 全局单例，所有用户共享同一套配置
- **googleTokens** 只存一条记录，全系统共用一个 Google Drive 账号
- **74 个 tRPC 路由 + 10 个 Express SSE 端点**无 userId 过滤
- **后台任务**不记录是谁提交的
- **contentStore** 内存缓存（SSE 中间结果暂存）无用户隔离
- **Express 认证中间件**已在 `req.user` 上附带用户信息，可直接使用

---

## 二、数据库改造（Phase 1）

### 2.1 新建 user_config 表

**目的**：替代 systemConfig 作为用户级配置存储

```
文件：drizzle/schema.ts
操作：新增表定义

表结构：
  id          INT AUTO_INCREMENT PRIMARY KEY
  userId      INT NOT NULL           -- FK → users.id
  key         VARCHAR(64) NOT NULL
  value       MEDIUMTEXT NOT NULL
  description TEXT
  updatedAt   TIMESTAMP DEFAULT NOW() ON UPDATE NOW()
  UNIQUE(userId, key)                -- 复合唯一约束
```

**需要迁移到 user_config 的配置项（20 个）**：

| 配置键 | 说明 | 当前位置 |
|--------|------|----------|
| apiModel | AI 模型选择 | systemConfig |
| apiKey | API 密钥 | systemConfig |
| apiUrl | API 端点 | systemConfig |
| currentYear | 当前年份 | systemConfig |
| roadmap | 一对一路书 | systemConfig |
| roadmapClass | 小班课路书 | systemConfig |
| firstLessonTemplate | 一对一首次课范例 | systemConfig |
| classFirstLessonTemplate | 小班课首次课范例 | systemConfig |
| driveBasePath | 一对一存储路径 | systemConfig |
| classStoragePath | 小班课存储路径 | systemConfig |
| batchFilePrefix | 批量文件前缀 | systemConfig |
| batchStoragePath | 批量存储路径 | systemConfig |
| batchConcurrency | 批量并发数 | systemConfig |
| maxTokens | 最大 token 数 | systemConfig |
| gdriveLocalBasePath | GDrive 本地路径 | systemConfig |
| gdriveDownloadsPath | GDrive 下载路径 | systemConfig |
| modelPresets | 模型预设（JSON） | systemConfig |
| apiProviderPresets | 供应商预设（含密钥） | systemConfig |
| hwAiModel | 学生管理 AI 模型 | systemConfig |
| hwPromptTemplate | 学生管理提示词 | systemConfig |
| corrAiModel | 批改 AI 模型 | systemConfig |
| correctionPrompt | 批改通用提示词 | systemConfig |
| correctionTypes | 批改类型配置 | systemConfig |
| studentLessonHistory | 学生课次历史 | systemConfig |

**保留在 systemConfig 的全局配置（2 个）**：

| 配置键 | 说明 | 理由 |
|--------|------|------|
| allowedEmails | 邮箱白名单 | 全局访问控制，admin 管理 |
| （无其他） | — | — |

### 2.2 改造 google_tokens 表

**目的**：支持每人绑定自己的 Google Drive

```
文件：drizzle/schema.ts:41-48
操作：添加 userId 列

变更：
  + userId INT NOT NULL              -- FK → users.id
  + UNIQUE(userId)                   -- 每用户只有一条 token
  - 删除旧的无 userId 约束
```

**关联改造文件**：

| 文件 | 行号 | 改动 |
|------|------|------|
| `server/googleAuth.ts:97` | `db.delete(googleTokens)` | → `db.delete(googleTokens).where(eq(googleTokens.userId, userId))` |
| `server/googleAuth.ts:98-102` | `db.insert(googleTokens).values({...})` | → 添加 `userId` 字段 |
| `server/googleAuth.ts:132` | `db.select().from(googleTokens).limit(1)` | → `.where(eq(googleTokens.userId, userId)).limit(1)` |
| `server/googleAuth.ts:186-191` | `db.update(googleTokens).set(...)` | → 添加 `.where(eq(googleTokens.userId, userId))` |
| `server/googleAuth.ts:208` | `db.select().from(googleTokens).limit(1)` | → `.where(eq(googleTokens.userId, userId))` |
| `server/googleAuth.ts:223` | `db.delete(googleTokens)` | → `.where(eq(googleTokens.userId, userId))` |
| `server/googleAuth.ts:245` | `db.select().from(googleTokens).limit(1)` | → `.where(eq(googleTokens.userId, userId))` |
| `server/_core/oauth.ts:34` | `googleAuth.handleCallback(code)` | → `googleAuth.handleCallback(code, userId)` — 需从 session 中获取 userId |

**函数签名改造**：

```
getValidToken()      → getValidToken(userId: number)
handleCallback(code) → handleCallback(code: string, userId: number)
isAuthorized()       → isAuthorized(userId: number)
disconnect()         → disconnect(userId: number)
getStatus()          → getStatus(userId: number)
```

**并发刷新锁改造**：

```
server/googleAuth.ts:113
当前：let refreshPromise: Promise<string | null> | null = null;  // 全局单一锁
改为：const refreshPromises = new Map<number, Promise<string | null>>();  // 每用户一把锁
```

### 2.3 改造 hw_students 表

```
文件：drizzle/schema.ts:73-81
操作：添加 userId 列，修改唯一约束

变更：
  + userId INT NOT NULL              -- FK → users.id
  - UNIQUE(name)                     -- 删除全局唯一
  + UNIQUE(userId, name)             -- 改为每用户内唯一
```

### 2.4 改造 hw_entries 表

```
文件：drizzle/schema.ts:87-100
操作：添加 userId 列

变更：
  + userId INT NOT NULL              -- FK → users.id
```

### 2.5 改造 background_tasks 表

```
文件：drizzle/schema.ts:54-67
操作：添加 userId 列

变更：
  + userId INT NOT NULL              -- FK → users.id
```

### 2.6 改造 batch_tasks 表

```
文件：drizzle/schema.ts:106-118
操作：添加 userId 列

变更：
  + userId INT NOT NULL              -- FK → users.id
```

### 2.7 改造 batch_task_items 表

```
文件：drizzle/schema.ts:124-137
操作：不需要直接添加 userId（通过 batchId 关联到 batch_tasks.userId）
理由：子任务始终属于父批量任务，间接通过 batchId → batchTasks.userId 确定归属
```

### 2.8 改造 correction_tasks 表

```
文件：drizzle/schema.ts:143-166
操作：添加 userId 列

变更：
  + userId INT NOT NULL              -- FK → users.id
```

### 2.9 数据库迁移脚本

**存量数据处理策略**：所有现有数据归属给 admin 用户（id=1）

```sql
-- 1. 新增 user_config 表
CREATE TABLE user_config (...);

-- 2. 各表添加 userId 列（先允许 NULL，填充后改 NOT NULL）
ALTER TABLE google_tokens ADD COLUMN user_id INT NULL;
ALTER TABLE hw_students ADD COLUMN user_id INT NULL;
ALTER TABLE hw_entries ADD COLUMN user_id INT NULL;
ALTER TABLE background_tasks ADD COLUMN user_id INT NULL;
ALTER TABLE batch_tasks ADD COLUMN user_id INT NULL;
ALTER TABLE correction_tasks ADD COLUMN user_id INT NULL;

-- 3. 填充现有数据（全部归 admin）
UPDATE google_tokens SET user_id = 1;
UPDATE hw_students SET user_id = 1;
UPDATE hw_entries SET user_id = 1;
UPDATE background_tasks SET user_id = 1;
UPDATE batch_tasks SET user_id = 1;
UPDATE correction_tasks SET user_id = 1;

-- 4. 改为 NOT NULL
ALTER TABLE google_tokens MODIFY COLUMN user_id INT NOT NULL;
ALTER TABLE hw_students MODIFY COLUMN user_id INT NOT NULL;
ALTER TABLE hw_entries MODIFY COLUMN user_id INT NOT NULL;
ALTER TABLE background_tasks MODIFY COLUMN user_id INT NOT NULL;
ALTER TABLE batch_tasks MODIFY COLUMN user_id INT NOT NULL;
ALTER TABLE correction_tasks MODIFY COLUMN user_id INT NOT NULL;

-- 5. 修改 hw_students 唯一约束
ALTER TABLE hw_students DROP INDEX hw_students_name_unique;
ALTER TABLE hw_students ADD UNIQUE INDEX hw_students_user_name (user_id, name);

-- 6. google_tokens 添加用户唯一约束
ALTER TABLE google_tokens ADD UNIQUE INDEX google_tokens_user_unique (user_id);

-- 7. 迁移 systemConfig → user_config（为 admin 用户）
INSERT INTO user_config (user_id, `key`, value, description)
SELECT 1, `key`, value, description FROM system_config
WHERE `key` NOT IN ('allowedEmails');

-- 8. 清理 systemConfig 中已迁移的行（保留 allowedEmails）
DELETE FROM system_config WHERE `key` != 'allowedEmails';
```

---

## 三、核心基础设施改造（Phase 2）

### 3.1 配置读取层改造

**文件：`server/core/aiClient.ts`**

| 行号 | 当前 | 改为 |
|------|------|------|
| 61 | `getConfigValue(key: string)` | `getConfigValue(key: string, userId?: number)` |
| 65 | `db.select().from(systemConfig).where(eq(systemConfig.key, key))` | userId 存在时查 user_config；否则查 systemConfig |
| 79 | `getAPIConfig()` | `getAPIConfig(userId: number)` |

**新增函数**：

```typescript
// 读取用户配置（优先用户级，回退到全局 systemConfig）
async function getUserConfigValue(userId: number, key: string): Promise<string> {
  // 1. 查 user_config
  // 2. 没有 → 查 systemConfig（向下兼容）
  // 3. 还没有 → DEFAULT_CONFIG
}
```

**文件：`server/routers.ts:73-87`（setConfig 函数）**

```
当前：setConfig(key, value)         → 写入 systemConfig
改为：setUserConfig(userId, key, value) → 写入 user_config
保留：setGlobalConfig(key, value)   → 写入 systemConfig（仅 allowedEmails）
```

### 3.2 Google Drive 调用链改造

所有调用 `getValidToken()` 的地方需要传入 userId：

| 文件 | 行号 | 当前调用 | 改为 |
|------|------|----------|------|
| `server/gdrive.ts:55` | `getValidToken()` | `getValidToken(userId)` |
| `server/gdrive.ts:254` | `getValidToken()` | `getValidToken(userId)` |
| `server/gdrive.ts:382` | `getValidToken()` | `getValidToken(userId)` |
| `server/gdrive.ts:589` | `getValidToken()` | `getValidToken(userId)` |
| `server/gdrive.ts:675` | `getValidToken()` | `getValidToken(userId)` |
| `server/gdrive.ts:716` | `getValidToken()` | `getValidToken(userId)` |

**gdrive.ts 函数签名改造**：

```
uploadToGoogleDrive(content, fileName, folderPath, onStatus?, maxRetries?)
→ uploadToGoogleDrive(userId, content, fileName, folderPath, onStatus?, maxRetries?)

uploadBinaryToGoogleDrive(content, fileName, folderPath, onStatus?, maxRetries?)
→ uploadBinaryToGoogleDrive(userId, content, fileName, folderPath, onStatus?, maxRetries?)

uploadMultipleFiles(files, onProgress?)
→ uploadMultipleFiles(userId, files, onProgress?)

readFileFromGoogleDrive(filePath)
→ readFileFromGoogleDrive(userId, filePath)

searchFileInGoogleDrive(fileNames, searchDir?)
→ searchFileInGoogleDrive(userId, fileNames, searchDir?)

verifyFileExists(filePath)
→ verifyFileExists(userId, filePath)

ensureFolderExists(folderPath)
→ ensureFolderExists(userId, folderPath)
```

### 3.3 contentStore 用户隔离

**文件：`server/contentStore.ts`（44 行）**

当前 contentStore 用 taskId 做 key，SSE 端点在生成完后调用 `storeContent(taskId, content)` 暂存结果供前端轮询拉取。

**风险评估**：taskId 是 `crypto.randomUUID()` 生成的，实际上不可猜测，安全风险极低。但严格隔离方案下仍建议做以下改造：

```
storeContent(taskId, content, meta?)
→ storeContent(taskId, content, meta?)  // key 不需要改（UUID 已隔离）
  但 meta 中记录 userId，retrieveContent 时可选验证

retrieveContent(taskId)
→ retrieveContent(taskId, userId?)  // 可选：验证 userId 是否匹配
```

**优先级**：低。taskId 是 UUID，泄露风险极低，可后期补充。

### 3.4 Express 认证中间件（已就绪）

**文件：`server/_core/authMiddleware.ts`（66 行）**

`requireAuth` 中间件已经将 `(req as any).user = user` 挂载到请求对象上，所有 SSE 端点可通过 `req.user.id` 获取 userId。**不需要改造**，只需在 SSE 路由中使用。

### 3.5 Google Drive OAuth 回调改造

**文件：`server/_core/oauth.ts:15-46`**

当前问题：Google OAuth 回调 `/api/google/callback` 是一个 Express GET 路由，不经过 tRPC 中间件，无法获取 ctx.user。

解决方案：
1. 回调 URL 中附带加密的 userId 参数（state 参数）
2. 或在 session 中缓存当前登录用户的 userId，回调时从 session 读取

```
getAuthUrl() → getAuthUrl(userId: number)
// 将 userId 编码到 OAuth state 参数中

handleCallback(code) → handleCallback(code, userId)
// 从 state 参数中解码 userId
```

---

## 四、路由层改造（Phase 3）

### 4.1 中间件增强（可选但推荐）

**文件：`server/_core/trpc.ts`**

在 `requireUser` 中间件中将 `userId` 作为便捷属性传递：

```typescript
return next({
  ctx: {
    ...ctx,
    user: ctx.user,
    userId: ctx.user.id,  // 便捷访问
  },
});
```

### 4.2 config 路由改造

**文件：`server/routers.ts`**

| 路由 | 行号 | 改动 |
|------|------|------|
| `config.getAll` | 151 | 读取 user_config 而非 systemConfig |
| `config.update` | 242 | 写入 user_config 而非 systemConfig |
| `config.reset` | 436 | 从 user_config 删除而非 systemConfig |
| `config.getStudentHistory` | 459 | 从 user_config 读取 |
| `config.saveStudentHistory` | 472 | 写入 user_config |

### 4.3 homework 路由改造

**文件：`server/routers.ts:2477-2671`**

所有调用都需传入 `ctx.user.id`：

| 路由 | 行号 | 改动 |
|------|------|------|
| `homework.listStudents` | 2479-2483 | `listStudents(input?.status)` → `listStudents(ctx.user.id, input?.status)` |
| `homework.addStudent` | 2485-2492 | `addStudent(...)` → `addStudent(ctx.user.id, ...)` |
| `homework.updateStudent` | 2494-2504 | `updateStudent(...)` → 添加 userId 验证 |
| `homework.removeStudent` | 2506-2510 | `removeStudent(...)` → 添加 userId 验证 |
| `homework.submitEntry` | 2513-2525 | `submitAndProcessEntry(...)` → 传入 userId |
| `homework.listPendingEntries` | 2527-2530 | `listPendingEntries()` → `listPendingEntries(ctx.user.id)` |
| `homework.listEntries` | 2532-2536 | `listEntries(...)` → `listEntries(ctx.user.id, ...)` |
| `homework.listStudentEntries` | 2539-2547 | → 传入 userId |
| `homework.retryEntry` | 2549-2555 | → 验证条目归属 |
| `homework.deleteEntry` | 2557-2561 | → 验证条目归属 |
| `homework.confirmEntries` | 2563-2569 | → 传入 userId |
| `homework.confirmAll` | 2571-2576 | → 传入 userId |
| `homework.getConfig` | 2579-2589 | → 读 user_config |
| `homework.updateConfig` | 2591-2604 | → 写 user_config |
| `homework.getStudentStatus` | 2607-2612 | → 传入 userId |
| `homework.importFromExtraction` | 2615-2624 | → 传入 userId |
| `homework.importFromTask` | 2627-2636 | → 传入 userId + 验证任务归属 |
| `homework.importClassFromTask` | 2639-2649 | → 传入 userId + 验证任务归属 |
| `homework.exportBackup` | 2652-2658 | → 传入 userId |
| `homework.importBackup` | 2666-2670 | → 传入 userId |

### 4.4 feedback 路由改造

**文件：`server/routers.ts:487-1538`**

所有 feedback 路由都用 `protectedProcedure`，需要：
1. 从 `ctx.user.id` 获取 userId
2. 用 userId 读取 user_config 而非 systemConfig
3. 传 userId 给 Google Drive 上传函数

| 路由 | 行号 | 关键改动 |
|------|------|----------|
| `generateFeedback` | 489-597 | getConfig → getUserConfig(userId); uploadToGoogleDrive → uploadToGoogleDrive(userId, ...) |
| `generateReview` | 600-702 | 同上 |
| `generateTest` | 704-806 | 同上 |
| `generateExtraction` | 808-909 | 同上 |
| `generateBubbleChart` | 911-985 | 同上（不涉及上传） |
| `uploadBubbleChart` | 987-1037 | uploadBinaryToGoogleDrive → (userId, ...) |
| `verifyAll` | 1039-1072 | verifyAllFiles → 传 userId |
| `exportLog` | 1089-1136 | uploadToGoogleDrive → (userId, ...) |
| `googleAuthStatus` | 1173 | getStatus() → getStatus(userId) |
| `googleAuthUrl` | 1177 | getAuthUrl() → getAuthUrl(userId) |
| `googleAuthCallback` | 1184 | handleCallback(code) → handleCallback(code, userId) |
| `googleAuthDisconnect` | 1189 | disconnect() → disconnect(userId) |
| `generateClassFeedback` | 1197 | getUserConfig(userId, ...) |
| `generateClassReview` | 1263 | 同上 |
| `generateClassTest` | 1316 | 同上 |
| `generateClassExtraction` | 1369 | 同上 |
| `generateClassBubbleChart` | 1421 | 同上 |
| `uploadClassFile` | 1462 | uploadToGoogleDrive/uploadBinaryToGoogleDrive → (userId, ...) |

### 4.5 localFile 路由改造

**文件：`server/routers.ts:1541-1904`**

| 路由 | 行号 | 关键改动 |
|------|------|----------|
| `diagnose` | 1543-1620 | getValidToken → getValidToken(userId); getConfig → getUserConfig(userId, ...) |
| `readFromDownloads` | 1623-1783 | readFileFromGoogleDrive/searchFileInGoogleDrive → (userId, ...); getConfig → getUserConfig |
| `readLastFeedback` | 1787-1903 | readFileFromGoogleDrive → (userId, ...); getConfig → getUserConfig |

### 4.6 bgTask 路由改造

**文件：`server/routers.ts:1907-2190`**

| 路由 | 行号 | 关键改动 |
|------|------|----------|
| `submit` | 1909-1978 | INSERT 时添加 userId；taskParams 中添加 userId |
| `status` | 1981-2004 | SELECT 时添加 `.where(eq(userId, ctx.user.id))` |
| `history` | 2007-2078 | SELECT 添加 userId 过滤 |
| `feedbackContent` | 2081-2103 | SELECT 添加 userId 过滤 |
| `extractionContent` | 2106-2128 | SELECT 添加 userId 过滤 |
| `inputMaterials` | 2131-2158 | SELECT 添加 userId 过滤 |
| `cancel` | 2161-2189 | SELECT/UPDATE 添加 userId 过滤 |

### 4.7 batchTask 路由改造

**文件：`server/routers.ts:2193-2423`**

| 路由 | 行号 | 关键改动 |
|------|------|----------|
| `submit` | 2195-2294 | INSERT 时添加 userId |
| `history` | 2297-2344 | SELECT 添加 userId 过滤 |
| `items` | 2347-2378 | 间接过滤：先验证 batchId 归属当前用户 |
| `retryItem` | 2381-2393 | 验证 batchId 归属 |
| `cancel` | 2396-2422 | 验证 batchId 归属 |

### 4.8 correction 路由改造

**文件：`server/routers.ts:2674-2769`**

| 路由 | 行号 | 关键改动 |
|------|------|----------|
| `submit` | 2676-2692 | submitCorrection 传入 userId |
| `getTask` | 2695-2700 | 添加 userId 过滤 |
| `listTasks` | 2703-2711 | 添加 userId 过滤 |
| `getTypes` | 2714-2718 | 从 user_config 读取 |
| `updateTypes` | 2721-2730 | 写入 user_config |
| `getPrompt` | 2733-2737 | 从 user_config 读取 |
| `updatePrompt` | 2740-2745 | 写入 user_config |
| `getConfig` | 2748-2756 | 从 user_config 读取 |
| `updateConfig` | 2759-2768 | 写入 user_config |

### 4.9 SSE 端点改造（Express 路由）

**文件：`server/classStreamRoutes.ts`（1592 行）**

这是系统中**最大的遗漏**。该文件注册了 10 个 Express SSE 端点，全部使用 `requireAuth` 中间件，可通过 `(req as any).user.id` 获取 userId。

| 端点 | 路径 | 关键改动 |
|------|------|----------|
| 获取暂存内容 | `GET /api/feedback-content/:id` | 可选：验证 userId 归属 |
| 小班课反馈流 | `POST /api/class-feedback-stream` | getConfig → getUserConfig(userId)；uploadToGoogleDrive → (userId, ...) |
| 一对一反馈流 | `POST /api/feedback-stream` | 同上 |
| 一对一复习文档流 | `POST /api/review-stream` | 同上 |
| 一对一测试本流 | `POST /api/test-stream` | 同上 |
| 一对一信息提取流 | `POST /api/extraction-stream` | 同上 |
| 小班课复习文档流 | `POST /api/class-review-stream` | 同上 |
| 小班课测试本流 | `POST /api/class-test-stream` | 同上 |
| 小班课信息提取流 | `POST /api/class-extraction-stream` | 同上 |
| 下载 Drive 文件 | `GET /api/download-drive-file` | getValidToken → getValidToken(userId) |

**改造模式**（每个 SSE 端点内部重复）：

```typescript
// 当前：
const apiModel = input.apiModel || await getConfig("apiModel") || DEFAULT_CONFIG.apiModel;
const apiKey = input.apiKey || await getConfig("apiKey") || DEFAULT_CONFIG.apiKey;
const uploadResult = await uploadToGoogleDrive(content, fileName, folderPath);

// 改为：
const userId = (req as any).user.id;
const apiModel = input.apiModel || await getUserConfig(userId, "apiModel") || DEFAULT_CONFIG.apiModel;
const apiKey = input.apiKey || await getUserConfig(userId, "apiKey") || DEFAULT_CONFIG.apiKey;
const uploadResult = await uploadToGoogleDrive(userId, content, fileName, folderPath);
```

**Google Drive 调用清单**：

| 行号 | 调用 | 改动 |
|------|------|------|
| 457 | `uploadToGoogleDrive(content, fileName, folderPath)` | → `(userId, ...)` |
| 691 | `uploadBinaryToGoogleDrive(buffer, fileName, folderPath)` | → `(userId, ...)` |
| 854 | `uploadBinaryToGoogleDrive(...)` | → `(userId, ...)` |
| 1006 | `uploadToGoogleDrive(...)` | → `(userId, ...)` |
| 1223 | `uploadBinaryToGoogleDrive(...)` | → `(userId, ...)` |
| 1380 | `uploadBinaryToGoogleDrive(...)` | → `(userId, ...)` |
| 1517 | `uploadToGoogleDrive(...)` | → `(userId, ...)` |
| 1562 | `getValidToken()` | → `getValidToken(userId)` |

**配置读取调用清单**（每个端点重复 3-6 次，约 30+ 处）：

| 类型 | 示例行号 | 改动 |
|------|----------|------|
| `getConfig("apiModel")` | 124, 606, 769, 922, 1103, 1302, 1438 | → `getUserConfig(userId, ...)` |
| `getConfig("apiKey")` | 125, 607, 770, 923, 1104, 1303, 1439 | → 同上 |
| `getConfig("apiUrl")` | 126, 608, 771, 924, 1105, 1304, 1440 | → 同上 |
| `getConfig("driveBasePath")` | 442, 673, 838, 988, 1135, 1327, 1463 | → 同上 |
| `getConfig("classStoragePath")` | 1134, 1326, 1462 | → 同上 |
| `getConfig("currentYear")` | 127 | → 同上 |
| `getConfig("roadmapClass")` | 128 | → 同上 |

### 4.10 批量处理 Express 路由改造

**文件：`server/batch/batchRoutes.ts`（1547 行）**

该文件是批量处理的 SSE 端点（Express Router），也使用 `requireAuth` 中间件。

| 端点 | 路径 | 关键改动 |
|------|------|----------|
| 停止批量 | `POST /api/batch/stop` | 验证 batchId 归属 userId |
| 查询状态 | `GET /api/batch/status/:batchId` | 验证归属 |
| 批量生成流 | `POST /api/batch/generate-stream` | getAPIConfig → getUserAPIConfig(userId); upload → (userId, ...) |
| 重试子任务 | `POST /api/batch/retry-task` | 验证归属 + userId 传递 |
| 上传文件 | `POST /api/batch/upload-files` | 无 GDrive 操作 |

**Google Drive 调用**：

| 行号 | 调用 | 改动 |
|------|------|------|
| 414 | `ensureFolderExists(batchFolderPath)` | → `ensureFolderExists(userId, ...)` |
| 802 | `uploadBinaryToGoogleDrive(buffer, filename, folder)` | → `(userId, ...)` |
| 1277 | `uploadBinaryToGoogleDrive(...)` | → `(userId, ...)` |

**配置调用**：

| 行号 | 调用 | 改动 |
|------|------|------|
| 373 | `getAPIConfig()` | → `getAPIConfig(userId)` |
| 1033 | `getAPIConfig()` | → `getAPIConfig(userId)` |

**内存状态隔离**：

```typescript
// 当前：全局 Map，任何用户可查看/停止任何批量
const activeBatches = new Map<string, BatchStatus>();

// 改为：查询时验证 batchId 的 userId 归属
// 不需要改 Map 结构，只需在 stop/status 端点验证所有权
```

### 4.11 批量执行器改造

**文件：`server/batch/batchExecutor.ts`（296 行）**

共享工具模块，被 batchRoutes.ts 和 batchTaskRunner.ts 调用。

```
executeBatchItem(params) → executeBatchItem(userId, params)
  - 内部调用 uploadBinaryToGoogleDrive → (userId, ...)

buildBatchMessageContent(params) → 无需改（纯数据构造，不涉及 DB/配置）
```

### 4.12 系统自检改造

**文件：`server/systemCheck.ts`（585 行）**

系统自检模块，被 `feedback.systemCheck` 路由调用。

```
runSystemCheck() → runSystemCheck(userId: number)
  - 内部 getValidToken() → getValidToken(userId)
  - 内部 isOAuthAuthorized() → isOAuthAuthorized(userId)
  - 配置读取从 systemConfig → getUserConfig(userId, ...)
```

**注意**：自检结果会因用户不同而不同（每人的 Google Drive 授权状态、API Key 配置状态不同）。

---

## 五、业务逻辑层改造（Phase 4）

### 5.1 homeworkManager.ts 改造

**文件：`server/homeworkManager.ts`（923 行）**

**函数签名改造**（全部需要添加 userId 参数）：

| 函数 | 行号 | 改动 |
|------|------|------|
| `listStudents(statusFilter?)` | 97 | → `listStudents(userId, statusFilter?)` |
| `addStudent(name, planType)` | 108 | → `addStudent(userId, name, planType)` |
| `updateStudent(id, data)` | 130 | → `updateStudent(userId, id, data)` + 验证归属 |
| `removeStudent(id)` | 147 | → `removeStudent(userId, id)` + 验证归属 |
| `getStudentLatestStatus(studentName)` | 185 | → `getStudentLatestStatus(userId, studentName)` |
| `submitAndProcessEntry(studentName, rawInput, aiModel?)` | 304 | → 添加 userId |
| `createEntry(studentName, rawInput, aiModel?)` | 286 | → 添加 userId |
| `processEntry(studentName, rawInput, aiModel?, onProgress?)` | 212 | → 读取 user_config |
| `listEntries(statusFilter?)` | 379 | → `listEntries(userId, statusFilter?)` |
| `listPendingEntries()` | 392 | → `listPendingEntries(userId)` |
| `listStudentEntries(studentName, limit, offset)` | 404 | → 添加 userId |
| `retryEntry(id)` | 427 | → 添加 userId + 验证归属 |
| `deleteEntry(id)` | 481 | → 添加 userId + 验证归属 |
| `confirmEntries(ids)` | 489 | → 添加 userId |
| `confirmAllPreStaged()` | 523 | → `confirmAllPreStaged(userId)` |
| `importFromExtraction(studentName, content)` | 562 | → 添加 userId |
| `importFromTaskExtraction(taskId, studentName)` | 604 | → 添加 userId + 验证任务归属 |
| `importClassFromTaskExtraction(taskId, className, students)` | 637 | → 添加 userId |
| `exportStudentBackup()` | 708 | → `exportStudentBackup(userId)` |
| `importStudentBackup(content)` | 854 | → `importStudentBackup(userId, content)` |
| `autoBackupToGDrive()` | 900 | → `autoBackupToGDrive(userId)` — 上传到用户自己的 GDrive |

**查询改造**（添加 userId 过滤）：

| 行号 | 当前 | 改为 |
|------|------|------|
| 102-104 | `db.select().from(hwStudents)` | 添加 `.where(eq(hwStudents.userId, userId))` |
| 113-115 | `db.select().from(hwStudents).where(eq(hwStudents.name, name))` | 添加 `and(eq(hwStudents.userId, userId), ...)` |
| 126 | `db.insert(hwStudents).values({...})` | 添加 `userId` 字段 |
| 143 | `db.update(hwStudents).set(...).where(eq(hwStudents.id, id))` | 添加 userId 条件 |
| 151 | `db.update(hwStudents).set({status: "inactive"}).where(...)` | 添加 userId 条件 |
| 190-197 | `db.select().from(hwEntries).where(...)` | 添加 userId 条件 |
| 204-208 | `db.select().from(hwStudents).where(...)` | 添加 userId 条件 |
| 290-295 | `db.insert(hwEntries).values({...})` | 添加 `userId` 字段 |
| 396-400 | `db.select().from(hwEntries).where(...)` | 添加 userId 条件 |
| 409-422 | `db.select().from(hwEntries).where(...)` | 添加 userId 条件 |
| 512-514 | `db.update(hwStudents).set(...).where(eq(hwStudents.name, name))` | 添加 userId 条件 |
| 529-531 | `db.select().from(hwEntries).where(...)` | 添加 userId 条件 |
| 545-548 | `db.update(hwStudents).set(...).where(eq(hwStudents.name, name))` | 添加 userId 条件 |
| 572-574 | `db.select().from(hwStudents).where(...)` | 添加 userId 条件 |
| 576-580 | `db.insert(hwStudents).values({...})` | 添加 userId 字段 |
| 713-715 | `db.select().from(hwStudents).where(...)` | 添加 userId 条件 |
| 870-873 | `db.select().from(hwStudents).where(...)` | 添加 userId 条件 |

**配置读取改造**（processEntry 函数内）：

| 行号 | 当前 | 改为 |
|------|------|------|
| 219 | `getConfigValue("apiKey")` | `getUserConfigValue(userId, "apiKey")` |
| 220 | `getConfigValue("apiUrl")` | `getUserConfigValue(userId, "apiUrl")` |
| 221 | `getConfigValue("apiModel")` | `getUserConfigValue(userId, "apiModel")` |
| 224 | `getConfigValue("hwPromptTemplate")` | `getUserConfigValue(userId, "hwPromptTemplate")` |

### 5.2 backgroundTaskRunner.ts 改造

**文件：`server/backgroundTaskRunner.ts`（1015 行）**

**关键改造点**：后台任务在 fire-and-forget 模式下运行，需要从任务参数中获取 userId。

方案：在 `inputParams` JSON 中嵌入 userId，后台运行时从中取出。

| 行号 | 改动 |
|------|------|
| 220-249（runTask） | 从 `task.inputParams` 中取 userId（或从新增的 backgroundTasks.userId 列读取） |
| 254-552（runOneToOneTask） | 所有 getConfig → getUserConfig(userId)；所有 upload → upload(userId, ...) |
| 557-898（runClassTask） | 同上 |
| 903-937（cleanupOldTasks） | 无需改造（按时间清理，不区分用户） |
| 980-1014（recoverInterruptedTasks） | 无需改造（标记所有 running 为失败，不区分用户） |

**配置读取改造（runOneToOneTask 内）**：

| 行号 | 当前 | 改为 |
|------|------|------|
| 262 | `getConfig("apiModel")` | `getUserConfig(userId, "apiModel")` |
| 263 | `getConfig("apiKey")` | `getUserConfig(userId, "apiKey")` |
| 264 | `getConfig("apiUrl")` | `getUserConfig(userId, "apiUrl")` |
| 265 | `getConfig("roadmap")` | `getUserConfig(userId, "roadmap")` |
| 266 | `getConfig("driveBasePath")` | `getUserConfig(userId, "driveBasePath")` |
| 267 | `getConfig("currentYear")` | `getUserConfig(userId, "currentYear")` |

**Google Drive 上传改造（runOneToOneTask 内）**：

| 行号 | 当前 | 改为 |
|------|------|------|
| 332 | `uploadToGoogleDrive(content, fileName, folderPath)` | `uploadToGoogleDrive(userId, content, fileName, folderPath)` |
| 429 | `uploadBinaryToGoogleDrive(buffer, fileName, folderPath)` | `uploadBinaryToGoogleDrive(userId, buffer, fileName, folderPath)` |
| 452 | `uploadBinaryToGoogleDrive(...)` | 同上 |
| 475 | `uploadToGoogleDrive(...)` | 同上 |
| 488 | `uploadBinaryToGoogleDrive(...)` | 同上 |
| 537 | `uploadToGoogleDrive(logContent, ...)` | 同上 |

**小班课任务同理**（runClassTask 内，行号 564-897）。

### 5.3 batchTaskRunner.ts 改造

**文件：`server/batch/batchTaskRunner.ts`**

与 backgroundTaskRunner 类似：

- 从 `batchTasks.userId` 列或 `inputParams` 中获取 userId
- 所有 `getConfig(...)` → `getUserConfig(userId, ...)`
- 所有 `uploadBinaryToGoogleDrive(...)` → `uploadBinaryToGoogleDrive(userId, ...)`
- `ensureFolderExists(...)` → `ensureFolderExists(userId, ...)`

### 5.4 correctionRunner.ts 改造

**文件：`server/correctionRunner.ts`**

- `submitCorrection(input)` → `submitCorrection(userId, input)` — INSERT 时添加 userId
- `getCorrectionTask(id)` → 添加 userId 过滤
- `listCorrectionTasks(studentName?, limit?)` → 添加 userId 过滤
- `getCorrectionTypes()` → 从 user_config 读取
- `getCorrectionPrompt()` → 从 user_config 读取
- `processCorrection(taskId)` 内部读取用户配置
- 配置读取：`getConfigValue("correctionTypes")` → `getUserConfigValue(userId, "correctionTypes")`
- 配置读取：`getConfigValue("correctionPrompt")` → `getUserConfigValue(userId, "correctionPrompt")`

### 5.5 autoBackupToGDrive 改造

**文件：`server/homeworkManager.ts:900-922`**

- 接收 userId 参数
- `getConfig("driveBasePath")` → `getUserConfig(userId, "driveBasePath")`
- `uploadToGoogleDrive(content, fileName, folderPath)` → `uploadToGoogleDrive(userId, content, ...)`

### 5.6 ensureHwTables / ensureTable 建表脚本改造

**文件**：
- `server/homeworkManager.ts:17-93`（CREATE TABLE hw_students / hw_entries）
- `server/backgroundTaskRunner.ts:942-974`（CREATE TABLE background_tasks）

需要在 CREATE TABLE 中添加 `user_id` 列，在 safeAddColumn 中处理兼容。

---

## 六、前端改造（Phase 5）

### 6.1 前端改动极小

由于隔离在服务端 API 层实现，前端 tRPC 调用**不需要传 userId**（session 自动携带），大部分前端代码**不需要修改**。

### 6.2 localStorage 用户隔离

**文件：`client/src/pages/Home.tsx`**

| 行号 | 当前 Key | 改为 |
|------|----------|------|
| 486 | `studentLessonHistoryV2` | `studentLessonHistoryV2_${user.id}` |
| 516 | 同上 | 同上 |
| 531 | 同上 | 同上 |
| 605 | 同上 | 同上 |

**文件：`client/src/components/DashboardLayout.tsx`**

| 行号 | 当前 Key | 改为 |
|------|----------|------|
| 35 | `sidebar-width` | `sidebar-width_${user.id}` |
| 46 | 同上 | 同上 |
| 52 | 同上 | 同上 |

**文件：`client/src/contexts/ThemeContext.tsx`**

| 行号 | 当前 Key | 改为 |
|------|----------|------|
| 26 | `theme` | `theme_${user.id}` |
| 41 | 同上 | 同上 |

### 6.3 Google Drive 授权 UI

**文件：`client/src/components/GlobalSettings.tsx`**

当前授权状态显示的是全局的。改为每用户独立后，不需要 UI 改动（后端返回的状态已经是当前用户的了）。

---

## 七、实施顺序与依赖关系

```
Phase 1: 数据库改造（无依赖）
  ├── 1.1 新建 user_config 表
  ├── 1.2 所有表添加 userId 列
  ├── 1.3 存量数据迁移
  └── 1.4 修改唯一约束

Phase 2: 核心基础设施（依赖 Phase 1）
  ├── 2.1 配置读取层 getUserConfigValue()
  ├── 2.2 googleAuth.ts 全面改造（userId 参数）
  ├── 2.3 gdrive.ts 全面改造（userId 参数）
  └── 2.4 trpc.ts 中间件增强（ctx.userId）

Phase 3: 路由层改造（依赖 Phase 2）
  ├── 3.1 config 路由（5 个 tRPC）
  ├── 3.2 homework 路由（20 个 tRPC）
  ├── 3.3 feedback 路由（18 个 tRPC）
  ├── 3.4 localFile 路由（3 个 tRPC）
  ├── 3.5 bgTask 路由（7 个 tRPC）
  ├── 3.6 batchTask 路由（5 个 tRPC）
  ├── 3.7 correction 路由（9 个 tRPC）
  ├── 3.8 classStreamRoutes SSE（10 个 Express）  ← 新增
  ├── 3.9 batchRoutes SSE（5 个 Express）          ← 新增
  └── 3.10 systemCheck（1 个 tRPC，调用改造后的函数）

Phase 4: 业务逻辑层（依赖 Phase 2，可与 Phase 3 并行）
  ├── 4.1 homeworkManager.ts（20+ 函数）
  ├── 4.2 backgroundTaskRunner.ts（配置 + 上传）
  ├── 4.3 batchTaskRunner.ts（配置 + 上传）
  ├── 4.4 correctionRunner.ts（配置 + 查询）
  ├── 4.5 batchExecutor.ts（上传函数签名）      ← 新增
  └── 4.6 systemCheck.ts（配置 + GDrive 检查）   ← 新增

Phase 5: 前端（依赖 Phase 3）
  └── 5.1 localStorage key 加 userId 前缀（3 个文件）

Phase 6: OAuth 回调（依赖 Phase 2）
  └── 6.1 Google OAuth callback 传递 userId
```

---

## 八、风险与注意事项

### 8.1 后台任务的 userId 传递

后台任务（backgroundTask, batchTask）在 `fire-and-forget` 模式下运行，脱离了 HTTP 请求上下文。必须确保 userId 在任务创建时持久化到数据库，运行时从数据库读取，而非从请求上下文获取。

**方案**：
- 任务表已有 `userId` 列 → 运行器从 DB 读取
- 同时在 `inputParams` JSON 中也保存 userId（双保险）

### 8.2 Google OAuth 回调中的用户识别

Google OAuth 回调是 GET 请求，不经过 tRPC。需要在发起授权时将 userId 编码到 OAuth `state` 参数中，回调时解码。

**安全考虑**：state 参数需加密或签名，防止伪造。

### 8.3 并发安全

- `getValidToken(userId)` 的并发刷新锁需改为 `Map<userId, Promise>`
- 多用户同时操作 Google Drive 文件夹创建需注意 `pendingFolderOps` 缓存隔离

### 8.4 存量数据兼容

- 迁移脚本必须在应用停机时执行
- systemConfig → user_config 迁移后，旧的 systemConfig 行应清理
- 确保 admin 用户 id=1 存在

### 8.5 ensureTable 兼容

`homeworkManager.ts` 和 `backgroundTaskRunner.ts` 中有 `CREATE TABLE IF NOT EXISTS` 自动建表逻辑。需要更新这些 SQL，添加 `user_id` 列，并加 `safeAddColumn` 兼容处理。

---

### 8.6 gdrive.ts 的 pendingFolderOps 缓存

**文件：`server/gdrive.ts`**

`pendingFolderOps` 是文件夹创建去重缓存（避免并发创建同名文件夹）。当前是全局 Map，不同用户的文件夹路径天然不同（因为 basePath 不同），所以**不需要按 userId 隔离此缓存**。但如果两个用户恰好配置了相同的 basePath，可能会互相缓存命中。

**建议**：将缓存 key 改为 `${userId}:${folderPath}`，简单且安全。

### 8.7 previewBackup / parseBackupContent 辅助函数

**文件：`server/homeworkManager.ts`**

`parseBackupContent()` 和 `previewBackup()` 是纯文本解析工具函数，不访问数据库，**不需要改造**。

---

## 九、改造统计

| 类别 | 数量 |
|------|------|
| 需改造的数据表 | 7 张（+ 新建 1 张） |
| 需改造的 tRPC 路由 | 74 个 |
| 需改造的 Express SSE 端点 | 15 个 |
| 需改造的后端文件 | 17 个 |
| 需改造的函数签名 | 50+ 个 |
| 需改造的 DB 查询 | 60+ 处 |
| 需改造的配置读取调用 | 80+ 处 |
| 需改造的 GDrive 调用 | 20+ 处 |
| 需改造的前端文件 | 3 个 |
| 数据库迁移步骤 | 8 步 |

### 涉及文件完整列表

| 文件 | 改动量 | 说明 |
|------|--------|------|
| `drizzle/schema.ts` | 大 | 6 张表加 userId + 新建 user_config |
| `server/core/aiClient.ts` | 中 | 配置读取层改造（getUserConfigValue） |
| `server/googleAuth.ts` | 大 | 全面 userId 参数化（5 个函数） |
| `server/gdrive.ts` | 大 | 全面 userId 参数化（8 个函数） |
| `server/_core/oauth.ts` | 中 | Google OAuth 回调传递 userId |
| `server/_core/trpc.ts` | 小 | 中间件增加 ctx.userId |
| `server/_core/authMiddleware.ts` | 无 | 已挂载 req.user，不需改 |
| `server/routers.ts` | 很大 | 74 个 tRPC 路由全部改造 |
| `server/classStreamRoutes.ts` | 很大 | 10 个 SSE 端点全部改造（1592 行） |
| `server/batch/batchRoutes.ts` | 大 | 5 个 Express 端点改造（1547 行） |
| `server/batch/batchExecutor.ts` | 小 | executeBatchItem 加 userId |
| `server/batch/batchTaskRunner.ts` | 大 | 配置 + Google Drive 改造 |
| `server/homeworkManager.ts` | 大 | 20+ 函数全部加 userId |
| `server/backgroundTaskRunner.ts` | 大 | 配置 + Google Drive 改造 |
| `server/correctionRunner.ts` | 中 | 查询 + 配置改造 |
| `server/systemCheck.ts` | 中 | getValidToken + 配置改造 |
| `server/contentStore.ts` | 小 | 可选：meta 中记录 userId |
| `client/src/pages/Home.tsx` | 小 | localStorage key 加用户前缀 |
| `client/src/components/DashboardLayout.tsx` | 小 | localStorage key 加用户前缀 |
| `client/src/contexts/ThemeContext.tsx` | 小 | localStorage key 加用户前缀 |

---

## 十、验证记录

### 第一轮：完整性检查

| 检查项 | 结果 | 补充内容 |
|--------|------|----------|
| 数据表覆盖 | ✅ 全部 9 张表已列出 | — |
| 配置键覆盖 | ✅ 全部 25 个用户配置 + 1 个全局配置 | — |
| tRPC 路由计数 | ⚠️ 修正 | 66 → 74（差 auth 2 + config 1 + feedback/list 等） |
| Express 端点 | ❌ 遗漏 | 新增 classStreamRoutes.ts（10 端点）、batchRoutes.ts（5 端点） |
| 后端文件 | ❌ 遗漏 | 新增 classStreamRoutes.ts、batchRoutes.ts、batchExecutor.ts、systemCheck.ts |
| 前端 localStorage | ⚠️ 补充 | 新增 sidebar-width（DashboardLayout）、theme（ThemeContext） |
| 辅助函数 | ✅ 确认 | parseBackupContent / previewBackup 不需改造 |

### 第二轮：合理性检查

| 检查项 | 结果 | 说明 |
|--------|------|------|
| user_config 方案 | ✅ 合理 | 用户级配置独立存储，全局配置保留 systemConfig |
| Google Drive 每人一套 OAuth | ✅ 合理 | googleTokens 加 userId + UNIQUE(userId) |
| batch_task_items 不加 userId | ✅ 合理 | 通过 batchId → batchTasks.userId 间接关联 |
| 存量数据归 admin | ✅ 合理 | 简单可行，admin id=1 已在 db.ts 中默认创建 |
| 后台任务从 DB 读 userId | ✅ 合理 | 避免闭包引用过期上下文 |
| OAuth state 传 userId | ✅ 合理 | 标准 OAuth 2.0 做法，需签名防伪造 |
| contentStore 不改 key | ✅ 合理 | UUID 不可猜测，安全性足够 |
| 配置回退链 | ✅ 合理 | user_config → systemConfig → DEFAULT_CONFIG |
| Phase 顺序 | ✅ 合理 | 依赖关系正确：schema → infra → routes → logic → frontend |

### 第三轮：逻辑正确性检查

| 检查项 | 结果 | 说明 |
|--------|------|------|
| hw_students 唯一约束变更 | ✅ 正确 | `UNIQUE(name)` → `UNIQUE(userId, name)`，不同用户可有同名学生 |
| ensureHwTables 建表 SQL | ⚠️ 需注意 | 建表 SQL 中要加 `user_id` 列；safeAddColumn 兼容旧表 |
| confirmEntries 跨表操作 | ⚠️ 需注意 | 按 studentName + userId 定位学生，而非仅 studentName |
| processEntry 的 userId 传递 | ✅ 正确 | 通过函数参数传递，不依赖全局状态 |
| 后台任务 config 快照 vs 实时读取 | ✅ 正确 | 当前已在 inputParams 中快照 apiModel/apiKey 等，userId 也从 DB 列读取 |
| autoBackupToGDrive fire-and-forget | ⚠️ 需注意 | 必须在调用时捕获 userId，不能依赖后续上下文 |
| 迁移脚本 admin id=1 | ⚠️ 需确认 | 迁移前需确认 admin 用户的实际 id 值 |
| Google Drive 文件夹缓存 | ⚠️ 需注意 | pendingFolderOps key 建议改为 `${userId}:${folderPath}` |
| 并发刷新锁 Map 内存泄漏 | ⚠️ 需注意 | refreshPromises Map 需在 Promise resolve 后清理 entry |
