# 迭代记录

本文档记录托福阅读学情反馈系统（feedback-mvp）从V1到V169的完整迭代历史。

---

## 版本总览

| 版本 | 阶段 | 一句话概括 |
|------|------|-----------|
| V1-V3 | 原型验证 | 技术栈跑通，核心功能实现 |
| V4-V12 | 功能完善 | 路书规范、高级设置、容错机制 |
| V13-V22 | 稳定性优化 | API切换、回滚恢复、流式输出 |
| V23-V28 | 简化迭代 | 去掉冗余，直接用原文 |
| V29-V33 | 日志与版控 | 日志系统、GitHub迁移 |
| V34-V38 | OAuth授权 | Google OAuth自助授权 |
| V39-V41 | 并发修复 | 并发隔离、日志导出修复 |
| V42-V44 | 小班课 | 气泡图乱码修复、小班课功能 |
| V45系列 | SSE改造 | 端到端SSE流式输出 |
| V46 | 批量处理 | 并发池模式批量生成文档 |
| V47 | 模板系统 | 词汇卡片精确排版模板 |
| V48 | 批量增强 | Markdown解析器升级、文件上传 |
| V49 | 配置增强 | 版本号显示、max_tokens可配置、截断检测 |
| V50 | 用户体验 | 模板格式说明、一键复制、写作素材模板 |
| V51 | 文档处理 | 文档转文字、XML来源标签 |
| V52 | AI代码生成 | AI生成docx-js代码，沙箱执行生成Word |
| V53 | 版本显示 | 页面右上角显示版本号 |
| V56 | 文档提取 | PDF/DOCX文本提取 |
| V58 | 发布修复 | 发布过程配置错误修复 |
| V60 | 系统修复 | AI代码生成系统问题修复 |
| V61 | 状态修复 | 步骤状态更新问题修复 |
| V62 | 步骤跳过 | 支持跳过不需要的步骤 |
| V63 | 多项优化 | 安全修复 + 并行生成 + 小班课优化 |
| V64 | 任务重做 | 单任务重做 + SSE稳定性 |
| V65 | 指定任务 | 批量处理支持指定任务编号 |
| V66-V67 | 协作规范 | 版本号发布检查清单、Manus协作指南补充 |
| V68-V71 | SSE传输修复 | 分块传输丢失 → 内存暂存+HTTP拉取 |
| V72-V100 | 大规模功能开发 | AI输出质量、健壮性、小班课完善、前端优化 |
| V101-V102 | TypeScript修复 | 字段缺失和重复定义修复 |
| V103-V111 | Google Drive集成 | 自动提取录音/反馈、OAuth API读取、三级搜索 |
| V112-V118 | 后台任务系统 | 后台任务引入、数据库升级、并发控制 |
| V119-V128 | 用户体验完善 | 防重复点击、非流式改造、截断续写、字体修复 |
| V129-V134 | 气泡图引擎重构 | resvg替代sharp、本地字体加载、COLLAB看板 |
| V137-V147 | 体验优化与功能补全 | 模型选择器、下载按钮、多段录音、查看素材 |
| V148-V152 | 作业管理系统 | 学生名册、语音AI处理、预入库、记录浏览 |
| V153-V164 | 作业管理完善+系统优化 | 提示词系统、迭代更新、API供应商预设、实时进度 |
| V165-V169 | 项目文档整理 | 知识交接文档、完整文档库合并、冗余清理 |

---

## 阶段一：原型验证（V1-V3）

### V1 - 初始版本
- **变更**：简单算术测试，验证技术栈可行性
- **目的**：确认 React + tRPC + Node.js 技术选型能跑通

### V2 - 核心功能
- **变更**：实现5个文档生成的完整功能
- **里程碑**：核心业务逻辑首次完成

### V3 - 用户体验
- **变更**：添加状态显示和结果反馈
- **目的**：让用户知道当前进度和生成结果

---

## 阶段二：功能完善（V4-V12）

### V4 - 路书规范化
- **变更**：V9路书格式规范写入提示词
- **目的**：统一AI生成文档的格式标准

### V5 - API切换
- **变更**：切换到神马中转API
- **原因**：原API不稳定或成本问题

### V6-V9 - 细节优化
- **变更**：若干细节调整（具体内容待补充）

### V10 - 架构重构 ⭐
- **变更**：多轮API重构，拆分为5个独立端点
- **意义**：每个文档独立生成，便于单步重试，一个失败不影响其他
- **经验**：这是一个关键的架构决策，大幅提升了系统的容错能力

### V11 - 可配置性
- **变更**：添加高级设置区域，配置持久化到数据库
- **功能**：API密钥、模型名称、路书等都可配置，重启不丢失

### V12 - 单步重试
- **变更**：添加单步重试功能
- **目的**：失败的步骤可以单独重试，不用从头来

---

## 阶段三：稳定性优化（V13-V22）

### V13-V14 - 过渡版本
- **变更**：若干调整（具体内容待补充）

### V15 - API再次切换
- **变更**：从神马中转API切换到DMXapi
- **原因**：神马API稳定性问题
- **教训**：选API要考虑稳定性，不只是价格

### V16 - 回滚恢复 ⚠️
- **变更**：回滚后重新实现丢失的功能
- **背景**：某次回滚操作导致部分功能代码丢失
- **教训**：没有版本管理是大坑，回滚前必须备份

### V17 - 功能补全
- **变更**：
  - 添加停止按钮，生成过程中可取消
  - 路书正式用于AI提示词

### V18 - 路书应用范围修复
- **变更**：让复习文档、测试本、课后信息提取也使用自定义V9路书
- **之前问题**：只有学情反馈用路书，其他文档用默认提示词

### V19 - 气泡图路书支持
- **变更**：气泡图生成也使用自定义V9路书

### V20 - 录音分段压缩
- **变更**：实现录音转文字分段压缩功能
- **后续**：V26取消了这个功能

### V21 - max_tokens修复
- **变更**：whatai.ts 默认 max_tokens 从8000改为16000
- **解决问题**：输出截断问题

### V22 - 流式输出 ⭐
- **变更**：所有AI调用改为SSE流式返回
- **解决问题**：长文档生成时的超时问题
- **技术方案**：使用Server-Sent Events，边生成边返回

---

## 阶段四：简化迭代（V23-V28）

### V23 - 路书直用 ⭐
- **变更**：直接使用V9路书原文作为系统提示词，不再转述
- **之前做法**：让AI先"理解"路书，再生成内容
- **改进后**：直接把路书原文塞给AI
- **效果**：生成质量明显提升
- **教训**：有时候简单粗暴比精心设计更有效

### V24 - 全面流式化
- **变更**：录音压缩和气泡图提取也改为流式输出

### V25 - 简化压缩
- **变更**：取消分段压缩，改成一次性压缩
- **后续**：V26进一步取消了整个压缩步骤

### V26 - 去掉录音压缩
- **变更**：取消录音转文字的压缩步骤，直接使用原文
- **之前做法**：先压缩录音转文字，再给AI
- **改进后**：直接用原文
- **教训**：能省的步骤就省，多一步处理多一步出错

### V27 - 气泡图改进
- **变更**：AI直接按V9路书生成SVG格式气泡图
- **流程**：AI生成SVG → 转换为PNG → 上传

### V28 - 边界限制
- **变更**：添加文档生成边界限制
- **目的**：告诉AI只生成当前文档，避免越界生成其他内容

---

## 阶段五：日志系统与GitHub迁移（V29-V33）

### V29 - 调试"Failed to fetch"错误
- **问题**：生成文档时随机出现"Failed to fetch"错误，无法定位原因
- **排查过程**：
  - 错误只在真实数据测试时出现，短文本测试正常
  - 怀疑是API响应时间波动导致
- **临时解决**：增加API调用的超时时间

### V30 - 日志系统初步实现
- **需求**：需要记录每次生成的详细信息，便于排查问题
- **实现**：
  - 创建 server/logger.ts 模块
  - 记录每个步骤的开始时间、结束时间、耗时
  - 记录成功/失败状态和错误信息
  - 日志保存到 /tmp/feedback-logs/ 目录
- **日志格式**：
  ```
  === 反馈生成日志 ===
  学生: 张三
  开始时间: 2026-01-08 10:30:00

  [学情反馈] 开始生成学情反馈
  [学情反馈] ✓ 完成 (59.8秒)

  [复习文档] 开始生成复习文档
  [复习文档] ✓ 完成 (45.2秒)
  ...
  ```

### V31 - 日志导出功能
- **新增功能**：前端添加"导出日志"按钮
- **实现**：
  - 后端新增 exportLog tRPC接口
  - 前端显示可下载的日志链接
  - 用户可以下载日志文件发给开发者排查问题

### V32 - API响应时间监控
- **发现问题**：
  - 同样的输入，学情反馈耗时波动很大（60秒 vs 195秒）
  - DMXapi响应时间不稳定
- **监控数据示例**：

| 测试 | 学情反馈耗时 |
|------|-------------|
| 测试1 | 59.8秒 |
| 测试2 | 195.1秒 |
| 测试3 | 44.5秒 |

- **结论**：API响应时间不稳定是导致随机超时的原因之一

### V33 - GitHub仓库迁移 ⭐
- **背景**：之前所有开发都在Manus单个对话里进行，无法多人协作，也无法回溯历史
- **操作**：
  1. 在GitHub创建 feedback-mvp 仓库
  2. 将Manus服务器上的代码推送到GitHub
  3. 设置GitHub作为代码的"真实来源"
- **仓库信息**：
  - 地址：https://github.com/haoen110/feedback-mvp
  - 默认分支：main
- **工作流程变更**：
  - 开发在Manus进行
  - 每次迭代完成后推送到GitHub
  - 需要回滚时可以从GitHub拉取
- **教训**：应该从项目一开始就使用版本控制，而不是等出问题了才补

---

## 阶段六：Google OAuth授权（V34-V38）

### V34 - Google Cloud OAuth配置 ⭐
- **需求**：实现用户自己授权Google Drive，而不是依赖Manus平台的rclone配置
- **Google Cloud Console配置**：
  1. 创建OAuth 2.0客户端ID
  2. 配置授权重定向URI：`https://feedmvp-i28qgefq.manus.space/api/google/callback`
  3. 启用Google Drive API
- **前端改动**：
  - 高级设置区域新增"Google Drive连接"区块
  - 显示当前连接状态和授权有效期
  - 添加"连接Google Drive"按钮
- **后端改动**：
  - 新增 /api/google/auth 端点，生成OAuth授权URL
  - 新增 /api/google/callback 端点，处理授权回调
  - Token存储到数据库，而不是依赖Manus的rclone配置

### V35 - OAuth回调路由404修复
- **问题**：Google成功回调，但网站返回404
- **原因**：代码只在Manus沙盒环境运行，没有发布到正式环境
- **解决**：
  1. 推送代码到GitHub
  2. 在Manus平台点击Publish发布
  3. 重新测试授权流程
- **测试结果**：8/8检测项全部通过
  - ✅ 数据库连接
  - ✅ API配置完整性
  - ✅ API连通性
  - ✅ API密钥有效性
  - ✅ API余额
  - ✅ Google Drive授权
  - ✅ Google Drive写入权限
  - ✅ V9路书配置

### V36-V38 - OAuth流程完善
- **V36**：修复token刷新逻辑
  - 添加refresh_token存储
  - 实现token自动刷新
- **V37**：添加"断开连接"功能
  - 用户可以断开Google Drive连接
  - 清除数据库中的token
- **V38**：OAuth错误提示优化
  - 授权失败时显示具体原因
  - 添加重试提示

---

## 阶段七：并发问题修复（V39-V41）

### V39 - 发现并发污染问题 ⭐
- **问题现象**：同时为两个学生生成文档时，学生名互相污染
- **测试场景**：
  - 标签页A：为"刘心瑶"生成
  - 标签页B：为"文梁惠雅"生成
- **实际结果**：
  ```
  日志头显示: 刘心瑶
  上传路径显示: 文梁惠雅
  ```
- **问题分析**：
  - logger.ts 使用了全局变量存储当前学生名
  - 并发请求时，后一个请求覆盖了前一个请求的学生名
  - 导致日志记录的是A学生，但上传用的是B学生的名字

### V40 - Logger重构解决并发问题 ⭐
- **解决方案**：每个请求创建独立的log对象，不使用全局变量
- **重构前（有问题）**：
  ```js
  // logger.ts - 全局变量
  let currentStudentName = '';
  let currentSessionId = '';

  export function setStudent(name: string) {
    currentStudentName = name;  // 并发时会被覆盖！
  }
  ```
- **重构后（正确）**：
  ```js
  // logger.ts - 每个请求独立的log对象
  export function createLogSession(studentName: string) {
    const sessionId = generateSessionId();
    return {
      studentName,
      sessionId,
      steps: [],
      startStep: (name) => { ... },
      endStep: (name, success) => { ... },
      save: () => { ... }
    };
  }
  ```
- **使用方式**：
  ```js
  // routers.ts
  const log = createLogSession(studentName);
  log.startStep('学情反馈');
  // ... 生成逻辑 ...
  log.endStep('学情反馈', true);
  await log.save();
  ```
- **前端改进**：添加当前生成学生名提示
  ```
  正在为「张三」生成 (2/5)...
  ```

### V41 - 日志导出修复
- **问题**：日志导出总是返回错误学生的日志
- **原因**：
  - 前端调用 exportLog 时没有传学生名参数
  - 后端返回"最新的日志"，但并发时最新的可能是另一个学生的
- **修复**：
  - 前端传入学生名参数
  - 后端根据学生名查找对应的日志文件
  - 日志文件名格式：`{学生名}_{sessionId}.log`

---

## 阶段八：气泡图与小班课（V42-V44）

### V42 - 气泡图中文乱码修复 ⭐
- **问题**：气泡图里的中文显示为乱码方块
- **原因分析**：
  - 后端使用 sharp 库将SVG转PNG
  - sharp 依赖系统字体
  - Manus服务器上没有安装中文字体
- **尝试方案1**：安装中文字体到服务器
  - 需要root权限，Manus不支持
  - ❌ 放弃
- **尝试方案2**：在SVG中嵌入字体
  - 需要将字体文件转为base64嵌入SVG
  - 字体文件太大，SVG会很臃肿
  - ❌ 放弃
- **最终方案：前端Canvas渲染** ⭐
  - 后端返回SVG给前端
  - 前端用Canvas渲染SVG
  - Canvas可以使用浏览器的字体
  - 渲染完成后导出为PNG
  - 再上传到Google Drive
- **实现流程**：
  ```
  AI生成SVG → 返回前端 → Canvas渲染 → 导出PNG → 上传Google Drive
  ```

### V43 - 小班课功能开发 ⭐
- **需求**：支持小班课场景，一次为多个学生（最多7人）生成文档
- **与一对一的区别**：

| 项目 | 一对一 | 小班课 |
|------|--------|--------|
| 输入标识 | 学生姓名 | 班号 |
| 学情反馈 | 1份 | 1份（包含所有学生） |
| 复习文档 | 1份 | 1份 |
| 测试本 | 1份 | 1份 |
| 课后信息提取 | 1份 | 1份 |
| 气泡图 | 1张 | N张（每个学生1张） |

- **前端改动**：
  - 新增"课程类型"切换（一对一/小班课）
  - 小班课模式下，"学生姓名"改为"班号"
  - 其他输入字段保持不变
- **后端改动**：
  - 气泡图生成逻辑支持返回多个学生的数据
  - 存储路径调整：`/学生档案/小班课/{班号}/`
- **遇到的问题**：
  1. 文件链接不可点击 - 小班课没有返回Google Drive链接
  2. 日志导出失败 - 小班课用班号，但日志查找还是用学生名

### V44 - 路书统一与Bug修复 ⭐
- **路书统一**：
  - 之前：不同文档可能使用不同的提示词来源
  - 现在：所有文档统一使用V9路书作为system prompt
  - 确保路书是"透明转发"给AI，不做任何转述
- **小班课三个Bug修复**：

| Bug | 原因 | 修复 |
|-----|------|------|
| 文件链接不可点击 | 小班课接口没有返回URL | 补充返回uploadResult.url |
| 日期显示偏移 | 日期解析逻辑有问题 | 修复日期解析 |
| 年份显示错误 | 没有传入年份参数 | 传入正确的年份 |

- **发现Cloudflare 524超时问题** 🔴
  - 测试小班课7个学生时发现：
    ```
    AI生成耗时: 142秒
    Cloudflare超时限制: 100秒
    结果: 524 Timeout Error
    ```
  - **问题分析**：
    - V22实现的流式输出是：后端到AI流式，但后端到前端仍是普通HTTP
    - 后端必须等AI全部生成完，再一次性返回给前端
    - 当AI生成超过100秒时，Cloudflare强制断开连接
  - **结论**：需要实现端到端SSE流式输出，这成为V45系列的核心任务

---

## 阶段九：SSE端到端改造（V45系列）⭐

### 背景说明

V44发现的Cloudflare 524超时问题是阻塞性Bug：小班课根本无法使用。必须实现端到端SSE流式输出，让后端收到AI的每个chunk就立即推送给前端，保持连接活跃。

V45系列是一次大规模改造，涉及4个SSE端点、前后端代码、日志系统等多个模块。

### V45b - 小班课学情反馈SSE改造 ⭐
- **目标**：解决小班课学情反馈超时问题
- **新增文件**：server/classStreamRoutes.ts（227行）
- **新增端点**：POST /api/class-feedback-stream
- **SSE响应头设置**：
  ```js
  res.setHeader('Content-Type', 'text/event-stream');
  res.setHeader('Cache-Control', 'no-cache');
  res.setHeader('Connection', 'keep-alive');
  res.setHeader('X-Accel-Buffering', 'no');  // 关键：禁用Nginx缓冲
  ```
- **SSE事件格式设计**：
  ```
  event: start
  data: {"message":"开始生成","students":7}

  event: progress
  data: {"chars":1500}

  event: complete
  data: {"success":true,"feedback":"内容...","chars":13335}

  event: error
  data: {"message":"错误信息"}
  ```
- **前端改造**：
  - client/src/pages/Home.tsx 第767行
  - 从tRPC调用改为 fetch + SSE流式读取
  - 使用 ReadableStream 读取响应

- **踩坑1：事件类型误判** 🔴
  - 测试时发现start事件被误判为error事件，导致生成立即失败。
  - **错误原因**：用字段判断事件类型
    ```js
    // 错误做法
    if (data.message && !data.feedback && !data.chars) {
      sseError = data.message;  // start事件也满足这个条件！
    }
    ```
  - start事件：`{"message":"开始为...", "students":6}`
    - 有message ✓，没feedback ✓，没chars ✓
    - 被错误地当成error事件
  - **正确做法**：用event:行判断事件类型
    ```js
    // 正确做法
    if (currentEventType === 'error' && data.message) {
      sseError = data.message;
    } else if (currentEventType === 'start') {
      console.log('[SSE] 收到开始事件:', data.message);
    }
    ```

- **踩坑2：变量作用域导致状态丢失** 🔴
  - 修复踩坑1后，又发现complete事件的内容丢失：
    ```
    [SSE] 收到完成事件，内容长度: 13739 字符
    [DEBUG] SSE循环结束，feedbackContent长度: 0  // 为什么是0？
    ```
  - **错误原因**：currentEventType 在for循环内部声明
    ```js
    // 错误做法
    while (true) {
      for (const line of lines) {
        let currentEventType = '';  // 每次循环都重置！
        if (line.startsWith('event: ')) {
          currentEventType = line.slice(7).trim();
        }
      }
    }
    ```
  - SSE的 event: 和 data: 行可能在不同数据块：
    - 数据块143: `"event: complete\n"` → currentEventType = 'complete'
    - 数据块144: `"data: {...}\n"` → 新循环，currentEventType被重置为''
  - **正确做法**：在while循环外部声明
    ```js
    // 正确做法
    let currentEventType = '';  // 在while外部声明
    while (true) {
      for (const line of lines) {
        if (line.startsWith('event: ')) {
          currentEventType = line.slice(7).trim();
        }
      }
    }
    ```
- **测试结果**：
  - 小班课7学生学情反馈：176秒，14915字符
  - 成功！不再超时
  - 全部5个文档生成成功
- **教训**：
  1. SSE事件类型必须用event:行判断，不能用字段判断
  2. 需要跨数据块保持的状态变量，必须在循环外部声明

### V45c - 一对一学情反馈SSE改造
- **目标**：一对一也可能超时，统一改造
- **新增端点**：POST /api/feedback-stream
- **前端改造**：client/src/pages/Home.tsx 第435行
- **同步修改**：max_tokens从16000改为32000
  - 修改原因：14947字符 ≈ 10000-15000 token，接近16000上限，可能被截断
  - 修改范围：全部18处
    - feedbackGenerator.ts: 6处
    - routers.ts: 6处
    - whatai.ts: 4处
    - classStreamRoutes.ts: 2处
  - 验证：`grep -r "16000" server/` 返回空，确认全部改完
- **测试结果**：
  - 学生1（高卓霆）：学情反馈131秒，成功
  - 学生2（赵宇宸）：学情反馈160秒，成功

### V45d - 一对一复习文档SSE改造
- **问题**：复习文档生成也可能超过100秒
- **新增端点**：POST /api/review-stream
- **前端改造**：步骤2改用fetch + SSE
- **测试结果**：复习文档107秒，成功

### V45e - 小班课复习文档SSE改造
- **新增端点**：POST /api/class-review-stream
- **前端改造**：小班课步骤2改用fetch + SSE
- 至此：一对一和小班课的学情反馈、复习文档都使用SSE，不会再超时

### V45f - 星期显示修复
- **问题发现**：生成的作业布置里星期显示错误

| 日期 | AI生成 | 实际 |
|------|--------|------|
| 2026年1月11日 | 周六 | 周日 |

- **问题原因**：传给AI的日期没有附带星期，AI自己计算，算错了
- **解决方案**：新增 `addWeekdayToDate()` 工具函数
  ```js
  function addWeekdayToDate(dateStr: string): string {
    const weekdays = ['日', '一', '二', '三', '四', '五', '六'];
    const date = new Date(dateStr);
    const weekday = weekdays[date.getDay()];
    return `${dateStr}（周${weekday}）`;
  }
  ```
- **修改范围**：
  - 一对一学情反馈
  - 小班课学情反馈
  - 小班课复习文档
- **修改后传给AI的日期格式**：
  - 之前：`2026年1月11日`
  - 之后：`2026年1月11日（周日）`
- **教训**：不要让AI自己计算能算出来的东西，直接告诉它

### V45g - 一对一复习文档进度显示修复
- **问题发现**：

| 步骤 | 显示 |
|------|------|
| 学情反馈 | 共6511字 ✅ |
| 复习文档 | 复习文档已上传到Google Drive ❌ 没有字符数 |

- **问题原因**：前端没有从complete事件中提取chars字段
- **修复**：
  - complete事件时保存字符数
  - 完成消息显示"共xxx字"

### V45h - 小班课复习文档进度显示修复
- **问题**：和一对一复习文档相同的问题
- **修复**：和V45g相同的方案
- **教训**：没有模块化导致同样的问题要修两遍

### V45i - 一对一学情反馈日志记录
- **问题发现**：生成成功后，点击"导出日志"显示"没有找到日志文件"
- **问题原因**：SSE改造后，生成逻辑从tRPC mutation移到了SSE端点，但SSE端点里没有调用日志系统函数
- **原来的日志系统工作流程**：
  1. createLogSession() - 创建日志会话
  2. startStep() / stepSuccess() / stepFailed() - 记录步骤
  3. endLogSession() - 保存日志文件到 /tmp/feedback-logs/
- SSE端点里完全没有这些调用，所以日志文件没有生成。
- **修复**：在 /api/feedback-stream 端点添加日志记录逻辑

### V45j - 所有SSE端点日志记录
- **问题**：V45i只修复了一对一学情反馈，其他3个SSE端点呢？
- **排查结果**：

| 端点 | 日志记录 |
|------|---------|
| /api/feedback-stream（一对一学情反馈） | ✅ V45i已修复 |
| /api/review-stream（一对一复习文档） | ❌ 无 |
| /api/class-feedback-stream（小班课学情反馈） | ❌ 无 |
| /api/class-review-stream（小班课复习文档） | ❌ 无 |

- **修复**：给其他3个SSE端点也添加日志记录
- **教训**：改造代码时要检查关联功能是否受影响；没有模块化导致同样的修复要做4遍

### V45k - 清理调试日志（第一次）
- **目的**：Console太乱，清理[DEBUG]日志
- **清理范围**：
  - 前端 Home.tsx 中的 [DEBUG] 日志
  - 后端 SSE 端点中的调试日志

### V45l - 超长内容分块发送 ⭐
- **问题发现**：某次一对一生成失败
  - 日志显示：
    ```
    最终结果: success
    步骤结果: ✓ feedback: success (215.9秒) - 24971字符
    ```
  - 后端成功了，但前端报错："学情反馈生成失败: 未收到内容"
- **奇怪现象**：
  - 后端日志显示24971字符生成成功
  - Google Drive有文件，内容正常
  - 但前端认为失败了
- **添加调试日志排查**：
  ```
  [SSE-DEBUG] complete事件，feedback存在: false
  [SSE-DEBUG] SSE循环结束，feedbackContent长度: 0
  ```
- **对比测试**：
  - 20982字符：成功
  - 24971字符：失败
- **问题定位**：内容超长时，complete事件的JSON数据太大，导致解析问题
- **解决方案：分块发送**
  ```js
  const CHUNK_THRESHOLD = 15000;
  const CHUNK_SIZE = 10000;

  if (content.length > CHUNK_THRESHOLD) {
    // 分块发送
    const chunks = [];
    for (let i = 0; i < content.length; i += CHUNK_SIZE) {
      chunks.push(content.slice(i, i + CHUNK_SIZE));
    }

    chunks.forEach((chunk, index) => {
      sendEvent("content-chunk", {
        index,
        total: chunks.length,
        text: chunk
      });
    });

    sendEvent("complete", {
      success: true,
      chunked: true,  // 标记已分块
      chars: content.length,
      uploadResult: ...
    });
  } else {
    // 小内容直接发
    sendEvent("complete", {
      success: true,
      feedback: content,
      chars: content.length,
      uploadResult: ...
    });
  }
  ```
- **前端解析**：
  ```js
  let contentChunks: string[] = [];

  if (currentEventType === 'content-chunk') {
    contentChunks[data.index] = data.text;
  } else if (currentEventType === 'complete') {
    if (data.chunked) {
      feedbackContent = contentChunks.join('');
    } else {
      feedbackContent = data.feedback;
    }
  }
  ```
- **修复范围确认**：

| 端点 | 包含feedback字段 | 需要分块 |
|------|-----------------|---------|
| 一对一学情反馈 | ✅ 是 | ✅ 已加 |
| 小班课学情反馈 | ✅ 是 | ✅ 已加 |
| 一对一复习文档 | ❌ 否（只有uploadResult） | 不需要 |
| 小班课复习文档 | ❌ 否（只有uploadResult） | 不需要 |

  复习文档在后端直接上传Google Drive，complete事件只返回上传结果，不传大内容给前端，所以不需要分块。
- **测试结果**：
  ```
  [SSE-DEBUG] 收到分块 1 / 2
  [SSE-DEBUG] 收到分块 2 / 2
  [SSE-DEBUG] 从分块拼接内容，长度: 24226
  [SSE-DEBUG] SSE循环结束，feedbackContent长度: 24226 sseError: null
  ```
  24226字符的超长内容成功处理！
- **教训**：SSE传输大数据时要考虑分块；不同端点设计不同（有的传内容，有的只传结果），要分别分析

### V45m - 最终收尾
- **变更**：清理所有[SSE-DEBUG]调试日志

### V45系列SSE端点汇总

| 端点 | 功能 | 文件位置 |
|------|------|---------|
| POST /api/feedback-stream | 一对一学情反馈 | server/classStreamRoutes.ts |
| POST /api/review-stream | 一对一复习文档 | server/classStreamRoutes.ts |
| POST /api/class-feedback-stream | 小班课学情反馈 | server/classStreamRoutes.ts |
| POST /api/class-review-stream | 小班课复习文档 | server/classStreamRoutes.ts |

### V45系列性能数据汇总

| 场景 | 耗时 | 字符数 | 状态 |
|------|------|--------|------|
| 小班课7学生学情反馈 | 176秒 | 14915 | ✅ 不超时 |
| 一对一学情反馈 | 131-194秒 | 20000-25000 | ✅ 不超时 |
| 一对一复习文档 | 107-262秒 | 22000-26000 | ✅ 不超时 |
| 超长内容（分块） | - | 24226 | ✅ 正常解析 |

---

## 阶段十：批量处理功能（V46）

### V46 - 批量处理功能 ⭐
- **需求背景**：
  - 原有功能每次只能为一个学生/班级生成文档
  - 新需求：一次性批量生成多个任务（如50个单词List各生成一份Word文档）
  - 需要支持并发执行，提高效率
- **新增功能**：

| 功能 | 说明 |
|------|------|
| 大分页切换 | 「课堂反馈」和「批量处理」两个顶级Tab |
| 任务编号范围 | 可配置起始和结束编号（如1-50） |
| 并发数配置 | 可设置同时执行的任务数（默认5） |
| 项目总体路书 | 大文本框输入，定义所有任务的指令 |
| 存储路径配置 | 可自定义Google Drive存储路径 |
| 实时进度显示 | 每个任务显示当前字符数 |
| 并发池模式 | 任务完成后自动补充新任务进入 |

- **技术实现**：
  1. 后端核心模块：
     - server/core/sseHelper.ts - SSE公共函数（抽取自4个重复端点）
     - server/core/concurrencyPool.ts - 并发池管理
     - server/core/wordGenerator.ts - Word文档生成
  2. 新增SSE端点：
     - POST /api/batch-stream - 批量处理流式端点
  3. 前端页面：
     - BatchProcess.tsx - 批量处理页面组件
- **并发池工作机制**：
  ```
  并发数设置: 5
  总任务: 12

  时间线:
  t0:  [1] [2] [3] [4] [5]  ← 5个槽位全满
  t1:  [1] [6] [3] [4] [5]  ← 任务2完成，任务6立即顶上
  t2:  [1] [6] [7] [4] [5]  ← 任务3完成，任务7立即顶上
  ...
  t10: [ ] [ ] [ ] [ ] [ ]  ← 全部完成
  ```
- **踩坑记录**：

| 问题 | 原因 | 解决方案 |
|------|------|---------|
| 文件名显示"学情反馈" | 复用了课堂反馈的命名逻辑 | 批量处理使用独立的命名函数 |
| 没有Google Drive链接 | 漏实现链接返回 | 补充uploadResult返回 |
| 并发数限制不生效 | 并发池逻辑bug | 修复队列管理逻辑 |

- **里程碑式开发经验**：
  本次采用里程碑拆解方式，14个步骤分5个里程碑：

| 里程碑 | 步骤数 | 验收标志 |
|--------|--------|---------|
| M1: 核心模块 | 3步 | 三个模块可独立导入 |
| M2: 页面框架 | 2步 | 大分页可切换 |
| M3: 单任务跑通 | 4步 | 1个任务能生成Word并上传 ⭐关键 |
| M4: 并发池跑通 | 2步 | 5个并发任务正确显示 |
| M5: 完善收尾 | 3步 | 所有验收项通过 |

- **教训**：
  - M3是关键里程碑，单任务跑通后即有最小可用版本
  - 复杂功能先用简单方案跑通，再逐步优化
  - 新功能要使用独立的命名和逻辑，避免复用导致混乱

---

## 阶段十一：模板系统（V47）

### V47 - 词汇卡片模板 ⭐
- **需求背景**：
  - V46的「通用文档」模式只能生成简单格式的Word
  - 新需求：生成精确排版的词汇卡片（紫色主题、双栏布局、卡片边框等）
  - Markdown无法实现复杂排版，需要专门的代码模板
- **新增功能**：

| 功能 | 说明 |
|------|------|
| 模板类型选择 | 下拉菜单：「通用文档」vs「词汇卡片」 |
| 词汇卡片模板 | 精确排版：紫色主题、双栏卡片、边框样式 |
| JSON数据解析 | AI输出JSON，程序套用模板生成Word |

- **两种模板的区别**：

| 模板 | AI输出格式 | 程序处理 |
|------|-----------|---------|
| 通用文档 | Markdown文本 | 简单转换为Word |
| 词汇卡片 | JSON数据 | 套用代码模板生成精确排版 |

- **词汇卡片JSON格式**：
  ```json
  {
    "listNumber": 3,
    "sceneName": "Library",
    "wordCount": 25,
    "words": [
      {
        "num": 65,
        "word": "Librarian",
        "phonetic": "/laɪˈbreəriən/",
        "pos": "n.",
        "meaning": "图书管理员",
        "example": "The librarian helped me find reference books.",
        "translation": "图书管理员帮我找到了参考书。"
      }
    ]
  }
  ```
- **技术实现**：
  1. 新增模板文件：
     - server/templates/wordCardTemplate.ts - 词汇卡片代码模板（约280行）
  2. 模板代码结构：
     - 类型定义：WordEntry、WordListData 接口
     - 格式常量：SPEC 对象（颜色、字号、间距）
     - 组件函数：卡片、标题栏、网格等
     - 主函数：generateWordListDocx(data)
- **踩坑记录**：

| 问题 | 原因 | 解决方案 |
|------|------|---------|
| JSON解析失败 | AI输出带```json标记 | 路书明确要求"不要输出Markdown代码块标记" |
| 卡片样式不对 | 模板代码语法错误 | require改import，module.exports改export |

- **教训**：
  - 让AI输出JSON时，必须明确禁止输出Markdown标记
  - 精确排版需求用专门的代码模板，不要强求通用方案
  - 技术确认先行：开始新功能前先确认技术细节

---

## 阶段十二：批量处理功能增强（V48）

### V48 - 批量处理功能增强（2026年1月15-16日）

**里程碑概览**：

| 里程碑 | 内容 | 步骤数 | 状态 |
|--------|------|--------|------|
| M1 | 输出格式扩展 | Step 1-2 | ✅ 完成 |
| M2 | Markdown解析器升级 | Step 3-5 | ✅ 完成 |
| M3 | 文件命名增强 | Step 6 | ✅ 完成 |
| M4 | 文件上传功能 | Step 7-9 | ✅ 完成 |
| M5 | 共享文件模式 | Step 13-15 | ⏳ 规划中 |

**详细变更**：

**M1: 输出格式扩展**
- Step 1 - 新增「生成MD文件」选项
  - 模板类型新增"生成MD文件"选项
  - AI返回的Markdown直接保存为.md文件
- Step 2 - 模板类型改为4选1
  - 教学材料（带样式）：紫色标题、浅紫色表头
  - 通用文档（无样式）：黑白简洁
  - 生成MD文件：直接输出Markdown
  - 词汇卡片：精确排版

**M2: Markdown解析器升级**
- Step 3 - 修复粗体/斜体
  - 新增parseInlineFormatting函数
  - 支持 **粗体**、*斜体*、***粗斜体***
- Step 4 - 新增表格支持
  - 新增parseMarkdownTable函数
  - 识别Markdown表格转Word表格
  - 带样式模式表头有背景色
- Step 5 - 新增列表/引用/分隔线
  - 有序列表：`1. xxx` → Word编号列表
  - 无序列表：`- xxx` → Word项目符号
  - 引用块：`> xxx` → 缩进段落
  - 分隔线：`---` → Word分隔线

**M3: 文件命名增强**
- Step 6 - 从文本解析文件名
  - 新增命名方式选择（前缀+编号 / 从文本解析）
  - 文本框输入多行，每行对应一个文件名
  - 空行使用默认值「任务XX」
  - 自动过滤非法字符

**M4: 文件上传功能**
- Step 7 - 后端上传接口
  - 新增 POST /api/batch/upload-files
  - 文档上传S3返回URL
  - 图片转Base64返回DataUri
  - 文件大小限制：文档30MB、图片20MB
- Step 8 - 前端上传界面
  - 新增配套文件上传区域
  - 支持多文件选择
  - 按文件名排序分配任务编号
  - 上传预览和清空重传
- Step 9 - 文件传给AI
  - 修改llm.ts支持FileInfo参数
  - 图片用image_url（Base64）
  - 文档用file_url（URL）
  - mime_type改为string类型

**新增功能清单**：

| 功能 | 说明 |
|------|------|
| 4种模板类型 | 教学材料/通用文档/MD文件/词汇卡片 |
| Markdown解析器 | 粗体/斜体/表格/列表/引用/分隔线 |
| 文件命名方式B | 从文本解析，一行一个文件名 |
| 配套文件上传 | 文档存S3、图片转Base64、传给AI |

**修改的文件**：

| 文件 | 修改内容 |
|------|---------|
| BatchProcess.tsx | 模板类型4选1、文件命名方式B、文件上传UI |
| batchRoutes.ts | 文件上传接口、接收files参数 |
| batchWordGenerator.ts | Markdown解析器增强 |
| llm.ts | FileInfo类型、mime_type改string |

**踩坑记录**：

| 问题 | 解决方案 |
|------|---------|
| mime_type枚举限制 | 改为string类型 |
| 文件排序不对 | 用localeCompare中文排序 |
| 字段名不一致 | 统一为base64DataUri |

---

## 阶段十三：配置增强与用户体验（V49-V51）

### V49 - 版本标识与配置增强（2026年1月16日）

**功能变更**：

1. **版本号显示**
   - 在页面右上角添加版本号标识（如"V49"）
   - 方便用户和开发者确认当前运行版本
   - 排查问题时一眼确认版本

2. **max_tokens可配置**
   - 高级设置新增max_tokens配置项
   - 默认值从32000改为64000（适配Claude 4.5 Sonnet的64K上限）
   - 不同AI模型token上限不同，需要灵活配置

3. **输出截断检测**
   - 解析AI返回的stop_reason字段
   - 当检测到"max_tokens"（输出被截断）时，弹出警告提示用户
   - 提示用户可以增大max_tokens配置或减少单次输出量

**技术实现**：
- 前端：BatchProcess.tsx添加版本号显示组件
- 后端：batchRoutes.ts解析stop_reason并返回给前端
- 数据库：system_config表新增max_tokens配置项

**踩坑记录**：

| 问题 | 原因 | 解决方案 |
|------|------|---------|
| 版本号位置异常 | Git rebase覆盖了代码改动 | 重新执行改动并验证 |

---

### V50 - 模板格式说明与复制功能（2026年1月16-17日）

**功能变更**：

1. **模板格式说明显示区域**
   - 选择模板类型后，显示该模板的详细格式说明
   - 固定120px高度 + 内容滚动
   - 帮助用户了解每种模板对AI输出的要求

2. **一键复制按钮**
   - 点击复制按钮，将模板格式说明复制到剪贴板
   - 复制成功后显示绿色对勾图标
   - 2秒后恢复为复制图标
   - 方便用户将格式说明粘贴到路书中

3. **新增写作素材模板**
   - 模板类型从4选1扩展为5选1
   - 新增 `writing_material` 模板类型
   - 适用于写作教学材料生成

**5种模板类型**：

| 模板标识 | 显示名称 | AI输出格式 |
|---------|---------|-----------|
| markdown_styled | 教学材料（带样式） | Markdown |
| markdown_plain | 通用文档（无样式） | Markdown |
| markdown_file | 生成MD文件 | Markdown |
| word_card | 词汇卡片 | JSON |
| writing_material | 写作素材模板 | Markdown |

**技术实现**：
- 前端：BatchProcess.tsx添加说明区域和复制按钮组件
- 模板说明文案：存储在前端常量中，按模板类型切换
- 复制功能：使用navigator.clipboard.writeText API

---

### V51 - 文档转文字与来源标签（2026年1月17日）

**功能变更**：

1. **文档转文字功能**
   - 上传Word/PDF文件后，自动提取纯文本内容
   - 将提取的文本发送给AI，而不是原始文件URL
   - 解决了部分AI模型不支持直接处理文件URL的兼容性问题

2. **XML来源标签**
   - 用XML标签区分不同来源的内容，方便AI理解上下文
   - 三种标签类型：
     - `<路书提示词>` - 项目总体路书内容
     - `<共享文档>` - 所有任务共享的参考文档
     - `<单独文档>` - 每个任务独立的配套文档

3. **Bug修复**
   - 修复前端BatchProcess.tsx未将extractedText字段传递到后端的问题
   - 修复文件映射逻辑，确保提取的文本正确关联到对应文件

**技术实现**：

- 文档解析库：
  - Word文档：mammoth / docx库
  - PDF文档：pdf-parse / pdfjs-dist库
  - 文本文件：直接读取

- 消息构建格式：
  ```
  <路书提示词>
  {项目总体路书内容}
  </路书提示词>

  <共享文档>
  [共享文档1.docx的提取文本]
  [共享文档2.pdf的提取文本]
  </共享文档>

  <单独文档>
  [任务X对应的独立文档提取文本]
  </单独文档>
  ```

**踩坑记录**：

| 问题 | 原因 | 解决方案 |
|------|------|---------|
| AI收到的是文件URL而不是提取的文本 | 前端文件映射时没有包含extractedText字段 | 修改BatchProcess.tsx中的文件映射逻辑 |
| 前端和后端字段名不一致 | 前端用extractedText，后端未正确接收 | 统一字段名并在后端正确解析 |

---

### 1月16日回滚事件记录

**事件背景**：
- 1月16日下午，开发进度从V48推进到V52
- 期间经历多次功能开发和调试

**事件经过**：
1. V49功能开发完成，保存Checkpoint
2. 继续开发V50、V51
3. 发现版本号位置异常（应该在右上角，但显示在右下角）
4. 排查发现Git rebase过程中代码被覆盖
5. 部分新建文件在Checkpoint后消失

**采取措施**：
1. 执行git checkout回滚到V48稳定版本
2. 重新按步骤推进V49 → V50 → V51
3. 每个版本完成后都保存Checkpoint并验证

**经验教训**：
1. **每个稳定版本打tag**：`git tag -a v49 -m "稳定版本"`
2. **及时推送到GitHub**：本地改动push到远程仓库
3. **Checkpoint后验证**：用无痕模式访问正式环境确认
4. **版本号显示的价值**：一眼确认当前运行版本，快速发现异常

---

## 阶段十四：AI代码生成系统（V52-V53）

### V52 - AI代码生成Word系统（2026年1月17-18日）⭐
- **核心功能**：让AI生成docx-js代码，在沙箱中执行生成Word文档，实现真正的自由排版。
- **设计思路**：
  - 传统方式：AI输出Markdown/JSON → 程序转换 → Word（格式受限）
  - 新方式：AI直接输出docx-js代码 → 沙箱执行 → Word（完全自由）
- **里程碑拆解**：

| 里程碑 | 内容 | Step数 |
|--------|------|--------|
| M1 | 代码执行沙箱 | 2 |
| M2 | 错误捕获机制 | 2 |
| M3 | 重试循环逻辑 | 2 |
| M4 | 文件验证逻辑 | 2 |
| M5 | 前后端集成 | 3 |
| M6 | 路书模板+测试 | 2 |

- **新增核心模块**：

| 文件 | 功能 |
|------|------|
| server/core/codeSandbox.ts | 代码沙箱执行，使用vm2/NodeVM |
| server/core/codeRetry.ts | 重试控制器，最多3次重试 |
| server/core/aiCodeFixer.ts | AI代码修正，根据错误信息修复代码 |
| server/core/docxValidator.ts | docx验证，检查文件完整性 |
| server/core/errorFormatter.ts | 错误格式化，生成AI可读的错误报告 |

- **前端改动**：
  - 模板类型新增「自由排版（AI代码）」选项
  - AI代码模式下文件命名区域有特殊处理
- **测试覆盖**：121个测试全部通过

### V53 - 版本号显示（2026年1月18日）
- **变更**：在页面右上角添加版本号显示，方便确认当前运行版本。

---

## 阶段十五：文档处理增强（V56-V58）

### V56 - 文档文字提取功能（2026年1月19日）
- **变更**：
  - 支持从上传的PDF和DOCX文件中提取纯文本
  - 提取的文本作为上下文发送给AI
  - 解决了直接传文件URL的兼容性问题

### V58 - 发布错误修复（2026年1月19日）
- **变更**：修复发布过程中的配置错误

---

## 阶段十六：AI代码系统修复（V60-V62）

### V60 - AI代码生成系统修复（2026年1月20-21日）⭐
- **问题背景**：V52的AI代码生成在实际运行中遇到多个问题。
- **修复内容**：

| 问题 | 原因 | 解决方案 |
|------|------|---------|
| require不可用 | vm2沙箱限制 | 改用NodeVM |
| docx模块导入失败 | ESM/CommonJS混用 | 改为全局变量注入 |
| 文件命名混乱 | AI自定义名和系统命名冲突 | 优化命名逻辑 |

- **V60.1改动**：
  - AI代码模式禁用前端文件命名区域
  - 路书添加文件命名要求
  - 后端使用AI实际生成的文件名

### V61 - 步骤状态修复（2026年1月21日）
- **问题**：步骤失败时状态未更新
- **原因**：React闭包陷阱，回调函数捕获了旧的状态值
- **解决**：使用useRef或函数式更新避免闭包问题
- **V61b**：让成功的步骤也显示"重做"按钮

### V62 - 步骤跳过功能（2026年1月21日）
- **变更**：为步骤2-5添加"跳过"功能，用户可以跳过不需要的步骤继续执行。

---

## 阶段十七：多项优化（V63系列）

### V63 - 安全与性能优化（2026年1月22-24日）⭐

V63是一个大版本，包含多个子版本：

**安全修复**：

| 子版本 | 变更 |
|--------|------|
| V63.3 | 移除硬编码API Key |
| V63.4 | 所有业务API改为protectedProcedure，需登录才能调用 |

**性能优化**：

| 子版本 | 变更 |
|--------|------|
| V63.7 | 一对一模式后4个文档并行生成（原为串行） |
| V63.9 | 小班课后4文档并行执行 |
| V63.10 | 小班课气泡图多学生并行生成 |

**体验优化**：

| 子版本 | 变更 |
|--------|------|
| V63.1 | 修复.md文件mimetype识别问题 |
| V63.5 | ai_code模式恢复三种文件命名方式 |
| V63.6 | 文件上传数量限制改为100个 |
| V63.8 | 并行生成进度显示优化 |
| V63.11 | 小班课并行进度显示优化 |
| V63.12 | 修复小班课单步重试bug |
| V63.13 | 添加小班课失败跳过功能 |

---

## 阶段十八：批量处理增强（V64-V65）

### V64 - 单任务重做 + SSE稳定性（2026年1月25-26日）⭐
- **核心功能**：批量处理完成后支持重做单个失败任务。
- **新增端点**：

| 端点 | 功能 |
|------|------|
| POST /api/batch/retry-task | 重做单个任务 |
| GET /api/batch/status/:batchId | 查询批次状态 |

- **SSE稳定性优化**：

| 机制 | 说明 |
|------|------|
| 心跳机制 | 每15秒发送心跳，防止连接被代理断开 |
| 超时检测 | 前端检测连接断开 |
| 降级查询 | 连接断开后查询状态接口恢复 |

- **踩坑经验**：
  - SSE连接在长时间无事件时会被代理/网关断开
  - 需要心跳保活 + 断线重连/降级机制

### V65 - 批量处理指定任务功能（2026年1月27日）⭐
- **需求背景**：批量生成时如果部分任务失败，用户需要重新跑全部任务，浪费时间。
- **新增功能**：「指定任务」模式，允许用户输入特定编号（如3,6,8,11,14），只重跑失败的任务。
- **技术改动**：

| 位置 | 改动 |
|------|------|
| BatchProcess.tsx | 新增taskMode状态（range/specific） |
| BatchProcess.tsx | 新增specificTasks输入框和解析函数 |
| batchRoutes.ts | 支持taskNumbers数组参数 |

- **踩坑记录**：
  - **问题**：后端502/503错误，服务器崩溃
  - **原因**：将start和end变量定义移到else分支后，有两处代码仍在引用这些变量（第245行日志输出、第289-290行SSE事件），导致ReferenceError。
  - **解决**：使用taskNumbers数组的首尾元素firstTask和lastTask替代。
  - **教训**：修改变量作用域时，要全局搜索该变量的所有引用位置。

---

## 阶段十九：协作规范（V66-V67）

### V66 - AI代码模式优化
- **变更**：AI代码生成功能的细节优化
- **背景**：基于V52-V65的AI代码模式使用经验进行调整

### V67 - 版本号发布检查清单
- **变更**：
  - 发现V67修复完成后右上角版本号仍显示V66
  - 建立强制规则：每次发布必须更新 generate-version.cjs
  - 更新任务书模板，验收标准必须包含版本号确认
- **教训**：版本号不会自动更新，发布后必须验证右上角显示

---

## 阶段二十：SSE传输稳定性攻坚（V68-V71）

### V68 - SSE分块传输修复
- **变更**：增大CHUNK_SIZE从15000到50000
- **问题**：SSE传输过程中内容丢失

### V68.2 - SSE进度实时更新
- **变更**：添加res.flush()调用强制刷新缓冲区
- **问题**：进度数据被缓冲区拦截，前端看不到实时更新
- **教训**：compression中间件未启用时flush()会报错，V68.2引入了新问题

### V68.3 - 填充数据强制刷新
- **变更**：使用填充数据强制刷新SSE缓冲区
- **背景**：V68.2的flush方案不够可靠，尝试替代方案

### V71 - 内存暂存 + HTTP拉取 ⭐
- **变更**：大内容改为内存暂存 + HTTP GET接口拉取
- **方案**：SSE只传事件通知（如taskId），前端通过独立HTTP请求拉取完整内容
- **意义**：彻底解决SSE传输丢失问题，不再依赖SSE传大数据
- **教训**：SSE适合传事件通知，不适合传大量内容

---

## 阶段二十一：大规模功能开发（V72-V100）

此阶段由 claude/review-project-overview-1VIxH 分支驱动，Claude在分支开发 → merge到main → Manus更新版本号。版本号推进较快，部分版本无独立记录。

### AI输出质量优化
- **变更**：
  - 新增stripAIMetaCommentary函数统一剔除AI元评论（如"以下是我为您生成的..."）
  - compressTranscript添加禁止元评论污染的指令
  - 强化各文档生成的prompt，减少AI自说自话
- **教训**：AI容易在输出中添加"元评论"，必须用后处理函数统一清理

### 系统健壮性修复
- **变更**：
  - 空文件校验：生成的文档为空时拦截，不上传
  - SSE reader cancel防流泄漏
  - OAuth token刷新并发锁：多个请求同时刷新时只执行一次
  - contentStore加500条上限防内存溢出
- **教训**：并发场景下的资源管理（token刷新、内存、连接）需要额外保护

### 小班课完善
- **变更**：
  - 修复重做步骤的bug
  - 出勤人数默认改为8人
  - 进度显示补全startTime
- **背景**：小班课上线后收集到的实际使用反馈

### 前端优化
- **变更**：
  - 新增DebouncedTextarea防抖组件，解决大文本框输入卡顿
  - 表单提示改善
- **教训**：大段文字输入时每次onChange都触发React重渲染导致严重卡顿，防抖是必须的

### 功能新增
- **变更**：
  - 批量生成的Word文档添加页眉和页码
  - 学生/班级课次自动记忆和递增
  - 上传文件到输入框功能
  - 学情反馈复制按钮
- **用户价值**：减少重复输入，提升日常使用效率

### 架构调整
- **变更**：
  - ⭐ 移除ai_code（AI自由排版）模式：实际使用中不稳定，投入产出比低
  - 提取DEFAULT_CONFIG和getConfig到共享模块
  - 系统自检移到全局设置
- **教训**：V52辛苦做的AI代码生成沙箱最终被移除，说明功能开发前要先验证实际需求

### 文件命名优化
- **变更**：改用课次代替日期命名文件；修复北京时间计算公式

### V87 - 合并冲突 ⚠️
- **变更**：修复sseUploadResult未声明问题
- **背景**：该版本为merge commit，说明经历了分支冲突合并

---

## 阶段二十二：TypeScript修复（V96-V102）

### V96 - TypeScript错误修复
- **变更**：修复lessonDate重复定义的TypeScript错误

### V98 - 版本号生成脚本更新
- **变更**：更新generate-version.cjs脚本

### V101-V102 - 字段类型修复
- **变更**：修复TypeScript编译错误和lessonNumber字段缺失
- **教训**：大量功能合并后要跑一遍完整编译，别只测单个文件

---

## 阶段二十三：Google Drive深度集成（V103-V111）

### V103 - 全局设置重组
- **变更**：系统自检和Google Drive连接移到全局设置

### V104 - 北京时间修复
- **变更**：修复北京时间计算公式

### V105 - 自动提取录音转文字 ⭐
- **变更**：
  - 系统自动从Google Drive读取上次录音转文字
  - 小班课文件名添加"班"字标识
- **用户价值**：省去手动复制粘贴录音转文字的步骤

### V106 - 自动提取上次反馈
- **变更**：自动从Google Drive读取上次学情反馈 + 修正文件名格式

### V107 - 文件名兼容
- **变更**：兼容有空格和无空格两种文件名格式
- **教训**：文件名格式在不同版本间可能不同，要做兼容

### V108 - Drive API读取 ⭐
- **变更**：改用Google Drive API读取文件内容（替代之前的方式）
- **意义**：统一通过OAuth API操作Drive，更可靠

### V109 - 三级搜索兜底 ⭐
- **变更**：文件搜索策略改为三级：精确路径 → 目录搜索 → 全局搜索
- **教训**：文件名可能不精确，路径可能变化，必须有兜底方案

### V110 - OAuth API统一
- **变更**：读取文件也改用OAuth API

### V111 - 手机优化
- **变更**：手机端界面优化 + Google Drive诊断端点
- **用户价值**：教师可以在手机上使用系统

---

## 阶段二十四：后台任务系统（V112-V118）

### V112 - 后台任务系统 ⭐
- **变更**：
  - 引入后台任务机制（tasks + task_steps两张新表）
  - 云盘自动提取功能整合
  - 大量鲁棒性修复
- **意义**：这是一个关键的架构升级，所有生成任务都有记录，可追溯、可恢复
- **新增表**：tasks（任务主表）、task_steps（步骤详情表）

### V113 - 数据库字段升级
- **变更**：input_params、step_results、system_config.value字段从text升级为mediumtext
- **原因**：长文本内容超出text字段的65KB限制

### V114 - 任务进度 + 气泡图修复
- **变更**：任务进度细节优化 + 气泡图中文乱码修复（仍未彻底解决）

### V115 - 提示语统一
- **变更**：统一三处云盘读取的提示语

### V116 - 细节修复
- **变更**：班号占位符、任务记录显示、笔记框样式修复

### V117 - 简化出勤输入
- **变更**：去掉出勤人数下拉框，固定8格输入
- **用户价值**：减少操作步骤，直接输入学生名即可

### V118 - 并发数优化
- **变更**：批量处理并发数默认从5改为50，支持持久化保存

---

## 阶段二十五：用户体验完善（V119-V128）

### V119 - 交互优化
- **变更**：
  - 防重复点击（生成按钮加锁）
  - 反馈全文查看 + 复制按钮
  - 分段录音合并功能

### V120 - 测试修复批次
- **变更**：测试修复7项 + 小班课气泡图partial处理 + 剩余易修3项

### V121 - 健壮性6轮修复
- **变更**：SSE断连处理 + 并发限制 + Google Drive转义 + 多轮健壮性修复
- **教训**：稳定性是无数小修复堆出来的

### V122 - 后台任务改非流式 ⭐
- **变更**：
  - 后台任务从SSE流式改为非流式调用
  - 新增停止按钮
  - 生成诊断信息
  - 截断自动续写功能
- **意义**：非流式调用可以使用更大的token上限，减少截断问题
- **教训**：并非所有场景都需要流式，非流式在token上限和稳定性上更有优势

### V123 - 气泡图 + 任务历史
- **变更**：
  - 气泡图也改为非流式调用
  - 保留填空题下划线格式
  - 后台任务保存历史记录

### V124 - SVG结构修复
- **变更**：修复气泡图SVG字体注入破坏XML结构，导致sharp转换失败
- **教训**：往SVG里注入CSS字体声明时要注意XML合法性

### V125 - 班号自动填充
- **变更**：
  - 选择班号自动填充学生名单
  - 课次直接填充
  - 小班课AI调用也改非流式（提高token上限）
- **用户价值**：选完班号，学生名和课次自动出来

### V126 - 中文乱码修复
- **变更**：
  - 修复复习文档和气泡图的中文乱码
  - 所有docx文档设置微软雅黑为默认字体
  - SVG字体注入增强
- **教训**：中文乱码问题反复出现，直到V129换resvg才彻底解决

### V127 - 气泡图调试
- **变更**：气泡图生成添加调试日志，上传到课后信息文件夹

### V128 - ESM修复 + 幽灵数据
- **变更**：
  - 移除require('sharp')防止ESM环境崩溃
  - 取消云盘读取时清除残留数据（幽灵数据修复）

---

## 阶段二十六：气泡图渲染引擎重构（V129-V134）

### V129 - resvg替代sharp ⭐
- **变更**：
  - 气泡图渲染引擎从sharp/librsvg换为resvg
  - 修复前端幽灵数据残留（取消云盘读取时清除ref/state）
  - 修复require(sharp)在ESM环境下的崩溃
- **意义**：彻底解决了困扰多个版本的气泡图中文乱码问题
- **教训**：sharp依赖系统级librsvg，对中文支持差；resvg是纯Rust实现，字体处理更可控

### V130 - 字体路径显式配置
- **变更**：resvg显式指定9个常见字体路径 + /usr/share/fonts目录扫描
- **问题**：部署后气泡图仍然空白（文字全部消失）
- **原因**：Node进程在Manus沙箱中运行，无法访问/usr/share/fonts

### V131 - 本地字体加载 ⭐
- **变更**：
  - 改为从项目本地fonts/目录加载字体文件
  - 将wqy-zenhei.ttc复制到项目目录
  - 新增COLLAB.md协作看板文件
- **意义**：绕过沙箱限制，气泡图中文终于正常显示
- **新机制**：COLLAB.md成为Claude ↔ Manus协作的标准沟通文档
- **教训**：沙箱环境的文件系统限制需要格外注意

### V132 - 测试本 + 学生填充
- **变更**：
  - 测试本答案分页符修复（检测多种AI输出格式）
  - 装饰性标记处理
  - 输入班号自动填充历史学生名单

### V133 - 代码模块化
- **变更**：
  - 一对一与小班课生成函数模块化合并
  - addWeekdayToDate抽取为共享函数
  - 一对一改非流式调用

### V134 - 字体升级
- **变更**：
  - 原始AI输出日志（排查换行问题）
  - 气泡图字体优先级改为Noto Sans CJK SC（思源黑体，比文泉驿更美观）
  - 代码做兜底：Noto不存在时仍用文泉驿

---

## 阶段二十七：体验优化与功能补全（V137-V147）

### V137 - 持久化修复 + 模型选择器
- **变更**：
  - 修复学生名持久化问题（Zod schema丢弃students字段）
  - 任务记录UI优化
  - 模型选择器从高级设置移到主界面
- **教训**：Zod schema验证会丢弃未声明的字段，新增字段必须同步更新schema

### V138 - 实时反馈
- **变更**：
  - 后台任务实时字符数显示
  - 反馈预览区导航按钮

### V141 - 任务记录显示模型
- **变更**：任务记录显示使用的模型名称（后端从inputParams提取，前端用shortModelName缩短显示）

### V142 - 提取预览
- **变更**：课后信息提取预览功能（点击"提取"可查看全文）

### V143 - 链接 + 下载 ⭐
- **变更**：
  - 查看链接恢复（文件名变蓝色，可点击在Google Drive打开）
  - 复习文档、测试本、气泡图一键下载按钮（带状态反馈）
  - 任务记录去折叠，始终展开
  - 小班课气泡图支持批量下载

### V144 - 进度实时更新
- **变更**：步骤2-5进度实时更新 + 小班课格式指令补全

### V145 - 多段录音 ⭐
- **变更**：多段录音构成功能 — 录音转文字支持明确指定分段数
- **用户价值**：一节课有多段录音时，可以按段标注，AI能更好地理解时间线

### V146 - 录音分段调整
- **变更**：多段录音默认分段数从2改为3（点开多段模式至少3段起步）

### V147 - 查看发送素材
- **变更**：任务详情底部新增「查看发送素材」按钮，可查看录音转文字（含分段信息）、课堂笔记、上次反馈的完整原文
- **用户价值**：可以验证实际发送给AI的内容，排查生成质量问题

---

## 阶段二十八：作业管理系统（V148-V152）

### V148 - 作业管理系统MVP ⭐⭐
- **变更**：
  - 新增「作业管理」Tab页（主界面顶部第四个标签）
  - 学生名册管理（点选按钮选择学生，日计划/周计划标记）
  - 语音转文字输入 → AI结构化处理（与反馈系统共用模型预设库，独立记忆上次模型选择）
  - 补充说明编辑器（术语映射等，每次随AI请求发送）
  - 预入库队列（查看/重试/删除/一键入库）
- **新增数据库表**：hw_students（学生名册）、hw_entries（条目队列）
- **新增文件**：HomeworkManagement.tsx、server/homeworkManager.ts、drizzle/0009_homework_management.sql
- **意义**：系统从"课堂反馈工具"升级为"教学管理平台"

### V149 - 课后信息导入作业管理 ⭐
- **变更**：
  - 课后信息提取（步骤4）成功后，新增「导入作业管理」按钮
  - 一键将课后信息提取内容导入作业管理的预入库队列
  - 自动创建学生名册记录（如该学生尚未添加）
- **意义**：打通反馈系统与作业管理系统，课堂反馈的成果可以直接流入作业管理

### V150 - 作业管理Bug修复
- **变更**：9个bug修复
  - updateStudent字段映射错误：用了snake_case（plan_type）而非Drizzle的camelCase（planType）
  - addStudent重复名处理：已删除学生再添加同名会报UNIQUE约束错误，改为自动重新激活
  - importFromExtraction不激活inactive学生
  - submitEntry改异步不阻塞
  - selectedStudent删除后清空
  - updateStudent Zod schema验证
  - 服务器重启卡死恢复
  - insertId安全检查
  - retryEntry状态检查
- **教训**：Drizzle ORM的字段命名（camelCase）和数据库字段（snake_case）容易搞混

### V151 - 已入库记录浏览
- **变更**：
  - 选中学生后，可点击「已入库记录」按钮查看该学生的所有历史入库记录
  - 记录按时间倒序排列，折叠时显示AI解析结果摘要
  - 展开可查看完整AI解析结果、原文、使用模型
  - 入库操作后自动刷新记录列表
  - 新增listStudentEntries API（按学生名+分页查询confirmed条目）

### V152 - 任务记录导入按钮
- **变更**：
  - 任务记录（TaskHistory）展开详情时，已完成的一对一课程任务显示「导入作业管理」按钮
  - 与主生成页面的导入功能一致，调用homework.importFromTask API
  - 自动从displayName提取学生姓名
  - 支持加载中/成功/失败状态反馈，失败可重试

---

## 阶段二十九：项目文档整理（V165-V169）

### V165-V167 - 知识交接文档 + 完整文档库合并
- **变更**：
  - 编写 `docs/HANDOFF.md` 知识交接文档（新对话引导入口）
  - 编写 `docs/deployment-collaboration.md` 部署协作规范
  - 将项目负责人维护的6份完整文档（V1-V152全量知识）合并到 `docs/` 目录：
    - 项目概述（26.7KB）、迭代记录（64KB）、技术备忘（75.2KB）、问题追踪（17.2KB）、Manus协作指南（42.4KB）、环境变量配置模板（13.7KB）
  - 旧版文档（V28 时期的简略版）被完整版替换

### V168-V169 - 冗余文档清理 + 文档维护规范
- **变更**：
  - 删除5个冗余文件：`ideas.md`、`todo.md`、`sse_investigation_report.md`、`sse_debug_frontend_log.txt`、`任务书-排查截断问题.md`
  - COLLAB.md 新增部署后更新状态的步骤要求
  - 建立文档维护规范：Claude 推送前更新迭代记录，Manus 部署后更新版本发布记录
  - HANDOFF.md 新增文档导航索引和维护规范章节
- **意义**：确保项目知识不散落在记忆目录中，新 Claude 对话可从 git 仓库获取完整上下文

---

## 关键教训总结

### 早期教训（V1-V28）

| 版本 | 教训 |
|------|------|
| V16 | 没有版本管理，回滚会丢代码 → **每次迭代前要备份** |
| V15 | 神马API不稳定 → **选API要考虑稳定性** |
| V23 | AI转述不如直接用原文 → **简单粗暴有时更有效** |
| V26 | 压缩步骤没必要 → **能省则省** |

### 中期教训（V29-V45）

| 版本 | 教训 |
|------|------|
| V33 | 项目一开始就应该用版本控制，不要等出问题再补 |
| V39-V40 | 并发场景下不能用全局变量存储请求相关的状态 |
| V42 | 服务端字体问题可以用前端Canvas渲染绕过 |
| V44 | 超过100秒的请求会被Cloudflare强制断开 |
| V45b | SSE事件类型要用event:行判断，不要用字段判断 |
| V45b | 关键状态变量要在循环外部声明，避免跨数据块丢失 |
| V45c | max_tokens要根据实际输出长度设置，留足余量 |
| V45f | 不要让AI自己计算能算出来的东西，直接告诉它 |
| V45i-j | 改造代码时要检查关联功能是否受影响 |
| V45l | 超长JSON数据可能导致解析失败，需要分块发送 |
| 通用 | 没有模块化导致每个端点都要改一遍，技术债累积严重 |

### 中后期教训（V46-V65）

| 版本 | 教训 |
|------|------|
| V46 | 大项目要拆成里程碑，找到"最小可用版本"节点 |
| V46 | 新功能使用独立的命名和逻辑，避免复用导致混乱 |
| V46 | 复杂功能先用简单方案跑通，再逐步优化 |
| V47 | 让AI输出JSON时，必须明确禁止Markdown标记 |
| V47 | 精确排版需求用专门的代码模板 |
| V47 | 技术确认先行，开始新功能前先确认技术细节 |
| V52 | AI代码生成需要沙箱安全执行 + 错误重试机制 |
| V60 | vm2沙箱中require不可用，需要改用NodeVM或全局注入 |
| V61 | React闭包陷阱：回调函数会捕获旧状态，用useRef解决 |
| V63 | 安全：不要硬编码API Key，业务API要加登录保护 |
| V63 | 性能：串行改并行可以显著提升速度 |
| V64 | SSE长连接需要心跳保活 + 断线降级机制 |
| V65 | 修改变量作用域时，要全局搜索所有引用位置 |
| 通用 | 测试用例要具体，给出"1+1=2"级别的简单输入 |
| 通用 | 排故先排查上报，讨论清楚再修改代码 |

### 后期教训（V66-V152）

| 版本 | 教训 |
|------|------|
| V67 | 版本号不会自动更新，发布后必须验证 |
| V71 | SSE适合传事件通知，不适合传大量内容 |
| V72-V100 | AI代码生成模式投入产出比低，最终被移除 → 功能开发前先验证实际需求 |
| V72-V100 | 大文本输入需要防抖，否则React重渲染导致卡顿 |
| V109 | 文件搜索必须有兜底方案（精确→目录→全局） |
| V112 | 任务记录是架构升级的关键，所有操作可追溯 |
| V113 | MySQL text字段有65KB限制，长内容要用mediumtext |
| V122 | 非流式调用在token上限和稳定性上优于流式 |
| V124 | SVG注入CSS时要注意XML合法性 |
| V126 | 中文乱码要从渲染引擎层面彻底解决，补丁式修复不可持续 |
| V129 | 沙箱环境的文件系统限制需要格外注意 |
| V131 | COLLAB.md协作看板大幅提升了多方协作效率 |
| V137 | Zod schema会丢弃未声明字段，新增字段必须同步更新 |
| V150 | Drizzle ORM camelCase和数据库snake_case容易搞混 |

---

## 回滚事件记录

| 时间 | 版本 | 原因 | 影响 |
|------|------|------|------|
| 1月16日 | V48→V52 | Git rebase覆盖代码改动 | 回滚到V48重新推进 |
| V63.7 | V63.7 | Checkpoint rebase与GitHub远程历史冲突 | rebase abort + reset回退 |
| V87 | V87 | 分支合并冲突（sseUploadResult未声明） | merge commit解决 |

---

*文档创建时间：2026年1月7日*
*最后更新时间：2026年2月12日*
*当前版本：V169*
