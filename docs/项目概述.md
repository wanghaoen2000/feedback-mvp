# 项目概述

## 基本信息

| 项目 | 内容 |
|------|------|
| 项目名称 | 托福阅读学情反馈系统（feedback-mvp） |
| 当前版本 | V179 |
| 项目状态 | 生产可用，多租户隔离已完成，已通过真实数据验证 |
| 部署平台 | Manus |
| 代码仓库 | https://github.com/wanghaoen2000/feedback-mvp |

## 项目定位

这是一个教学辅助自动化工具，帮助新东方托福阅读教师和助教快速生成课后文档。

核心价值：把原本需要手工整理的课后工作自动化，教师只需输入课堂信息，系统自动生成全套文档并上传到Google Drive。

## 目标用户

| 角色 | 使用场景 |
|------|---------|
| 托福阅读教师 | 课后输入课堂信息，获得学情反馈、复习文档、测试本 |
| 助教 | 获得课后信息提取文档，用于作业管理和家长沟通 |
| 内容制作者 | 批量生成词汇表、练习册等教学材料（V46新增） |

## 核心功能

### 四大Tab页

| Tab | 模式/功能 | 适用场景 | 引入版本 |
|-----|----------|---------|---------|
| 课堂反馈 | 一对一 / 小班课 | 课后生成反馈+复习+测试+气泡图 | V1 |
| 批量处理 | 批量任务生成 | 词汇表、练习册等批量文档 | V46 |
| 任务记录 | 历史任务浏览 | 查看/下载/导入历史生成记录 | V112 |
| 作业管理 | 学生作业管理 | 语音AI结构化、预入库、记录存档 | V148 |

### 课堂反馈功能（一对一/小班课）

自动生成5个文档：

| 文档 | 格式 | 用途 | 一对一 | 小班课 |
|------|------|------|--------|--------|
| 学情反馈 | .md | 记录学生本次课表现、知识点掌握情况 | 1份 | 1份（含所有学生） |
| 复习文档 | .docx | 学生课后复习用的知识点整理 | 1份 | 1份 |
| 测试本 | .docx | 课后练习题，末尾附答案 | 1份 | 1份 |
| 课后信息提取 | .md | 助教用的作业管理档案 | 1份 | 1份 |
| 气泡图 | .png | 可视化展示学生知识点掌握情况 | 1张 | N张（每学生1张） |

生成完成后，文档自动上传到指定的Google Drive路径，并返回可点击的文件链接。

### 批量处理功能（V46新增，V48-V51、V64-V65持续增强）

支持一次性批量生成多个独立任务，适用于词汇表、练习册等批量文档生成场景。

| 功能 | 说明 |
|------|------|
| 任务编号范围 | 可配置起始和结束编号（如1-50） |
| 并发执行 | 可设置同时执行的任务数（默认50，V118调整） |
| 项目总体路书 | 定义所有任务的统一指令，任务编号自动注入 |
| 存储路径配置 | 可自定义Google Drive存储路径 |
| 实时进度显示 | 每个任务显示当前生成字符数 |
| 并发池模式 | 任务完成后自动补充新任务进入执行池 |

**任务编号模式（V65新增）：**

| 模式 | 输入方式 | 适用场景 |
|------|---------|---------|
| 连续范围 | 起始编号、结束编号（如 1-50） | 首次批量生成 |
| 指定任务 | 逗号分隔的编号（如 3,6,8,11,14） | 重跑失败任务 |

**单任务重做（V64新增）：**

- 批量处理完成后，可点击单个任务的"重做"按钮
- 只重新生成该任务，不影响其他已完成任务
- 使用原有的路书和配置参数

**模板类型（V50扩展为5选1）：**

| 模板 | AI输出格式 | 适用场景 |
|------|-----------|---------|
| 教学材料（带样式） | Markdown文本 | 紫色标题、表头背景色 |
| 通用文档（无样式） | Markdown文本 | 黑白简洁文档 |
| 生成MD文件 | Markdown文本 | 直接输出.md文件 |
| 词汇卡片 | JSON数据 | 精确排版的词汇表 |
| 写作素材模板 | Markdown文本 | 写作教学材料（V50新增） |

> 注：V52曾新增"自由排版（AI代码）"模板，通过AI生成docx-js代码实现自定义排版，后因实际使用中AI代码生成不够稳定、投入产出比低，于V72-V100期间移除。

**Markdown解析器功能（V48新增）：**

- 粗体/斜体样式保留
- 表格转Word表格（带样式有表头背景色）
- 编号列表、项目符号列表
- 引用块（带样式有橙色标记）
- 分隔线

**文件命名（V48新增方式B）：**

- 方式A：前缀+编号（原有）
- 方式B：从文本解析 - 一行一个文件名

**配套文件上传（V48新增）：**

- 支持文档：.docx/.md/.txt/.pdf（最大30MB）
- 支持图片：.png/.jpg/.jpeg/.webp（最大20MB）
- 按文件名排序，自动分配任务编号
- 文档存S3返回URL，图片转Base64
- AI能识别图片内容、分析文档内容

**文档转文字功能（V51新增）：**

- 上传Word/PDF文件后，自动提取纯文本内容
- 用XML标签区分不同来源的内容：
  - `<路书提示词>` - 项目总体路书内容
  - `<共享文档>` - 所有任务共享的参考文档
  - `<单独文档>` - 每个任务独立的配套文档
- 解决了大文件直接传给AI的兼容性问题

**模板格式说明（V50新增）：**

- 选择模板后显示该模板的输出格式说明
- 固定120px高度 + 滚动显示
- 提供一键复制按钮，方便粘贴到路书中

### 作业管理系统（V148新增，V149-V152持续增强）

独立Tab页，用于管理学生课后作业的录入、AI结构化处理和存档。

| 功能 | 说明 |
|------|------|
| 学生名册 | 点选按钮选择学生，支持日计划/周计划标记 |
| 语音AI处理 | 输入语音转文字 → AI 结构化处理（共用模型预设库） |
| 补充说明 | 术语映射等固定说明，每次随 AI 请求发送 |
| 预入库队列 | 查看AI处理结果、重试、删除、一键入库到数据库 |
| 已入库浏览 | 选中学生查看历史已入库记录（V151新增） |
| 课后信息导入 | 课堂反馈的课后信息提取可一键导入（V149新增） |
| 任务记录导入 | 任务记录页也可导入到作业管理（V152新增） |

**新增数据库表：**

| 表名 | 用途 |
|------|------|
| hw_students | 学生名册（姓名、计划类型、激活状态） |
| hw_entries | 作业条目队列（原文、AI结果、状态、关联学生） |

## 技术架构

```
┌─────────────────────────────────────────────────────────────┐
│                       前端 (React)                           │
│  Home.tsx │ BatchProcess.tsx │ TaskHistory.tsx │ HomeworkMgmt │
│    表单输入 → 实时进度 → 结果反馈 → 气泡图(resvg) → 下载     │
└──────────────────────────┬──────────────────────────────────┘
                           │ tRPC + SSE + HTTP拉取
┌──────────────────────────▼──────────────────────────────────┐
│                      后端 (Node.js)                          │
│  ┌────────────┐  ┌────────────┐  ┌────────────┐  ┌────────┐ │
│  │feedbackGen │  │ whatai/llm │  │ gdrive     │  │ logger │ │
│  │(文档生成)   │  │(AI调用)    │  │(云盘读写)   │  │(日志)  │ │
│  └────────────┘  └────────────┘  └────────────┘  └────────┘ │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │              课堂反馈模块                                 │ │
│  │  classStreamRoutes (SSE端点)                            │ │
│  │  内存暂存 + HTTP拉取 (V71改造)                           │ │
│  │  非流式AI调用 (V122/V125改造)                            │ │
│  └─────────────────────────────────────────────────────────┘ │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │              批量处理模块 (V46新增)                        │ │
│  │  sseHelper / concurrencyPool / wordGenerator            │ │
│  │  并发数默认50，最大100 (V118调整)                         │ │
│  └─────────────────────────────────────────────────────────┘ │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │              后台任务系统 (V112新增)                       │ │
│  │  tasks + task_steps 表 / 非流式调用 (V122)               │ │
│  │  截断自动续写 / 停止按钮 / 诊断信息                       │ │
│  └─────────────────────────────────────────────────────────┘ │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │              作业管理模块 (V148新增)                       │ │
│  │  homeworkManager.ts / hw_students + hw_entries 表        │ │
│  │  语音AI结构化 / 预入库队列 / 已入库浏览                    │ │
│  └─────────────────────────────────────────────────────────┘ │
└─────────┬───────────────┬───────────────┬───────────────┬───┘
          │               │               │               │
          ▼               ▼               ▼               ▼
       MySQL          DMXapi        Google Drive       GitHub
   (6张表)          (AI服务)       (文件存储+读取)     (版本控制)
```

**技术栈：**

- 前端：React 19 + TypeScript + Tailwind CSS + shadcn/ui
- 后端：Node.js + tRPC + Express + Drizzle ORM
- 数据库：MySQL（TiDB兼容）
- AI服务：DMXapi（默认模型 claude-sonnet-4-5-20250929，max_tokens可配置，默认64000）
- 文件存储：Google Drive（支持OAuth自助授权 + REST API读写）
- 版本控制：GitHub

### 数据库表（共12张）

| 表名 | 用途 | 引入版本 |
|------|------|---------|
| users | 用户表（id, openId, email, role） | V153 |
| system_config | 系统全局配置（仅 allowedEmails） | V11 |
| user_config | 用户级配置（userId+key 复合唯一约束） | V172 |
| google_tokens | OAuth令牌存储（按 userId 隔离） | V34 |
| tasks | 后台任务记录（按 userId 隔离） | V112 |
| task_steps | 任务步骤详情 | V112 |
| hw_students | 作业管理-学生名册（按 userId 隔离） | V148 |
| hw_entries | 作业管理-作业条目（按 userId 隔离） | V148 |
| batch_tasks | 批量任务（按 userId 隔离） | V153 |
| batch_task_items | 批量子任务 | V153 |
| correction_tasks | 作业批改任务（按 userId 隔离） | V171 |
| grading_tasks | 周打分任务（按 userId 隔离） | V172 |

### 气泡图渲染引擎

| 版本 | 渲染引擎 | 说明 |
|------|---------|------|
| V42 | 前端Canvas | 首次解决部分中文乱码 |
| V5-V128 | sharp/librsvg | 服务端渲染，中文乱码反复出现 |
| V129起 | **resvg** | 纯Rust实现，彻底解决中文乱码 |

字体方案：项目本地 `fonts/` 目录存放字体文件（绕过沙箱限制），优先使用 Noto Sans CJK SC，兜底使用文泉驿正黑（V131/V134）。

## 关键设计决策

| 版本 | 决策 | 原因 |
|------|------|------|
| V10 | 5个独立API端点 | 便于单步重试，一个失败不影响其他 |
| V22 | 后端流式输出 | 防止长文档生成时后端超时 |
| V23 | 直接使用V9路书原文作为提示词 | 比让AI"理解后转述"效果更好 |
| V26 | 取消录音压缩步骤 | 能省的步骤就省，多一步处理多一步出错 |
| V33 | GitHub版本控制 | 避免回滚丢代码，支持多人协作 |
| V34-V38 | Google OAuth自助授权 | 用户可自行刷新授权，无需重新部署 |
| V39-V41 | 并发请求隔离 | 每个请求独立log对象，避免全局变量污染 |
| V42 | 前端Canvas渲染气泡图 | 绕过服务器字体问题，解决中文乱码 |
| V45 | 端到端SSE流式输出 | 解决Cloudflare 524超时（100秒限制） |
| V45f | 日期附带星期 | 不让AI自己计算，直接告诉它 |
| V45l | 超长内容分块传输 | 解决24000+字符JSON解析失败 |
| V46 | 并发池模式 | 任务完成即补充新任务，最大化利用并发能力 |
| V46 | SSE公共模块抽取 | 减少4个端点的重复代码，一处修改处处生效 |
| V47 | 模板类型分离 | 通用文档和精确排版用不同处理逻辑 |
| V47 | JSON数据+代码模板 | 精确排版需求无法用Markdown实现 |
| V48 | 完整Markdown解析器 | 支持表格、列表等复杂格式转Word |
| V48 | 文件上传分类处理 | 图片用Base64直接传AI，文档存S3用URL |
| V48 | llm.ts支持多内容类型 | 一条消息可同时包含文件和文本 |
| V49 | 版本号显示 | 方便确认当前运行版本，排查问题 |
| V49 | max_tokens可配置 | 不同AI模型token上限不同，需要灵活配置 |
| V49 | 输出截断检测 | 检测stop_reason，截断时提醒用户 |
| V50 | 模板格式说明区域 | 帮助用户了解每种模板的输出要求 |
| V51 | 文档转文字 | 解决直接传文件给AI的兼容性问题 |
| V51 | XML来源标签 | 区分路书、共享文档、独立文档的内容来源 |
| V52 | AI 代码 + 沙箱执行 | 实现真正自由排版，无需维护模板库 |
| V52 | 最多重试 3 次 | 平衡成功率和效率 |
| V63 | 后 4 文档并行生成 | 串行太慢，并行提升 60% 性能 |
| V64 | SSE 心跳 15 秒 | 代理/网关通常 60-120 秒超时 |
| V64 | 断线查询降级 | 避免长任务因连接问题误报失败 |
| V65 | 指定任务模式 | 避免部分失败时重跑全部 |
| V71 | SSE只传通知，大内容走HTTP | SSE传大数据会丢失，职责分离更可靠 |
| V72-V100 | 移除AI代码生成模式 | 实际使用不稳定，投入产出比低 |
| V72-V100 | DebouncedTextarea防抖 | 大文本输入导致React重渲染卡顿 |
| V108 | 改用Google Drive API读取文件 | 统一OAuth API操作，更可靠 |
| V109 | 文件搜索三级兜底 | 文件名/路径可能变化，必须有降级方案 |
| V112 | 后台任务系统 + 数据库记录 | 所有操作可追溯可恢复 |
| V113 | mediumtext替代text | text字段65KB限制不够用 |
| V118 | 默认并发数改为50 | 实测50并发不会触发API限流 |
| V122 | 后台任务改非流式 | token上限更大，减少截断，连接更稳定 |
| V129 | resvg替代sharp | sharp依赖系统librsvg，中文支持差 |
| V131 | 项目本地fonts目录 | 沙箱环境无法访问系统字体目录 |
| V131 | COLLAB.md协作看板 | Claude与Manus标准化沟通文档 |
| V148 | 作业管理独立Tab | 从反馈工具升级为教学管理平台 |
| V149 | 课后信息导入作业管理 | 打通两个系统，课堂成果直接流入作业管理 |

## 高级设置

用户可在界面中配置以下选项（持久化存储）：

**AI配置**

| 设置项 | 说明 | 默认值 |
|--------|------|--------|
| AI模型名称 | 可切换其他模型 | claude-sonnet-4-5-20250929 |
| API密钥 | DMXapi 的访问密钥 | - |
| API地址 | API服务地址 | https://www.DMXapi.com/v1 |
| max_tokens | 最大输出token数（V49新增） | 64000 |
| 自定义V9路书 | 粘贴后覆盖默认路书 | - |

**Google Drive配置**

| 设置项 | 说明 |
|--------|------|
| 连接状态 | 显示当前授权状态 |
| 授权有效期 | 显示token过期时间 |
| 连接/断开按钮 | 自助管理Google Drive授权 |
| 自动提取录音转文字 | 自动从Drive读取上次录音转文字（V105新增） |
| 自动提取上次反馈 | 自动从Drive读取上次学情反馈（V106新增） |
| Drive诊断端点 | 可测试Drive连接和文件搜索（V111新增） |

文件搜索策略（V109起）：精确路径 → 目录搜索 → 全局搜索，三级兜底。

**课程配置**

| 设置项 | 说明 | 默认值 |
|--------|------|--------|
| 课程类型 | 一对一 / 小班课 | 一对一 |
| 年份 | 影响文件存储路径 | 2026 |

**批量处理配置（V46新增，V49-V50、V118增强）**

| 设置项 | 说明 | 默认值 |
|--------|------|--------|
| 并发数 | 同时执行的任务数 | 50（V118调整，原为5） |
| 存储路径 | Google Drive存储路径 | Mac(online)/Documents/XDF/批量任务 |
| 模板类型 | 5种模板可选 | 教学材料（带样式） |
| max_tokens | 最大输出token数（V49新增） | 64000 |

并发数支持持久化保存到数据库。

## 容错机制

| 机制 | 说明 | 版本 |
|------|------|------|
| Google Drive上传重试 | 失败自动重试3次 | V1 |
| AI调用重试 | 失败自动重试2次，递增延迟 | V1 |
| 单步重试 | 某个文档生成失败，可手动单独重试该步骤 | V12 |
| 停止按钮 | 生成过程中可随时取消 | V17 |
| 日志导出 | 可导出详细生成日志用于排查问题 | V30-V31 |
| SSE长连接 | 防止Cloudflare 524超时 | V45 |
| 超长内容分块 | 防止大JSON解析失败 | V45l |
| 输出截断检测 | 检测并提醒用户输出被截断 | V49 |
| SSE 心跳保活 | 每 15 秒发送心跳，防止长连接断开 | V64 |
| 连接断线降级 | SSE 断开后自动查询批次状态恢复 | V64 |
| 单任务重做 | 批量完成后可重做单个失败任务 | V64 |
| 指定任务重跑 | 只重跑特定编号的任务 | V65 |
| 内存暂存+HTTP拉取 | 大内容不走SSE，改为独立HTTP接口拉取 | V71 |
| AI元评论剔除 | stripAIMetaCommentary 自动清理AI自说自话 | V72-V100 |
| OAuth并发锁 | 多请求同时刷新token时只执行一次 | V72-V100 |
| contentStore上限 | 内存暂存限500条防溢出 | V72-V100 |
| 空文件校验 | 生成结果为空时拦截，不上传 | V72-V100 |
| Google Drive三级搜索 | 精确路径→目录搜索→全局搜索 | V109 |
| 后台任务系统 | 所有任务可追溯、可恢复 | V112 |
| 防重复点击 | 生成按钮加锁，防止误触重复提交 | V119 |
| 非流式AI调用 | token上限更大、连接更稳定 | V122 |
| 截断自动续写 | 检测到输出截断时自动请求AI继续 | V122 |
| 后台任务停止按钮 | 后台任务可随时停止 | V122 |

## 系统自检（8项）

启动时自动检测以下项目：

| 检测项 | 说明 |
|--------|------|
| 数据库连接 | MySQL/TiDB连接是否正常 |
| API配置完整性 | API地址、密钥是否已配置 |
| API连通性 | 能否访问AI服务 |
| API密钥有效性 | 密钥是否有效 |
| API余额 | 是否有足够余额 |
| Google Drive授权 | OAuth token是否有效 |
| Google Drive写入权限 | 能否写入文件 |
| V9路书配置 | 是否已配置路书 |

## 输入输出说明

### 输入（用户在表单填写）

**通用字段：**

- 课次编号
- 本次课日期
- 下次课日期
- 本次课笔记（教师整理的课堂知识点）
- 录音转文字（课堂录音的原始转写）
- 上次课反馈（用于对比避免重复）
- 特殊要求（可选）
- 是否新生首次课

**一对一模式额外字段：**

- 学生姓名

**小班课模式额外字段：**

- 班号

**批量处理模式字段（V46新增，V48-V65增强）：**

- 任务编号范围（起始-结束）或指定任务编号（V65新增）
- 并发数
- 项目总体路书
- 存储路径
- 配套文件上传（V48新增）
- 文档转文字开关（V51新增）

### 输出（自动生成并上传）

**一对一模式路径：**

```
Mac/Documents/XDF/学生档案/{学生姓名}/
├── 学情反馈/
│   └── {学生姓名}{日期}阅读课反馈.md
├── 复习文档/
│   ├── {学生姓名}{日期}复习文档.docx
│   └── {学生姓名}{日期}测试文档.docx
├── 课后信息/
│   └── {学生姓名}{日期}课后信息提取.md
└── 气泡图/
    └── {学生姓名}{日期}气泡图.png
```

**小班课模式路径：**

```
Mac/Documents/XDF/学生档案/小班课/{班号}/
├── 学情反馈/
│   └── {班号}{日期}阅读课反馈.md
├── 复习文档/
│   ├── {班号}{日期}复习文档.docx
│   └── {班号}{日期}测试文档.docx
├── 课后信息/
│   └── {班号}{日期}课后信息提取.md
└── 气泡图/
    ├── {学生1姓名}{日期}气泡图.png
    ├── {学生2姓名}{日期}气泡图.png
    └── ...
```

**批量处理模式路径（V46新增）：**

```
{自定义路径}/{时间戳文件夹}/
├── 任务01_xxx.docx
├── 任务02_xxx.docx
├── 任务03_xxx.docx
└── ...
```

## 性能数据

| 场景 | 典型耗时 | 输出字符数 |
|------|---------|-----------|
| 一对一学情反馈 | 131-194秒 | 20000-25000 |
| 一对一复习文档 | 107-262秒 | 22000-26000 |
| 小班课学情反馈（7学生） | 176秒 | 14915 |
| 完整5文档生成 | 5-10分钟 | - |
| 批量处理单任务 | 30-60秒 | 视任务而定 |

## 版本历程摘要

| 阶段 | 版本 | 关键里程碑 |
|------|------|-----------|
| 原型验证 | V1-V3 | 技术栈验证，核心功能跑通 |
| 功能完善 | V4-V12 | 路书规范、高级设置、单步重试 |
| 稳定性优化 | V13-V22 | API切换、后端流式输出、回滚恢复 |
| 简化迭代 | V23-V28 | 去掉冗余步骤，直接用路书原文 |
| 日志与版控 | V29-V33 | 日志系统、GitHub迁移 |
| OAuth授权 | V34-V38 | Google OAuth自助授权、token刷新 |
| 并发修复 | V39-V41 | 并发隔离、日志导出修复 |
| 小班课 | V42-V44 | 气泡图乱码修复、小班课功能、路书统一 |
| SSE改造 | V45系列 | 端到端SSE流式输出、解决Cloudflare超时 |
| 批量处理 | V46 | 并发池模式批量生成、SSE模块抽取 |
| 模板系统 | V47 | 词汇卡片精确排版模板 |
| Markdown增强 | V48 | 完整Markdown解析器、文件上传功能、模板类型扩展 |
| 配置增强 | V49 | 版本号显示、max_tokens可配置、输出截断检测 |
| 模板说明 | V50 | 模板格式说明显示区域、一键复制、写作素材模板 |
| 文档处理 | V51 | 文档转文字功能、XML来源标签 |
| AI代码生成 | V52-V53 | AI 生成代码 + 沙箱执行 |
| 文档提取 | V56-V58 | 文档文字提取功能 |
| 系统修复 | V60-V62 | AI 代码系统修复、步骤跳过 |
| 多项优化 | V63 | 安全修复、并行生成、小班课优化 |
| 批量增强 | V64-V65 | 单任务重做、SSE稳定性、指定任务 |
| SSE攻坚 | V68-V71 | 内存暂存+HTTP拉取，彻底解决传输丢失 |
| 大规模开发 | V72-V100 | AI质量优化、健壮性、移除AI代码模式 |
| TypeScript修复 | V96-V102 | 字段类型和编译错误修复 |
| Drive深度集成 | V103-V111 | 自动提取录音/反馈、三级搜索、手机优化 |
| 后台任务 | V112-V118 | 后台任务系统、数据库升级、并发数调整 |
| 体验完善 | V119-V128 | 非流式改造、截断续写、防重复点击 |
| 气泡图重构 | V129-V134 | resvg引擎、本地字体、COLLAB看板 |
| 功能补全 | V137-V147 | 模型选择器、下载按钮、多段录音、查看素材 |
| 作业管理 | V148-V152 | 学生名册、语音AI、预入库、已入库浏览 |
| 用户管理 | V153-V169 | OAuth认证、多用户、God Mode、邮箱白名单 |
| 作业批改 | V171 | 多模态AI批改、自动入库学生状态 |
| 多租户隔离 | V172-V179 | user_config、数据表 userId 隔离、配置权限开放 |

详细迭代历史见 迭代记录.md

## 关键文件说明

| 文件 | 说明 |
|------|------|
| server/whatai.ts | AI API调用模块，含重试和流式输出 |
| server/gdrive.ts | Google Drive读写模块 |
| server/feedbackGenerator.ts | 5个文档的生成逻辑 |
| server/classStreamRoutes.ts | 4个SSE端点（V45新增） |
| server/logger.ts | 日志记录模块 |
| server/routers.ts | tRPC路由定义 |
| server/core/sseHelper.ts | SSE公共函数（V46新增） |
| server/core/concurrencyPool.ts | 并发池管理（V46新增） |
| server/core/wordGenerator.ts | Word文档生成（V46新增） |
| server/core/batchWordGenerator.ts | Markdown解析和Word生成（V48增强） |
| server/batchRoutes.ts | 批量处理路由（V48支持文件上传） |
| server/llm.ts | AI调用模块（V48支持FileInfo参数） |
| server/templates/wordCardTemplate.ts | 词汇卡片模板（V47新增） |
| server/templates/writingMaterialTemplate.ts | 写作素材模板（V50新增） |
| server/documentExtractor.ts | 文档文本提取（V51新增） |
| server/homeworkManager.ts | 作业管理后端逻辑（V148新增） |
| client/src/pages/Home.tsx | 前端主页面 |
| client/src/pages/BatchProcess.tsx | 批量处理前端页面（V46新增） |
| client/src/pages/TaskHistory.tsx | 任务记录前端页面（V112+拆分） |
| client/src/pages/HomeworkManagement.tsx | 作业管理前端页面（V148新增） |
| drizzle/schema.ts | 数据库表结构定义 |
| drizzle/0009_homework_management.sql | 作业管理数据库迁移（V148新增） |
| fonts/ | 项目本地字体目录（V131新增） |
| COLLAB.md | Claude与Manus协作看板（V131新增） |

## 已知限制

| 限制 | 说明 |
|------|------|
| 小班课最多7人 | 超过7人建议分班 |
| 单次生成耗时较长 | 完整5文档需5-10分钟 |
| V9路书需手动粘贴 | 暂不支持自动读取文件 |
| 气泡图格式依赖AI | 如格式不对需调整路书示例 |
| 词汇卡片模板AI必须输出纯JSON | 不能带Markdown代码块标记 |
| 单任务最多10个文件 | DMXapi API限制，共享+独立文件合计 |
| 气泡图字体依赖本地目录 | fonts/ 目录需包含中文字体文件，否则中文显示空白 |
| 作业管理暂无导出功能 | 已入库记录只能在系统内查看，尚不支持批量导出 |
| 沙箱环境文件系统受限 | Manus沙箱无法访问系统字体和部分系统目录 |
| COLLAB.md状态需手动更新 | 部署后"待部署"状态不会自动更新为"已部署" |

## 后续规划

| 优先级 | 功能 |
|--------|------|
| P1 | 多轮Agent循环（工具调用+自动纠错，类似Claude网页端） |
| P1 | 作业管理数据导出功能 |
| P2 | 步骤级粒度重试（目前只支持任务级） |
| P2 | 更多模板类型支持 |
| P3 | 更多AI模型接入和自动切换 |

---

*文档创建时间：2026年1月7日*
*最后更新：2026年2月16日*
*当前版本：V179*
