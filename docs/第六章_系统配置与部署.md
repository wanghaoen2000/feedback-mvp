# 第六章 系统配置与部署

> **学情反馈系统 (feedback-mvp) 技术手册**
> 版本 V179 | 2026-02-16

---

## 6.1 项目构建

### 6.1.1 构建命令

```bash
# 开发模式（热重载）
npm run dev
# 执行：build:version → tsx watch server/_core/index.ts

# 生产构建
npm run build
# 执行：build:version → vite build → esbuild server bundle

# 生产运行
npm run start
# 执行：NODE_ENV=production node dist/index.js

# TypeScript 类型检查（不输出文件）
npm run check

# 单元测试
npm run test
```

### 6.1.2 构建流程详解

**`npm run build` 实际执行三个步骤：**

```
步骤 1: node scripts/generate-version.cjs
        ├── 读取 VERSION 常量（如 "V179"）
        ├── 读取 git commit hash
        └── 生成 client/src/version.generated.ts
            export const VERSION = "V179";
            export const COMMIT_HASH = "abc1234";
            export const VERSION_DISPLAY = "V179 (abc1234)";

步骤 2: vite build
        ├── 入口：client/index.html
        ├── 处理 React + TypeScript + Tailwind CSS
        ├── 输出到 dist/public/（前端静态文件）
        └── 路径别名：@ → client/src, @shared → shared

步骤 3: esbuild server/_core/index.ts
        ├── 打包后端为单个 ESM bundle
        ├── --platform=node --packages=external
        ├── 不打包 node_modules（external）
        └── 输出到 dist/index.js
```

### 6.1.3 关键构建约束

| 约束 | 原因 |
|------|------|
| ESM 模式（`"type": "module"`） | 不能使用 `require()`，所有导入必须用 `import` |
| esbuild 打包后端 | 不用 webpack，更快且更简单 |
| `--packages=external` | node_modules 不打包进 bundle，运行时从目录加载 |
| vite build 在 esbuild 之前 | 前端构建产物供后端 Express 静态服务 |

---

## 6.2 环境变量

### 6.2.1 必需环境变量

| 变量 | 说明 | 示例 |
|------|------|------|
| `DATABASE_URL` | MySQL 连接字符串 | `mysql://user:pass@localhost:3306/feedback` |
| `OWNER_OPEN_ID` | 系统 Owner 的 Manus OpenID | `manus_xxx` |
| `GOOGLE_OAUTH_CLIENT_ID` | Google OAuth Client ID | `xxx.apps.googleusercontent.com` |
| `GOOGLE_OAUTH_CLIENT_SECRET` | Google OAuth Client Secret | `GOCSPX-xxx` |

### 6.2.2 可选环境变量

| 变量 | 默认值 | 说明 |
|------|--------|------|
| `NODE_ENV` | `development` | `production` 时：服务静态文件、隐藏错误堆栈 |
| `PORT` | `3000` | 服务端口（被占用时自动递增，最多尝试 20 个端口） |

### 6.2.3 不通过环境变量管理的配置

以下配置存储在数据库中，通过前端「全局设置」界面管理：

- AI API 密钥和地址（支持多用户各自配置不同供应商）
- AI 模型名称
- Google Drive 存储路径
- 路书内容
- 批改类型和提示词
- 作业管理提示词

> **原因：** 这些配置需要支持多用户独立设置，且需要在运行时动态修改，不适合写入环境变量。

---

## 6.3 服务器启动流程

**文件：** `server/_core/index.ts`

```
startServer()
  ├── 初始化 Express
  │   ├── express.json({ limit: "50mb" })      ← 支持大文件上传
  │   ├── express.urlencoded({ limit: "50mb" })
  │   └── 服务器超时 = 15 分钟                    ← 长时间 AI 生成
  │
  ├── 注册路由
  │   ├── OAuth 路由（/api/oauth/callback）
  │   ├── SSE 路由（/api/*-stream, /api/feedback-content, /api/download-drive-file）
  │   ├── 批量处理路由（/api/batch/*，需 requireAuth）
  │   └── tRPC 中间件（/api/trpc/*，15 分钟超时）
  │
  ├── 前端静态服务
  │   ├── 开发模式 → Vite dev server（热重载）
  │   └── 生产模式 → express.static("dist/public")
  │
  ├── 数据库初始化
  │   ├── 自动建表（CREATE TABLE IF NOT EXISTS）
  │   └── 自动加列（ALTER TABLE ADD COLUMN，忽略 Duplicate column 错误）
  │
  ├── 后台任务恢复
  │   ├── recoverInterruptedTasks()    ← running/pending → failed
  │   ├── cleanupOldTasks()            ← 删除 3 天以上的旧任务
  │   ├── recoverInterruptedBatchTasks()
  │   └── cleanupOldBatchTasks()
  │
  └── 端口绑定
      ├── 尝试 localhost:3000
      ├── 被占用 → 尝试 3001, 3002, ... （最多 +20）
      └── 成功 → 输出启动日志
```

---

## 6.4 部署流程（Manus 沙箱）

### 6.4.1 标准部署步骤

```bash
# 1. 设置远程地址（首次或 checkpoint 后）
git remote set-url origin https://github.com/wanghaoen2000/feedback-mvp.git

# 2. 拉取开发分支
git fetch origin
git merge origin/claude/xxx    # 应直接 fast-forward

# 3. 安装依赖（如有变更）
npm install

# 4. 构建
npm run build

# 5. 先 checkpoint（保存沙箱快照）
webdev_save_checkpoint

# 6. 最后推 GitHub
git push origin main
```

### 6.4.2 顺序至关重要

```
正确顺序：merge → build → checkpoint → push
错误顺序：merge → build → push → checkpoint ← 会导致 checkpoint 失败！
```

**原因：** Manus 的 `webdev_save_checkpoint` 会把 Git remote 切换到 S3 地址。如果先推了 GitHub，本地的 remote 已经指向 GitHub，checkpoint 时本地历史和 S3 历史分叉，导致失败。

### 6.4.3 判断是否需要 npm install

| 场景 | 是否需要 |
|------|----------|
| Claude 发布说明中提到"新增依赖"或"移除依赖" | 需要 |
| Claude 发布说明中提到"无需 npm install" | 不需要 |
| 不确定 | 跑一次 `npm install` 没有副作用 |

### 6.4.4 数据库迁移

系统的数据库迁移是**自动且幂等的**：

- 服务启动时自动执行 `CREATE TABLE IF NOT EXISTS`
- 新增列使用 `ALTER TABLE ADD COLUMN`，捕获 Duplicate column 错误忽略
- 不需要手动执行 SQL

---

## 6.5 日志系统

**文件：** `server/logger.ts`

### 6.5.1 生成日志

每次学情反馈生成都会创建一份详细的日志文件：

```
日志路径：/tmp/feedback-logs/{studentName}_{timestamp}.log
```

**日志内容包括：**

- 生成参数（学生姓名、课次、日期等）
- 配置快照（模型、API 地址、路书摘要）
- 各步骤的开始/结束时间和耗时
- AI 原始输出（用于排查截断问题）
- 上传结果（文件名、URL）
- 错误详情和堆栈

### 6.5.2 日志管理接口

| 接口 | 功能 |
|------|------|
| `feedback.listLogs` | 列出所有日志文件 |
| `feedback.getLatestLog` | 获取最新日志 |
| `feedback.exportLog` | 导出指定日志 |

前端可通过「导出日志」按钮下载日志文件，用于排查问题。

### 6.5.3 控制台日志前缀

后端日志使用统一前缀便于过滤：

| 前缀 | 模块 |
|------|------|
| `[启动]` | 服务器启动 |
| `[后台任务]` | backgroundTaskRunner |
| `[批量任务]` | batchTaskRunner |
| `[学生管理]` | homeworkManager |
| `[作业批改]` | correctionRunner |
| `[打分]` | gradingRunner |
| `[提醒]` | reminderRunner |
| `[AuthMiddleware]` | 认证中间件 |

---

## 6.6 安全配置

### 6.6.1 Cookie 安全

```typescript
{
  httpOnly: true,      // JavaScript 无法访问 Cookie（防 XSS）
  path: "/",
  sameSite: "none",    // 允许跨站请求（Manus iframe 嵌入）
  secure: boolean      // HTTPS 环境下为 true
}
```

**Secure 检测逻辑：** 检查 `req.protocol` 或 `x-forwarded-proto` header，支持多级代理。

### 6.6.2 API Key 安全

- API Key **永远不返回给前端**（`config.getAll` 返回空字符串，仅返回 `hasApiKey: boolean`）
- 配置导出时 API Key 被遮蔽
- 前端显示 `****xxxx` 格式

### 6.6.3 数据隔离

- 所有查询附加 `WHERE user_id = ?`
- 管理员通过伪装登录间接访问（不绕过隔离）
- 配置备份导出不包含其他用户的数据

### 6.6.4 输入验证

- 所有 tRPC 输入通过 Zod schema 校验
- 路径参数检查（防路径遍历）
- 文件大小限制（50MB）
- 图片自动压缩（前端限制 2048×2048，服务端检查）

---

## 6.7 性能配置

### 6.7.1 超时设置

| 配置 | 值 | 原因 |
|------|------|------|
| Express server timeout | 15 分钟 | AI 生成可能很慢 |
| keepAliveTimeout | 15 分钟 | 匹配 server timeout |
| headersTimeout | 15 分钟 + 1 秒 | 略大于 keepAlive |
| tRPC 路由超时 | 15 分钟 | 匹配 server timeout |
| AI 单次调用超时 | 3 分钟 | 防止单轮 AI 卡死 |
| 文件下载超时 | 60 秒 | 前端 AbortController |

### 6.7.2 并发限制

| 资源 | 限制 | 原因 |
|------|------|------|
| 后台任务 | 最多 3 个同时 | 防止 AI API 限速 |
| 批量任务子项 | 用户可配（默认 50，上限 200） | 平衡速度和 API 负载 |
| 打分同步 | 默认 20 个同时 | 防止 AI API 限速 |

### 6.7.3 数据清理策略

| 数据 | 保留时间 | 清理时机 |
|------|----------|----------|
| background_tasks | 3 天 | 服务启动时 |
| batch_tasks | 3 天 | 服务启动时 |
| correction_tasks | 3 天 | 服务启动时 |
| grading_tasks | 180 天 | 服务启动时 |
| reminder_tasks | 30 天 | 服务启动时 |
| SSE 内容缓存 | 短期（内存） | 自动过期 |

---

## 6.8 字体配置

### 6.8.1 字体文件

气泡图 SVG → PNG 渲染需要中文字体。字体文件放在项目 `fonts/` 目录下。

| 字体 | 文件 | 优先级 | 说明 |
|------|------|--------|------|
| Noto Sans CJK SC | `fonts/NotoSansCJK-Regular.ttc` | 优先使用 | 更美观 |
| WenQuanYi Zen Hei | `fonts/wqy-zenhei.ttc` | 兜底 | Noto 不存在时使用 |

### 6.8.2 为什么需要项目内置字体

Manus 沙箱环境中，Node.js 进程无法访问系统字体目录（`/usr/share/fonts`）。`@resvg/resvg-js` 的 `loadSystemFonts` 在沙箱中找不到字体，导致中文渲染为空白。因此必须将字体文件复制到项目目录，由代码显式加载。

---

## 6.9 版本发布检查清单

每次发布新版本前，开发端（Claude）需要：

- [ ] 更新 `scripts/generate-version.cjs` 中的 `VERSION` 常量
- [ ] 将变更说明追加到 `COLLAB.md` 的「Claude → Manus」区域
- [ ] 说明是否有新增依赖、数据库迁移
- [ ] 提供完整的部署操作命令
- [ ] `git fetch origin && git rebase origin/main` 后再推送

每次部署后，部署端（Manus）需要：

- [ ] 按正确顺序执行（merge → build → checkpoint → push）
- [ ] 更新 `COLLAB.md`「版本发布记录」中的部署状态
- [ ] 验证核心功能是否正常
