# V67 前端请求排查报告 - 请求持续增加的问题

**排查时间**：2026年1月27日
**问题现象**：API 返回 401 错误后，前端请求持续增加（9→15→21 次）

---

## 一、排查结果汇总

### 1. 前端是否有重连机制？

**没有自动重连机制**。搜索 `reconnect` 只找到 HTML 中的 `preconnect` 标签，与业务无关。

### 2. 心跳超时后会做什么？

**只是打印警告，不会触发重连或重试**。

```typescript
// BatchProcess.tsx 第 876-881 行
const timeoutChecker = setInterval(() => {
  const elapsed = Date.now() - lastEventTime;
  if (elapsed > 30000) { // 30秒无事件
    console.warn('[SSE] 超过30秒未收到事件，可能连接已断开');
  }
}, 5000); // 每5秒检查一次
```

### 3. SSE 失败后是否会降级为轮询？

**是的，会启动轮询**。

```typescript
// BatchProcess.tsx 第 1046-1052 行
} else if (status.status === 'running') {
  // 批次还在运行，显示提示并启动轮询
  console.log('[SSE] 批次仍在运行，启动轮询');
  updateStateFromBatchStatus(status);
  startPolling(currentBatchId);  // ⚠️ 启动轮询
  return; // 不显示错误
}
```

轮询间隔：**每 3 秒查询一次**

```typescript
// BatchProcess.tsx 第 715-736 行
pollingIntervalRef.current = setInterval(async () => {
  const status = await fetchBatchStatus(batchId);
  // ...
}, 3000); // 每3秒查询一次
```

### 4. batch_create_event_v2 请求是从哪个函数发出的？

**这个请求名称不在代码中**，可能是 DMXapi 后端的内部接口名称。

前端发出的请求是：
- `/api/batch/generate-stream` - 主要的批量处理请求（第 852 行）
- `/api/batch/status/{batchId}` - 状态查询请求（第 662 行）
- `/api/batch/retry-task` - 单任务重做请求（第 528 行）

---

## 二、问题分析

### 请求持续增加的可能原因

**不是前端的问题**。前端代码分析显示：

1. **没有自动重连机制** - 前端不会在 SSE 失败后自动重新发起 `/api/batch/generate-stream` 请求
2. **轮询只查询状态** - 轮询只调用 `/api/batch/status/{batchId}`，不会触发新的 AI 调用
3. **心跳超时只打印日志** - 不会触发任何请求

### 真正的问题在后端

`batch_create_event_v2` 是 DMXapi 后端的接口名称，不是前端发出的请求。

**可能的原因**：

1. **后端并发任务** - 批量处理启动了多个并发任务，每个任务都会调用 AI API
2. **后端重试逻辑** - 虽然我们已经把 `maxRetries` 设为 0，但代码可能还没有发布到生产环境
3. **代码执行重试** - `codeRetry.ts` 的 `maxAttempts` 虽然改为 1，但如果代码执行失败，仍会调用 AI 修正代码

---

## 三、验证建议

### 1. 确认代码是否已发布

```bash
# 检查生产环境的版本号
# 右上角应该显示 V67 (5d2450c)
```

### 2. 检查后端日志

查看后端日志，确认：
- 是否有多个并发任务在运行？
- 每个任务是否只调用一次 AI？
- `[AIClient]` 日志是否显示 `尝试 1/1`？

### 3. 单任务测试

只运行 1 个任务（不是批量），观察：
- 网络面板应该只有 1 次 AI API 请求
- 如果仍有多次请求，说明后端代码没有正确部署

---

## 四、结论

**前端没有重连/重试机制导致请求增加的问题**。

请求持续增加的原因最可能是：
1. 后端并发任务（多个任务同时调用 AI）
2. 后端代码没有正确部署（仍在使用旧版本）
3. AI 代码模式的代码执行重试（`codeRetry.ts`）

**建议**：
1. 确认生产环境版本号是否为 V67 (5d2450c)
2. 只运行 1 个任务进行测试
3. 查看后端日志确认调用次数

---

**报告完成，等待用户确认。**
