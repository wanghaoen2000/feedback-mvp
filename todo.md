# 学情反馈MVP - TODO

## 核心功能
- [x] 前端：简单输入表单（算术题输入框）
- [x] 后端：tRPC接口调用Claude API计算
- [x] 后端：Google Drive文件上传功能
- [x] 集成：将计算结果保存到指定路径

## 测试
- [x] 端到端测试：输入算术题 → 计算 → 保存到Google Drive

## 完整版功能（V2）
- [x] 前端：三个长文本输入框（上次反馈/本次笔记/录音转文字）
- [x] 前端：学生姓名、课次、日期输入
- [x] 前端：特殊要求输入框（可选）
- [x] 前端：新生首次课模式切换
- [x] 后端：调用LLM生成学情反馈文档
- [x] 后端：调用LLM生成复习文档
- [x] 后端：调用LLM生成测试本
- [x] 后端：调用LLM生成课后信息提取
- [x] 后端：生成气泡图PNG
- [x] 后端：按新路径存储到Google Drive（Mac/Documents/XDF/学生档案/学生名/子文件夹/）
- [x] 测试：完整流程端到端测试

## 状态显示和结果反馈（V3）
- [x] 前端：实时进度条显示当前步骤
- [x] 前端：每步状态图标（成功✓/失败✗/进行中...）
- [x] 前端：失败时显示具体错误信息
- [x] 后端：返回分步执行状态
- [x] 后端：Google Drive文件验证（检查文件是否真的存在）
- [x] 前端：显示最终文件列表和Google Drive链接


## 格式规范修复（V4）
- [x] 将V9路书的学情反馈格式要求写入系统提示词
- [x] 将V9路书的复习文档格式要求写入系统提示词
- [x] 将V9路书的测试本格式要求写入系统提示词
- [x] 将V9路书的课后信息提取格式要求写入系统提示词
- [x] 将V9路书的气泡图格式要求写入系统提示词
- [x] 测试验证生成的文档格式是否符合路书规范

## Bug修复和API切换（V5）
- [x] 修复Word文档格式问题（使用docx库正确生成docx）
- [x] 修复气泡图生成问题（使用sharp库将SVG转换为PNG）
- [x] 切换到神马中转API（https://api.whatai.cc/v1）
- [x] 配置默认使用claude-opus-4-5-20251101-thinking模型
- [x] 测试验证所有修复

## Bug修复（V6）
- [x] 诊断并修复API fetch failed错误（添加超时设置和重试机制）

## 模型切换（V7）
- [x] 将默认模型从Opus切换到claude-sonnet-4-5-20250929

## 超时延长（V8）
- [x] 延长API请求超时时间（复杂任务10分钟，简单任务3分钟）

## Bug修复（V9）
- [~] 修复前端进度显示问题（跳过，后续优化）
- [x] 修复学情反馈格式（纯文本，无markdown标记）
- [x] 修复Word文档格式（正确分页符，无markdown/HTML标记）
- [x] 修复课上生词数量问题（强调15-25个硬性要求）

## 多轮API重构（V10）
- [x] 重构后端API：拆分为5个独立端点（学情反馈、复习文档、测试本、课后信息、气泡图）
- [x] 重构前端：实现自动多轮调用，每完成一个自动触发下一个
- [x] 添加实时进度显示：显示当前正在生成哪个文档

## V11 界面优化
- [x] 删除日期字段（本次课日期、下次课日期），AI自动从笔记提取
- [x] 添加高级设置区域（默认折叠）
- [x] 添加模型名称配置（可持久化）
- [x] 添加API密钥配置（可持久化）
- [x] 添加API地址配置（可持久化）
- [x] 修改AI提示词，自动从笔记中提取日期信息

## V12 单步重试功能
- [x] 在失败的步骤旁边添加“重试”按钮
- [x] 实现单步重试逻辑（只重新执行失败的那一步）
- [x] 重试成功后自动继续后续步骤

## V15 修复 fetch failed 错误
- [x] 将默认 API 切换到 DMXapi（已测试可用）
- [x] 更新默认 API 密钥和地址
- [x] 测试验证修复效果

## V16 重新实现回滚后丢失的功能
- [x] 年份输入字段（默认2026，可持久化）
- [x] 本次课日期输入字段（如"1月5日"，与年份组合）
- [x] 路书管理功能（高级设置中可粘贴更新的V9路书）
- [x] 上传重试机制（失败后自动重试3次）
- [x] 测试所有功能正常工作
- [x] 保存检查点

## V17 遗留功能实现
- [x] 停止按钮 - 允许用户中途取消生成
- [x] V9路书直接用于AI提示词 - 确保数据库中保存的路书内容被AI使用
- [x] 测试所有功能正常工作
- [x] 保存检查点

## V18 修复路书应用范围
- [x] 复习文档生成使用自定义V9路书
- [x] 测试本生成使用自定义V9路书
- [x] 课后信息提取使用自定义V9路书
- [x] 修改routers.ts传递roadmap参数
- [x] 测试并保存检查点

## V19 气泡图也使用自定义路书
- [x] 修改气泡图生成使用自定义V9路书
- [x] 修改routers.ts传递roadmap参数给气泡图
- [x] 测试并保存检查点

## V20 录音转文字分段压缩
- [x] 实现录音转文字分段压缩功能（超长录音分段处理，每段压缩后再合并）
- [x] 测试并保存检查点

## V22 流式输出防止超时
- [x] 在whatai.ts中实现流式API调用
- [x] 修改生成函数使用流式输出（学情反馈、复习文档、测试本、课后信息提取）
- [x] 测试并保存检查点

## V23 直接使用V9路书原文
- [x] 修改学情反馈生成，直接使用路书原文
- [x] 修改复习文档生成，直接使用路书原文
- [x] 修改测试本生成，直接使用路书原文
- [x] 修改课后信息提取，直接使用路书原文
- [x] 修改气泡图提取，直接使用路书原文
- [x] 测试并保存检查点

## V24 全部改为流式输出
- [x] 录音压缩改为流式输出
- [x] 气泡图提取改为流式输出
- [x] 测试并保存检查点

## V25 取消分段压缩
- [x] 取消录音分段压缩，改成一次性压缩
- [x] 测试并保存检查点

## V26 取消录音压缩
- [x] 取消录音压缩步骤，直接使用原文
- [x] 测试并保存检查点

## V27 让AI直接按V9路书生成气泡图
- [x] 修改气泡图生成逻辑，让AI直接按V9路书生成SVG
- [x] 测试并保存检查点

## V28 添加文档生成边界限制
- [x] 给学情反馈生成添加边界限制
- [x] 给复习文档生成添加边界限制
- [x] 给测试本生成添加边界限制
- [x] 给课后信息提取添加边界限制
- [x] 给气泡图生成添加边界限制
- [x] 测试并保存检查点


## V29 日志与调试系统增强

- [x] 任务二：中文错误提示系统
  - [x] 建立错误码映射表
  - [x] 服务端错误包装成结构化对象
  - [x] 前端显示中文错误提示
- [x] 任务三：日志记录与导出系统
  - [x] 创建logg er.ts模块
  - [x] 记录每次生成的完整日志
  - [x] 添加“导出日志”按钮
  - [x] 上传日志到Google Drive
- [x] 任务一：实时状态上屏显示
  - [x] 添加实时输出预览面板
  - [x] 流式内容推送到前端
  - [x] 显示每个步骤的状态


## V29 问题修复

- [ ] 问题1：实时数据没上屏 - 只显示"连接AI服务中"，没有显示AI返回的内容
- [x] 问题2：错误信息没显示 - 已添加错误详情显示区域
- [x] 问题3：日志文件没生成 - 已在所有步骤的catch块中添加endLogSession调用

## 日志导出优化

- [x] 修改服务端exportLog接口返回路径和链接
- [x] 修改前端显示导出结果（路径+可点击链接）


## 日志导出问题修复

- [x] 问题1：链接没显示 - 前端已正确显示路径和链接
- [x] 问题2：文件没真正上传 - 修复了上传状态检查逻辑，失败时正确返回错误


## Google Drive授权修复

- [ ] 重新授权Google Drive（token过期）- 需要用户在Manus设置中手动操作
- [ ] 验证授权成功
- [x] 修复文件上传的错误处理 - 已为5个步骤都添加了uploadResult.status检查
